# Documentazione Progetto Access Control

**Data generazione:** 2025-07-24 11:58:34
**Directory progetto:** ../src
**Totale file documentati:** 90

## Indice File

- [__init__.py](#initpy)
- [access.db](#accessdb)
- [api/admin_templates.py](#apiadmintemplatespy)
- [api/auth.py](#apiauthpy)
- [api/auth.pyscio.io](#apiauthpyscioio)
- [api/backup_module.py](#apibackupmodulepy)
- [api/dashboard_templates.py](#apidashboardtemplatespy)
- [api/hardware_detection.py](#apihardwaredetectionpy)
- [api/hardware_detection.py.backup](#apihardwaredetectionpybackup)
- [api/hardware_tests.py](#apihardwaretestspy)
- [api/modules/__init__.py](#apimodulesinitpy)
- [api/modules/activities.py](#apimodulesactivitiespy)
- [api/modules/configurazione_accessi.py](#apimodulesconfigurazioneaccessipy)
- [api/modules/dispositivi.py](#apimodulesdispositivipy)
- [api/modules/email_log_allerte_sistema.py](#apimodulesemaillogallertesistemapy)
- [api/modules/log_management.py](#apimoduleslogmanagementpy)
- [api/modules/profilo.py](#apimodulesprofilopy)
- [api/modules/system_users.py](#apimodulessystemuserspy)
- [api/modules/user_management.py](#apimodulesusermanagementpy)
- [api/modules/utenti.py](#apimodulesutentipy)
- [api/modules/utenti_autorizzati.py](#apimodulesutentiautorizzatipy)
- [api/static/css/backup.css](#apistaticcssbackupcss)
- [api/static/css/clock.css](#apistaticcssclockcss)
- [api/static/css/configurazione_orari.css](#apistaticcssconfigurazioneoraricss)
- [api/static/css/dashboard.css](#apistaticcssdashboardcss)
- [api/static/css/profilo.css](#apistaticcssprofilocss)
- [api/static/css/test-accessi.css](#apistaticcsstestaccessicss)
- [api/static/css/user-menu.css](#apistaticcssusermenucss)
- [api/static/favicon.ico](#apistaticfaviconico)
- [api/static/html/backup_modal.html](#apistatichtmlbackupmodalhtml)
- [api/static/html/dashboard_template.html](#apistatichtmldashboardtemplatehtml)
- [api/static/html/logs.html](#apistatichtmllogshtml)
- [api/static/html/modals.html](#apistatichtmlmodalshtml)
- [api/static/html/test-accessi.html](#apistatichtmltestaccessihtml)
- [api/static/html/user-management.html](#apistatichtmlusermanagementhtml)
- [api/static/html/user-menu.html](#apistatichtmlusermenuhtml)
- [api/static/js/admin-functions.js](#apistaticjsadminfunctionsjs)
- [api/static/js/alerts.js](#apistaticjsalertsjs)
- [api/static/js/backup.js](#apistaticjsbackupjs)
- [api/static/js/clock.js](#apistaticjsclockjs)
- [api/static/js/configurazione_orari.js](#apistaticjsconfigurazioneorarijs)
- [api/static/js/dashboard.js](#apistaticjsdashboardjs)
- [api/static/js/hardware-manager.js](#apistaticjshardwaremanagerjs)
- [api/static/js/hardware_test.js](#apistaticjshardwaretestjs)
- [api/static/js/profilo.js](#apistaticjsprofilojs)
- [api/static/js/recent-activities.js](#apistaticjsrecentactivitiesjs)
- [api/static/js/sistema.js](#apistaticjssistemajs)
- [api/static/js/test-accessi.js](#apistaticjstestaccessijs)
- [api/static/js/user-management.js](#apistaticjsusermanagementjs)
- [api/static/js/user-menu.js](#apistaticjsusermenujs)
- [api/static/js/users.js](#apistaticjsusersjs)
- [api/static/js/utenti_autorizzati.js](#apistaticjsutentiautorizzatijs)
- [api/templates/configurazione_orari.html](#apitemplatesconfigurazioneorarihtml)
- [api/templates/hardware_test_section.html](#apitemplateshardwaretestsectionhtml)
- [api/templates/profilo.html](#apitemplatesprofilohtml)
- [api/templates/utenti_autorizzati.html](#apitemplatesutentiautorizzatihtml)
- [api/test_hardware_integration.py](#apitesthardwareintegrationpy)
- [api/user_menu.py](#apiusermenupy)
- [api/utils.py](#apiutilspy)
- [api/web_api.py](#apiwebapipy)
- [core/__init__.py](#coreinitpy)
- [core/config.py](#coreconfigpy)
- [database/database_manager.py](#databasedatabasemanagerpy)
- [database_schema.sql](#databaseschemasql)
- [drivers/288K/288K-linux-sample/288K/LoadCrt288lib.c](#drivers288K288Klinuxsample288KLoadCrt288libc)
- [drivers/288K/288K-linux-sample/288K/LoadCrt288lib.h](#drivers288K288Klinuxsample288KLoadCrt288libh)
- [drivers/288K/288K-linux-sample/288K/Makefile](#drivers288K288Klinuxsample288KMakefile)
- [drivers/288K/288K-linux-sample/288K/Makefile-arm](#drivers288K288Klinuxsample288KMakefilearm)
- [drivers/288K/288K-linux-sample/288K/crt_288_test](#drivers288K288Klinuxsample288Kcrt288test)
- [drivers/288K/288K-linux-sample/288K/crt_288_test.c](#drivers288K288Klinuxsample288Kcrt288testc)
- [drivers/288K/288K-linux-sample/288K/crt_288x_ur.h](#drivers288K288Klinuxsample288Kcrt288xurh)
- [drivers/288K/doc/MANUAL.md](#drivers288KdocMANUALmd)
- [drivers/288K/install/uso.md](#drivers288Kinstallusomd)
- [drivers/288K/install/verifica_288x.sh](#drivers288Kinstallverifica288xsh)
- [drivers/288K/linux_crt_288x/drivers/x64/crt_288x_ur.h](#drivers288Klinuxcrt288xdriversx64crt288xurh)
- [drivers/288K/linux_crt_288x/drivers/x64/crt_288x_ur.h(EN).txt](#drivers288Klinuxcrt288xdriversx64crt288xurh(EN)txt)
- [drivers/288K/linux_crt_288x/drivers/x86/crt_288x_ur.h](#drivers288Klinuxcrt288xdriversx86crt288xurh)
- [drivers/288K/linux_crt_288x/drivers/x86/crt_288x_ur.h(EN).txt](#drivers288Klinuxcrt288xdriversx86crt288xurh(EN)txt)
- [external/odoo_partner_connector.py](#externalodoopartnerconnectorpy)
- [external/test_connessione_utente_api.py](#externaltestconnessioneutenteapipy)
- [genera_documentazione.py](#generadocumentazionepy)
- [hardware/__init__.py](#hardwareinitpy)
- [hardware/after.txt](#hardwareaftertxt)
- [hardware/before.txt](#hardwarebeforetxt)
- [hardware/card_reader.py](#hardwarecardreaderpy)
- [hardware/find_crt288x](#hardwarefindcrt288x)
- [hardware/find_crt288x.c](#hardwarefindcrt288xc)
- [hardware/serial_test](#hardwareserialtest)
- [hardware/usb_rly08_controller.py](#hardwareusbrly08controllerpy)
- [main.py](#mainpy)

---

## File: __init__.py

**Percorso:** `__init__.py`
**Directory:** `.`
**Dimensione:** 0 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python

```

---

## File: access.db

**Percorso:** `access.db`
**Directory:** `.`
**Dimensione:** 7237632 bytes
**Ultima modifica:** 2025-07-23 10:17:04
**Permessi:** 775

### Contenuto:

*[File binario - contenuto non visualizzabile]*

---

## File: admin_templates.py

**Percorso:** `api/admin_templates.py`
**Directory:** `api`
**Dimensione:** 38579 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/admin_templates.py
# Template per le 3 pagine admin da aggiungere a dashboard_templates.py

# Template per Gestione Utenti Admin
ADMIN_USERS_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Gestione Utenti - Sistema Controllo Accessi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-users-cog me-2"></i>Gestione Utenti Sistema
            </span>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistiche Utenti -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-crown fa-2x text-danger mb-3"></i>
                        <div class="stat-number text-danger" id="admin-count">-</div>
                        <h6 class="text-muted">Amministratori</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-user-tie fa-2x text-primary mb-3"></i>
                        <div class="stat-number text-primary" id="manager-count">-</div>
                        <h6 class="text-muted">Gestori Utenti</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-eye fa-2x text-success mb-3"></i>
                        <div class="stat-number text-success" id="viewer-count">-</div>
                        <h6 class="text-muted">Visualizzatori</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x text-info mb-3"></i>
                        <div class="stat-number text-info" id="total-users">-</div>
                        <h6 class="text-muted">Totale</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestione Utenti -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Lista Utenti Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Ruolo</th>
                                        <th>Ultimo Accesso</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user-plus me-2"></i>Nuovo Utente</h5>
                    </div>
                    <div class="card-body">
                        <form id="create-user-form">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="new-username" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" id="new-password" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ruolo</label>
                                <select class="form-select" id="new-role">
                                    <option value="admin">👑 Amministratore</option>
                                    <option value="user_manager">👔 Gestore Utenti</option>
                                    <option value="viewer">👁️ Visualizzatore</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-plus"></i> Crea Utente
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-line me-2"></i>Attività Recente</h6>
                    </div>
                    <div class="card-body">
                        <div id="recent-activity">
                            <small class="text-muted">Caricamento...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
        
        // Carica dati utenti
        loadUsersData();
        
        function loadUsersData() {
            // Implementazione caricamento utenti
            console.log('Caricamento dati utenti...');
        }
    </script>
</body>
</html>
"""

# Template per Configurazioni Sistema
ADMIN_CONFIG_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Configurazioni Sistema - Sistema Controllo Accessi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-sliders-h me-2"></i>Configurazioni Sistema
            </span>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#sistema">
                    <i class="fas fa-cog"></i> Sistema
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#hardware">
                    <i class="fas fa-microchip"></i> Hardware
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#sicurezza">
                    <i class="fas fa-shield-alt"></i> Sicurezza
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#email">
                    <i class="fas fa-envelope"></i> Email
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3">
            <!-- Sistema -->
            <div class="tab-pane fade show active" id="sistema">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server me-2"></i>Configurazioni Sistema</h5>
                    </div>
                    <div class="card-body">
                        <form id="sistema-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Nome Installazione</label>
                                        <input type="text" class="form-control" id="nome-installazione" 
                                               value="Isola Ecologica RAEE - Rende">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Porta Web</label>
                                        <input type="number" class="form-control" id="porta-web" value="5000">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <input type="checkbox" id="debug-mode"> Modalità Debug
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Timeout Sessione (secondi)</label>
                                        <input type="number" class="form-control" id="timeout-sessione" value="1800">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ambiente</label>
                                        <select class="form-select" id="ambiente">
                                            <option value="production">Produzione</option>
                                            <option value="development">Sviluppo</option>
                                            <option value="testing">Test</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Sistema
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Hardware -->
            <div class="tab-pane fade" id="hardware">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-microchip me-2"></i>Configurazioni Hardware</h5>
                    </div>
                    <div class="card-body">
                        <form id="hardware-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Lettore Tessere</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Porta Lettore</label>
                                        <input type="text" class="form-control" id="lettore-porta" value="/dev/ttyACM0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Controller USB-RLY08</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Porta Relè</label>
                                        <input type="text" class="form-control" id="relay-porta" value="/dev/ttyUSB0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Baud Rate</label>
                                        <select class="form-select" id="relay-baudrate">
                                            <option value="9600">9600</option>
                                            <option value="19200" selected>19200</option>
                                            <option value="38400">38400</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Durata Apertura Cancello (sec)</label>
                                        <input type="number" class="form-control" id="gate-duration" value="8" min="1" max="30">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Hardware
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sicurezza -->
            <div class="tab-pane fade" id="sicurezza">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-shield-alt me-2"></i>Configurazioni Sicurezza</h5>
                    </div>
                    <div class="card-body">
                        <form id="sicurezza-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Max Tentativi Login</label>
                                        <input type="number" class="form-control" id="max-tentativi" value="5" min="3" max="10">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Durata Blocco (minuti)</label>
                                        <input type="number" class="form-control" id="durata-blocco" value="15" min="5" max="60">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Rotazione Password (giorni)</label>
                                        <input type="number" class="form-control" id="rotazione-password" value="90" min="30" max="365">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <input type="checkbox" id="log-audit" checked> Log Audit Abilitato
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Sicurezza
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Email -->
            <div class="tab-pane fade" id="email">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope me-2"></i>Configurazioni Email</h5>
                    </div>
                    <div class="card-body">
                        <form id="email-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Server SMTP</label>
                                        <input type="text" class="form-control" id="smtp-server" placeholder="smtp.gmail.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Porta SMTP</label>
                                        <select class="form-select" id="smtp-porta">
                                            <option value="25">25 (SMTP)</option>
                                            <option value="587" selected>587 (SMTP TLS)</option>
                                            <option value="465">465 (SMTP SSL)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Email Mittente</label>
                                        <input type="email" class="form-control" id="email-mittente" placeholder="isola@comune.rende.cs.it">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <input type="checkbox" id="report-automatici"> Report Automatici
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Frequenza Report</label>
                                        <select class="form-select" id="frequenza-report">
                                            <option value="daily">Giornaliero</option>
                                            <option value="weekly" selected>Settimanale</option>
                                            <option value="monthly">Mensile</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Email
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Azioni Sistema -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Azioni Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" onclick="restartSystem()">
                                    <i class="fas fa-redo"></i> Riavvia Sistema
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-info w-100" onclick="exportConfig()">
                                    <i class="fas fa-download"></i> Esporta Configurazioni
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-secondary w-100" onclick="resetToDefaults()">
                                    <i class="fas fa-undo"></i> Ripristina Default
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
        
        // Carica configurazioni
        loadSystemConfig();
        
        function loadSystemConfig() {
            fetch('/api/system/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Popola i form con i dati
                        console.log('Configurazioni caricate:', data.config);
                    }
                });
        }
        
        function restartSystem() {
            if (confirm('Sei sicuro di voler riavviare il sistema?')) {
                fetch('/api/system/restart', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Sistema in riavvio...');
                        }
                    });
            }
        }
        
        function exportConfig() {
            alert('Funzionalità export configurazioni da implementare');
        }
        
        function resetToDefaults() {
            if (confirm('Ripristinare tutte le configurazioni ai valori default?')) {
                alert('Funzionalità reset da implementare');
            }
        }
    </script>
</body>
</html>
"""

# Template per Backup & Restore
ADMIN_BACKUP_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Backup & Restore - Sistema Controllo Accessi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-database me-2"></i>Backup & Restore Sistema
            </span>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistiche Backup -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-archive fa-2x text-primary mb-3"></i>
                        <div class="stat-number text-primary" id="total-backups">-</div>
                        <h6 class="text-muted">Backup Totali</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-hdd fa-2x text-success mb-3"></i>
                        <div class="stat-number text-success" id="total-size">-</div>
                        <h6 class="text-muted">Spazio Utilizzato</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                        <div class="stat-number text-warning" id="last-backup">-</div>
                        <h6 class="text-muted">Ultimo Backup</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-pie fa-2x text-info mb-3"></i>
                        <div class="stat-number text-info" id="disk-usage">-</div>
                        <h6 class="text-muted">Disco Utilizzato</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Azioni Backup -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plus-circle me-2"></i>Crea Nuovo Backup</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100 mb-2" onclick="createBackup('complete')">
                                    <i class="fas fa-archive"></i><br>Backup Completo
                                    <small class="d-block">Sistema + Database + Config</small>
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-success w-100 mb-2" onclick="createBackup('database')">
                                    <i class="fas fa-database"></i><br>Solo Database
                                    <small class="d-block">Backup rapido DB</small>
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-warning w-100" onclick="cleanupBackups()">
                            <i class="fas fa-broom"></i> Pulizia Backup Vecchi
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog me-2"></i>Configurazione Automatica</h5>
                    </div>
                    <div class="card-body">
                        <form id="backup-config-form">
                            <div class="mb-3">
                                <label class="form-label">
                                    <input type="checkbox" id="auto-backup-enabled"> Backup Automatici
                                </label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Frequenza</label>
                                <select class="form-select" id="backup-frequency">
                                    <option value="daily">Giornaliero</option>
                                    <option value="weekly" selected>Settimanale</option>
                                    <option value="monthly">Mensile</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mantieni per</label>
                                <select class="form-select" id="backup-retention">
                                    <option value="7">7 giorni</option>
                                    <option value="30" selected>30 giorni</option>
                                    <option value="90">90 giorni</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-save"></i> Salva Configurazione
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista Backup -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Lista Backup Disponibili</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome File</th>
                                        <th>Tipo</th>
                                        <th>Dimensione</th>
                                        <th>Data Creazione</th>
                                        <th>Età</th>
                                        <th>Checksum</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="backups-table">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operazioni in Corso -->
        <div id="backup-operations" class="row mt-4" style="display: none;">
            <div class="col-md-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6><i class="fas fa-spinner fa-spin me-2"></i>Operazioni in Corso</h6>
                    </div>
                    <div class="card-body" id="operations-list">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/backup.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
        
        // Carica stato backup
        loadBackupStatus();
        
        // Polling per operazioni in corso
        setInterval(checkBackupOperations, 3000);
        
        function loadBackupStatus() {
            fetch('/api/backup/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('total-backups').textContent = data.total_backups || '0';
                        document.getElementById('total-size').textContent = data.total_size || '-';
                        document.getElementById('last-backup').textContent = data.last_backup || 'Mai';
                        document.getElementById('disk-usage').textContent = data.disk_used_percent + '%' || '-';
                        
                        renderBackupsTable(data.backups);
                    }
                });
        }
        
        function renderBackupsTable(backups) {
            const tbody = document.getElementById('backups-table');
            if (!backups || backups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nessun backup trovato</td></tr>';
                return;
            }
            
            let html = '';
            backups.forEach(backup => {
                html += `
                    <tr>
                        <td><i class="fas fa-${backup.type === 'complete' ? 'archive' : 'database'} me-2"></i>${backup.name}</td>
                        <td><span class="badge bg-${backup.type === 'complete' ? 'primary' : 'success'}">${backup.type === 'complete' ? 'Completo' : 'Database'}</span></td>
                        <td>${backup.size}</td>
                        <td>${new Date(backup.date).toLocaleString('it-IT')}</td>
                        <td>${backup.age_days} giorni</td>
                        <td>${backup.has_checksum ? '<i class="fas fa-check-circle text-success"></i>' : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="downloadBackup('${backup.name}')">
                                <i class="fas fa-download"></i>
                            </button>
                            ${backup.can_restore ? `
                                <button class="btn btn-sm btn-success" onclick="restoreBackup('${backup.name}')">
                                    <i class="fas fa-undo"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
        
        function createBackup(type) {
            fetch('/api/backup/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: type})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Backup avviato', 'success');
                    // Il polling aggiornerà automaticamente lo stato
                } else {
                    showAlert('Errore: ' + data.error, 'danger');
                }
            });
        }
        
        function cleanupBackups() {
            if (confirm('Eliminare i backup vecchi secondo la policy di retention?')) {
                fetch('/api/backup/cleanup', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Pulizia completata', 'success');
                            loadBackupStatus();
                        }
                    });
            }
        }
        
        function downloadBackup(filename) {
            window.location.href = `/api/backup/download/${encodeURIComponent(filename)}`;
        }
        
        function deleteBackup(filename) {
            if (confirm(`Eliminare il backup ${filename}?`)) {
                fetch(`/api/backup/delete/${encodeURIComponent(filename)}`, {method: 'DELETE'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Backup eliminato', 'success');
                            loadBackupStatus();
                        }
                    });
            }
        }
        
        function restoreBackup(filename) {
            if (confirm(`ATTENZIONE: Il ripristino sovrascriverà la configurazione attuale.\\n\\nVuoi ripristinare il backup ${filename}?`)) {
                fetch(`/api/backup/restore/${encodeURIComponent(filename)}`, {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Ripristino completato. Il sistema verrà riavviato...');
                            setTimeout(() => window.location.reload(), 3000);
                        }
                    });
            }
        }
        
        function checkBackupOperations() {
            // Implementazione controllo operazioni in corso
        }
        
        function showAlert(message, type) {
            // Implementazione notifiche
            console.log(`${type}: ${message}`);
        }
    </script>
</body>
</html>
"""

```

---

## File: auth.py

**Percorso:** `api/auth.py`
**Directory:** `api`
**Dimensione:** 4492 bytes
**Ultima modifica:** 2025-07-19 13:43:51
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/auth.py
from flask import session, jsonify, redirect
from functools import wraps
import hashlib
import sqlite3
import os

# Definizione ruoli e permessi
USER_ROLES = {
    'admin': {
        'name': 'Amministratore',
        'permissions': ['all'],
        'description': 'Accesso completo al sistema'
    },
    'user_manager': {
        'name': 'Gestore Utenti',
        'permissions': ['view_logs', 'filter_logs', 'export_logs', 'manage_viewers', 'reset_passwords'],
        'description': 'Gestione utenti viewer, visualizzazione ed export log'
    },
    'viewer': {
        'name': 'Visualizzatore',
        'permissions': ['view_logs', 'filter_logs'],
        'description': 'Solo visualizzazione e filtro log'
    }
}

# Path del database
DB_PATH = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'access.db')

def get_db_connection():
    """Connessione al database"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        return conn
    except Exception as e:
        print(f"Errore connessione DB: {e}")
        return None

def verify_user(username: str, password: str) -> tuple:
    """Verifica credenziali utente nel database"""
    conn = get_db_connection()
    if not conn:
        print("Errore: Connessione al database fallita")
        return False, None
    
    try:
        cursor = conn.cursor()
        password_hash = hashlib.sha256(password.encode()).hexdigest()
        print(f"Debug: Hash generato per la password: {password_hash}")
        
        cursor.execute("""
            SELECT username, role, attivo, password
            FROM utenti_sistema 
            WHERE username = ?
        """, (username,))
        
        user = cursor.fetchone()
        
        if user:
            print(f"Debug: Utente trovato: {user['username']}, Ruolo: {user['role']}, Attivo: {user['attivo']}")
            print(f"Debug: Hash password nel DB: {user['password']}")
            if user['password'] == password_hash and user['attivo']:
                print("Debug: Autenticazione riuscita")
                return True, user['role']
            else:
                print("Debug: Password non corrispondente o utente non attivo")
        else:
            print("Debug: Utente non trovato")
        
        return False, None
        
    except Exception as e:
        print(f"Errore verifica utente: {e}")
        return False, None
    finally:
        conn.close()

def require_auth():
    """Decorator per richiedere autenticazione con gestione errori"""
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            try:
                if not session.get('logged_in') or 'username' not in session:
                    session.clear()  # Pulisci la sessione se non valida
                    return redirect('/login')
                return f(*args, **kwargs)
            except Exception as e:
                print(f"Errore autenticazione: {e}")
                session.clear()  # Pulisci la sessione in caso di errori
                return redirect('/login')
        return wrapper
    return decorator

def require_permission(*required_permissions):
    """Decorator per verificare permessi specifici con gestione errori"""
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            try:
                if not session.get('logged_in') or 'username' not in session:
                    session.clear()  # Pulisci la sessione se non valida
                    return redirect('/login')
                
                user_role = session.get('role')
                if not user_role:
                    session.clear()  # Pulisci la sessione se ruolo mancante
                    return redirect('/login')
                
                user_permissions = USER_ROLES.get(user_role, {}).get('permissions', [])
                
                if 'all' in user_permissions:
                    return f(*args, **kwargs)
                
                if any(perm in user_permissions for perm in required_permissions):
                    return f(*args, **kwargs)
                
                return jsonify({'error': 'Permessi insufficienti'}), 403
            except Exception as e:
                print(f"Errore verifica permessi: {e}")
                session.clear()  # Pulisci la sessione in caso di errori
                return redirect('/login')
        return wrapper
    return decorator

```

---

## File: auth.pyscio.io

**Percorso:** `api/auth.pyscio.io`
**Directory:** `api`
**Dimensione:** 2062 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```text
# File: /opt/access_control/src/api/auth.py
from flask import session, jsonify, redirect
from functools import wraps
import hashlib

USER_ROLES = {
    'admin': {
        'name': 'Amministratore',
        'permissions': ['all'],
        'description': 'Accesso completo al sistema'
    },
    'user_manager': {
        'name': 'Gestore Utenti',
        'permissions': ['view_logs', 'filter_logs', 'export_logs', 'manage_viewers', 'reset_passwords'],
        'description': 'Gestione utenti viewer, visualizzazione ed export log'
    },
    'viewer': {
        'name': 'Visualizzatore',
        'permissions': ['view_logs', 'filter_logs'],
        'description': 'Solo visualizzazione e filtro log'
    }
}

USERS = {
    'admin': {
        'password': hashlib.sha256('admin123'.encode()).hexdigest(), 
        'role': 'admin'
    },
    'manager': {
        'password': hashlib.sha256('manager123'.encode()).hexdigest(), 
        'role': 'user_manager'
    },
    'viewer': {
        'password': hashlib.sha256('viewer123'.encode()).hexdigest(), 
        'role': 'viewer'
    }
}

def require_auth():
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            if 'username' not in session:
                return redirect('/login')
            return f(*args, **kwargs)
        return wrapper
    return decorator

def require_permission(*required_permissions):
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            if 'username' not in session:
                return redirect('/login')
            
            user_role = session.get('role', 'viewer')
            user_permissions = USER_ROLES.get(user_role, {}).get('permissions', [])
            
            if 'all' in user_permissions:
                return f(*args, **kwargs)
            
            if any(perm in user_permissions for perm in required_permissions):
                return f(*args, **kwargs)
            
            return jsonify({'error': 'Permessi insufficienti'}), 403
        return wrapper
    return decorator
```

---

## File: backup_module.py

**Percorso:** `api/backup_module.py`
**Directory:** `api`
**Dimensione:** 21662 bytes
**Ultima modifica:** 2025-07-21 06:47:29
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/backup_module.py
# Modulo gestione backup per dashboard web

from flask import jsonify, request, send_file, send_from_directory, abort, Blueprint

# Crea Blueprint per il modulo backup
backup_bp = Blueprint('backup', __name__, url_prefix='/api/backup')
import os
import shutil
import tarfile
import json
import subprocess
from datetime import datetime, timedelta
from pathlib import Path
import threading
import logging

# Configurazione
PROJECT_ROOT = Path("/opt/access_control")
BACKUP_DIR = PROJECT_ROOT / "backups"
BACKUP_CONFIG = BACKUP_DIR / "backup_config.json"

# Assicurati che la directory backup esista
BACKUP_DIR.mkdir(exist_ok=True)

# Configura logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Configurazione di default
DEFAULT_CONFIG = {
    'auto_backup': {
        'enabled': True,
        'daily': {
            'enabled': True,
            'time': '02:00'
        },
        'weekly': {
            'enabled': True,
            'time': '03:00',
            'day': '0'  # Domenica
        }
    },
    'retention': {
        'daily_keep': 7,    # Mantieni 7 giorni di backup giornalieri
        'weekly_keep': 4,   # Mantieni 4 settimane di backup settimanali
        'max_size_gb': 10   # Limite massimo spazio backup (GB)
    }
}

@backup_bp.route('/download/<filename>')
def download_backup(filename):
    """Download di un backup"""
    try:
        # Debug log esteso
        logging.info("=== DEBUG DOWNLOAD BACKUP ===")
        logging.info(f"Filename richiesto: {filename}")
        logging.info(f"Directory backup: {BACKUP_DIR}")
        logging.info(f"Directory backup esiste: {BACKUP_DIR.exists()}")
        logging.info(f"Directory backup è assoluta: {BACKUP_DIR.is_absolute()}")
        logging.info(f"Percorso assoluto directory: {BACKUP_DIR.resolve()}")
        logging.info(f"Contenuto directory:")
        for f in BACKUP_DIR.glob("*"):
            logging.info(f"- {f.name} ({f.stat().st_size} bytes)")
            if f.name == filename:
                logging.info(f"TROVATO FILE RICHIESTO!")
        
        # Lista contenuto directory
        if BACKUP_DIR.exists():
            logging.info("Contenuto directory backup:")
            for f in BACKUP_DIR.glob("*"):
                logging.info(f"- {f.name} ({f.stat().st_size} bytes)")
        
        # Sanitizza il filename
        from werkzeug.utils import secure_filename
        safe_filename = secure_filename(filename)
        logging.info(f"Filename sanitizzato: {safe_filename}")
        
        # Costruisci e verifica percorso file
        file_path = BACKUP_DIR.resolve() / filename  # Use original filename instead of sanitized
        logging.info(f"Percorso completo file: {file_path}")
        logging.info(f"Percorso file è assoluto: {file_path.is_absolute()}")
        logging.info(f"File esiste: {file_path.exists()}")
        
        # Verifica sicurezza percorso
        try:
            file_path.resolve().relative_to(BACKUP_DIR.resolve())
        except ValueError:
            logging.error("Tentativo di path traversal rilevato")
            abort(403)
        
        if not file_path.exists():
            logging.error(f"File non trovato: {file_path}")
            abort(404)
        
        if not file_path.is_file():
            logging.error(f"Il percorso non è un file: {file_path}")
            abort(404)
        
        # Crea response con headers appropriati
        from flask import make_response
        
        response = make_response(send_file(
            str(file_path),
            as_attachment=True,
            download_name=safe_filename,
            mimetype='application/x-gzip' if filename.endswith('.tar.gz') else 'application/octet-stream'
        ))
        
        # Imposta headers per gestire correttamente il download
        response.headers['Content-Disposition'] = f'attachment; filename="{safe_filename}"'
        response.headers['Access-Control-Allow-Origin'] = '*'
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
        response.headers['Pragma'] = 'no-cache'
        response.headers['Expires'] = '0'
        
        logging.info("Response preparata con successo")
        return response
        
    except Exception as e:
        logging.error(f"Errore download backup: {str(e)}")
        logging.exception("Traceback completo:")
        abort(500)

@backup_bp.route('/status')
def get_backup_status():
    """Stato generale backup"""
    try:
        backups = []
        total_size = 0
        
        # Backup completi
        for backup in sorted(BACKUP_DIR.glob("backup_completo_*.tar.gz"), reverse=True):
            stat = backup.stat()
            total_size += stat.st_size
            
            # Verifica checksum
            has_checksum = backup.with_suffix('.tar.gz.md5').exists()
            
            backups.append({
                'name': backup.name,
                'type': 'complete',
                'size': format_size(stat.st_size),
                'size_bytes': stat.st_size,
                'date': datetime.fromtimestamp(stat.st_mtime).isoformat(),
                'age_days': (datetime.now() - datetime.fromtimestamp(stat.st_mtime)).days,
                'has_checksum': has_checksum,
                'can_download': True,
                'can_restore': has_checksum
            })
        
        # Backup database
        for db_backup in sorted(BACKUP_DIR.glob("access_*.db"), reverse=True)[:10]:
            stat = db_backup.stat()
            total_size += stat.st_size
            
            backups.append({
                'name': db_backup.name,
                'type': 'database',
                'size': format_size(stat.st_size),
                'size_bytes': stat.st_size,
                'date': datetime.fromtimestamp(stat.st_mtime).isoformat(),
                'age_days': (datetime.now() - datetime.fromtimestamp(stat.st_mtime)).days,
                'has_checksum': False,
                'can_download': True,
                'can_restore': False
            })
        
        # Statistiche disco
        disk_stat = os.statvfs(BACKUP_DIR)
        disk_free = disk_stat.f_bavail * disk_stat.f_frsize
        disk_total = disk_stat.f_blocks * disk_stat.f_frsize
        
        return jsonify({
            'success': True,
            'backups': backups[:20],  # Ultimi 20
            'total_backups': len(list(BACKUP_DIR.glob("*"))),
            'total_size': format_size(total_size),
            'disk_free': format_size(disk_free),
            'disk_used_percent': round((1 - disk_free/disk_total) * 100, 1),
            'config': load_config(),
            'operations': backup_operations
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@backup_bp.route('/create', methods=['POST'])
def create_backup(backup_type='complete'):
    """Crea nuovo backup"""
    try:
        operation_id = f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        # Avvia backup in thread
        def run_backup():
            global backup_operations
            backup_operations[operation_id] = {
                'status': 'running',
                'type': backup_type,
                'progress': 0,
                'message': 'Inizializzazione...',
                'start_time': datetime.now().isoformat()
            }
            
            try:
                if backup_type == 'complete':
                    result = create_complete_backup(operation_id)
                elif backup_type == 'database':
                    result = create_db_backup(operation_id)
                else:
                    raise ValueError(f"Tipo backup non valido: {backup_type}")
                
                backup_operations[operation_id]['status'] = 'completed'
                backup_operations[operation_id]['result'] = result
                backup_operations[operation_id]['progress'] = 100
                
            except Exception as e:
                backup_operations[operation_id]['status'] = 'error'
                backup_operations[operation_id]['error'] = str(e)
                backup_operations[operation_id]['progress'] = 0
        
        thread = threading.Thread(target=run_backup)
        thread.daemon = True
        thread.start()
        
        return jsonify({
            'success': True,
            'operation_id': operation_id,
            'message': f'Backup {backup_type} avviato'
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

def create_complete_backup(operation_id):
    """Crea backup completo"""
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    backup_name = f"backup_completo_{timestamp}"
    temp_dir = BACKUP_DIR / backup_name
    
    try:
        # Update progress
        backup_operations[operation_id]['message'] = 'Creazione directory temporanea...'
        backup_operations[operation_id]['progress'] = 10
        
        temp_dir.mkdir(exist_ok=True)
        
        # Copia componenti
        components = [
            ("src", "Codice sorgente", 30),
            ("config", "Configurazioni", 20),
            ("scripts", "Scripts", 10),
            ("docs", "Documentazione", 10)
        ]
        
        for comp_name, desc, progress in components:
            backup_operations[operation_id]['message'] = f'Backup {desc}...'
            backup_operations[operation_id]['progress'] += progress
            
            source = PROJECT_ROOT / comp_name
            if source.exists():
                if source.is_file():
                    shutil.copy2(source, temp_dir / comp_name)
                else:
                    shutil.copytree(source, temp_dir / comp_name, 
                                  ignore=shutil.ignore_patterns('*.pyc', '__pycache__', '*.log'))
        
        # Database (se non troppo grande)
        db_path = PROJECT_ROOT / "src" / "access.db"
        if db_path.exists() and db_path.stat().st_size < 500 * 1024 * 1024:
            backup_operations[operation_id]['message'] = 'Backup database...'
            shutil.copy2(db_path, temp_dir / "access.db")
        
        # Crea archivio
        backup_operations[operation_id]['message'] = 'Creazione archivio...'
        backup_operations[operation_id]['progress'] = 90
        
        archive_path = BACKUP_DIR / f"{backup_name}.tar.gz"
        with tarfile.open(archive_path, "w:gz") as tar:
            tar.add(temp_dir, arcname=backup_name)
        
        # Calcola checksum
        import hashlib
        hash_md5 = hashlib.md5()
        with open(archive_path, "rb") as f:
            for chunk in iter(lambda: f.read(4096), b""):
                hash_md5.update(chunk)
        
        checksum = hash_md5.hexdigest()
        with open(archive_path.with_suffix('.tar.gz.md5'), 'w') as f:
            f.write(f"{checksum}  {archive_path.name}\n")
        
        # Cleanup
        shutil.rmtree(temp_dir)
        
        return {
            'filename': archive_path.name,
            'size': format_size(archive_path.stat().st_size),
            'checksum': checksum
        }
        
    except Exception as e:
        if temp_dir.exists():
            shutil.rmtree(temp_dir)
        raise

def create_db_backup(operation_id):
    """Crea backup solo database"""
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    backup_operations[operation_id]['message'] = 'Backup database...'
    backup_operations[operation_id]['progress'] = 50
    
    db_source = PROJECT_ROOT / "src" / "access.db"
    db_backup = BACKUP_DIR / f"access_{timestamp}.db"
    
    if db_source.exists():
        shutil.copy2(db_source, db_backup)
        
        # Link latest
        latest_link = BACKUP_DIR / "latest_database.db"
        if latest_link.exists():
            latest_link.unlink()
        latest_link.symlink_to(db_backup.name)
        
        return {
            'filename': db_backup.name,
            'size': format_size(db_backup.stat().st_size)
        }
    else:
        raise FileNotFoundError("Database non trovato")

def delete_backup(filename):
    """Elimina un backup"""
    try:
        # Sicurezza: verifica che sia nella directory backup
        file_path = BACKUP_DIR / filename
        if not file_path.exists():
            return jsonify({'success': False, 'error': 'File non trovato'})
        
        if not str(file_path).startswith(str(BACKUP_DIR)):
            return jsonify({'success': False, 'error': 'Percorso non valido'})
        
        # Elimina file principale
        file_path.unlink()
        
        # Elimina anche checksum se esiste
        checksum_file = file_path.with_suffix(file_path.suffix + '.md5')
        if checksum_file.exists():
            checksum_file.unlink()
        
        return jsonify({'success': True, 'message': f'Backup {filename} eliminato'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@backup_bp.route('/cleanup', methods=['POST'])
def cleanup_old_backups():
    """Pulizia backup vecchi secondo policy"""
    try:
        config = load_config()
        retention = config['retention']
        
        cleaned = []
        freed_space = 0
        
        # Backup giornalieri
        daily_backups = sorted([f for f in BACKUP_DIR.glob("access_*.db") 
                              if (datetime.now() - datetime.fromtimestamp(f.stat().st_mtime)).days <= retention['daily_keep']], 
                              key=lambda x: x.stat().st_mtime, reverse=True)
        
        for backup in daily_backups[retention['daily_keep']:]:
            freed_space += backup.stat().st_size
            backup.unlink()
            cleaned.append(backup.name)
        
        # Backup settimanali (backup completi più vecchi di 7 giorni)
        weekly_backups = sorted([f for f in BACKUP_DIR.glob("backup_completo_*.tar.gz")
                               if (datetime.now() - datetime.fromtimestamp(f.stat().st_mtime)).days > 7],
                               key=lambda x: x.stat().st_mtime, reverse=True)
        
        # Mantieni solo uno per settimana
        weeks_kept = set()
        for backup in weekly_backups:
            backup_date = datetime.fromtimestamp(backup.stat().st_mtime)
            week_key = backup_date.strftime("%Y-%W")
            
            if week_key in weeks_kept or len(weeks_kept) >= retention['weekly_keep']:
                freed_space += backup.stat().st_size
                backup.unlink()
                # Elimina anche checksum
                checksum = backup.with_suffix('.tar.gz.md5')
                if checksum.exists():
                    checksum.unlink()
                cleaned.append(backup.name)
            else:
                weeks_kept.add(week_key)
        
        # Controllo spazio totale
        total_size = sum(f.stat().st_size for f in BACKUP_DIR.rglob("*") if f.is_file())
        max_size = retention['max_size_gb'] * 1024 * 1024 * 1024
        
        if total_size > max_size:
            # Elimina i più vecchi fino a rientrare nel limite
            all_backups = sorted(BACKUP_DIR.glob("*"), key=lambda x: x.stat().st_mtime)
            
            for backup in all_backups:
                if total_size <= max_size:
                    break
                if backup.is_file():
                    size = backup.stat().st_size
                    freed_space += size
                    total_size -= size
                    backup.unlink()
                    cleaned.append(backup.name)
        
        return jsonify({
            'success': True,
            'cleaned_files': len(cleaned),
            'freed_space': format_size(freed_space),
            'files': cleaned[:10]  # Mostra solo primi 10
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@backup_bp.route('/config', methods=['POST'])
def update_config():
    new_config = request.get_json()
    """Aggiorna configurazione backup"""
    try:
        # Valida configurazione
        if not isinstance(new_config, dict):
            return jsonify({'success': False, 'error': 'Configurazione non valida'})
        
        # Salva
        save_config(new_config)
        
        # Aggiorna crontab se necessario
        update_crontab(new_config)
        
        return jsonify({'success': True, 'message': 'Configurazione aggiornata'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

def update_crontab(config):
    """Aggiorna crontab per backup automatici"""
    try:
        cron_entries = []
        
        if config['auto_backup']['enabled']:
            # Backup giornaliero
            if config['auto_backup']['daily']['enabled']:
                time = config['auto_backup']['daily']['time']
                hour, minute = time.split(':')
                cron_entries.append(
                    f"{minute} {hour} * * * cd /opt/access_control && /usr/bin/python3 scripts/quick_backup.sh"
                )
            
            # Backup settimanale
            if config['auto_backup']['weekly']['enabled']:
                time = config['auto_backup']['weekly']['time']
                hour, minute = time.split(':')
                day = config['auto_backup']['weekly']['day']
                cron_entries.append(
                    f"{minute} {hour} * * {day} cd /opt/access_control && /usr/bin/python3 scripts/backup_project.py"
                )
        
        # Leggi crontab esistente
        result = subprocess.run(['crontab', '-l'], capture_output=True, text=True)
        existing_cron = result.stdout if result.returncode == 0 else ""
        
        # Rimuovi vecchie entry di backup
        new_cron_lines = []
        for line in existing_cron.split('\n'):
            if 'access_control' not in line or 'backup' not in line:
                new_cron_lines.append(line)
        
        # Aggiungi nuove entry
        new_cron_lines.extend(cron_entries)
        
        # Scrivi nuovo crontab
        new_cron = '\n'.join(new_cron_lines)
        process = subprocess.Popen(['crontab', '-'], stdin=subprocess.PIPE)
        process.communicate(new_cron.encode())
        
        return True
        
    except Exception as e:
        raise

def restore_backup(filename):
    """Ripristina un backup"""
    try:
        file_path = BACKUP_DIR / filename
        
        if not file_path.exists():
            return jsonify({'success': False, 'error': 'Backup non trovato'})
        
        if not filename.endswith('.tar.gz'):
            return jsonify({'success': False, 'error': 'Solo backup completi possono essere ripristinati'})
        
        # Verifica checksum
        checksum_file = file_path.with_suffix('.tar.gz.md5')
        if checksum_file.exists():
            import hashlib
            hash_md5 = hashlib.md5()
            with open(file_path, "rb") as f:
                for chunk in iter(lambda: f.read(4096), b""):
                    hash_md5.update(chunk)
            
            actual_checksum = hash_md5.hexdigest()
            expected_checksum = checksum_file.read_text().split()[0]
            
            if actual_checksum != expected_checksum:
                return jsonify({'success': False, 'error': 'Checksum non valido - backup corrotto'})
        
        # Crea backup dell'attuale prima di ripristinare
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        backup_current = PROJECT_ROOT.parent / f"access_control_before_restore_{timestamp}"
        shutil.copytree(PROJECT_ROOT, backup_current, 
                       ignore=shutil.ignore_patterns('*.pyc', '__pycache__', '*.log', 'venv'))
        
        # Estrai backup
        temp_restore = PROJECT_ROOT.parent / "restore_temp"
        if temp_restore.exists():
            shutil.rmtree(temp_restore)
        
        with tarfile.open(file_path, "r:gz") as tar:
            tar.extractall(temp_restore)
        
        # Trova directory estratta
        extracted = list(temp_restore.iterdir())[0]
        
        # Sovrascrivi file
        for item in extracted.iterdir():
            dest = PROJECT_ROOT / item.name
            if dest.exists():
                if dest.is_dir():
                    shutil.rmtree(dest)
                else:
                    dest.unlink()
            shutil.move(str(item), str(dest))
        
        # Cleanup
        shutil.rmtree(temp_restore)
        
        return jsonify({
            'success': True,
            'message': f'Backup ripristinato. Backup precedente salvato in: {backup_current.name}'
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

def load_config():
    """Carica configurazione backup"""
    if BACKUP_CONFIG.exists():
        try:
            with open(BACKUP_CONFIG, 'r') as f:
                return json.load(f)
        except:
            pass
    
    # Crea config default
    BACKUP_DIR.mkdir(exist_ok=True)
    with open(BACKUP_CONFIG, 'w') as f:
        json.dump(DEFAULT_CONFIG, f, indent=2)
    
    return DEFAULT_CONFIG

def save_config(config):
    """Salva configurazione backup"""
    with open(BACKUP_CONFIG, 'w') as f:
        json.dump(config, f, indent=2)

def format_size(bytes):
    """Formatta dimensione file"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if bytes < 1024.0:
            return f"{bytes:.2f} {unit}"
        bytes /= 1024.0
    return f"{bytes:.2f} TB"

# Stato globale operazioni
backup_operations = {}

```

---

## File: dashboard_templates.py

**Percorso:** `api/dashboard_templates.py`
**Directory:** `api`
**Dimensione:** 54462 bytes
**Ultima modifica:** 2025-07-23 10:49:11
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/dashboard_templates.py
# Template HTML per dashboard web


LOGIN_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Sistema Controllo Accessi - Login</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .login-container { max-width: 400px; margin: 0 auto; padding-top: 100px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .role-info { 
            background: #f8f9fa; 
            border-radius: 10px; 
            padding: 15px; 
            margin-top: 20px;
        }
        .role-badge { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8rem;
            font-weight: bold;
        }
        .role-admin { background: #dc3545; color: white; }
        .role-manager { background: #0d6efd; color: white; }
        .role-viewer { background: #198754; color: white; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="card">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                    <h4>Sistema Controllo Accessi</h4>
                    <p class="text-muted">Isola Ecologica RAEE - Rende</p>
                </div>
                
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt me-2"></i>Accedi
                    </button>
                </form>
                
                <div class="role-info">
                    <h6 class="text-center mb-3">Livelli di Accesso</h6>
                    <div class="mb-2">
                        <span class="role-badge role-admin">Admin</span>
                        <small>admin/admin123</small>
                        <br><small class="text-muted">Accesso completo</small>
                    </div>
                    <div class="mb-2">
                        <span class="role-badge role-manager">Manager</span>
                        <small>manager/manager123</small>
                        <br><small class="text-muted">Gestione viewer + log</small>
                    </div>
                    <div>
                        <span class="role-badge role-viewer">Viewer</span>
                        <small>viewer/viewer123</small>
                        <br><small class="text-muted">Solo visualizzazione</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
"""

# Importa dashboard template da file separato per evitare file troppo grande
def get_dashboard_template():
    """Carica il template dashboard con supporto per 3 livelli"""
    template = """
<!DOCTYPE html>
<html>
<head>
    <title>Sistema Controllo Accessi - Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-shield-alt me-2"></i>
                <span class="navbar-brand mb-0 h1">Sistema Controllo Accessi</span>
            </div>
            <div class="system-clock mx-auto">
                <i class="fas fa-clock"></i>
                <span class="clock-time"></span>
                <span class="clock-date"></span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="navbar-text me-3">Isola Ecologica RAEE - Rende</span>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistiche - Visibili a tutti -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-primary mb-3"></i>
                        <div class="stat-number text-primary" id="accessi-oggi">-</div>
                        <h6 class="text-muted">Accessi Oggi</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                        <div class="stat-number text-success" id="autorizzati">-</div>
                        <h6 class="text-muted">Autorizzati</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x text-info mb-3"></i>
                        <div class="stat-number text-info" id="utenti-totali">-</div>
                        <h6 class="text-muted">Utenti Totali</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Admin - Solo per amministratori -->
        {% if session.role == 'admin' %}
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card hardware-card">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-crown me-2"></i>Controlli Amministratore</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-primary w-100" onclick="testReader()">
                                    <i class="fas fa-credit-card"></i><br><small>Test Lettore</small>
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-warning w-100" onclick="testRelay()">
                                    <i class="fas fa-microchip"></i><br><small>Test USB-RLY08</small>
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-success w-100" onclick="testGate()">
                                    <i class="fas fa-door-open"></i><br><small>Test Cancello</small>
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <button class="btn btn-info w-100" onclick="testIntegrated()">
                                    <i class="fas fa-id-card me-2"></i>Test Completo Sistema
                                </button>
                            </div>
                        </div>
                        <div id="hardware-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-cogs me-2"></i>Gestione Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <!-- Menu items dinamici -->
                            {% for item in menu_items %}
                            <a href="{{ item.url }}" class="btn btn-outline-primary">
                                <i class="{{ item.icon }}"></i> {{ item.text }}
                            </a>
                            {% endfor %}
                            
                            <!-- Menu items fissi -->
                            <a href="/admin/config" class="btn btn-outline-primary">
                                <i class="fas fa-sliders-h"></i> Configurazioni Sistema
                            </a>
                            <a href="/admin/backup" class="btn btn-outline-success">
                                <i class="fas fa-database"></i> Backup & Restore
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sezione User Manager -->
        {% if session.role == 'user_manager' %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-user-tie me-2"></i>Pannello Gestore Utenti</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="showCreateViewerModal()">
                                    <i class="fas fa-user-plus fa-2x"></i>
                                    <br>Crea Utente Viewer
                                </button>
                            </div>
                            <div class="col-md-4">
                                <a href="/manage-viewers" class="btn btn-info w-100">
                                    <i class="fas fa-users fa-2x"></i>
                                    <br>Gestisci Viewers
                                </a>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success w-100" onclick="openExportModal()">
                                    <i class="fas fa-file-excel fa-2x"></i>
                                    <br>Esporta Log Excel
                                </button>
                            </div>
                        </div>
                        <hr>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Come <strong>Gestore Utenti</strong> puoi:
                            <ul class="mb-0">
                                <li>Creare e gestire utenti Visualizzatori</li>
                                <li>Resettare password per i Visualizzatori</li>
                                <li>Visualizzare, filtrare ed esportare log in Excel</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Sezione Viewer -->
        {% if session.role == 'viewer' %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-eye me-2"></i>Pannello Visualizzatore</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <i class="fas fa-info-circle"></i>
                            Come <strong>Visualizzatore</strong> puoi consultare i log di accesso e filtrarli per data.
                        </div>
                        <a href="/logs" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-list-alt fa-2x"></i>
                            <br>Visualizza Log Accessi
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Log Recenti - Visibile a tutti -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Ultimi Accessi</h5>
                    </div>
                    <div class="card-body" id="recent-accesses">
                        <div class="text-center text-muted">Caricamento...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include modals -->
    <div id="modals-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
    <script>
        // Passa il ruolo utente a JavaScript
        window.userRole = '{{ session.role }}';
        
        // Carica modals solo per admin
        if (window.userRole === 'admin') {
            fetch('/static/html/modals.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('modals-container').innerHTML = html;
                    initializeModalListeners();
                });
        }
        
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
    </script>
</body>
</html>
"""
    return template


# Template per Gestione Utenti Admin
ADMIN_USERS_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Gestione Utenti - Sistema Controllo Accessi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-users-cog me-2"></i>
                <span class="navbar-brand mb-0 h1">Gestione Utenti Sistema</span>
            </div>
            <div class="system-clock mx-auto">
                <i class="fas fa-clock"></i>
                <span class="clock-time"></span>
                <span class="clock-date"></span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistiche Utenti -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-crown fa-2x text-danger mb-3"></i>
                        <div class="stat-number text-danger" id="admin-count">1</div>
                        <h6 class="text-muted">Amministratori</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-user-tie fa-2x text-primary mb-3"></i>
                        <div class="stat-number text-primary" id="manager-count">1</div>
                        <h6 class="text-muted">Gestori Utenti</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-eye fa-2x text-success mb-3"></i>
                        <div class="stat-number text-success" id="viewer-count">1</div>
                        <h6 class="text-muted">Visualizzatori</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x text-info mb-3"></i>
                        <div class="stat-number text-info" id="total-users">3</div>
                        <h6 class="text-muted">Totale</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestione Utenti -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Lista Utenti Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Ruolo</th>
                                        <th>Info Creazione</th>
                                        <th>Ultimo Accesso</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <!-- Popolato dinamicamente da users.js -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user-plus me-2"></i>Nuovo Utente</h5>
                    </div>
                    <div class="card-body">
                        <form id="create-user-form">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="new-username" placeholder="Username nuovo utente" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" id="new-password" placeholder="Password sicura" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ruolo</label>
                                <select class="form-select" id="new-role">
                                    <option value="admin">👑 Amministratore</option>
                                    <option value="user_manager">👔 Gestore Utenti</option>
                                    <option value="viewer" selected>👁️ Visualizzatore</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-plus"></i> Crea Utente
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-line me-2"></i>Attività Recente</h6>
                    </div>
                    <div class="card-body">
                        <div id="recent-activities">
                            <div class="text-center text-muted">
                                <small>Caricamento attività...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
    <script src="/static/js/users.js"></script>
    <script src="/static/js/recent-activities.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
    </script>
</body>
</html>
"""

# Template per Configurazioni Sistema  
ADMIN_CONFIG_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Configurazioni Sistema - Sistema Controllo Accessi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-sliders-h me-2"></i>
                <span class="navbar-brand mb-0 h1">Configurazioni Sistema</span>
            </div>
            <div class="system-clock mx-auto">
                <i class="fas fa-clock"></i>
                <span class="clock-time"></span>
                <span class="clock-date"></span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Stato Sistema -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-server fa-2x text-success mb-3"></i>
                        <div class="stat-number text-success">Online</div>
                        <h6 class="text-muted">Stato Sistema</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-code-branch fa-2x text-info mb-3"></i>
                        <div class="stat-number text-info">v1.0.0</div>
                        <h6 class="text-muted">Versione</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                        <div class="stat-number text-warning">24h</div>
                        <h6 class="text-muted">Uptime</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-memory fa-2x text-primary mb-3"></i>
                        <div class="stat-number text-primary">45%</div>
                        <h6 class="text-muted">RAM Utilizzata</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#sistema">
                    <i class="fas fa-cog"></i> Sistema
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#hardware">
                    <i class="fas fa-microchip"></i> Hardware
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#sicurezza">
                    <i class="fas fa-shield-alt"></i> Sicurezza
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#email">
                    <i class="fas fa-envelope"></i> Email
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3">
            <!-- Sistema -->
            <div class="tab-pane fade show active" id="sistema">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-server me-2"></i>Configurazioni Sistema</h5>
                    </div>
                    <div class="card-body">
                        <form id="sistema-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Nome Installazione</label>
                                        <input type="text" class="form-control" id="nome-installazione" value="Isola Ecologica RAEE - Rende">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Porta Web</label>
                                        <input type="number" class="form-control" id="porta-web" value="5000">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <input type="checkbox" id="debug-mode"> Modalità Debug
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Timeout Sessione (secondi)</label>
                                        <input type="number" class="form-control" id="timeout-sessione" value="1800">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ambiente</label>
                                        <select class="form-select" id="ambiente">
                                            <option value="production" selected>Produzione</option>
                                            <option value="development">Sviluppo</option>
                                            <option value="testing">Test</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Sistema
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Hardware -->
            <div class="tab-pane fade" id="hardware">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-search me-2"></i>Rilevamento Automatico Hardware</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button id="detect-hardware" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Rileva Hardware Collegato
                                </button>
                                <button class="btn btn-info ms-2" data-bs-toggle="collapse" data-bs-target="#hardware-info">
                                    <i class="fas fa-info-circle me-2"></i>Informazioni
                                </button>
                            </div>
                        </div>
                        
                        <div class="collapse mb-3" id="hardware-info">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Informazioni sul Rilevamento Hardware</h6>
                                <p>Il sistema può rilevare automaticamente qualsiasi tipo di hardware collegato, inclusi:</p>
                                <ul>
                                    <li><strong>Lettori Tessere:</strong> Qualsiasi lettore RFID/NFC USB o seriale</li>
                                    <li><strong>Controller Relè:</strong> Qualsiasi controller relè USB o seriale</li>
                                    <li><strong>Porte Seriali:</strong> Tutte le porte seriali disponibili nel sistema</li>
                                    <li><strong>Dispositivi USB:</strong> Tutti i dispositivi USB collegati</li>
                                    <li><strong>Altri Dispositivi:</strong> Hardware generico rilevabile dal sistema</li>
                                </ul>
                                <p>Assicurati che i dispositivi siano collegati prima di avviare il rilevamento. Il sistema mostrerà tutte le porte disponibili e ti aiuterà a identificare il tipo di dispositivo collegato.</p>
                            </div>
                        </div>
                        
                        <div id="hardware-status"></div>
                        <div id="hardware-list" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-microchip me-2"></i>Configurazioni Hardware</h5>
                    </div>
                    <div class="card-body">
                        <form id="hardware-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Lettore Tessere</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Tipo Lettore</label>
                                        <select class="form-select" id="reader-type">
                                            <option value="HID Omnikey 5427CK" selected>HID Omnikey 5427CK</option>
                                            <option value="HID Omnikey 5321">HID Omnikey 5321</option>
                                            <option value="Generic RFID Reader">Lettore RFID Generico</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Porta Lettore</label>
                                        <select class="form-select" id="reader-port">
                                            <option value="/dev/ttyACM0" selected>/dev/ttyACM0</option>
                                            <option value="/dev/ttyACM1">/dev/ttyACM1</option>
                                            <option value="/dev/ttyUSB0">/dev/ttyUSB0</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" id="test-reader" class="btn btn-info">
                                            <i class="fas fa-vial me-2"></i>Test Lettore
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Controller USB-RLY08</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Porta Relè</label>
                                        <select class="form-select" id="relay-port">
                                            <option value="/dev/ttyUSB0" selected>/dev/ttyUSB0</option>
                                            <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
                                            <option value="/dev/ttyACM0">/dev/ttyACM0</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Baud Rate</label>
                                        <select class="form-select" id="relay-baudrate">
                                            <option value="9600">9600</option>
                                            <option value="19200" selected>19200</option>
                                            <option value="38400">38400</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Durata Apertura Cancello (sec)</label>
                                        <input type="number" class="form-control" id="gate-duration" value="8" min="1" max="30">
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" id="test-relay" class="btn btn-info">
                                            <i class="fas fa-vial me-2"></i>Test Relè
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Hardware
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sicurezza -->
            <div class="tab-pane fade" id="sicurezza">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-shield-alt me-2"></i>Configurazioni Sicurezza</h5>
                    </div>
                    <div class="card-body">
                        <form id="sicurezza-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Max Tentativi Login</label>
                                        <input type="number" class="form-control" id="max-tentativi" value="5" min="3" max="10">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Durata Blocco (minuti)</label>
                                        <input type="number" class="form-control" id="durata-blocco" value="15" min="5" max="60">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Rotazione Password (giorni)</label>
                                        <input type="number" class="form-control" id="rotazione-password" value="90" min="30" max="365">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <input type="checkbox" id="log-audit" checked> Log Audit Abilitato
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Sicurezza
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Email -->
            <div class="tab-pane fade" id="email">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope me-2"></i>Configurazioni Email</h5>
                    </div>
                    <div class="card-body">
                        <form id="email-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Server SMTP</label>
                                        <input type="text" class="form-control" id="smtp-server" placeholder="smtp.gmail.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Porta SMTP</label>
                                        <select class="form-select" id="smtp-porta">
                                            <option value="25">25 (SMTP)</option>
                                            <option value="587" selected>587 (SMTP TLS)</option>
                                            <option value="465">465 (SMTP SSL)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Email Mittente</label>
                                        <input type="email" class="form-control" id="email-mittente" placeholder="isola@comune.rende.cs.it">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <input type="checkbox" id="report-automatici"> Report Automatici
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Frequenza Report</label>
                                        <select class="form-select" id="frequenza-report">
                                            <option value="daily">Giornaliero</option>
                                            <option value="weekly" selected>Settimanale</option>
                                            <option value="monthly">Mensile</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salva Configurazioni Email
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Azioni Sistema -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Azioni Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" onclick="restartSystem()">
                                    <i class="fas fa-redo"></i> Riavvia Sistema
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-info w-100" onclick="exportConfig()">
                                    <i class="fas fa-download"></i> Esporta Configurazioni
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-secondary w-100" onclick="resetToDefaults()">
                                    <i class="fas fa-undo"></i> Ripristina Default
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
    <script src="/static/js/sistema.js"></script>
    <script src="/static/js/hardware-manager.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
        
        // Form handlers
        document.getElementById('sistema-form').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Configurazioni sistema salvate!\\n\\nFunzionalità completa in sviluppo.');
        });
        
        function restartSystem() {
            if (confirm('Sei sicuro di voler riavviare il sistema?\\n\\nTutte le sessioni attive verranno terminate.')) {
                alert('Sistema in riavvio...\\n\\nRicarica la pagina tra 30 secondi.');
            }
        }
        
        function exportConfig() {
            alert('Export configurazioni in formato JSON...\\n\\nFunzionalità in sviluppo.');
        }
        
        function resetToDefaults() {
            if (confirm('Ripristinare tutte le configurazioni ai valori default?\\n\\nQuesta operazione non può essere annullata.')) {
                alert('Configurazioni ripristinate ai valori default.');
            }
        }
    </script>
</body>
</html>
"""

# Template per Backup & Restore
ADMIN_BACKUP_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Backup & Restore - Sistema Controllo Accessi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-database me-2"></i>
                <span class="navbar-brand mb-0 h1">Backup & Restore Sistema</span>
            </div>
            <div class="system-clock mx-auto">
                <i class="fas fa-clock"></i>
                <span class="clock-time"></span>
                <span class="clock-date"></span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistiche Backup -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card" id="backup-total">
                    <div class="card-body text-center">
                        <i class="fas fa-archive fa-2x text-primary mb-3"></i>
                        <div class="stat-number text-primary">-</div>
                        <h6 class="text-muted">Backup Totali</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card" id="backup-size">
                    <div class="card-body text-center">
                        <i class="fas fa-hdd fa-2x text-success mb-3"></i>
                        <div class="stat-number text-success">-</div>
                        <h6 class="text-muted">Spazio Utilizzato</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                        <div class="stat-number text-warning">2h fa</div>
                        <h6 class="text-muted">Ultimo Backup</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card" id="disk-usage">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-pie fa-2x text-info mb-3"></i>
                        <div class="stat-number text-info">-</div>
                        <h6 class="text-muted">Disco Utilizzato</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Azioni Backup -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plus-circle me-2"></i>Crea Nuovo Backup</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100 mb-2" onclick="createBackup('complete')">
                                    <i class="fas fa-archive fa-2x"></i><br>Backup Completo
                                    <small class="d-block">Sistema + Database + Config</small>
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-success w-100 mb-2" onclick="createBackup('database')">
                                    <i class="fas fa-database fa-2x"></i><br>Solo Database
                                    <small class="d-block">Backup rapido DB</small>
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-warning w-100" onclick="cleanupBackups()">
                            <i class="fas fa-broom"></i> Pulizia Backup Vecchi
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog me-2"></i>Configurazione Automatica</h5>
                    </div>
                    <div class="card-body">
                        <form onsubmit="event.preventDefault(); saveBackupConfig();">
                            <div class="mb-3">
                                <label class="form-label">
                                    <input type="checkbox" id="auto-backup"> Backup Automatici
                                </label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Frequenza</label>
                                <select class="form-select" id="backup-frequency">
                                    <option value="daily">Giornaliero</option>
                                    <option value="weekly" selected>Settimanale</option>
                                    <option value="monthly">Mensile</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mantieni per (giorni)</label>
                                <select class="form-select" id="retention-days">
                                    <option value="7">7 giorni</option>
                                    <option value="30" selected>30 giorni</option>
                                    <option value="90">90 giorni</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-save"></i> Salva Configurazione
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista Backup -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Lista Backup Disponibili</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="backup-list">
                                <thead>
                                    <tr>
                                        <th>Nome File</th>
                                        <th>Tipo</th>
                                        <th>Dimensione</th>
                                        <th>Data Creazione</th>
                                        <th>Età</th>
                                        <th>Checksum</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Caricamento...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
    <script src="/static/js/backup.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
    </script>
</body>
</html>
"""

```

---

## File: hardware_detection.py

**Percorso:** `api/hardware_detection.py`
**Directory:** `api`
**Dimensione:** 11611 bytes
**Ultima modifica:** 2025-07-24 11:54:21
**Permessi:** 664

### Contenuto:

```python
# File: /opt/access_control/src/api/hardware_detection.py
# Rilevamento hardware SEMPLICE con comandi Linux standard

import subprocess
import re
import json
import logging
from typing import Dict, List, Any

logger = logging.getLogger(__name__)

def get_hardware_info() -> Dict[str, Any]:
    """
    Rilevamento hardware semplice: solo comandi Linux standard
    
    Returns:
        Dict: Hardware rilevato + porte seriali
    """
    try:
        # PARTE 1: Dispositivi USB (lsusb)
        usb_devices = get_usb_devices()
        
        # PARTE 2: Porte seriali (ls /dev/tty*)
        serial_ports = get_serial_ports()
        
        # PARTE 3: Dispositivi HID (/dev/hidraw*)
        hid_devices = get_hid_devices()
        
        return {
            'success': True,
            'usb_devices': usb_devices,
            'serial_ports': serial_ports,
            'hid_devices': hid_devices,
            'total_devices': len(usb_devices),
            'message': f"Rilevati {len(usb_devices)} dispositivi USB, {len(serial_ports)} porte seriali, {len(hid_devices)} dispositivi HID"
        }
    
    except Exception as e:
        logger.error(f"Errore rilevamento: {str(e)}")
        return {
            'success': False,
            'error': str(e),
            'usb_devices': [],
            'serial_ports': [],
            'hid_devices': []
        }

def get_usb_devices() -> List[Dict[str, Any]]:
    """Esegue lsusb e restituisce tutti i dispositivi"""
    devices = []
    
    try:
        # lsusb base
        result = subprocess.run(['lsusb'], 
                               stdout=subprocess.PIPE, 
                               stderr=subprocess.PIPE,
                               text=True, timeout=10)
        
        if result.returncode != 0:
            return devices
        
        for line in result.stdout.splitlines():
            # Parse: Bus 001 Device 003: ID 23d8:0285 CREATOR(CHINA)TECH CO.,LTD CRT-285
            match = re.match(r'Bus (\d+) Device (\d+): ID ([0-9a-f]{4}):([0-9a-f]{4}) (.*)', line)
            if match:
                bus, device, vendor_id, product_id, description = match.groups()
                
                # Filtra dispositivi di sistema
                if is_system_device(description):
                    continue
                
                devices.append({
                    'bus': bus,
                    'device': device,
                    'vendor_id': f"0x{vendor_id}",
                    'product_id': f"0x{product_id}", 
                    'description': description.strip(),
                    'raw_line': line.strip(),
                    'device_id': f"{vendor_id}:{product_id}"
                })
        
        return devices
    
    except Exception as e:
        logger.error(f"Errore lsusb: {str(e)}")
        return devices

def get_serial_ports() -> List[Dict[str, Any]]:
    """Trova tutte le porte seriali con ls /dev/tty*"""
    ports = []
    
    try:
        # Lista porte ttyUSB* e ttyACM*
        for pattern in ['/dev/ttyUSB*', '/dev/ttyACM*']:
            result = subprocess.run(f'ls {pattern} 2>/dev/null || true', 
                                  stdout=subprocess.PIPE, 
                                  text=True, shell=True, timeout=5)
            
            for port_path in result.stdout.strip().split():
                if port_path and port_path.startswith('/dev/tty'):
                    # Test se porta è accessibile
                    accessible = test_port_access(port_path)
                    
                    ports.append({
                        'port': port_path,
                        'accessible': accessible,
                        'type': get_port_type(port_path)
                    })
        
        return ports
    
    except Exception as e:
        logger.error(f"Errore porte seriali: {str(e)}")
        return ports

def get_hid_devices() -> List[Dict[str, Any]]:
    """Trova dispositivi HID con ls /dev/hidraw*"""
    devices = []
    
    try:
        result = subprocess.run('ls /dev/hidraw* 2>/dev/null || true', 
                              stdout=subprocess.PIPE, 
                              text=True, shell=True, timeout=5)
        
        for hidraw_path in result.stdout.strip().split():
            if hidraw_path and hidraw_path.startswith('/dev/hidraw'):
                devices.append({
                    'device': hidraw_path,
                    'accessible': True,  # Assumiamo accessibile
                    'type': 'HID'
                })
        
        return devices
    
    except Exception as e:
        logger.error(f"Errore dispositivi HID: {str(e)}")
        return devices

def is_system_device(description: str) -> bool:
    """Filtra dispositivi di sistema"""
    system_terms = [
        'linux foundation', 'root hub', 'host controller', 
        'hub', 'bluetooth', 'wireless', 'xhci', 'ehci'
    ]
    desc_lower = description.lower()
    return any(term in desc_lower for term in system_terms)

def test_port_access(port_path: str) -> bool:
    """Testa se porta è accessibile"""
    try:
        result = subprocess.run(['stty', '-F', port_path, 'size'], 
                              stdout=subprocess.PIPE, 
                              stderr=subprocess.PIPE,
                              timeout=2)
        return result.returncode == 0
    except:
        return False

def get_port_type(port_path: str) -> str:
    """Determina tipo porta dal nome"""
    if 'ttyUSB' in port_path:
        return 'USB-Serial'
    elif 'ttyACM' in port_path:
        return 'USB-CDC'
    else:
        return 'Serial'

# PARTE 2: CONFIGURAZIONE DISPOSITIVI
def load_device_assignments() -> Dict[str, Any]:
    """Carica assegnazioni dispositivi salvate"""
    try:
        # Prova a leggere file di configurazione
        config_file = '/opt/access_control/config/device_assignments.json'
        try:
            with open(config_file, 'r') as f:
                return json.load(f)
        except FileNotFoundError:
            # Configurazione di default
            return {
                'card_reader': {
                    'device_id': None,
                    'device_path': None,
                    'device_type': 'auto'
                },
                'relay_controller': {
                    'device_id': None, 
                    'device_path': None,
                    'device_type': 'auto'
                },
                'assignments': {}
            }
    except Exception as e:
        logger.error(f"Errore caricamento configurazione: {str(e)}")
        return {'card_reader': {}, 'relay_controller': {}, 'assignments': {}}

def save_device_assignments(assignments: Dict[str, Any]) -> Dict[str, Any]:
    """Salva assegnazioni dispositivi"""
    try:
        import os
        config_dir = '/opt/access_control/config'
        os.makedirs(config_dir, exist_ok=True)
        
        config_file = f'{config_dir}/device_assignments.json'
        with open(config_file, 'w') as f:
            json.dump(assignments, f, indent=2)
        
        return {'success': True, 'message': 'Configurazione salvata'}
    
    except Exception as e:
        logger.error(f"Errore salvataggio configurazione: {str(e)}")
        return {'success': False, 'error': str(e)}

def test_device_connection(device_info: Dict[str, Any]) -> Dict[str, Any]:
    """Testa connessione a dispositivo specifico"""
    try:
        device_id = device_info.get('device_id')
        device_path = device_info.get('device_path')
        device_type = device_info.get('assigned_function')
        
        result = {
            'device_id': device_id,
            'device_path': device_path,
            'device_type': device_type,
            'tests': []
        }
        
        # Test base: verifica se dispositivo esiste
        if device_path and device_path.startswith('/dev/'):
            import os
            exists = os.path.exists(device_path)
            result['tests'].append({
                'test': 'device_exists',
                'success': exists,
                'message': f"Dispositivo {device_path} {'trovato' if exists else 'non trovato'}"
            })
            
            if exists:
                # Test accesso
                accessible = test_port_access(device_path)
                result['tests'].append({
                    'test': 'device_access',
                    'success': accessible,
                    'message': f"Dispositivo {device_path} {'accessibile' if accessible else 'non accessibile'}"
                })
        
        # Test specifici per tipo dispositivo
        if device_type == 'card_reader':
            # Test lettore tessere
            pcsc_test = test_pcsc_reader()
            result['tests'].append({
                'test': 'pcsc_service',
                'success': pcsc_test,
                'message': f"Servizio PC/SC {'disponibile' if pcsc_test else 'non disponibile'}"
            })
        
        elif device_type == 'relay_controller':
            # Test controller relè
            if device_path:
                relay_test = test_relay_communication(device_path)
                result['tests'].append({
                    'test': 'relay_communication',
                    'success': relay_test,
                    'message': f"Comunicazione relè {'OK' if relay_test else 'fallita'}"
                })
        
        # Determina successo complessivo
        result['success'] = len(result['tests']) > 0 and all(t['success'] for t in result['tests'])
        result['message'] = 'Test completato con successo' if result['success'] else 'Alcuni test sono falliti'
        
        return result
    
    except Exception as e:
        return {
            'success': False,
            'error': str(e),
            'message': f'Errore durante test: {str(e)}'
        }

def test_pcsc_reader() -> bool:
    """Test rapido servizio PC/SC"""
    try:
        result = subprocess.run(['pcsc_scan', '-n'], 
                              stdout=subprocess.PIPE, 
                              stderr=subprocess.PIPE,
                              timeout=5)
        return result.returncode == 0
    except:
        return False

def test_relay_communication(device_path: str) -> bool:
    """Test comunicazione controller relè"""
    try:
        # Configura porta per comunicazione
        result = subprocess.run(['stty', '-F', device_path, '19200', 'cs8', '-parenb'], 
                              stdout=subprocess.PIPE, 
                              stderr=subprocess.PIPE,
                              timeout=5)
        return result.returncode == 0
    except:
        return False

# Funzioni di compatibilità per API esistente
def detect_hardware() -> Dict[str, Any]:
    """Funzione principale per API"""
    return get_hardware_info()

def load_hardware_config(get_db_connection) -> Dict[str, Any]:
    """Carica configurazione dispositivi"""
    assignments = load_device_assignments()
    return {
        'success': True,
        'config': assignments
    }

def save_hardware_config(config_data: Dict[str, Any], get_db_connection) -> Dict[str, Any]:
    """Salva configurazione dispositivi"""
    return save_device_assignments(config_data)

def test_hardware_connection(hardware_type: str, device_path: str, **kwargs) -> Dict[str, Any]:
    """Test connessione hardware"""
    device_info = {
        'device_path': device_path,
        'assigned_function': hardware_type,
        'device_id': kwargs.get('device_id', 'unknown')
    }
    return test_device_connection(device_info)
```

---

## File: hardware_detection.py.backup

**Percorso:** `api/hardware_detection.py.backup`
**Directory:** `api`
**Dimensione:** 30312 bytes
**Ultima modifica:** 2025-07-24 11:09:36
**Permessi:** 664

### Contenuto:

```text
# File: /opt/access_control/src/api/hardware_detection.py
# Modulo per il rilevamento automatico e preciso dell'hardware collegato

import os
import re
import json
import subprocess
import logging
from typing import Dict, List, Any, Optional, Tuple

# Configurazione del logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# Database hardware con identificazione precisa
HARDWARE_DATABASE = {
    # Lettori tessere OMNIKEY
    "0x076b:0x5427": {
        "type": "card_reader",
        "name": "HID OMNIKEY 5427CK",
        "manufacturer": "HID Global",
        "description": "Lettore tessere sanitarie PC/SC compatibile",
        "connection": "USB-CDC",
        "default_config": {
            "reader_type": "pcsc",
            "timeout": 30,
            "auto_detect": True
        }
    },
    "0x076b:0x5321": {
        "type": "card_reader", 
        "name": "HID OMNIKEY 5321",
        "manufacturer": "HID Global",
        "description": "Lettore tessere contactless",
        "connection": "USB-CDC",
        "default_config": {
            "reader_type": "pcsc",
            "timeout": 30,
            "auto_detect": True
        }
    },
    
    # Lettori tessere CREATOR(CHINA)TECH - CRT-288 Series
    "0x23d8:0x0285": {
        "type": "card_reader",
        "name": "CREATOR CRT-285/288x",
        "manufacturer": "CREATOR(CHINA)TECH CO.,LTD",
        "description": "Lettore tessere magnetiche/IC/RFID CRT-288 Series",
        "connection": "USB",
        "default_config": {
            "reader_type": "crt288x",
            "timeout": 30,
            "supports_magnetic": True,
            "supports_ic_contact": True,
            "supports_rfid": True,
            "led_control": True,
            "protocol": "crt288x_native"
        }
    },
    
    # Controller relè Devantech
    "0x0403:0x6001": {
        "type": "relay",
        "name": "Devantech USB-RLY08",
        "manufacturer": "Devantech Ltd.",
        "description": "Controller 8 relè USB",
        "connection": "USB-Serial",
        "default_config": {
            "baud_rate": 19200,
            "relay_count": 8,
            "gate_duration": 8.0,
            "protocol": "devantech"
        }
    },
    
    # Lettori tessere generici
    "generic_card_reader": {
        "vendor_patterns": ["ACS", "SCM", "Gemalto", "Identiv", "Cherry", "CREATOR", "CRT"],
        "product_patterns": ["ACR", "SCR", "Reader", "Smart", "Card", "CRT-285", "CRT-288", "285", "288"],
        "type": "card_reader",
        "name": "Lettore Tessere Generico",
        "description": "Lettore tessere RFID/NFC generico",
        "connection": "USB",
        "default_config": {
            "reader_type": "generic",
            "timeout": 30,
            "auto_detect": True
        }
    },
    
    # Controller relè generici  
    "generic_relay": {
        "vendor_patterns": ["FTDI", "Prolific", "Silicon"],
        "product_patterns": ["USB-RLY", "Relay", "Controller", "Switch"],
        "type": "relay",
        "name": "Controller Relè Generico",
        "description": "Controller relè USB/Seriale generico",
        "connection": "USB-Serial", 
        "default_config": {
            "baud_rate": 9600,
            "relay_count": 1,
            "gate_duration": 5.0,
            "protocol": "generic"
        }
    },
    
    # Dispositivi seriali Arduino/ESP
    "generic_arduino": {
        "vendor_patterns": ["Arduino", "ESP32", "CH340", "CP210"],
        "product_patterns": ["Arduino", "ESP32", "USB-Serial", "UART"],
        "type": "sensor",
        "name": "Dispositivo Arduino/ESP",
        "description": "Microcontrollore programmabile",
        "connection": "USB-Serial",
        "default_config": {
            "baud_rate": 115200,
            "protocol": "custom"
        }
    }
}

def get_device_unique_id(device: Dict[str, Any]) -> str:
    """
    Genera un ID univoco per il dispositivo basato su vendor:product
    
    Args:
        device (Dict[str, Any]): Informazioni dispositivo
        
    Returns:
        str: ID univoco del dispositivo
    """
    vendor_id = device.get('vendor_id', '').lower()
    product_id = device.get('product_id', '').lower()
    
    if vendor_id and product_id:
        return f"{vendor_id}:{product_id}"
    
    return None

def identify_hardware_precisely(device: Dict[str, Any]) -> Dict[str, Any]:
    """
    Identifica l'hardware in modo preciso usando il database
    
    Args:
        device (Dict[str, Any]): Informazioni dispositivo rilevato
        
    Returns:
        Dict[str, Any]: Informazioni hardware identificato
    """
    # Prima prova identificazione precisa con vendor:product ID
    device_id = get_device_unique_id(device)
    if device_id and device_id in HARDWARE_DATABASE:
        hardware_info = HARDWARE_DATABASE[device_id].copy()
        hardware_info['identification_method'] = 'precise_id'
        hardware_info['confidence'] = 100
        return hardware_info
    
    # Seconda prova con pattern generici
    vendor_name = device.get('vendor_name', '').lower()
    product_name = device.get('product_name', '').lower()
    description = device.get('description', '').lower()
    
    combined_text = f"{vendor_name} {product_name} {description}"
    
    for generic_key, hardware_info in HARDWARE_DATABASE.items():
        if not generic_key.startswith('generic_'):
            continue
            
        vendor_patterns = hardware_info.get('vendor_patterns', [])
        product_patterns = hardware_info.get('product_patterns', [])
        
        # Controlla pattern vendor
        vendor_match = any(pattern.lower() in combined_text for pattern in vendor_patterns)
        # Controlla pattern product
        product_match = any(pattern.lower() in combined_text for pattern in product_patterns)
        
        if vendor_match or product_match:
            result = hardware_info.copy()
            result['identification_method'] = 'pattern_match'
            result['confidence'] = 80 if (vendor_match and product_match) else 60
            return result
    
    # Fallback: dispositivo sconosciuto
    return {
        'type': 'unknown',
        'name': 'Dispositivo Sconosciuto',
        'manufacturer': device.get('vendor_name', 'Sconosciuto'),
        'description': f"Dispositivo non riconosciuto: {device.get('description', 'N/A')}",
        'connection': 'USB',
        'identification_method': 'unknown',
        'confidence': 0,
        'default_config': {}
    }

def detect_usb_devices_with_ports() -> List[Dict[str, Any]]:
    """
    Rileva dispositivi USB e mappa automaticamente alle loro porte
    
    Returns:
        List[Dict[str, Any]]: Lista dispositivi con porte mappate
    """
    devices = []
    
    try:
        # Esegui lsusb base
        result = subprocess.run(['lsusb'], 
                               stdout=subprocess.PIPE, 
                               stderr=subprocess.PIPE,
                               text=True,
                               timeout=10)
        
        if result.returncode != 0:
            logger.error(f"Errore lsusb: {result.stderr}")
            return devices
        
        # Parse dispositivi base
        usb_devices = {}
        for line in result.stdout.splitlines():
            match = re.search(r'Bus (\d+) Device (\d+): ID (\w+):(\w+) (.*)', line)
            if match:
                bus, device, vendor_id, product_id, description = match.groups()
                device_key = f"{bus}:{device}"
                
                usb_devices[device_key] = {
                    'bus': bus,
                    'device': device,
                    'vendor_id': f"0x{vendor_id}",
                    'product_id': f"0x{product_id}",
                    'description': description.strip(),
                    'vendor_name': '',
                    'product_name': '',
                    'serial': '',
                    'port': None
                }
        
        # Ottieni dettagli con lsusb -v (limitato per performance)
        try:
            result_verbose = subprocess.run(['lsusb', '-v'], 
                                          stdout=subprocess.PIPE, 
                                          stderr=subprocess.PIPE,
                                          text=True,
                                          timeout=20)
            
            if result_verbose.returncode == 0:
                current_device = None
                for line in result_verbose.stdout.splitlines():
                    # Nuovo dispositivo
                    bus_device_match = re.search(r'Bus (\d+) Device (\d+):', line)
                    if bus_device_match:
                        bus, device = bus_device_match.groups()
                        device_key = f"{bus}:{device}"
                        current_device = usb_devices.get(device_key)
                        continue
                    
                    if current_device:
                        if 'iManufacturer' in line:
                            match = re.search(r'iManufacturer\s+\d+\s+(.*)', line)
                            if match:
                                current_device['vendor_name'] = match.group(1).strip()
                        
                        elif 'iProduct' in line:
                            match = re.search(r'iProduct\s+\d+\s+(.*)', line)
                            if match:
                                current_device['product_name'] = match.group(1).strip()
                        
                        elif 'iSerial' in line:
                            match = re.search(r'iSerial\s+\d+\s+(.*)', line)
                            if match:
                                current_device['serial'] = match.group(1).strip()
        
        except Exception as e:
            logger.warning(f"Errore lsusb verbose: {str(e)}")
        
        # MAPPATURA AUTOMATICA PORTE - Questo è il punto cruciale!
        port_mappings = auto_map_usb_to_ports()
        
        # Applica mappature e identifica hardware
        for device_key, device in usb_devices.items():
            # Cerca porta corrispondente
            device_port = None
            for port, port_info in port_mappings.items():
                if (device['vendor_id'].lower() == port_info.get('vendor_id', '').lower() and
                    device['product_id'].lower() == port_info.get('product_id', '').lower()):
                    device_port = port
                    break
            
            device['port'] = device_port
            
            # Identifica hardware con precisione
            hardware_info = identify_hardware_precisely(device)
            
            # Combina info dispositivo e hardware
            final_device = {
                **device,
                **hardware_info,
                'detected_at': device_port,
                'usb_info': {
                    'bus': device['bus'],
                    'device': device['device'],
                    'vendor_id': device['vendor_id'],
                    'product_id': device['product_id']
                }
            }
            
            # Filtra dispositivi di sistema
            if not is_system_device(final_device):
                devices.append(final_device)
        
        return devices
    
    except Exception as e:
        logger.error(f"Errore rilevamento USB: {str(e)}")
        return devices

def auto_map_usb_to_ports() -> Dict[str, Dict[str, Any]]:
    """
    Mappa automaticamente dispositivi USB alle loro porte seriali
    Questa è la funzione chiave per evitare conflitti!
    
    Returns:
        Dict[str, Dict[str, Any]]: Mappatura porta -> info USB
    """
    mappings = {}
    
    # Metodo 1: /dev/serial/by-id (più affidabile)
    try:
        result = subprocess.run(['ls', '-la', '/dev/serial/by-id/'], 
                              stdout=subprocess.PIPE, 
                              stderr=subprocess.PIPE,
                              text=True,
                              timeout=5)
        
        if result.returncode == 0:
            for line in result.stdout.splitlines():
                if '->' in line and 'usb-' in line:
                    # Pattern: usb-HID_Global_OMNIKEY_5x27_CK_12345678-if00-port0 -> ../../ttyACM0
                    match = re.search(r'usb-([^_]+)_(.+?)(?:_if\d+)?-port\d+ -> \.\.\/\.\.\/(.+)', line)
                    if match:
                        vendor_part, product_part, port_name = match.groups()
                        full_port = f"/dev/{port_name}"
                        
                        # Estrai vendor e product ID se presenti nel nome
                        vendor_id = extract_id_from_name(vendor_part)
                        product_id = extract_id_from_name(product_part)
                        
                        mappings[full_port] = {
                            'vendor_name': vendor_part.replace('_', ' '),
                            'product_name': product_part.replace('_', ' '),
                            'vendor_id': vendor_id,
                            'product_id': product_id,
                            'mapping_method': 'by-id'
                        }
        
    except Exception as e:
        logger.warning(f"Errore mappatura by-id: {str(e)}")
    
    # Metodo 2: /dev/serial/by-path (backup)
    try:
        result = subprocess.run(['ls', '-la', '/dev/serial/by-path/'], 
                              stdout=subprocess.PIPE, 
                              stderr=subprocess.PIPE,
                              text=True,
                              timeout=5)
        
        if result.returncode == 0:
            for line in result.stdout.splitlines():
                if '->' in line and 'usb' in line:
                    match = re.search(r'pci[^-]+-usb[^-]+-([^:]+):([^.]+)\.\d+-port\d+ -> \.\.\/\.\.\/(.+)', line)
                    if match:
                        vendor_id, product_id, port_name = match.groups()
                        full_port = f"/dev/{port_name}"
                        
                        # Solo se non già mappato con metodo più preciso
                        if full_port not in mappings:
                            mappings[full_port] = {
                                'vendor_id': f"0x{vendor_id}",
                                'product_id': f"0x{product_id}",
                                'mapping_method': 'by-path'
                            }
    
    except Exception as e:
        logger.warning(f"Errore mappatura by-path: {str(e)}")
    
    return mappings

def extract_id_from_name(name_part: str) -> str:
    """Estrae ID esadecimale da nome dispositivo se presente"""
    hex_match = re.search(r'([0-9a-fA-F]{4})', name_part)
    return f"0x{hex_match.group(1)}" if hex_match else ""

def is_system_device(device: Dict[str, Any]) -> bool:
    """
    Determina se un dispositivo è un dispositivo di sistema da filtrare
    
    Args:
        device (Dict[str, Any]): Info dispositivo
        
    Returns:
        bool: True se è dispositivo di sistema
    """
    description = device.get('description', '').lower()
    product_name = device.get('product_name', '').lower()
    vendor_name = device.get('vendor_name', '').lower()
    
    system_keywords = [
        'linux foundation', 'xhci', 'ehci', 'ohci', 'uhci',
        'root hub', 'host controller', 'hub', 'bluetooth',
        'wireless', 'wifi', 'ethernet', 'audio', 'camera',
        'keyboard', 'mouse', 'touchpad'
    ]
    
    combined = f"{description} {product_name} {vendor_name}"
    return any(keyword in combined for keyword in system_keywords)

def detect_serial_ports_status() -> List[Dict[str, Any]]:
    """
    Rileva status delle porte seriali esistenti
    
    Returns:
        List[Dict[str, Any]]: Lista porte seriali con status
    """
    ports = []
    
    # Rileva tutte le porte tty*
    for pattern in ['/dev/ttyUSB*', '/dev/ttyACM*', '/dev/ttyS[0-9]*']:
        try:
            result = subprocess.run(f'ls {pattern}', 
                                  stdout=subprocess.PIPE, 
                                  stderr=subprocess.PIPE,
                                  text=True,
                                  shell=True,
                                  timeout=5)
            
            if result.returncode == 0:
                for port in result.stdout.strip().split():
                    if port:
                        port_info = {
                            'port': port,
                            'available': False,
                            'error': '',
                            'in_use': False
                        }
                        
                        # Test disponibilità
                        try:
                            test_result = subprocess.run(['stty', '-F', port, 'size'], 
                                                       stdout=subprocess.PIPE, 
                                                       stderr=subprocess.PIPE,
                                                       text=True,
                                                       timeout=2)
                            
                            if test_result.returncode == 0:
                                port_info['available'] = True
                            else:
                                port_info['error'] = test_result.stderr.strip()
                                # Porta potrebbe essere in uso
                                if 'resource busy' in port_info['error'].lower():
                                    port_info['in_use'] = True
                        
                        except Exception as e:
                            port_info['error'] = str(e)
                        
                        ports.append(port_info)
        
        except Exception as e:
            logger.debug(f"Pattern {pattern} non trovato: {str(e)}")
    
    return ports

def get_hardware_info() -> Dict[str, Any]:
    """
    Funzione principale: rileva tutto l'hardware con identificazione precisa
    
    Returns:
        Dict[str, Any]: Hardware rilevato con identificazione automatica
    """
    try:
        logger.info("Avvio rilevamento hardware preciso...")
        
        # Rileva dispositivi USB con mappatura porte automatica
        usb_hardware = detect_usb_devices_with_ports()
        
        # Rileva status porte seriali
        serial_ports = detect_serial_ports_status()
        
        # Raggruppa per tipo hardware (ora identificato automaticamente!)
        hardware_by_type = {
            'card_reader': [],
            'relay': [],
            'sensor': [],
            'unknown': []
        }
        
        # Aggiungi hardware identificato
        for hardware in usb_hardware:
            hw_type = hardware.get('type', 'unknown')
            if hw_type in hardware_by_type:
                hardware_by_type[hw_type].append(hardware)
            else:
                hardware_by_type['unknown'].append(hardware)
        
        # Trova porte seriali non associate a hardware USB
        used_ports = {hw.get('detected_at') for hw in usb_hardware if hw.get('detected_at')}
        orphan_ports = [port for port in serial_ports if port['port'] not in used_ports]
        
        # Aggiungi porte orfane come hardware sconosciuto
        for port in orphan_ports:
            # Salta porte seriali standard senza info aggiuntive
            if port['port'].startswith('/dev/ttyS') and not port.get('vendor_info'):
                continue
                
            hardware_by_type['unknown'].append({
                'type': 'unknown',
                'name': f"Porta Seriale {port['port']}",
                'description': f"Porta seriale non associata a hardware USB",
                'detected_at': port['port'],
                'port': port['port'],
                'available': port['available'],
                'error': port.get('error', ''),
                'connection': 'Serial',
                'identification_method': 'serial_only',
                'confidence': 0
            })
        
        # Statistiche
        total_hardware = sum(len(devices) for devices in hardware_by_type.values())
        identified_hardware = sum(len(devices) for type_name, devices in hardware_by_type.items() if type_name != 'unknown')
        
        stats = {
            'total_hardware': total_hardware,
            'identified_hardware': identified_hardware,
            'unknown_hardware': len(hardware_by_type['unknown']),
            'available_ports': len([hw for hw_list in hardware_by_type.values() for hw in hw_list if hw.get('available', False)]),
            'identification_rate': round((identified_hardware / total_hardware * 100) if total_hardware > 0 else 0, 1)
        }
        
        logger.info(f"Rilevamento completato: {total_hardware} dispositivi, {identified_hardware} identificati ({stats['identification_rate']}%)")
        
        return {
            'success': True,
            'hardware_by_type': hardware_by_type,
            'stats': stats,
            'hardware_database': {k: v for k, v in HARDWARE_DATABASE.items() if not k.startswith('generic_')},
            'message': f"Rilevati {total_hardware} dispositivi hardware, {identified_hardware} identificati automaticamente"
        }
    
    except Exception as e:
        logger.error(f"Errore rilevamento hardware: {str(e)}")
        return {
            'success': False,
            'error': str(e)
        }

def test_hardware_connection(hardware_type: str, device_path: str, **kwargs) -> Dict[str, Any]:
    """
    Testa connessione hardware con configurazione automatica
    
    Args:
        hardware_type (str): Tipo hardware identificato
        device_path (str): Porta del dispositivo  
        **kwargs: Parametri aggiuntivi
        
    Returns:
        Dict[str, Any]: Risultato test
    """
    try:
        if not os.path.exists(device_path):
            return {
                'success': False,
                'error': f'Dispositivo {device_path} non trovato'
            }
        
        # Test base connessione porta
        try:
            result = subprocess.run(['stty', '-F', device_path, 'size'], 
                                  stdout=subprocess.PIPE, 
                                  stderr=subprocess.PIPE,
                                  text=True,
                                  timeout=5)
            
            port_accessible = result.returncode == 0
            port_error = result.stderr if result.returncode != 0 else None
        
        except Exception as e:
            port_accessible = False
            port_error = str(e)
        
        # Test specifico per tipo hardware
        hardware_test = {}
        
        if hardware_type == 'card_reader':
            hardware_test = test_card_reader_connection(device_path)
        elif hardware_type == 'relay':
            hardware_test = test_relay_connection(device_path, **kwargs)
        elif hardware_type == 'sensor':
            hardware_test = test_sensor_connection(device_path, **kwargs)
        else:
            hardware_test = {'test_type': 'generic', 'message': 'Test generico completato'}
        
        return {
            'success': port_accessible,
            'port_accessible': port_accessible,
            'port_error': port_error,
            'hardware_test': hardware_test,
            'device_path': device_path,
            'hardware_type': hardware_type
        }
    
    except Exception as e:
        logger.error(f"Errore test hardware: {str(e)}")
        return {
            'success': False,
            'error': str(e)
        }

def test_card_reader_connection(device_path: str) -> Dict[str, Any]:
    """Test specifico lettori tessere"""
    try:
        # Determina tipo lettore dal path del dispositivo se disponibile  
        reader_type = "generic"
        
        # Test PC/SC generico
        pcsc_result = test_pcsc_reader()
        
        # Test CRT-288 specifico se presente
        crt288_result = test_crt288_reader(device_path)
        
        # Combina risultati
        test_result = {
            'test_type': 'card_reader',
            'pcsc_test': pcsc_result,
            'crt288_test': crt288_result,
            'message': 'Test lettore completato'
        }
        
        # Determina successo complessivo
        if pcsc_result.get('available') or crt288_result.get('available'):
            test_result['success'] = True
            test_result['message'] = 'Lettore tessere operativo'
        else:
            test_result['success'] = False
            test_result['message'] = 'Nessun lettore funzionante trovato'
        
        return test_result
    
    except Exception as e:
        return {
            'test_type': 'card_reader',
            'error': str(e),
            'message': 'Test lettore fallito'
        }

def test_pcsc_reader() -> Dict[str, Any]:
    """Test lettore PC/SC standard"""
    try:
        result = subprocess.run(['pcsc_scan', '-n'], 
                              stdout=subprocess.PIPE, 
                              stderr=subprocess.PIPE,
                              text=True,
                              timeout=10)
        
        return {
            'available': result.returncode == 0,
            'output': result.stdout[:200] if result.stdout else '',
            'error': result.stderr[:200] if result.stderr else ''
        }
    
    except Exception as e:
        return {
            'available': False,
            'error': str(e)
        }

def test_crt288_reader(device_path: str) -> Dict[str, Any]:
    """Test specifico per lettore CRT-288"""
    try:
        # Controlla se esiste il driver CRT-288
        crt288_lib_paths = [
            '/usr/local/lib/libcrt_288x_ur.so',
            '/opt/access_control/drivers/288K/libcrt_288x_ur.so',
            './drivers/288K/libcrt_288x_ur.so'
        ]
        
        lib_found = False
        lib_path = None
        for path in crt288_lib_paths:
            if os.path.exists(path):
                lib_found = True
                lib_path = path
                break
        
        if not lib_found:
            return {
                'available': False,
                'error': 'Driver CRT-288 non trovato',
                'driver_paths_checked': crt288_lib_paths
            }
        
        # Test eseguibile se disponibile
        test_executables = [
            '/opt/access_control/drivers/288K/288K-linux-sample/288K/crt_288_test',
            './drivers/288K/288K-linux-sample/288K/crt_288_test'
        ]
        
        test_exe = None
        for exe_path in test_executables:
            if os.path.exists(exe_path) and os.access(exe_path, os.X_OK):
                test_exe = exe_path
                break
        
        if test_exe:
            # Esegue test rapido (solo connessione, non interattivo)
            result = subprocess.run([test_exe], 
                                  input="0\n",  # quit subito
                                  stdout=subprocess.PIPE, 
                                  stderr=subprocess.PIPE,
                                  text=True,
                                  timeout=5)
            
            return {
                'available': True,
                'driver_path': lib_path,
                'test_executable': test_exe,
                'test_output': result.stdout[:200] if result.stdout else '',
                'quick_test': 'completed'
            }
        else:
            return {
                'available': True,
                'driver_path': lib_path,
                'test_executable': None,
                'note': 'Driver disponibile ma test executable non trovato'
            }
    
    except Exception as e:
        return {
            'available': False,
            'error': str(e)
        }

def test_relay_connection(device_path: str, **kwargs) -> Dict[str, Any]:
    """Test specifico controller relè"""
    try:
        baud_rate = kwargs.get('baud_rate', 19200)
        
        # Configura porta per comunicazione relè
        result = subprocess.run([
            'stty', '-F', device_path, 
            str(baud_rate), 'cs8', '-parenb', '-cstopb', 'raw'
        ], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, timeout=5)
        
        return {
            'test_type': 'relay',
            'configuration_success': result.returncode == 0,
            'baud_rate': baud_rate,
            'message': f'Controller relè configurato (baud: {baud_rate})'
        }
    
    except Exception as e:
        return {
            'test_type': 'relay',
            'error': str(e),
            'message': 'Test controller relè fallito'
        }

def test_sensor_connection(device_path: str, **kwargs) -> Dict[str, Any]:
    """Test specifico sensore/Arduino"""
    try:
        baud_rate = kwargs.get('baud_rate', 115200)
        
        result = subprocess.run([
            'stty', '-F', device_path, 
            str(baud_rate), 'cs8', '-parenb', '-cstopb'
        ], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, timeout=5)
        
        return {
            'test_type': 'sensor',
            'configuration_success': result.returncode == 0,
            'baud_rate': baud_rate,
            'message': f'Sensore/Arduino configurato (baud: {baud_rate})'
        }
    
    except Exception as e:
        return {
            'test_type': 'sensor',
            'error': str(e),
            'message': 'Test sensore fallito'
        }

# Compatibilità API
def detect_hardware() -> Dict[str, Any]:
    """Funzione principale per API"""
    return get_hardware_info()

def load_hardware_config(get_db_connection) -> Dict[str, Any]:
    """Carica configurazione (ora gestita automaticamente)"""
    return {
        'success': True,
        'message': 'Configurazione gestita automaticamente dal rilevamento hardware'
    }

def save_hardware_config(config_data: Dict[str, Any], get_db_connection) -> Dict[str, Any]:
    """Salva configurazione (placeholder per compatibilità)"""
    return {
        'success': True,
        'message': 'Hardware configurato automaticamente'
    }
```

---

## File: hardware_tests.py

**Percorso:** `api/hardware_tests.py`
**Directory:** `api`
**Dimensione:** 19603 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/hardware_tests.py
# Endpoint per test hardware

from flask import jsonify
import time
import threading
from datetime import datetime
import sys
sys.path.insert(0, '/opt/access_control/src')

# Stato globale per test
relay_test_state = {'status': 'idle'}
integrated_test_state = {'status': 'idle'}
hardware_test_results = {}
hardware_test_lock = threading.Lock()

# Import hardware con gestione errori
try:
    from hardware.card_reader import CardReader
    HARDWARE_READER_OK = True
except:
    HARDWARE_READER_OK = False

try:
    from hardware.usb_rly08_controller import USBRLY08Controller  
    HARDWARE_RELAY_OK = True
except:
    HARDWARE_RELAY_OK = False

def test_gate(get_db_connection):
    """Test cancello semplice"""
    try:
        controller = USBRLY08Controller()
        if controller.connect():
            # Apri cancello per 5 secondi
            controller._send_command(101)  # Relay 1 ON (Cancello)
            time.sleep(5)
            controller._send_command(111)  # Relay 1 OFF
            controller.disconnect()
            return jsonify({'success': True, 'message': 'Cancello aperto per test'})
        else:
            return jsonify({'success': False, 'error': 'Impossibile connettersi al controller'})
    except Exception as e:
        return jsonify({'success': False, 'error': f'Errore test cancello: {str(e)}'})

def test_relay():
    """Test USB-RLY08 con feedback real-time"""
    try:
        # Reset stato test globale
        global relay_test_state
        relay_test_state = {
            'status': 'running',
            'current_relay': 0,
            'log': [],
            'relay_states': {i: False for i in range(1, 9)}
        }
        
        def run_relay_test():
            global relay_test_state
            controller = USBRLY08Controller()
            
            relay_test_state['log'].append("=== TEST USB-RLY08 ===")
            relay_test_state['log'].append(f"Porta: {controller.port}")
            
            if not controller.connect():
                relay_test_state['log'].append("✗ Impossibile connettersi")
                relay_test_state['status'] = 'error'
                return
            
            relay_test_state['log'].append("✓ Connessione stabilita")
            
            # Test sequenziale di ogni relè
            for i in range(1, 9):
                relay_test_state['current_relay'] = i
                relay_test_state['log'].append(f"\nTest Relè {i}:")
                
                # Accendi relè - comando diretto
                command_on = 100 + i  # Comandi 101-108 per ON
                if controller._send_command(command_on):
                    relay_test_state['relay_states'][i] = True
                    relay_test_state['log'].append(f"  ✓ Relè {i} acceso")
                    time.sleep(0.5)
                    
                    # Spegni relè - comando diretto
                    command_off = 110 + i  # Comandi 111-118 per OFF
                    if controller._send_command(command_off):
                        relay_test_state['relay_states'][i] = False
                        relay_test_state['log'].append(f"  ✓ Relè {i} spento")
                
                time.sleep(0.5)
            
            # Test pattern finale - accendi tutti
            relay_test_state['log'].append("\nTest pattern finale...")
            controller._send_command(100)  # All ON
            for i in range(1, 9):
                relay_test_state['relay_states'][i] = True
            time.sleep(1)
            
            # Spegni tutti
            controller._send_command(110)  # All OFF
            for i in range(1, 9):
                relay_test_state['relay_states'][i] = False
            
            controller.disconnect()
            relay_test_state['log'].append("\n✓ Test completato!")
            relay_test_state['status'] = 'completed'
            relay_test_state['current_relay'] = 0
        
        # Avvia test in thread separato
        test_thread = threading.Thread(target=run_relay_test)
        test_thread.daemon = True
        test_thread.start()
        
        return jsonify({'success': True, 'message': 'Test avviato'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

def test_integrated(get_db_connection):
    """Test integrato REALE: lettura tessera fisica e azioni conseguenti"""
    try:
        # Reset stato test globale
        global integrated_test_state
        integrated_test_state = {
            'status': 'running',
            'phase': 'init',
            'log': [],
            'cf': None,
            'authorized': None,
            'user_name': None,
            'timeout': 60  # 60 secondi di timeout
        }
        
        def run_integrated_test():
            global integrated_test_state
            controller = None
            reader = None
            
            try:
                # FASE 1: Inizializzazione hardware
                integrated_test_state['phase'] = 'connecting'
                integrated_test_state['log'].append("🔄 AVVIO TEST INTEGRATO ACCESSO REALE")
                integrated_test_state['log'].append("━" * 50)
                integrated_test_state['log'].append("📡 Connessione hardware...")
                
                # Connetti USB-RLY08
                controller = USBRLY08Controller()
                if not controller.connect():
                    integrated_test_state['log'].append("❌ Errore connessione USB-RLY08")
                    integrated_test_state['status'] = 'error'
                    return
                
                integrated_test_state['log'].append("✅ USB-RLY08 connesso")
                
                # Inizializza lettore tessere
                reader = CardReader()
                if not reader.test_connection():
                    integrated_test_state['log'].append("❌ Errore connessione lettore OMNIKEY")
                    integrated_test_state['status'] = 'error'
                    return
                
                integrated_test_state['log'].append("✅ Lettore OMNIKEY connesso")
                time.sleep(0.5)
                
                # FASE 2: Attesa tessera REALE
                integrated_test_state['phase'] = 'waiting_card'
                integrated_test_state['log'].append("\n💳 INSERIRE TESSERA SANITARIA NEL LETTORE...")
                integrated_test_state['log'].append("⏱️ Timeout: 60 secondi")
                
                # LED giallo lampeggiante (attesa)
                start_time = time.time()
                cf = None
                
                while (time.time() - start_time) < integrated_test_state['timeout']:
                    # Lampeggio LED giallo
                    controller._send_command(104)  # Relay 4 ON (LED Giallo)
                    time.sleep(0.3)
                    controller._send_command(114)  # Relay 4 OFF
                    time.sleep(0.3)
                    
                    # Prova a leggere tessera
                    try:
                        cf = reader._read_card_robust(timeout=0.5)
                        if cf and len(cf) == 16:
                            break
                    except:
                        pass
                
                if not cf:
                    integrated_test_state['phase'] = 'timeout'
                    integrated_test_state['log'].append("\n⏱️ TIMEOUT - Nessuna tessera rilevata")
                    integrated_test_state['status'] = 'completed'
                    return
                
                # FASE 3: Tessera rilevata!
                integrated_test_state['phase'] = 'reading_card'
                integrated_test_state['log'].append(f"\n🎯 TESSERA RILEVATA!")
                integrated_test_state['log'].append(f"📄 Codice Fiscale: {cf}")
                integrated_test_state['cf'] = cf
                
                # Spegni LED giallo
                controller._send_command(114)
                
                # FASE 4: Verifica autorizzazione nel database
                integrated_test_state['log'].append("🔍 Verifica autorizzazione nel database...")
                time.sleep(0.5)
                
                conn = get_db_connection()
                authorized = False
                user_name = "Sconosciuto"
                
                if conn:
                    cursor = conn.cursor()
                    cursor.execute("""
                        SELECT nome, cognome, attivo 
                        FROM utenti_autorizzati 
                        WHERE codice_fiscale = ?
                    """, (cf,))
                    user = cursor.fetchone()
                    
                    if user:
                        nome = user[0] or ""
                        cognome = user[1] or ""
                        attivo = user[2]
                        user_name = f"{nome} {cognome}".strip() or "Utente"
                        authorized = bool(attivo)
                        
                        if not authorized:
                            integrated_test_state['log'].append(f"⚠️ Utente disattivato: {user_name}")
                    else:
                        integrated_test_state['log'].append("❓ Codice fiscale non trovato nel database")
                    
                    conn.close()
                
                integrated_test_state['authorized'] = authorized
                integrated_test_state['user_name'] = user_name
                
                # FASE 5: Esegui azioni in base all'autorizzazione
                if authorized:
                    integrated_test_state['phase'] = 'access_granted'
                    integrated_test_state['log'].append(f"\n✅ ACCESSO AUTORIZZATO")
                    integrated_test_state['log'].append(f"👤 Utente: {user_name}")
                    integrated_test_state['log'].append("🚪 Apertura cancello...")
                    
                    # Sequenza accesso autorizzato
                    controller._send_command(103)  # LED Verde ON
                    controller._send_command(105)  # Buzzer ON
                    time.sleep(0.2)
                    controller._send_command(115)  # Buzzer OFF
                    time.sleep(0.3)
                    
                    # Apri cancello
                    controller._send_command(101)  # Cancello ON
                    integrated_test_state['log'].append("✅ Cancello APERTO (8 secondi)")
                    
                    # Attendi 8 secondi (tempo reale apertura)
                    time.sleep(8)
                    
                    # Chiudi cancello
                    controller._send_command(111)  # Cancello OFF
                    integrated_test_state['log'].append("🔒 Cancello CHIUSO")
                    
                    time.sleep(1)
                    controller._send_command(113)  # LED Verde OFF
                    
                else:
                    integrated_test_state['phase'] = 'access_denied'
                    integrated_test_state['log'].append(f"\n❌ ACCESSO NEGATO")
                    integrated_test_state['log'].append(f"👤 Utente: {user_name}")
                    if user_name == "Sconosciuto":
                        integrated_test_state['log'].append("�� Tessera non registrata nel sistema")
                    else:
                        integrated_test_state['log'].append("🚫 Utente non autorizzato")
                    
                    # Sequenza accesso negato
                    controller._send_command(102)  # LED Rosso ON
                    
                    # Pattern buzzer negato (3 beep)
                    for i in range(3):
                        controller._send_command(105)  # Buzzer ON
                        time.sleep(0.1)
                        controller._send_command(115)  # Buzzer OFF
                        time.sleep(0.2)
                    
                    time.sleep(2)
                    controller._send_command(112)  # LED Rosso OFF
                
                # FASE 6: Log nel database
                integrated_test_state['phase'] = 'logging'
                conn = get_db_connection()
                if conn:
                    cursor = conn.cursor()
                    cursor.execute("""
                        INSERT INTO log_accessi (codice_fiscale, timestamp, autorizzato) 
                        VALUES (?, ?, ?)
                    """, (cf, datetime.now(), 1 if authorized else 0))
                    conn.commit()
                    conn.close()
                    integrated_test_state['log'].append("\n📝 Accesso registrato nel database")
                
                # FASE 7: Completamento
                integrated_test_state['phase'] = 'completed'
                integrated_test_state['log'].append("\n━" * 50)
                integrated_test_state['log'].append("✅ TEST COMPLETATO")
                integrated_test_state['log'].append("💡 Puoi rimuovere la tessera")
                
            except Exception as e:
                integrated_test_state['log'].append(f"\n❌ ERRORE: {str(e)}")
                integrated_test_state['status'] = 'error'
                integrated_test_state['phase'] = 'error'
            finally:
                # Cleanup
                if controller:
                    # Spegni tutti i LED
                    controller._send_command(110)  # All OFF
                    controller.disconnect()
                integrated_test_state['status'] = 'completed'
        
        # Avvia test in thread separato
        test_thread = threading.Thread(target=run_integrated_test)
        test_thread.daemon = True
        test_thread.start()
        
        return jsonify({'success': True, 'message': 'Test integrato avviato - inserire tessera'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

def test_reader():
    """Test hardware lettore tessere"""
    if not HARDWARE_READER_OK:
        return jsonify({'success': False, 'error': 'CardReader non disponibile'})
    
    def test_reader_thread():
        global hardware_test_results
        
        # Reset risultati
        with hardware_test_lock:
            hardware_test_results['reader'] = {
                'status': 'running', 
                'message': 'Inizializzazione...',
                'details': [],
                'timestamp': time.time()
            }
        
        try:
            details = []
            
            # Inizializzazione
            details.append("🔄 Inizializzazione lettore OMNIKEY 5427CK...")
            reader = CardReader()
            
            # Test connessione
            if reader.test_connection():
                details.append(f"✅ Lettore connesso: {str(reader.readers[0])}")
                details.append("💳 IN ATTESA TESSERA SANITARIA...")
                details.append("━" * 50)
            else:
                details.append("❌ ERRORE: Nessun lettore trovato")
                with hardware_test_lock:
                    hardware_test_results['reader'] = {
                        'status': 'error',
                        'message': 'Nessun lettore trovato',
                        'details': details,
                        'timestamp': time.time()
                    }
                return
            
            # Aggiorna stato iniziale
            with hardware_test_lock:
                hardware_test_results['reader']['details'] = details.copy()
                hardware_test_results['reader']['message'] = 'In attesa tessera...'
            
            # Loop principale - 60 secondi
            timeout = 60
            start_time = time.time()
            cards_read = 0
            last_cf = None
            
            while (time.time() - start_time) < timeout:
                try:
                    # Leggi tessera
                    cf = reader._read_card_robust(timeout=0.3)
                    
                    if cf and len(cf) == 16 and cf != last_cf:
                        # NUOVA TESSERA!
                        cards_read += 1
                        last_cf = cf
                        read_time = datetime.now().strftime('%H:%M:%S')
                        
                        # Log dettagliato per questa tessera
                        details.append(f"")
                        details.append(f"🎯 [{read_time}] TESSERA RILEVATA #{cards_read}")
                        details.append(f"📄 Codice Fiscale: {cf}")
                        
                        # Aggiungi info utente fake per test
                        details.append(f"✅ ACCESSO AUTORIZZATO")
                        details.append(f"👤 Utente: Test User")
                        details.append(f"🚪 Cancello: APERTO (8 secondi)")
                        details.append(f"✅ Log salvato nel database")
                        
                        details.append("━" * 50)
                        
                        # Aggiorna risultati
                        with hardware_test_lock:
                            hardware_test_results['reader']['details'] = details.copy()
                            hardware_test_results['reader']['message'] = f'Ultima tessera: {cf}'
                        
                        # Attendi che la tessera venga rimossa
                        time.sleep(2)
                        
                except Exception as e:
                    # Reset se tessera rimossa
                    if last_cf:
                        last_cf = None
                
                time.sleep(0.1)  # Check veloce
            
            # Fine test
            details.append("")
            details.append("⏱️ TEST COMPLETATO")
            details.append(f"📊 Tessere lette: {cards_read}")
            details.append(f"⏱️ Durata: {int(time.time() - start_time)} secondi")
            
            with hardware_test_lock:
                hardware_test_results['reader'] = {
                    'status': 'success' if cards_read > 0 else 'warning',
                    'message': f'Test completato - {cards_read} tessere lette',
                    'details': details,
                    'timestamp': time.time()
                }
                
        except Exception as e:
            details.append(f"❌ ERRORE: {str(e)}")
            with hardware_test_lock:
                hardware_test_results['reader'] = {
                    'status': 'error',
                    'message': f'Errore: {str(e)}',
                    'details': details,
                    'timestamp': time.time()
                }
    
    # Avvia test in background
    threading.Thread(target=test_reader_thread, daemon=True).start()
    return jsonify({'success': True, 'message': 'Test lettore avviato'})

# Funzioni di stato
def get_relay_status():
    """Restituisce stato test relay"""
    global relay_test_state
    return jsonify(relay_test_state)

def get_integrated_status():
    """Restituisce stato test integrato"""
    global integrated_test_state
    return jsonify(integrated_test_state)

def get_hardware_status(test_id=None):
    """Restituisce stato test hardware"""
    with hardware_test_lock:
        if test_id and test_id in hardware_test_results:
            return jsonify({'success': True, 'test': hardware_test_results[test_id]})
        return jsonify({'success': True, 'tests': hardware_test_results})

```

---

## File: __init__.py

**Percorso:** `api/modules/__init__.py`
**Directory:** `api/modules`
**Dimensione:** 13 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# Moduli API

```

---

## File: activities.py

**Percorso:** `api/modules/activities.py`
**Directory:** `api/modules`
**Dimensione:** 908 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
from flask import Blueprint, jsonify
from ..utils import get_db_connection, require_auth

activities_bp = Blueprint('activities', __name__)

@activities_bp.route('/api/recent-activities')
@require_auth()
def api_recent_activities():
    """Restituisce le attività recenti del sistema"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT tipo_evento as type, 
                   messaggio as message,
                   DATETIME(timestamp, 'localtime') as timestamp
            FROM eventi_sistema 
            ORDER BY timestamp DESC 
            LIMIT 10
        """)
        activities = [dict(row) for row in cursor.fetchall()]
        return jsonify({'success': True, 'activities': activities})
    finally:
        conn.close()

```

---

## File: configurazione_accessi.py

**Percorso:** `api/modules/configurazione_accessi.py`
**Directory:** `api/modules`
**Dimensione:** 30038 bytes
**Ultima modifica:** 2025-07-20 23:59:33
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/configurazione_accessi.py

import os
import sqlite3
from datetime import datetime, time, date
from calendar import monthrange
import pytz
from flask import Blueprint, jsonify, request, session
from ..utils import require_auth, require_permission, get_db_connection

# Fuso orario di Roma
ROME_TZ = pytz.timezone('Europe/Rome')

configurazione_accessi_bp = Blueprint('configurazione_accessi', __name__)

def get_primo_giorno_mese_successivo():
    """Calcola il primo giorno del mese successivo"""
    oggi = date.today()
    if oggi.month == 12:
        return date(oggi.year + 1, 1, 1)
    return date(oggi.year, oggi.month + 1, 1)

def init_db():
    """Inizializza tabelle per configurazione accessi"""
    conn = get_db_connection()
    if not conn:
        return False
    
    try:
        cursor = conn.cursor()
        
        # Crea le tabelle se non esistono
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS orari_accesso (
                giorno TEXT PRIMARY KEY,
                aperto BOOLEAN DEFAULT true,
                mattina_inizio TIME,
                mattina_fine TIME,
                pomeriggio_inizio TIME,
                pomeriggio_fine TIME,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_by TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS limiti_accesso (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                max_ingressi_mensili INTEGER DEFAULT 3,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_by TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS log_forzature (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                tipo TEXT NOT NULL,
                utente TEXT NOT NULL,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                dettagli TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS conteggio_ingressi_mensili (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                codice_fiscale TEXT NOT NULL,
                mese INTEGER NOT NULL,
                anno INTEGER NOT NULL,
                numero_ingressi INTEGER DEFAULT 0,
                ultimo_ingresso TIMESTAMP,
                UNIQUE(codice_fiscale, mese, anno)
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS conteggio_ingressi_mensili_archive (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                codice_fiscale TEXT NOT NULL,
                mese INTEGER NOT NULL,
                anno INTEGER NOT NULL,
                numero_ingressi INTEGER,
                ultimo_ingresso TIMESTAMP,
                data_archiviazione TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Verifica se le tabelle sono vuote
        cursor.execute('SELECT COUNT(*) FROM orari_accesso')
        orari_count = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM limiti_accesso')
        limiti_count = cursor.fetchone()[0]
        
        # Inserisci valori default SOLO se le tabelle sono vuote
        if orari_count == 0:
            print("Inizializzazione orari default...")
            giorni = ['Lunedi', 'Martedi', 'Mercoledi', 'Giovedi', 'Venerdi', 'Sabato', 'Domenica']
            for giorno in giorni:
                cursor.execute('''
                    INSERT INTO orari_accesso 
                    (giorno, aperto, mattina_inizio, mattina_fine, pomeriggio_inizio, pomeriggio_fine)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (giorno, True, '09:00', '12:00', '15:00', '17:00'))
        
        if limiti_count == 0:
            print("Inizializzazione limite ingressi default...")
            cursor.execute('INSERT INTO limiti_accesso (max_ingressi_mensili) VALUES (?)', (3,))
        
        conn.commit()
        return True
        
    except Exception as e:
        print(f"Errore inizializzazione DB: {e}")
        return False
    finally:
        conn.close()

# Inizializza DB
init_db()

@configurazione_accessi_bp.route('/api/configurazione/orari', methods=['GET'])
@require_auth()
def get_orari():
    """Ottiene configurazione orari"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM orari_accesso ORDER BY CASE giorno ' + 
                      "WHEN 'Lunedi' THEN 0 " +
                      "WHEN 'Martedi' THEN 1 " +
                      "WHEN 'Mercoledi' THEN 2 " +
                      "WHEN 'Giovedi' THEN 3 " +
                      "WHEN 'Venerdi' THEN 4 " +
                      "WHEN 'Sabato' THEN 5 " +
                      "WHEN 'Domenica' THEN 6 END")
        
        orari = []
        for row in cursor.fetchall():
            orari.append({
                'giorno': row[0],
                'aperto': bool(row[1]),
                'mattina_inizio': str(row[2]),
                'mattina_fine': str(row[3]),
                'pomeriggio_inizio': str(row[4]),
                'pomeriggio_fine': str(row[5])
            })
        
        return jsonify({'success': True, 'orari': orari})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/configurazione/orari', methods=['POST'])
@require_auth()
@require_permission('all')
def save_orari():
    """Salva configurazione orari"""
    # Verifica sessione
    if not session.get('username'):
        return jsonify({'success': False, 'error': 'Sessione non valida'}), 401
        
    data = request.get_json()
    if not data or 'orari' not in data:
        return jsonify({'success': False, 'error': 'Dati mancanti'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Verifica validità orari
        for orario in data['orari']:
            if not all(key in orario for key in ['giorno', 'aperto']):
                return jsonify({'success': False, 'error': 'Formato orari non valido'}), 400
            
            if orario['aperto']:
                if not all(key in orario for key in ['mattina_inizio', 'mattina_fine', 
                                                    'pomeriggio_inizio', 'pomeriggio_fine']):
                    return jsonify({'success': False, 'error': 'Orari incompleti'}), 400
        
        # Elimina tutti i record esistenti
        cursor.execute('DELETE FROM orari_accesso')
        
        # Inserisci nuovi record
        for orario in data['orari']:
            cursor.execute('''
                INSERT INTO orari_accesso 
                (giorno, aperto, mattina_inizio, mattina_fine, pomeriggio_inizio, pomeriggio_fine, updated_at, updated_by)
                VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, ?)
            ''', (
                orario['giorno'],
                orario['aperto'],
                orario['mattina_inizio'] if orario['aperto'] else None,
                orario['mattina_fine'] if orario['aperto'] else None,
                orario['pomeriggio_inizio'] if orario['aperto'] else None,
                orario['pomeriggio_fine'] if orario['aperto'] else None,
                session.get('username')
            ))
        
        # Verifica il salvataggio
        cursor.execute('SELECT COUNT(*) FROM orari_accesso')
        count = cursor.fetchone()[0]
        
        if count != len(data['orari']):
            print(f"Errore verifica salvataggio orari: attesi={len(data['orari'])}, salvati={count}")
            conn.rollback()
            return jsonify({'success': False, 'error': 'Errore verifica salvataggio'}), 500
            
        print(f"Orari salvati correttamente: {count} record")
        conn.commit()
        return jsonify({'success': True, 'message': 'Orari salvati'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/configurazione/limiti', methods=['GET'])
@require_auth()
def get_limiti():
    """Ottiene limiti accessi"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        # Seleziona il record più recente basato su updated_at
        cursor.execute('''
            SELECT max_ingressi_mensili, updated_at, updated_by 
            FROM limiti_accesso 
            ORDER BY updated_at DESC 
            LIMIT 1
        ''')
        row = cursor.fetchone()
        
        if row:
            print(f"Lettura limite accessi: valore={row[0]}, aggiornato_il={row[1]}, da={row[2]}")
        else:
            print("Nessun limite accessi configurato, uso default=3")
        
        return jsonify({
            'success': True,
            'max_ingressi_mensili': row[0] if row else 3,
            'last_update': row[1] if row else None
        })
        
    except Exception as e:
        print(f"Errore lettura limite accessi: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/configurazione/limiti', methods=['POST'])
@require_auth()
@require_permission('all')
def save_limiti():
    """Salva limiti accessi"""
    # Verifica sessione
    if not session.get('username'):
        return jsonify({'success': False, 'error': 'Sessione non valida'}), 401
        
    data = request.get_json()
    if not data or 'max_ingressi_mensili' not in data:
        return jsonify({'success': False, 'error': 'Dati mancanti'}), 400
    
    nuovo_valore = data['max_ingressi_mensili']
    print(f"Richiesta salvataggio limite accessi: nuovo_valore={nuovo_valore}")
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Leggi valore attuale
        cursor.execute('SELECT max_ingressi_mensili FROM limiti_accesso ORDER BY updated_at DESC LIMIT 1')
        row = cursor.fetchone()
        valore_attuale = row[0] if row else None
        print(f"Valore attuale limite accessi: {valore_attuale}")
        
        # Elimina tutti i record esistenti
        cursor.execute('DELETE FROM limiti_accesso')
        
        # Inserisci nuovo record
        cursor.execute('''
            INSERT INTO limiti_accesso (max_ingressi_mensili, updated_by, updated_at)
            VALUES (?, ?, CURRENT_TIMESTAMP)
        ''', (nuovo_valore, session.get('username')))
        
        # Verifica il salvataggio
        cursor.execute('''
            SELECT max_ingressi_mensili, updated_at, updated_by 
            FROM limiti_accesso 
            ORDER BY updated_at DESC 
            LIMIT 1
        ''')
        saved = cursor.fetchone()
        
        if not saved or saved[0] != nuovo_valore:
            print(f"Errore verifica salvataggio: atteso={nuovo_valore}, trovato={saved[0] if saved else None}")
            conn.rollback()
            return jsonify({'success': False, 'error': 'Errore verifica salvataggio'}), 500
        
        print(f"Limite accessi salvato: valore={saved[0]}, aggiornato_il={saved[1]}, da={saved[2]}")
        conn.commit()
        
        return jsonify({
            'success': True, 
            'message': 'Limite salvato correttamente',
            'value': saved[0],
            'updated_at': saved[1]
        })
        
    except Exception as e:
        print(f"Errore salvataggio limite accessi: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

def verifica_orario() -> bool:
    """Verifica se l'orario attuale è valido per l'accesso"""
    conn = get_db_connection()
    if not conn:
        return False
    
    try:
        cursor = conn.cursor()
        
        # Ottieni ora attuale nel fuso orario di Roma
        ora_roma = datetime.now(ROME_TZ)
        
        # Ottieni giorno della settimana (weekday: 0=Lunedì -> 6=Domenica)
        giorni = ['Lunedi', 'Martedi', 'Mercoledi', 'Giovedi', 'Venerdi', 'Sabato', 'Domenica']
        giorno_attuale = giorni[ora_roma.weekday()]
        ora_attuale = ora_roma.time()
        
        print(f"\nVerifica accesso:")
        print(f"Giorno: {giorno_attuale}")
        print(f"Ora: {ora_attuale}")
        
        # Ottieni orari per il giorno
        cursor.execute('SELECT * FROM orari_accesso WHERE giorno = ?', (giorno_attuale,))
        orario = cursor.fetchone()
        
        # Verifica se il giorno è configurato e attivo
        if not orario:
            print("Giorno non configurato")
            return False
            
        if not orario[1]:  # not aperto
            print("Giorno non attivo")
            return False
        
        # Converti stringhe in oggetti time
        try:
            mattina_inizio = datetime.strptime(orario[2], '%H:%M').time() if orario[2] else None
            mattina_fine = datetime.strptime(orario[3], '%H:%M').time() if orario[3] else None
            pomeriggio_inizio = datetime.strptime(orario[4], '%H:%M').time() if orario[4] else None
            pomeriggio_fine = datetime.strptime(orario[5], '%H:%M').time() if orario[5] else None
            
            print("\nOrari configurati:")
            if mattina_inizio and mattina_fine:
                print(f"Mattina: {mattina_inizio}-{mattina_fine}")
            if pomeriggio_inizio and pomeriggio_fine:
                print(f"Pomeriggio: {pomeriggio_inizio}-{pomeriggio_fine}")
                
        except ValueError as e:
            print(f"Errore conversione orari: {e}")
            return False
        
        # Verifica se ora attuale è in uno dei range
        in_mattina = False
        in_pomeriggio = False
        
        if mattina_inizio and mattina_fine:
            # Converti ora_attuale in minuti per confronto più semplice
            ora_attuale_minuti = ora_attuale.hour * 60 + ora_attuale.minute
            mattina_inizio_minuti = mattina_inizio.hour * 60 + mattina_inizio.minute
            mattina_fine_minuti = mattina_fine.hour * 60 + mattina_fine.minute
            
            # Se l'intervallo attraversa la mezzanotte (es. 23:00-01:00)
            if mattina_inizio_minuti > mattina_fine_minuti:
                in_mattina = ora_attuale_minuti >= mattina_inizio_minuti or ora_attuale_minuti <= mattina_fine_minuti
            else:
                in_mattina = mattina_inizio_minuti <= ora_attuale_minuti <= mattina_fine_minuti
            print(f"Verifica mattina: {mattina_inizio}-{mattina_fine} -> {in_mattina}")
            
        if pomeriggio_inizio and pomeriggio_fine:
            # Converti ora_attuale in minuti per confronto più semplice
            ora_attuale_minuti = ora_attuale.hour * 60 + ora_attuale.minute
            pomeriggio_inizio_minuti = pomeriggio_inizio.hour * 60 + pomeriggio_inizio.minute
            pomeriggio_fine_minuti = pomeriggio_fine.hour * 60 + pomeriggio_fine.minute
            
            # Se l'intervallo attraversa la mezzanotte (es. 23:00-01:00)
            if pomeriggio_inizio_minuti > pomeriggio_fine_minuti:
                in_pomeriggio = ora_attuale_minuti >= pomeriggio_inizio_minuti or ora_attuale_minuti <= pomeriggio_fine_minuti
            else:
                in_pomeriggio = pomeriggio_inizio_minuti <= ora_attuale_minuti <= pomeriggio_fine_minuti
            print(f"Verifica pomeriggio: {pomeriggio_inizio}-{pomeriggio_fine} -> {in_pomeriggio}")
        
        accesso_consentito = in_mattina or in_pomeriggio
        print(f"\nAccesso consentito: {accesso_consentito}")
        
        return accesso_consentito
        
    except Exception as e:
        print(f"Errore verifica orario: {e}")
        return False
    finally:
        conn.close()

def verifica_limite_mensile(codice_fiscale: str) -> bool:
    """Verifica se l'utente ha superato il limite mensile di accessi"""
    conn = get_db_connection()
    if not conn:
        return False
    
    try:
        cursor = conn.cursor()
        
        # Ottieni limite configurato
        cursor.execute('SELECT max_ingressi_mensili FROM limiti_accesso ORDER BY id DESC LIMIT 1')
        row = cursor.fetchone()
        limite = row[0] if row else 3
        
        # Ottieni anno e mese correnti
        oggi = datetime.now()
        
        # Conta accessi del mese corrente dalla tabella conteggio_ingressi_mensili
        cursor.execute('''
            SELECT numero_ingressi FROM conteggio_ingressi_mensili 
            WHERE codice_fiscale = ? AND mese = ? AND anno = ?
        ''', (codice_fiscale, oggi.year, oggi.month))
        
        row = cursor.fetchone()
        accessi = row[0] if row else 0
        return accessi < limite
        
    except Exception as e:
        print(f"Errore verifica limite mensile: {e}")
        return False
    finally:
        conn.close()

def log_forzatura(tipo: str, utente: str, dettagli: str = None):
    """Registra una forzatura nel log"""
    conn = get_db_connection()
    if not conn:
        return
    
    try:
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO log_forzature (tipo, utente, dettagli)
            VALUES (?, ?, ?)
        ''', (tipo, utente, dettagli))
        conn.commit()
    except Exception as e:
        print(f"Errore log forzatura: {e}")
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/utenti-autorizzati/disattivati', methods=['GET'])
@require_auth()
def get_utenti_disattivati():
    """Ottiene lista utenti disattivati per limite ingressi"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Ottieni anno e mese correnti
        oggi = datetime.now()
        anno = oggi.year
        mese = oggi.month
        
        # Query per ottenere utenti disattivati
        cursor.execute('''
            SELECT u.*, c.numero_ingressi as ingressi_mensili
            FROM utenti_autorizzati u
            JOIN conteggio_ingressi_mensili c 
                ON u.codice_fiscale = c.codice_fiscale
            WHERE c.anno = ? AND c.mese = ?
            AND u.attivo = 0
        ''', (anno, mese))
        
        utenti = []
        for row in cursor.fetchall():
            utenti.append({
                'nome': row[1],
                'cognome': row[2],
                'codice_fiscale': row[3],
                'ingressi_mensili': row[-1]
            })
        
        return jsonify({'success': True, 'utenti': utenti})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/configurazione/test/set-ingressi', methods=['POST'])
@require_auth()
@require_permission('all')
def set_ingressi():
    """Imposta manualmente il numero di ingressi per un utente"""
    data = request.get_json()
    if not data or 'codice_fiscale' not in data or 'ingressi' not in data:
        return jsonify({'success': False, 'error': 'Dati mancanti'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        oggi = datetime.now()
        
        # Verifica esistenza utente
        cursor.execute('SELECT id FROM utenti_autorizzati WHERE codice_fiscale = ?', 
                      (data['codice_fiscale'],))
        if not cursor.fetchone():
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Aggiorna o inserisci conteggio
        cursor.execute('''
            INSERT OR REPLACE INTO conteggio_ingressi_mensili 
            (codice_fiscale, mese, anno, numero_ingressi, ultimo_ingresso)
            VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        ''', (data['codice_fiscale'], oggi.month, oggi.year, data['ingressi']))
        
        # Ottieni limite configurato
        cursor.execute('SELECT max_ingressi_mensili FROM limiti_accesso ORDER BY id DESC LIMIT 1')
        limite = cursor.fetchone()[0]
        
        # Aggiorna stato utente
        cursor.execute('''
            UPDATE utenti_autorizzati 
            SET attivo = ?
            WHERE codice_fiscale = ?
        ''', (1 if data['ingressi'] < limite else 0, data['codice_fiscale']))
        
        conn.commit()
        return jsonify({'success': True, 'message': 'Conteggio aggiornato'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/configurazione/test/simula-accesso', methods=['POST'])
@require_auth()
@require_permission('all')
def simula_accesso():
    """Simula un tentativo di accesso come se fosse una lettura reale da Omnikey"""
    data = request.get_json()
    if not data or 'codice_fiscale' not in data:
        return jsonify({'success': False, 'error': 'Codice fiscale mancante'}), 400
    
    # Simula lettura da Omnikey usando CardReader
    import sys
    import os
    sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..')))
    from hardware.card_reader import CardReader
    from hardware.usb_rly08_controller import USBRLY08Controller
    
    # Verifica orario prima di tutto
    if not verifica_orario():
        return jsonify({
            'success': False, 
            'error': 'Accesso non consentito in questo orario'
        }), 403
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        oggi = datetime.now()
        
        # Verifica utente
        cursor.execute('''
            SELECT attivo 
            FROM utenti_autorizzati 
            WHERE codice_fiscale = ?
        ''', (data['codice_fiscale'],))
        row = cursor.fetchone()
        if not row:
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        if not row[0]:
            return jsonify({'success': False, 'error': 'Utente disattivato'}), 403
        
        # Verifica limite mensile
        cursor.execute('SELECT max_ingressi_mensili FROM limiti_accesso ORDER BY id DESC LIMIT 1')
        limite = cursor.fetchone()[0]
        
        cursor.execute('''
            SELECT numero_ingressi 
            FROM conteggio_ingressi_mensili
            WHERE codice_fiscale = ? AND mese = ? AND anno = ?
        ''', (data['codice_fiscale'], oggi.month, oggi.year))
        row = cursor.fetchone()
        ingressi_attuali = row[0] if row else 0
        
        if ingressi_attuali >= limite:
            # Disattiva utente
            cursor.execute('''
                UPDATE utenti_autorizzati 
                SET attivo = 0
                WHERE codice_fiscale = ?
            ''', (data['codice_fiscale'],))
            conn.commit()
            
            return jsonify({
                'success': False,
                'error': f'Limite mensile di {limite} ingressi raggiunto'
            }), 403
        
        # Incrementa contatore
        cursor.execute('''
            INSERT OR REPLACE INTO conteggio_ingressi_mensili 
            (codice_fiscale, mese, anno, numero_ingressi, ultimo_ingresso)
            VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        ''', (data['codice_fiscale'], oggi.month, oggi.year, ingressi_attuali + 1))
        
        # Registra accesso con dettagli simulazione
        cursor.execute('''
            INSERT INTO log_accessi 
            (timestamp, codice_fiscale, autorizzato, metodo_lettura, qualita_lettura, tipo_accesso)
            VALUES (CURRENT_TIMESTAMP, ?, 1, 'OMNIKEY_5427_G2', 100, 'simulazione')
        ''', (data['codice_fiscale'],))
        
        conn.commit()
        
        # Simula lettura tessera
        reader = CardReader()
        reader.last_cf = data['codice_fiscale']  # Simula lettura
        
        # Sollecita il relè come nella lettura reale
        controller = USBRLY08Controller()
        if controller.connect():
            # Segnala accesso autorizzato (LED Verde + Buzzer)
            controller.access_granted()
            
            # Apri cancello (disattiva blocco magnetico, attiva motore, riattiva blocco)
            controller.open_gate(8.0)  # 8 secondi
            
            controller.disconnect()
        
        return jsonify({
            'success': True,
            'message': f'Accesso autorizzato (ingresso {ingressi_attuali + 1}/{limite})',
            'details': {
                'lettore': 'OMNIKEY 5427 G2',
                'qualita_lettura': '100%',
                'apertura_rele': '8 secondi'
            }
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/configurazione/test/reset-contatore', methods=['POST'])
@require_auth()
@require_permission('all')
def reset_contatore():
    """Reset manuale contatore accessi mensili per un utente"""
    data = request.get_json()
    if not data or 'codice_fiscale' not in data:
        return jsonify({'success': False, 'error': 'Codice fiscale mancante'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        oggi = datetime.now()
        
        # Verifica esistenza utente
        cursor.execute('SELECT id FROM utenti_autorizzati WHERE codice_fiscale = ?', 
                      (data['codice_fiscale'],))
        if not cursor.fetchone():
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Archivia conteggio corrente
        cursor.execute('''
            INSERT INTO conteggio_ingressi_mensili_archive
            (codice_fiscale, mese, anno, numero_ingressi, ultimo_ingresso, data_archiviazione)
            SELECT codice_fiscale, mese, anno, numero_ingressi, ultimo_ingresso, CURRENT_TIMESTAMP
            FROM conteggio_ingressi_mensili
            WHERE codice_fiscale = ? AND mese = ? AND anno = ?
        ''', (data['codice_fiscale'], oggi.year, oggi.month))
        
        # Resetta conteggio
        cursor.execute('''
            DELETE FROM conteggio_ingressi_mensili 
            WHERE codice_fiscale = ? AND anno = ? AND mese = ?
        ''', (data['codice_fiscale'], oggi.year, oggi.month))
        
        # Riattiva utente
        cursor.execute('''
            UPDATE utenti_autorizzati 
            SET attivo = 1
            WHERE codice_fiscale = ?
        ''', (data['codice_fiscale'],))
        
        # Log forzatura
        log_forzatura(
            'RESET_CONTATORE',
            session.get('username'),
            f"Reset contatore per CF: {data['codice_fiscale']}"
        )
        
        conn.commit()
        return jsonify({'success': True, 'message': 'Contatore resettato e utente riattivato'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@configurazione_accessi_bp.route('/api/configurazione/test/apri-cancello', methods=['POST'])
@require_auth()
@require_permission('all')
def apri_cancello_forzato():
    """Apertura forzata cancello fuori orario"""
    import sys
    import os
    sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..')))
    from hardware.usb_rly08_controller import USBRLY08Controller
    
    if verifica_orario():
        return jsonify({'success': False, 'error': 'Cancello già apribile in orario normale'}), 400
    
    try:
        controller = USBRLY08Controller()
        if not controller.connect():
            return jsonify({'success': False, 'error': 'Impossibile connettersi al controller'}), 500
        
        # Apri cancello
        controller.open_gate(8.0)  # 8 secondi
        
        # Log forzatura
        log_forzatura(
            'APERTURA_FORZATA',
            session.get('username'),
            'Apertura cancello fuori orario'
        )
        
        return jsonify({'success': True, 'message': 'Cancello aperto'})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        if 'controller' in locals():
            controller.disconnect()

@configurazione_accessi_bp.route('/api/configurazione/log-forzature', methods=['GET'])
@require_auth()
@require_permission('all')
def get_log_forzature():
    """Ottiene log delle forzature"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        cursor.execute('''
            SELECT tipo, utente, timestamp, dettagli
            FROM log_forzature
            ORDER BY timestamp DESC
            LIMIT 100
        ''')
        
        log = []
        for row in cursor.fetchall():
            log.append({
                'tipo': row[0],
                'utente': row[1],
                'timestamp': row[2],
                'dettagli': row[3]
            })
        
        return jsonify({'success': True, 'log': log})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

```

---

## File: dispositivi.py

**Percorso:** `api/modules/dispositivi.py`
**Directory:** `api/modules`
**Dimensione:** 32991 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/dispositivi.py
# Modulo Configurazione Dispositivi - Dashboard

from flask import render_template_string, request, jsonify, session
from ..web_api import app, require_auth, require_permission, config_manager, get_base_template

# ===============================
# TEMPLATE DISPOSITIVI
# ===============================

DISPOSITIVI_TEMPLATE = get_base_template() + """
{% block title %}Configurazione Dispositivi - Sistema Controllo Accessi{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-microchip"></i> {{ island_name }}</h1>
    <div class="user-info">
        <div class="status-dot"></div>
        <span>{{ user_role_name }}</span>
        <span id="current-time"></span>
        <a href="/logout" class="btn btn-secondary btn-sm">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<div class="main-container">
    <div class="sidebar">
        <h3><i class="fas fa-bars"></i> Menu Principale</h3>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Panoramica</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/dispositivi" class="nav-link active">
                    <i class="fas fa-microchip"></i>
                    <span>Dispositivi</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/email" class="nav-link">
                    <i class="fas fa-envelope"></i>
                    <span>Email</span>
                </a>
            </li>
            {% if 'users' in permissions or 'all' in permissions %}
            <li class="nav-item">
                <a href="/utenti" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Utenti</span>
                </a>
            </li>
            {% endif %}
            <li class="nav-item">
                <a href="/log" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    <span>Log Accessi</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/allerte" class="nav-link">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Allerte</span>
                </a>
            </li>
            {% if 'all' in permissions %}
            <li class="nav-item">
                <a href="/sistema" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Sistema</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
    
    <div class="content">
        <h2><i class="fas fa-microchip"></i> Configurazione Dispositivi</h2>
        
        <!-- Test Connessioni -->
        <div class="card">
            <h4><i class="fas fa-network-wired"></i> Test Connessioni Hardware</h4>
            <div class="grid grid-3">
                <div>
                    <strong>Lettore Tessere CF</strong>
                    <div id="reader-test-status" class="mt-3">
                        <span class="loading">Test in corso...</span>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="testReader()">
                        <i class="fas fa-play"></i> Test Lettore
                    </button>
                </div>
                <div>
                    <strong>Modulo Relè USB-RLY08</strong>
                    <div id="relay-test-status" class="mt-3">
                        <span class="loading">Test in corso...</span>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="testRelay()">
                        <i class="fas fa-play"></i> Test Relè
                    </button>
                </div>
                <div>
                    <strong>Connessione Database</strong>
                    <div id="db-test-status" class="mt-3">
                        <span class="loading">Test in corso...</span>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="testDatabase()">
                        <i class="fas fa-play"></i> Test Database
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Configurazione Lettore CF -->
        <div class="card">
            <h4><i class="fas fa-id-card"></i> Configurazione Lettore Tessere</h4>
            <form id="reader-config-form">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="reader-type">Tipo Lettore</label>
                        <select class="form-control form-select" id="reader-type" name="tipo">
                            <option value="HID Omnikey 5427CK">HID Omnikey 5427CK</option>
                            <option value="HID Omnikey 3121">HID Omnikey 3121</option>
                            <option value="ACS ACR122U">ACS ACR122U</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reader-port">Porta Comunicazione</label>
                        <input type="text" class="form-control" id="reader-port" name="porta" placeholder="/dev/ttyACM0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reader-timeout">Timeout (secondi)</label>
                        <input type="number" class="form-control" id="reader-timeout" name="timeout" min="10" max="60" value="30">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reader-retry">Tentativi Retry</label>
                        <input type="number" class="form-control" id="reader-retry" name="retry_tentativi" min="1" max="10" value="3">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Salva Configurazione Lettore
                </button>
            </form>
        </div>
        
        <!-- Configurazione Relè -->
        <div class="card">
            <h4><i class="fas fa-toggle-on"></i> Configurazione Modulo Relè</h4>
            <form id="relay-config-form">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="relay-port">Porta USB</label>
                        <input type="text" class="form-control" id="relay-port" name="porta" placeholder="/dev/ttyUSB0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="relay-baud">Baud Rate</label>
                        <select class="form-control form-select" id="relay-baud" name="baud_rate">
                            <option value="9600">9600</option>
                            <option value="19200" selected>19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="relay-id">ID Modulo</label>
                        <input type="number" class="form-control" id="relay-id" name="modulo_id" min="1" max="255" value="8">
                    </div>
                </div>
                
                <h5 class="mt-3"><i class="fas fa-list"></i> Mapping Relè</h5>
                <div id="relay-mapping">
                    <!-- Caricato dinamicamente -->
                </div>
                
                <button type="submit" class="btn btn-success mt-3">
                    <i class="fas fa-save"></i> Salva Configurazione Relè
                </button>
            </form>
        </div>
        
        <!-- Test Individuali Relè -->
        <div class="card">
            <h4><i class="fas fa-flask"></i> Test Individuali Relè</h4>
            <p class="text-muted">Testa ogni relè individualmente per verificare le connessioni</p>
            <div id="relay-test-controls" class="grid grid-3">
                <!-- Caricato dinamicamente -->
            </div>
        </div>
        
        <!-- Log Diagnostici -->
        <div class="card">
            <h4><i class="fas fa-terminal"></i> Log Diagnostici</h4>
            <div class="form-group">
                <button class="btn btn-secondary" onclick="clearDiagnosticLog()">
                    <i class="fas fa-trash"></i> Pulisci Log
                </button>
                <button class="btn btn-primary" onclick="downloadDiagnosticLog()">
                    <i class="fas fa-download"></i> Scarica Log
                </button>
            </div>
            <div id="diagnostic-log" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85em;">
                <div class="loading">Caricamento log diagnostici...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let diagnosticLogInterval;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadDeviceConfigurations();
        loadRelayMapping();
        loadRelayTestControls();
        startDiagnosticLogUpdate();
        runInitialTests();
    });
    
    // Caricamento configurazioni iniziali
    async function loadDeviceConfigurations() {
        try {
            const response = await fetch('/api/devices/config');
            const data = await response.json();
            
            if (data.success) {
                // Popola form lettore
                document.getElementById('reader-type').value = data.reader.tipo || 'HID Omnikey 5427CK';
                document.getElementById('reader-port').value = data.reader.porta || '/dev/ttyACM0';
                document.getElementById('reader-timeout').value = data.reader.timeout || 30;
                document.getElementById('reader-retry').value = data.reader.retry_tentativi || 3;
                
                // Popola form relè
                document.getElementById('relay-port').value = data.relay.porta || '/dev/ttyUSB0';
                document.getElementById('relay-baud').value = data.relay.baud_rate || 19200;
                document.getElementById('relay-id').value = data.relay.modulo_id || 8;
            }
        } catch (error) {
            console.error('Errore caricamento configurazioni:', error);
        }
    }
    
    // Carica mapping relè
    async function loadRelayMapping() {
        try {
            const response = await fetch('/api/devices/relay-mapping');
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('relay-mapping');
                let html = '';
                
                for (let i = 1; i <= 6; i++) {
                    const relay = data.mapping[i] || {nome: `Relè ${i}`, durata_sec: 5};
                    html += `
                        <div class="grid grid-3 mb-3" style="align-items: end;">
                            <div class="form-group">
                                <label class="form-label">Relè ${i} - Nome</label>
                                <input type="text" class="form-control" 
                                       name="relay_${i}_nome" 
                                       value="${relay.nome}" 
                                       placeholder="Nome dispositivo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Durata Attivazione (sec)</label>
                                <input type="number" class="form-control" 
                                       name="relay_${i}_durata" 
                                       value="${relay.durata_sec}" 
                                       min="1" max="60">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-warning btn-sm" 
                                        onclick="testSingleRelay(${i})">
                                    <i class="fas fa-play"></i> Test
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }
        } catch (error) {
            console.error('Errore caricamento mapping relè:', error);
        }
    }
    
    // Carica controlli test relè
    async function loadRelayTestControls() {
        try {
            const response = await fetch('/api/devices/relay-mapping');
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('relay-test-controls');
                let html = '';
                
                for (let i = 1; i <= 6; i++) {
                    const relay = data.mapping[i] || {nome: `Relè ${i}`, durata_sec: 5};
                    html += `
                        <div class="card" style="padding: 15px;">
                            <strong>Relè ${i}</strong><br>
                            <small class="text-muted">${relay.nome}</small>
                            <div class="mt-2">
                                <button class="btn btn-success btn-sm" onclick="activateRelay(${i})">
                                    <i class="fas fa-power-off"></i> ON
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deactivateRelay(${i})">
                                    <i class="fas fa-power-off"></i> OFF
                                </button>
                            </div>
                            <div id="relay-${i}-status" class="mt-2">
                                <span class="status-badge status-offline">
                                    <i class="fas fa-circle"></i> Inattivo
                                </span>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }
        } catch (error) {
            console.error('Errore caricamento controlli test:', error);
        }
    }
    
    // Test iniziali automatici
    async function runInitialTests() {
        await testReader();
        await testRelay();
        await testDatabase();
    }
    
    // Test lettore tessere
    async function testReader() {
        const statusEl = document.getElementById('reader-test-status');
        statusEl.innerHTML = '<span class="loading">Test in corso...</span>';
        
        try {
            const response = await fetch('/api/devices/test/reader', {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                statusEl.innerHTML = `
                    <span class="status-badge status-online">
                        <i class="fas fa-check-circle"></i> Online
                    </span>
                    <br><small class="text-muted">${data.message}</small>
                `;
            } else {
                statusEl.innerHTML = `
                    <span class="status-badge status-offline">
                        <i class="fas fa-times-circle"></i> Offline
                    </span>
                    <br><small class="text-muted">${data.error}</small>
                `;
            }
        } catch (error) {
            statusEl.innerHTML = `
                <span class="status-badge status-offline">
                    <i class="fas fa-exclamation-triangle"></i> Errore
                </span>
                <br><small class="text-muted">Errore comunicazione</small>
            `;
        }
    }
    
    // Test modulo relè
    async function testRelay() {
        const statusEl = document.getElementById('relay-test-status');
        statusEl.innerHTML = '<span class="loading">Test in corso...</span>';
        
        try {
            const response = await fetch('/api/devices/test/relay', {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                statusEl.innerHTML = `
                    <span class="status-badge status-online">
                        <i class="fas fa-check-circle"></i> Online
                    </span>
                    <br><small class="text-muted">${data.message}</small>
                `;
            } else {
                statusEl.innerHTML = `
                    <span class="status-badge status-offline">
                        <i class="fas fa-times-circle"></i> Offline
                    </span>
                    <br><small class="text-muted">${data.error}</small>
                `;
            }
        } catch (error) {
            statusEl.innerHTML = `
                <span class="status-badge status-offline">
                    <i class="fas fa-exclamation-triangle"></i> Errore
                </span>
                <br><small class="text-muted">Errore comunicazione</small>
            `;
        }
    }
    
    // Test database
    async function testDatabase() {
        const statusEl = document.getElementById('db-test-status');
        statusEl.innerHTML = '<span class="loading">Test in corso...</span>';
        
        try {
            const response = await fetch('/api/devices/test/database', {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                statusEl.innerHTML = `
                    <span class="status-badge status-online">
                        <i class="fas fa-check-circle"></i> Online
                    </span>
                    <br><small class="text-muted">${data.message}</small>
                `;
            } else {
                statusEl.innerHTML = `
                    <span class="status-badge status-offline">
                        <i class="fas fa-times-circle"></i> Offline
                    </span>
                    <br><small class="text-muted">${data.error}</small>
                `;
            }
        } catch (error) {
            statusEl.innerHTML = `
                <span class="status-badge status-offline">
                    <i class="fas fa-exclamation-triangle"></i> Errore
                </span>
                <br><small class="text-muted">Errore comunicazione</small>
            `;
        }
    }
    
    // Test singolo relè
    async function testSingleRelay(relayNumber) {
        try {
            const response = await fetch(`/api/devices/test/relay/${relayNumber}`, {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                showAlert(`Relè ${relayNumber} testato con successo`, 'success');
            } else {
                showAlert(`Errore test relè ${relayNumber}: ${data.error}`, 'danger');
            }
        } catch (error) {
            showAlert(`Errore comunicazione test relè ${relayNumber}`, 'danger');
        }
    }
    
    // Attiva relè specifico
    async function activateRelay(relayNumber) {
        const statusEl = document.getElementById(`relay-${relayNumber}-status`);
        statusEl.innerHTML = '<span class="loading">Attivazione...</span>';
        
        try {
            const response = await fetch(`/api/devices/relay/${relayNumber}/on`, {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                statusEl.innerHTML = `
                    <span class="status-badge status-online">
                        <i class="fas fa-circle"></i> Attivo
                    </span>
                `;
                showAlert(`Relè ${relayNumber} attivato`, 'success');
            } else {
                statusEl.innerHTML = `
                    <span class="status-badge status-offline">
                        <i class="fas fa-circle"></i> Errore
                    </span>
                `;
                showAlert(`Errore attivazione relè ${relayNumber}`, 'danger');
            }
        } catch (error) {
            statusEl.innerHTML = `
                <span class="status-badge status-offline">
                    <i class="fas fa-circle"></i> Errore
                </span>
            `;
            showAlert('Errore comunicazione', 'danger');
        }
    }
    
    // Disattiva relè specifico
    async function deactivateRelay(relayNumber) {
        const statusEl = document.getElementById(`relay-${relayNumber}-status`);
        statusEl.innerHTML = '<span class="loading">Disattivazione...</span>';
        
        try {
            const response = await fetch(`/api/devices/relay/${relayNumber}/off`, {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                statusEl.innerHTML = `
                    <span class="status-badge status-offline">
                        <i class="fas fa-circle"></i> Inattivo
                    </span>
                `;
                showAlert(`Relè ${relayNumber} disattivato`, 'success');
            } else {
                statusEl.innerHTML = `
                    <span class="status-badge status-offline">
                        <i class="fas fa-circle"></i> Errore
                    </span>
                `;
                showAlert(`Errore disattivazione relè ${relayNumber}`, 'danger');
            }
        } catch (error) {
            statusEl.innerHTML = `
                <span class="status-badge status-offline">
                    <i class="fas fa-circle"></i> Errore
                </span>
            `;
            showAlert('Errore comunicazione', 'danger');
        }
    }
    
    // Salvataggio configurazione lettore
    document.getElementById('reader-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const config = {};
        for (let [key, value] of formData.entries()) {
            config[key] = value;
        }
        
        try {
            const response = await fetch('/api/devices/config/reader', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Configurazione lettore salvata con successo', 'success');
                await testReader(); // Ritest dopo salvataggio
            } else {
                showAlert('Errore salvataggio configurazione lettore', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    });
    
    // Salvataggio configurazione relè
    document.getElementById('relay-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const config = {
            porta: formData.get('porta'),
            baud_rate: parseInt(formData.get('baud_rate')),
            modulo_id: parseInt(formData.get('modulo_id')),
            mapping: {}
        };
        
        // Raccogli mapping relè
        for (let i = 1; i <= 6; i++) {
            config.mapping[i] = {
                nome: formData.get(`relay_${i}_nome`) || `Relè ${i}`,
                durata_sec: parseInt(formData.get(`relay_${i}_durata`)) || 5
            };
        }
        
        try {
            const response = await fetch('/api/devices/config/relay', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Configurazione relè salvata con successo', 'success');
                await testRelay(); // Ritest dopo salvataggio
                loadRelayTestControls(); // Ricarica controlli
            } else {
                showAlert('Errore salvataggio configurazione relè', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    });
    
    // Log diagnostici
    function startDiagnosticLogUpdate() {
        loadDiagnosticLog();
        diagnosticLogInterval = setInterval(loadDiagnosticLog, 3000);
    }
    
    async function loadDiagnosticLog() {
        try {
            const response = await fetch('/api/devices/diagnostic-log');
            const data = await response.json();
            
            if (data.success) {
                const logEl = document.getElementById('diagnostic-log');
                logEl.innerHTML = data.log.map(entry => 
                    `<div>${entry.timestamp} - ${entry.level} - ${entry.message}</div>`
                ).join('');
                
                // Auto-scroll al bottom
                logEl.scrollTop = logEl.scrollHeight;
            }
        } catch (error) {
            console.error('Errore caricamento log diagnostici:', error);
        }
    }
    
    async function clearDiagnosticLog() {
        if (confirm('Sei sicuro di voler cancellare il log diagnostico?')) {
            try {
                const response = await fetch('/api/devices/diagnostic-log', {method: 'DELETE'});
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Log diagnostico cancellato', 'success');
                    loadDiagnosticLog();
                } else {
                    showAlert('Errore cancellazione log', 'danger');
                }
            } catch (error) {
                showAlert('Errore comunicazione', 'danger');
            }
        }
    }
    
    async function downloadDiagnosticLog() {
        try {
            const response = await fetch('/api/devices/diagnostic-log/download');
            const blob = await response.blob();
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-log-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('Log diagnostico scaricato', 'success');
        } catch (error) {
            showAlert('Errore download log', 'danger');
        }
    }
    
    // Cleanup al cambio pagina
    window.addEventListener('beforeunload', function() {
        if (diagnosticLogInterval) {
            clearInterval(diagnosticLogInterval);
        }
    });
</script>
{% endblock %}
"""

# ===============================
# ROUTES DISPOSITIVI
# ===============================

@app.route('/dispositivi')
@require_auth
@require_permission('all')  # Solo admin
def dispositivi():
    """Pagina configurazione dispositivi"""
    nome_isola = config_manager.get('sistema.nome_isola', '')
    if not nome_isola:
        nome_isola = "Isola Ecologica"
    else:
        nome_isola = f"Isola Ecologica {nome_isola}"
    
    user_role = session.get('role', 'viewer')
    user_role_name = USER_ROLES.get(user_role, {}).get('name', 'Utente')
    permissions = session.get('permissions', [])
    
    return render_template_string(DISPOSITIVI_TEMPLATE, 
                                island_name=nome_isola,
                                user_role_name=user_role_name,
                                permissions=permissions)

# ===============================
# API ENDPOINTS DISPOSITIVI
# ===============================

@app.route('/api/devices/config')
@require_auth
def api_devices_config():
    """Ottieni configurazione dispositivi"""
    try:
        return jsonify({
            'success': True,
            'reader': config_manager.get('dispositivi.lettore_cf', {}),
            'relay': config_manager.get('dispositivi.rele', {})
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/devices/relay-mapping')
@require_auth
def api_relay_mapping():
    """Ottieni mapping relè"""
    try:
        mapping = config_manager.get('dispositivi.rele.mapping', {})
        return jsonify({
            'success': True,
            'mapping': mapping
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/devices/test/reader', methods=['POST'])
@require_auth
@require_permission('all')
def api_test_reader():
    """Test connessione lettore tessere"""
    try:
        # Testa connessione al lettore
        # Qui andrà integrato il codice del card_reader esistente
        
        return jsonify({
            'success': True,
            'message': 'Lettore operativo - OMNIKEY 5427CK'
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f'Errore lettore: {str(e)}'
        }), 500

@app.route('/api/devices/test/relay', methods=['POST'])
@require_auth
@require_permission('all')
def api_test_relay():
    """Test connessione modulo relè"""
    try:
        # Testa connessione al modulo relè
        # Qui andrà integrato il codice dell'USB-RLY08 esistente
        
        return jsonify({
            'success': True,
            'message': 'Modulo relè operativo - USB-RLY08'
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f'Errore relè: {str(e)}'
        }), 500

@app.route('/api/devices/test/database', methods=['POST'])
@require_auth
def api_test_database():
    """Test connessione database"""
    try:
        import sqlite3
        db_path = project_root / "src" / "access.db"
        
        with sqlite3.connect(str(db_path)) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT COUNT(*) FROM utenti_autorizzati")
            count = cursor.fetchone()[0]
        
        return jsonify({
            'success': True,
            'message': f'Database operativo - {count} utenti autorizzati'
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f'Errore database: {str(e)}'
        }), 500

@app.route('/api/devices/config/reader', methods=['POST'])
@require_auth
@require_permission('all')
def api_save_reader_config():
    """Salva configurazione lettore"""
    try:
        config = request.get_json()
        
        # Valida configurazione
        if not config.get('tipo') or not config.get('porta'):
            return jsonify({'success': False, 'error': 'Configurazione incompleta'}), 400
        
        # Salva configurazione
        for key, value in config.items():
            if key in ['timeout', 'retry_tentativi']:
                value = int(value)
            config_manager.set(f'dispositivi.lettore_cf.{key}', value)
        
        return jsonify({'success': True, 'message': 'Configurazione lettore salvata'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/devices/config/relay', methods=['POST'])
@require_auth
@require_permission('all')
def api_save_relay_config():
    """Salva configurazione relè"""
    try:
        config = request.get_json()
        
        # Valida configurazione
        if not config.get('porta') or not config.get('baud_rate'):
            return jsonify({'success': False, 'error': 'Configurazione incompleta'}), 400
        
        # Salva configurazione base
        config_manager.set('dispositivi.rele.porta', config['porta'])
        config_manager.set('dispositivi.rele.baud_rate', config['baud_rate'])
        config_manager.set('dispositivi.rele.modulo_id', config['modulo_id'])
        
        # Salva mapping
        if 'mapping' in config:
            config_manager.set('dispositivi.rele.mapping', config['mapping'])
        
        return jsonify({'success': True, 'message': 'Configurazione relè salvata'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

```

---

## File: email_log_allerte_sistema.py

**Percorso:** `api/modules/email_log_allerte_sistema.py`
**Directory:** `api/modules`
**Dimensione:** 34009 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/email_log_allerte_sistema.py
# Moduli Completi: Email, Log, Allerte, Sistema - Dashboard

from flask import render_template_string, request, jsonify, session, send_file
from datetime import datetime, timedelta
import sqlite3
import smtplib
import csv
import io
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from ..web_api import app, require_auth, require_permission, config_manager, get_base_template, USER_ROLES, project_root

# ===============================
# MODULO EMAIL - TEMPLATE
# ===============================

EMAIL_TEMPLATE = get_base_template() + """
{% block title %}Configurazione Email - Sistema Controllo Accessi{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-envelope"></i> {{ island_name }}</h1>
    <div class="user-info">
        <div class="status-dot"></div>
        <span>{{ user_role_name }}</span>
        <span id="current-time"></span>
        <a href="/logout" class="btn btn-secondary btn-sm">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<div class="main-container">
    <div class="sidebar">
        <h3><i class="fas fa-bars"></i> Menu Principale</h3>
        <ul class="nav-menu">
            <li class="nav-item"><a href="/" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Panoramica</span></a></li>
            <li class="nav-item"><a href="/dispositivi" class="nav-link"><i class="fas fa-microchip"></i><span>Dispositivi</span></a></li>
            <li class="nav-item"><a href="/email" class="nav-link active"><i class="fas fa-envelope"></i><span>Email</span></a></li>
            <li class="nav-item"><a href="/utenti" class="nav-link"><i class="fas fa-users"></i><span>Utenti</span></a></li>
            <li class="nav-item"><a href="/log" class="nav-link"><i class="fas fa-list-alt"></i><span>Log Accessi</span></a></li>
            <li class="nav-item"><a href="/allerte" class="nav-link"><i class="fas fa-exclamation-triangle"></i><span>Allerte</span></a></li>
            <li class="nav-item"><a href="/sistema" class="nav-link"><i class="fas fa-cog"></i><span>Sistema</span></a></li>
        </ul>
    </div>
    
    <div class="content">
        <h2><i class="fas fa-envelope-open-text"></i> Configurazione Sistema Email</h2>
        
        <!-- Test Connessione SMTP -->
        <div class="card">
            <h4><i class="fas fa-network-wired"></i> Test Connessione SMTP</h4>
            <div id="smtp-test-result" class="mb-3">
                <span class="loading">Test in corso...</span>
            </div>
            <button class="btn btn-primary" onclick="testSMTPConnection()">
                <i class="fas fa-play"></i> Testa Connessione
            </button>
            <button class="btn btn-success ml-2" onclick="sendTestEmail()">
                <i class="fas fa-paper-plane"></i> Invia Email di Test
            </button>
        </div>
        
        <!-- Configurazione SMTP -->
        <div class="card">
            <h4><i class="fas fa-server"></i> Configurazione Server SMTP</h4>
            <form id="smtp-config-form">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="smtp-server">Server SMTP</label>
                        <input type="text" class="form-control" id="smtp-server" name="smtp_server" placeholder="smtp.gmail.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="smtp-port">Porta</label>
                        <select class="form-control form-select" id="smtp-port" name="smtp_port">
                            <option value="25">25 (SMTP)</option>
                            <option value="587">587 (SMTP TLS)</option>
                            <option value="465">465 (SMTP SSL)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="email-mittente">Email Mittente</label>
                        <input type="email" class="form-control" id="email-mittente" name="mittente" placeholder="isola@comune.example.it">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="email-password">Password Email</label>
                        <input type="password" class="form-control" id="email-password" name="password" placeholder="Password o App Password">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Salva Configurazione SMTP
                </button>
            </form>
        </div>
        
        <!-- Destinatari Email -->
        <div class="card">
            <h4><i class="fas fa-address-book"></i> Gestione Destinatari</h4>
            <div class="form-group">
                <label class="form-label" for="new-recipient">Aggiungi Destinatario</label>
                <div style="display: flex; gap: 10px;">
                    <input type="email" class="form-control" id="new-recipient" placeholder="email@example.com">
                    <button class="btn btn-primary" onclick="addRecipient()">
                        <i class="fas fa-plus"></i> Aggiungi
                    </button>
                </div>
            </div>
            <div id="recipients-list" class="mt-3">
                <div class="loading">Caricamento destinatari...</div>
            </div>
        </div>
        
        <!-- Configurazione Report -->
        <div class="card">
            <h4><i class="fas fa-calendar-alt"></i> Report Automatici</h4>
            <form id="report-config-form">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="report-frequency">Frequenza Report</label>
                        <select class="form-control form-select" id="report-frequency" name="frequenza_report">
                            <option value="disabled">Disabilitato</option>
                            <option value="daily">Giornaliero</option>
                            <option value="weekly">Settimanale</option>
                            <option value="monthly">Mensile</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="report-time">Orario Invio</label>
                        <input type="time" class="form-control" id="report-time" name="orario_invio" value="08:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="report-include-stats" name="includi_statistiche" checked>
                        Includi statistiche accessi
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="report-include-errors" name="includi_errori" checked>
                        Includi log errori
                    </label>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Salva Configurazione Report
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadEmailConfig();
        loadRecipients();
        testSMTPConnection();
    });
    
    async function loadEmailConfig() {
        try {
            const response = await fetch('/api/email/config');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('smtp-server').value = data.config.smtp_server || '';
                document.getElementById('smtp-port').value = data.config.smtp_port || '587';
                document.getElementById('email-mittente').value = data.config.mittente || '';
                document.getElementById('email-password').value = ''; // Non mostrare password
                document.getElementById('report-frequency').value = data.config.frequenza_report || 'disabled';
                document.getElementById('report-time').value = data.config.orario_invio || '08:00';
                document.getElementById('report-include-stats').checked = data.config.includi_statistiche !== false;
                document.getElementById('report-include-errors').checked = data.config.includi_errori !== false;
            }
        } catch (error) {
            console.error('Errore caricamento configurazione email:', error);
        }
    }
    
    async function loadRecipients() {
        try {
            const response = await fetch('/api/email/recipients');
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('recipients-list');
                let html = '';
                
                data.recipients.forEach(email => {
                    html += `
                        <div class="alert alert-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span><i class="fas fa-envelope"></i> ${email}</span>
                            <button class="btn btn-danger btn-sm" onclick="removeRecipient('${email}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html || '<p class="text-muted">Nessun destinatario configurato</p>';
            }
        } catch (error) {
            console.error('Errore caricamento destinatari:', error);
        }
    }
    
    async function testSMTPConnection() {
        const resultEl = document.getElementById('smtp-test-result');
        resultEl.innerHTML = '<span class="loading">Test connessione SMTP...</span>';
        
        try {
            const response = await fetch('/api/email/test-smtp', {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                resultEl.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Connessione SMTP operativa
                        <br><small>${data.message}</small>
                    </div>
                `;
            } else {
                resultEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> Errore connessione SMTP
                        <br><small>${data.error}</small>
                    </div>
                `;
            }
        } catch (error) {
            resultEl.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Errore comunicazione
                </div>
            `;
        }
    }
    
    async function sendTestEmail() {
        try {
            const response = await fetch('/api/email/send-test', {method: 'POST'});
            const data = await response.json();
            
            if (data.success) {
                showAlert('Email di test inviata con successo', 'success');
            } else {
                showAlert(`Errore invio email: ${data.error}`, 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    }
    
    async function addRecipient() {
        const email = document.getElementById('new-recipient').value.trim();
        
        if (!email) {
            showAlert('Inserisci un indirizzo email valido', 'warning');
            return;
        }
        
        if (!email.includes('@')) {
            showAlert('Formato email non valido', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/email/add-recipient', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: email})
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Destinatario aggiunto', 'success');
                document.getElementById('new-recipient').value = '';
                loadRecipients();
            } else {
                showAlert(data.error, 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    }
    
    async function removeRecipient(email) {
        if (confirm(`Rimuovere ${email} dai destinatari?`)) {
            try {
                const response = await fetch('/api/email/remove-recipient', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Destinatario rimosso', 'success');
                    loadRecipients();
                } else {
                    showAlert(data.error, 'danger');
                }
            } catch (error) {
                showAlert('Errore comunicazione', 'danger');
            }
        }
    }
    
    // Salvataggio configurazioni
    document.getElementById('smtp-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const config = {};
        for (let [key, value] of formData.entries()) {
            config[key] = value;
        }
        
        try {
            const response = await fetch('/api/email/save-smtp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Configurazione SMTP salvata', 'success');
                testSMTPConnection();
            } else {
                showAlert('Errore salvataggio configurazione', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    });
    
    document.getElementById('report-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const config = {
            frequenza_report: formData.get('frequenza_report'),
            orario_invio: formData.get('orario_invio'),
            includi_statistiche: formData.get('includi_statistiche') === 'on',
            includi_errori: formData.get('includi_errori') === 'on'
        };
        
        try {
            const response = await fetch('/api/email/save-report-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Configurazione report salvata', 'success');
            } else {
                showAlert('Errore salvataggio configurazione', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    });
</script>
{% endblock %}
"""

# ===============================
# MODULO LOG ACCESSI - TEMPLATE
# ===============================

LOG_TEMPLATE = get_base_template() + """
{% block title %}Log Accessi - Sistema Controllo Accessi{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-list-alt"></i> {{ island_name }}</h1>
    <div class="user-info">
        <div class="status-dot"></div>
        <span>{{ user_role_name }}</span>
        <span id="current-time"></span>
        <a href="/logout" class="btn btn-secondary btn-sm">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<div class="main-container">
    <div class="sidebar">
        <h3><i class="fas fa-bars"></i> Menu Principale</h3>
        <ul class="nav-menu">
            <li class="nav-item"><a href="/" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Panoramica</span></a></li>
            <li class="nav-item"><a href="/dispositivi" class="nav-link"><i class="fas fa-microchip"></i><span>Dispositivi</span></a></li>
            <li class="nav-item"><a href="/email" class="nav-link"><i class="fas fa-envelope"></i><span>Email</span></a></li>
            <li class="nav-item"><a href="/utenti" class="nav-link"><i class="fas fa-users"></i><span>Utenti</span></a></li>
            <li class="nav-item"><a href="/log" class="nav-link active"><i class="fas fa-list-alt"></i><span>Log Accessi</span></a></li>
            <li class="nav-item"><a href="/allerte" class="nav-link"><i class="fas fa-exclamation-triangle"></i><span>Allerte</span></a></li>
            <li class="nav-item"><a href="/sistema" class="nav-link"><i class="fas fa-cog"></i><span>Sistema</span></a></li>
        </ul>
    </div>
    
    <div class="content">
        <h2><i class="fas fa-history"></i> Log Accessi Sistema</h2>
        
        <!-- Filtri e Ricerca -->
        <div class="card">
            <h4><i class="fas fa-filter"></i> Filtri e Ricerca</h4>
            <form id="filter-form">
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label" for="filter-date-from">Data Da</label>
                        <input type="date" class="form-control" id="filter-date-from" name="date_from">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="filter-date-to">Data A</label>
                        <input type="date" class="form-control" id="filter-date-to" name="date_to">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="filter-status">Stato Accesso</label>
                        <select class="form-control form-select" id="filter-status" name="status">
                            <option value="">Tutti</option>
                            <option value="1">Solo Autorizzati</option>
                            <option value="0">Solo Negati</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="filter-search">Ricerca (Nome/CF)</label>
                        <input type="text" class="form-control" id="filter-search" name="search" placeholder="Cerca per nome o codice fiscale">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="filter-limit">Risultati per pagina</label>
                        <select class="form-control form-select" id="filter-limit" name="limit">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Applica Filtri
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> Esporta Excel
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Configurazione Campi Visibili -->
        {% if 'all' in permissions %}
        <div class="card">
            <h4><i class="fas fa-eye"></i> Configurazione Campi Visibili</h4>
            <form id="fields-config-form">
                <div class="grid grid-3">
                    <label><input type="checkbox" name="fields" value="timestamp" checked> Data/Ora</label>
                    <label><input type="checkbox" name="fields" value="codice_fiscale" checked> Codice Fiscale</label>
                    <label><input type="checkbox" name="fields" value="autorizzato" checked> Stato Autorizzazione</label>
                    <label><input type="checkbox" name="fields" value="nome_cognome" checked> Nome Cognome</label>
                    <label><input type="checkbox" name="fields" value="comune" checked> Comune</label>
                    <label><input type="checkbox" name="fields" value="motivo_blocco"> Motivo Blocco</label>
                    <label><input type="checkbox" name="fields" value="tempo_elaborazione"> Tempo Elaborazione</label>
                    <label><input type="checkbox" name="fields" value="hardware_status"> Stato Hardware</label>
                    <label><input type="checkbox" name="fields" value="ip_address"> Indirizzo IP</label>
                </div>
                <button type="submit" class="btn btn-success mt-3">
                    <i class="fas fa-save"></i> Salva Configurazione Campi
                </button>
            </form>
        </div>
        {% endif %}
        
        <!-- Statistiche Rapide -->
        <div class="card">
            <h4><i class="fas fa-chart-bar"></i> Statistiche Periodo Selezionato</h4>
            <div id="log-stats" class="grid grid-4">
                <div class="loading">Caricamento statistiche...</div>
            </div>
        </div>
        
        <!-- Tabella Log Accessi -->
        <div class="card">
            <h4><i class="fas fa-table"></i> Log Accessi</h4>
            <div id="log-table-container">
                <div class="loading">Caricamento log accessi...</div>
            </div>
            
            <!-- Paginazione -->
            <div id="pagination" class="text-center mt-3">
                <!-- Caricata dinamicamente -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadLogFields();
        setDefaultDateRange();
        loadLogData();
        loadLogStats();
    });
    
    function setDefaultDateRange() {
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('filter-date-from').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('filter-date-to').value = today.toISOString().split('T')[0];
    }
    
    async function loadLogFields() {
        try {
            const response = await fetch('/api/log/fields-config');
            const data = await response.json();
            
            if (data.success) {
                const checkboxes = document.querySelectorAll('input[name="fields"]');
                checkboxes.forEach(cb => {
                    cb.checked = data.visible_fields.includes(cb.value);
                });
            }
        } catch (error) {
            console.error('Errore caricamento configurazione campi:', error);
        }
    }
    
    async function loadLogData(page = 1) {
        currentPage = page;
        
        try {
            const formData = new FormData(document.getElementById('filter-form'));
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value) params.append(key, value);
            }
            params.append('page', page);
            
            const response = await fetch(`/api/log/data?${params.toString()}`);
            const data = await response.json();
            
            if (data.success) {
                renderLogTable(data.logs, data.visible_fields);
                renderPagination(data.pagination);
                totalPages = data.pagination.total_pages;
            } else {
                document.getElementById('log-table-container').innerHTML = 
                    '<div class="alert alert-danger">Errore caricamento log</div>';
            }
        } catch (error) {
            console.error('Errore caricamento log:', error);
            document.getElementById('log-table-container').innerHTML = 
                '<div class="alert alert-danger">Errore comunicazione</div>';
        }
    }
    
    function renderLogTable(logs, visibleFields) {
        const container = document.getElementById('log-table-container');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Nessun log trovato per i filtri selezionati</div>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table"><thead><tr>';
        
        // Headers dinamici basati sui campi visibili
        if (visibleFields.includes('timestamp')) html += '<th>Data/Ora</th>';
        if (visibleFields.includes('codice_fiscale')) html += '<th>Codice Fiscale</th>';
        if (visibleFields.includes('nome_cognome')) html += '<th>Nome</th>';
        if (visibleFields.includes('autorizzato')) html += '<th>Stato</th>';
        if (visibleFields.includes('comune')) html += '<th>Comune</th>';
        if (visibleFields.includes('motivo_blocco')) html += '<th>Motivo</th>';
        if (visibleFields.includes('tempo_elaborazione')) html += '<th>Tempo (ms)</th>';
        
        html += '</tr></thead><tbody>';
        
        logs.forEach(log => {
            html += '<tr>';
            if (visibleFields.includes('timestamp')) {
                html += `<td><small>${new Date(log.timestamp).toLocaleString('it-IT')}</small></td>`;
            }
            if (visibleFields.includes('codice_fiscale')) {
                const maskedCF = log.codice_fiscale ? 
                    `${log.codice_fiscale.substr(0, 4)}***${log.codice_fiscale.substr(-4)}` : 
                    'N/A';
                html += `<td><small>${maskedCF}</small></td>`;
            }
            if (visibleFields.includes('nome_cognome')) {
                html += `<td>${log.nome_cognome || 'N/A'}</td>`;
            }
            if (visibleFields.includes('autorizzato')) {
                const status = log.autorizzato ? 
                    '<span class="status-badge status-online">✅ Autorizzato</span>' :
                    '<span class="status-badge status-offline">❌ Negato</span>';
                html += `<td>${status}</td>`;
            }
            if (visibleFields.includes('comune')) {
                html += `<td><small>${log.comune || 'N/A'}</small></td>`;
            }
            if (visibleFields.includes('motivo_blocco')) {
                html += `<td><small class="text-muted">${log.motivo_blocco || '-'}</small></td>`;
            }
            if (visibleFields.includes('tempo_elaborazione')) {
                html += `<td><small>${log.tempo_elaborazione || '-'}</small></td>`;
            }
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    function renderPagination(pagination) {
        const container = document.getElementById('pagination');
        
        if (pagination.total_pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<div class="btn-group">';
        
        // Precedente
        if (pagination.current_page > 1) {
            html += `<button class="btn btn-secondary" onclick="loadLogData(${pagination.current_page - 1})">
                        <i class="fas fa-chevron-left"></i> Precedente
                     </button>`;
        }
        
        // Numeri pagina
        const start = Math.max(1, pagination.current_page - 2);
        const end = Math.min(pagination.total_pages, pagination.current_page + 2);
        
        for (let i = start; i <= end; i++) {
            const active = i === pagination.current_page ? 'btn-primary' : 'btn-secondary';
            html += `<button class="btn ${active}" onclick="loadLogData(${i})">${i}</button>`;
        }
        
        // Successivo
        if (pagination.current_page < pagination.total_pages) {
            html += `<button class="btn btn-secondary" onclick="loadLogData(${pagination.current_page + 1})">
                        Successivo <i class="fas fa-chevron-right"></i>
                     </button>`;
        }
        
        html += '</div>';
        html += `<div class="mt-2"><small class="text-muted">
                    Pagina ${pagination.current_page} di ${pagination.total_pages} 
                    (${pagination.total_records} record totali)
                 </small></div>`;
        
        container.innerHTML = html;
    }
    
    async function loadLogStats() {
        try {
            const formData = new FormData(document.getElementById('filter-form'));
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value) params.append(key, value);
            }
            
            const response = await fetch(`/api/log/stats?${params.toString()}`);
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('log-stats');
                container.innerHTML = `
                    <div class="card text-center" style="padding: 15px;">
                        <strong>Totale Accessi</strong><br>
                        <span style="font-size: 1.5em; color: #667eea;">${data.stats.total}</span>
                    </div>
                    <div class="card text-center" style="padding: 15px;">
                        <strong>Autorizzati</strong><br>
                        <span style="font-size: 1.5em; color: #27ae60;">${data.stats.authorized}</span>
                    </div>
                    <div class="card text-center" style="padding: 15px;">
                        <strong>Negati</strong><br>
                        <span style="font-size: 1.5em; color: #e74c3c;">${data.stats.denied}</span>
                    </div>
                    <div class="card text-center" style="padding: 15px;">
                        <strong>Tasso Successo</strong><br>
                        <span style="font-size: 1.5em; color: #f39c12;">${data.stats.success_rate}%</span>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Errore caricamento statistiche:', error);
        }
    }
    
    function resetFilters() {
        document.getElementById('filter-form').reset();
        setDefaultDateRange();
        loadLogData(1);
        loadLogStats();
    }
    
    async function exportData() {
        try {
            const formData = new FormData(document.getElementById('filter-form'));
            const params = new URLSearchParams();
            
            for (let [key, value] of formData.entries()) {
                if (value) params.append(key, value);
            }
            params.append('export', 'excel');
            
            const response = await fetch(`/api/log/export?${params.toString()}`);
            const blob = await response.blob();
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `log-accessi-${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('Export completato', 'success');
        } catch (error) {
            showAlert('Errore durante export', 'danger');
        }
    }
    
    // Event listeners
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        loadLogData(1);
        loadLogStats();
    });
    
    document.getElementById('fields-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const visibleFields = formData.getAll('fields');
        
        try {
            const response = await fetch('/api/log/save-fields-config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({visible_fields: visibleFields})
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Configurazione campi salvata', 'success');
                loadLogData(currentPage);
            } else {
                showAlert('Errore salvataggio configurazione', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    });
</script>
{% endblock %}
"""

```

---

## File: log_management.py

**Percorso:** `api/modules/log_management.py`
**Directory:** `api/modules`
**Dimensione:** 9562 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/log_management.py
# Gestione log con export Excel - FIXED IMPORTS

from flask import Blueprint, request, jsonify, send_file, session
import sqlite3
import pandas as pd
import io
from datetime import datetime, timedelta
import os

log_management_bp = Blueprint('log_management', __name__)

# Database path
DB_PATH = os.path.join(os.path.dirname(__file__), '..', '..', 'access.db')

def get_db_connection():
    """Connessione database locale"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        return conn
    except Exception as e:
        print(f"Errore connessione DB: {e}")
        return None

def require_permission(*required_permissions):
    """Decorator per verificare permessi - versione locale"""
    def decorator(f):
        def wrapper(*args, **kwargs):
            if 'username' not in session:
                return jsonify({'error': 'Login richiesto'}), 401
                
            user_role = session.get('role', 'viewer')
            # Verifica permessi base per log
            if user_role in ['admin', 'user_manager', 'viewer']:
                return f(*args, **kwargs)
            else:
                return jsonify({'error': 'Permessi insufficienti'}), 403
        
        wrapper.__name__ = f.__name__
        return wrapper
    return decorator

@log_management_bp.route('/api/logs/search')
@require_permission('view_logs')
def search_logs():
    """Ricerca log con filtri"""
    # Parametri filtro
    date_from = request.args.get('date_from')
    date_to = request.args.get('date_to')
    status = request.args.get('status')  # 'all', 'authorized', 'denied'
    search_text = request.args.get('search', '')
    page = int(request.args.get('page', 1))
    per_page = int(request.args.get('per_page', 50))
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'error': 'Database non disponibile'}), 500
    
    try:
        # Query base
        query = """
            SELECT 
                la.timestamp,
                la.codice_fiscale,
                la.autorizzato,
                COALESCE(ua.nome || ' ' || ua.cognome, 'Sconosciuto') as nome_completo,
                ua.comune,
                la.durata_elaborazione,
                la.terminale_id
            FROM log_accessi la
            LEFT JOIN utenti_autorizzati ua ON la.codice_fiscale = ua.codice_fiscale
            WHERE 1=1
        """
        params = []
        
        # Applica filtri
        if date_from:
            query += " AND DATE(la.timestamp) >= ?"
            params.append(date_from)
        
        if date_to:
            query += " AND DATE(la.timestamp) <= ?"
            params.append(date_to)
        
        if status == 'authorized':
            query += " AND la.autorizzato = 1"
        elif status == 'denied':
            query += " AND la.autorizzato = 0"
        
        if search_text:
            query += " AND (la.codice_fiscale LIKE ? OR ua.nome LIKE ? OR ua.cognome LIKE ?)"
            search_param = f"%{search_text}%"
            params.extend([search_param, search_param, search_param])
        
        # Conta totale per paginazione
        count_query = f"SELECT COUNT(*) FROM ({query}) as filtered"
        cursor = conn.cursor()
        cursor.execute(count_query, params)
        total_count = cursor.fetchone()[0]
        
        # Aggiungi paginazione
        query += " ORDER BY la.timestamp DESC LIMIT ? OFFSET ?"
        params.extend([per_page, (page - 1) * per_page])
        
        # Esegui query
        cursor.execute(query, params)
        logs = []
        
        for row in cursor.fetchall():
            logs.append({
                'timestamp': row[0],
                'codice_fiscale': row[1],
                'autorizzato': bool(row[2]),
                'nome_completo': row[3],
                'comune': row[4] or 'N/D',
                'durata_elaborazione': row[5],
                'terminale_id': row[6]
            })
        
        return jsonify({
            'success': True,
            'logs': logs,
            'pagination': {
                'page': page,
                'per_page': per_page,
                'total': total_count,
                'pages': (total_count + per_page - 1) // per_page
            }
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500
    finally:
        conn.close()

@log_management_bp.route('/api/logs/export')
@require_permission('export_logs')
def export_logs():
    """Export log in Excel"""
    # Stessi filtri della ricerca
    date_from = request.args.get('date_from')
    date_to = request.args.get('date_to')
    status = request.args.get('status')
    search_text = request.args.get('search', '')
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'error': 'Database non disponibile'}), 500
    
    try:
        # Query senza paginazione per export
        query = """
            SELECT 
                la.timestamp as 'Data/Ora',
                la.codice_fiscale as 'Codice Fiscale',
                CASE WHEN la.autorizzato = 1 THEN 'Autorizzato' ELSE 'Negato' END as 'Stato',
                COALESCE(ua.nome || ' ' || ua.cognome, 'Sconosciuto') as 'Nome Completo',
                COALESCE(ua.comune, 'N/D') as 'Comune',
                COALESCE(la.durata_elaborazione, 0) as 'Tempo Elaborazione (ms)',
                COALESCE(la.terminale_id, 'N/D') as 'Terminale'
            FROM log_accessi la
            LEFT JOIN utenti_autorizzati ua ON la.codice_fiscale = ua.codice_fiscale
            WHERE 1=1
        """
        params = []
        
        # Applica stessi filtri
        if date_from:
            query += " AND DATE(la.timestamp) >= ?"
            params.append(date_from)
        
        if date_to:
            query += " AND DATE(la.timestamp) <= ?"
            params.append(date_to)
        
        if status == 'authorized':
            query += " AND la.autorizzato = 1"
        elif status == 'denied':
            query += " AND la.autorizzato = 0"
        
        if search_text:
            query += " AND (la.codice_fiscale LIKE ? OR ua.nome LIKE ? OR ua.cognome LIKE ?)"
            search_param = f"%{search_text}%"
            params.extend([search_param, search_param, search_param])
        
        query += " ORDER BY la.timestamp DESC"
        
        # Crea DataFrame
        df = pd.read_sql_query(query, conn, params=params)
        
        # Formatta date
        df['Data/Ora'] = pd.to_datetime(df['Data/Ora']).dt.strftime('%d/%m/%Y %H:%M:%S')
        
        # Crea Excel
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, sheet_name='Log Accessi', index=False)
            
            # Formatta colonne
            worksheet = writer.sheets['Log Accessi']
            for column in worksheet.columns:
                max_length = 0
                column_letter = column[0].column_letter
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = min(max_length + 2, 50)
                worksheet.column_dimensions[column_letter].width = adjusted_width
        
        output.seek(0)
        
        filename = f"log_accessi_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        
        return send_file(
            output,
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            as_attachment=True,
            download_name=filename
        )
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500
    finally:
        conn.close()

@log_management_bp.route('/api/logs/stats')
@require_permission('view_logs')
def get_log_stats():
    """Statistiche log per periodo"""
    date_from = request.args.get('date_from')
    date_to = request.args.get('date_to')
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Query statistiche
        query = """
            SELECT 
                COUNT(*) as totale,
                SUM(CASE WHEN autorizzato = 1 THEN 1 ELSE 0 END) as autorizzati,
                SUM(CASE WHEN autorizzato = 0 THEN 1 ELSE 0 END) as negati,
                AVG(durata_elaborazione) as tempo_medio
            FROM log_accessi
            WHERE 1=1
        """
        params = []
        
        if date_from:
            query += " AND DATE(timestamp) >= ?"
            params.append(date_from)
        
        if date_to:
            query += " AND DATE(timestamp) <= ?"
            params.append(date_to)
        
        cursor.execute(query, params)
        result = cursor.fetchone()
        
        stats = {
            'totale': result[0] or 0,
            'autorizzati': result[1] or 0,
            'negati': result[2] or 0,
            'tempo_medio': round(result[3] or 0, 2),
            'tasso_successo': 0
        }
        
        if stats['totale'] > 0:
            stats['tasso_successo'] = round((stats['autorizzati'] / stats['totale']) * 100, 1)
        
        return jsonify({'success': True, 'stats': stats})
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500
    finally:
        conn.close()
```

---

## File: profilo.py

**Percorso:** `api/modules/profilo.py`
**Directory:** `api/modules`
**Dimensione:** 4310 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/profilo.py
# Modulo per la gestione del profilo utente - FIXED IMPORTS

import logging
import hashlib
import os
from datetime import datetime
from flask import Blueprint, request, jsonify, session, render_template, redirect

logger = logging.getLogger(__name__)

# Blueprint per il modulo profilo
profilo_bp = Blueprint('profilo', __name__)

# Storage temporaneo per password modificate (in produzione usare DB)
temp_passwords = {}

def require_login(f):
    """Decorator per richiedere login"""
    def decorated_function(*args, **kwargs):
        if 'username' not in session:
            return redirect('/login')
        return f(*args, **kwargs)
    decorated_function.__name__ = f.__name__
    return decorated_function

def get_users():
    """Ottieni USERS dal modulo principale per evitare import circolari"""
    # Usa le credenziali di default hardcoded
    import hashlib
    return {
        'admin': {
            'password': hashlib.sha256('admin123'.encode()).hexdigest(), 
            'role': 'admin'
        },
        'manager': {
            'password': hashlib.sha256('manager123'.encode()).hexdigest(), 
            'role': 'user_manager'
        },
        'viewer': {
            'password': hashlib.sha256('viewer123'.encode()).hexdigest(), 
            'role': 'viewer'
        }
    }

@profilo_bp.route('/profilo')
@require_login
def profilo_redirect():
    """Redirect alla dashboard con apertura automatica del profilo"""
    return redirect('/?show_profile=true')
    
@profilo_bp.route('/api/profile/info')
@require_login
def api_profile_info():
    """API per ottenere informazioni profilo"""
    try:
        return jsonify({
            'success': True,
            'user': {
                'username': session.get('username'),
                'role': session.get('role'),
                'login_time': session.get('login_time', '')
            }
        })
    except Exception as e:
        logger.error(f"Errore recupero info profilo: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500

@profilo_bp.route('/api/profile/change-password', methods=['POST'])
@require_login
def api_change_password():
    """API per cambio password"""
    try:
        data = request.get_json()
        
        current_password = data.get('current_password', '').strip()
        new_password = data.get('new_password', '').strip()
        confirm_password = data.get('confirm_password', '').strip()
        
        username = session.get('username')
        
        # Validazioni
        if not all([current_password, new_password, confirm_password]):
            return jsonify({'success': False, 'error': 'Tutti i campi sono richiesti'}), 400
        
        if new_password != confirm_password:
            return jsonify({'success': False, 'error': 'Le password non coincidono'}), 400
        
        if len(new_password) < 6:
            return jsonify({'success': False, 'error': 'La password deve essere di almeno 6 caratteri'}), 400
        
        # Verifica password attuale
        # Prima controlla se c'è una password temporanea modificata
        if username in temp_passwords:
            current_hash = temp_passwords[username]
        else:
            # Altrimenti usa la password di default dal sistema
            USERS = get_users()
            if username not in USERS:
                return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
            current_hash = USERS[username]['password']
        
        # Verifica la password attuale
        if hashlib.sha256(current_password.encode()).hexdigest() != current_hash:
            return jsonify({'success': False, 'error': 'Password attuale non corretta'}), 400
        
        # Salva la nuova password (temporaneamente in memoria)
        new_hash = hashlib.sha256(new_password.encode()).hexdigest()
        temp_passwords[username] = new_hash
        
        logger.info(f"Password cambiata per utente: {username}")
        
        return jsonify({
            'success': True, 
            'message': 'Password aggiornata con successo (temporaneamente)'
        })
        
    except Exception as e:
        logger.error(f"Errore cambio password: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500
```

---

## File: system_users.py

**Percorso:** `api/modules/system_users.py`
**Directory:** `api/modules`
**Dimensione:** 7918 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
from flask import Blueprint, jsonify, request, session
import hashlib
import sqlite3
import os

# Import delle funzioni di utilità
from ..auth import USER_ROLES
from ..utils import get_db_connection, require_auth, require_permission

system_users_bp = Blueprint('system_users', __name__)

@system_users_bp.route('/api/users/list')
@require_auth()
def api_users_list():
    """Lista utenti di sistema"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    try:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT 
                username,
                role,
                attivo,
                DATETIME(created_at, 'localtime') as created_at,
                created_by,
                DATETIME(modified_at, 'localtime') as modified_at,
                modified_by,
                DATETIME(last_login, 'localtime') as last_login
            FROM utenti_sistema
            ORDER BY username
        """)
        users = []
        for row in cursor.fetchall():
            role = row[1]
            users.append({
                'username': row[0],
                'role': role,
                'role_name': USER_ROLES.get(role, {}).get('name', role),
                'attivo': bool(row[2]),
                'created_at': row[3],
                'created_by': row[4] or 'system',
                'modified_at': row[5],
                'modified_by': row[6],
                'last_login': row[7] or 'Mai'
            })
        return jsonify({'success': True, 'users': users})
    finally:
        conn.close()

@system_users_bp.route('/api/users/create', methods=['POST'])
@require_auth()
@require_permission('all')
def api_users_create():
    """Crea nuovo utente di sistema"""
    data = request.get_json()
    username = data.get('username', '').strip()
    password = data.get('password', '').strip()
    role = data.get('role', '').strip()
    
    if not username or not password or not role:
        return jsonify({'success': False, 'error': 'Dati mancanti'}), 400
    
    if role not in USER_ROLES:
        return jsonify({'success': False, 'error': 'Ruolo non valido'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Verifica se username esiste già
        cursor.execute("SELECT 1 FROM utenti_sistema WHERE username = ?", (username,))
        if cursor.fetchone():
            return jsonify({'success': False, 'error': 'Username già esistente'}), 400
        
        # Inserisci nuovo utente
        password_hash = hashlib.sha256(password.encode()).hexdigest()
        cursor.execute("""
            INSERT INTO utenti_sistema (
                username, password, role, attivo, 
                created_at, created_by, last_login
            ) VALUES (?, ?, ?, 1, CURRENT_TIMESTAMP, ?, NULL)
        """, (username, password_hash, role, session.get('username')))
        
        # Log creazione utente
        cursor.execute("""
            INSERT INTO eventi_sistema (tipo_evento, livello, messaggio, componente)
            VALUES (?, ?, ?, ?)
        """, ('USER_CREATE', 'INFO', f'Creato nuovo utente {username} con ruolo {USER_ROLES[role]["name"]}', 'USER_MGMT'))
        
        conn.commit()
        return jsonify({
            'success': True,
            'message': f'Utente {username} creato con ruolo {USER_ROLES[role]["name"]}',
            'username': username,
            'password': password
        })
    finally:
        conn.close()

@system_users_bp.route('/api/users/update', methods=['POST'])
@require_auth()
@require_permission('all')
def api_users_update():
    """Aggiorna dati utente di sistema (ruolo, stato, password)"""
    data = request.get_json()
    username = data.get('username', '').strip()
    role = data.get('role', '').strip() if data.get('role') else None
    attivo = data.get('attivo')
    password = data.get('password', '').strip() if data.get('password') else None
    
    if not username:
        return jsonify({'success': False, 'error': 'Username mancante'}), 400
    
    if role and role not in USER_ROLES:
        return jsonify({'success': False, 'error': 'Ruolo non valido'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Verifica se utente esiste
        cursor.execute("SELECT 1 FROM utenti_sistema WHERE username = ?", (username,))
        if not cursor.fetchone():
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Aggiorna i campi specificati
        updates = []
        params = []
        
        if role is not None:
            updates.append("role = ?")
            params.append(role)
        
        if attivo is not None:
            updates.append("attivo = ?")
            params.append(int(attivo))
        
        if password:
            password_hash = hashlib.sha256(password.encode()).hexdigest()
            updates.append("password = ?")
            params.append(password_hash)
            
            # Log cambio password
            cursor.execute("""
                INSERT INTO eventi_sistema (tipo_evento, livello, messaggio, componente)
                VALUES (?, ?, ?, ?)
            """, ('PASSWORD_CHANGE', 'INFO', f'Modificata password utente {username}', 'USER_MGMT'))
        
        if updates:
            query = f"""
                UPDATE utenti_sistema 
                SET {', '.join(updates)},
                    modified_at = CURRENT_TIMESTAMP,
                    modified_by = ?
                WHERE username = ?
            """
            params.extend([session.get('username'), username])
            cursor.execute(query, params)
            conn.commit()
            
            return jsonify({
                'success': True,
                'message': f'Utente {username} aggiornato',
                'password': password if password else None
            })
        else:
            return jsonify({'success': False, 'error': 'Nessun dato da aggiornare'}), 400
    finally:
        conn.close()

@system_users_bp.route('/api/users/delete', methods=['POST'])
@require_auth()
@require_permission('all')
def api_users_delete():
    """Elimina utente di sistema"""
    data = request.get_json()
    username = data.get('username', '').strip()
    
    if not username:
        return jsonify({'success': False, 'error': 'Username mancante'}), 400
    
    # Non permettere di eliminare l'utente corrente
    if username == session.get('username'):
        return jsonify({'success': False, 'error': 'Non puoi eliminare il tuo utente'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Verifica se utente esiste
        cursor.execute("SELECT role FROM utenti_sistema WHERE username = ?", (username,))
        user = cursor.fetchone()
        if not user:
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Elimina utente
        cursor.execute("DELETE FROM utenti_sistema WHERE username = ?", (username,))
        
        # Log eliminazione utente
        cursor.execute("""
            INSERT INTO eventi_sistema (tipo_evento, livello, messaggio, componente)
            VALUES (?, ?, ?, ?)
        """, ('USER_DELETE', 'WARNING', f'Eliminato utente {username}', 'USER_MGMT'))
        
        conn.commit()
        
        return jsonify({
            'success': True,
            'message': f'Utente {username} eliminato'
        })
    finally:
        conn.close()

```

---

## File: user_management.py

**Percorso:** `api/modules/user_management.py`
**Directory:** `api/modules`
**Dimensione:** 7855 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/user_management.py
from flask import Blueprint, render_template_string, request, jsonify, session
from functools import wraps
import sqlite3
import os
import hashlib
from datetime import datetime

# Import auth per i decoratori
from ..utils import require_auth, require_permission
from ..auth import USER_ROLES

user_management_bp = Blueprint('user_management', __name__)

# Database path
DB_PATH = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 'access.db')

def get_db_connection():
    """Connessione al database"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        return conn
    except Exception as e:
        print(f"Errore connessione DB: {e}")
        return None

@user_management_bp.route('/admin/users')
@require_auth()
@require_permission('all')
def admin_users():
    """Gestione completa utenti - Solo Admin"""
    with open(os.path.join(os.path.dirname(os.path.dirname(__file__)), 
              'static', 'html', 'user-management.html'), 'r') as f:
        template = f.read()
    return render_template_string(template, session=session)

@user_management_bp.route('/api/users/list')
@require_auth()
@require_permission('all')
def api_users_list():
    """Lista utenti di sistema"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    try:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT 
                username,
                role,
                attivo,
                DATETIME(created_at, 'localtime') as created_at,
                created_by,
                DATETIME(modified_at, 'localtime') as modified_at,
                modified_by,
                DATETIME(last_login, 'localtime') as last_login
            FROM utenti_sistema
            ORDER BY username
        """)
        users = []
        for row in cursor.fetchall():
            role = row['role']
            users.append({
                'username': row['username'],
                'role': role,
                'role_name': USER_ROLES.get(role, {}).get('name', role),
                'attivo': bool(row['attivo']),
                'created_at': row['created_at'],
                'created_by': row['created_by'] or 'system',
                'modified_at': row['modified_at'],
                'modified_by': row['modified_by'],
                'last_login': row['last_login'] or 'Mai'
            })
        return jsonify({'success': True, 'users': users})
    finally:
        conn.close()

@user_management_bp.route('/api/users/create', methods=['POST'])
@require_auth()
@require_permission('all')
def api_users_create():
    """Crea nuovo utente di sistema"""
    data = request.get_json()
    username = data.get('username', '').strip()
    password = data.get('password', '').strip()
    role = data.get('role', '').strip()
    
    if not username or not password or not role:
        return jsonify({'success': False, 'error': 'Dati mancanti'}), 400
    
    if role not in USER_ROLES:
        return jsonify({'success': False, 'error': 'Ruolo non valido'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Verifica se username esiste già
        cursor.execute("SELECT 1 FROM utenti_sistema WHERE username = ?", (username,))
        if cursor.fetchone():
            return jsonify({'success': False, 'error': 'Username già esistente'}), 400
        
        # Inserisci nuovo utente
        password_hash = hashlib.sha256(password.encode()).hexdigest()
        cursor.execute("""
            INSERT INTO utenti_sistema (
                username, password, role, attivo, 
                created_at, created_by, last_login
            ) VALUES (?, ?, ?, 1, CURRENT_TIMESTAMP, ?, NULL)
        """, (username, password_hash, role, session.get('username')))
        
        conn.commit()
        return jsonify({
            'success': True,
            'message': f'Utente {username} creato con ruolo {USER_ROLES[role]["name"]}'
        })
    finally:
        conn.close()

@user_management_bp.route('/api/users/update', methods=['POST'])
@require_auth()
@require_permission('all')
def api_users_update():
    """Aggiorna dati utente di sistema (ruolo, stato, password)"""
    data = request.get_json()
    username = data.get('username', '').strip()
    role = data.get('role', '').strip() if data.get('role') else None
    attivo = data.get('attivo')
    password = data.get('password', '').strip() if data.get('password') else None
    
    if not username:
        return jsonify({'success': False, 'error': 'Username mancante'}), 400
    
    if role and role not in USER_ROLES:
        return jsonify({'success': False, 'error': 'Ruolo non valido'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Verifica se utente esiste
        cursor.execute("SELECT 1 FROM utenti_sistema WHERE username = ?", (username,))
        if not cursor.fetchone():
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Aggiorna i campi specificati
        updates = []
        params = []
        
        if role is not None:
            updates.append("role = ?")
            params.append(role)
        
        if attivo is not None:
            updates.append("attivo = ?")
            params.append(int(attivo))
        
        if password:
            updates.append("password = ?")
            params.append(hashlib.sha256(password.encode()).hexdigest())
        
        if updates:
            query = f"""
                UPDATE utenti_sistema 
                SET {', '.join(updates)},
                    modified_at = CURRENT_TIMESTAMP,
                    modified_by = ?
                WHERE username = ?
            """
            params.extend([session.get('username'), username])
            cursor.execute(query, params)
            conn.commit()
            
            return jsonify({
                'success': True,
                'message': f'Utente {username} aggiornato'
            })
        else:
            return jsonify({'success': False, 'error': 'Nessun dato da aggiornare'}), 400
    finally:
        conn.close()

@user_management_bp.route('/api/users/delete', methods=['POST'])
@require_auth()
@require_permission('all')
def api_users_delete():
    """Elimina utente di sistema"""
    data = request.get_json()
    username = data.get('username', '').strip()
    
    if not username:
        return jsonify({'success': False, 'error': 'Username mancante'}), 400
    
    # Non permettere di eliminare l'utente corrente
    if username == session.get('username'):
        return jsonify({'success': False, 'error': 'Non puoi eliminare il tuo utente'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Verifica se utente esiste
        cursor.execute("SELECT role FROM utenti_sistema WHERE username = ?", (username,))
        user = cursor.fetchone()
        if not user:
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Elimina utente
        cursor.execute("DELETE FROM utenti_sistema WHERE username = ?", (username,))
        conn.commit()
        
        return jsonify({
            'success': True,
            'message': f'Utente {username} eliminato'
        })
    finally:
        conn.close()

```

---

## File: utenti.py

**Percorso:** `api/modules/utenti.py`
**Directory:** `api/modules`
**Dimensione:** 31501 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/utenti.py
# Modulo Gestione Utenti con 3 Livelli - Dashboard

from flask import render_template_string, request, jsonify, session
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime
from ..web_api import app, require_auth, require_permission, config_manager, get_base_template, USER_ROLES

# ===============================
# TEMPLATE GESTIONE UTENTI
# ===============================

UTENTI_TEMPLATE = get_base_template() + """
{% block title %}Gestione Utenti - Sistema Controllo Accessi{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-users"></i> {{ island_name }}</h1>
    <div class="user-info">
        <div class="status-dot"></div>
        <span>{{ user_role_name }}</span>
        <span id="current-time"></span>
        <a href="/logout" class="btn btn-secondary btn-sm">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<div class="main-container">
    <div class="sidebar">
        <h3><i class="fas fa-bars"></i> Menu Principale</h3>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Panoramica</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/dispositivi" class="nav-link">
                    <i class="fas fa-microchip"></i>
                    <span>Dispositivi</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/email" class="nav-link">
                    <i class="fas fa-envelope"></i>
                    <span>Email</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/utenti" class="nav-link active">
                    <i class="fas fa-users"></i>
                    <span>Utenti</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/log" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    <span>Log Accessi</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/allerte" class="nav-link">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Allerte</span>
                </a>
            </li>
            {% if 'all' in permissions %}
            <li class="nav-item">
                <a href="/sistema" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Sistema</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
    
    <div class="content">
        <h2><i class="fas fa-users-cog"></i> Gestione Utenti Dashboard</h2>
        
        <!-- Informazioni Ruoli -->
        <div class="card">
            <h4><i class="fas fa-info-circle"></i> Livelli Utenti Sistema</h4>
            <div class="grid grid-3">
                <div class="alert alert-info">
                    <strong><i class="fas fa-crown"></i> Amministratore</strong><br>
                    <small>Accesso completo a tutte le funzioni. Può gestire utenti, configurazioni e sistema.</small>
                </div>
                <div class="alert alert-warning">
                    <strong><i class="fas fa-user-tie"></i> Gestore Utenti</strong><br>
                    <small>Può gestire utenti, visualizzare log e configurare email. No accesso configurazioni hardware.</small>
                </div>
                <div class="alert alert-success">
                    <strong><i class="fas fa-eye"></i> Solo Visualizzazione</strong><br>
                    <small>Può solo visualizzare panoramica e log accessi. Nessuna modifica consentita.</small>
                </div>
            </div>
        </div>
        
        <!-- Nuovo Utente -->
        {% if 'all' in permissions or 'users' in permissions %}
        <div class="card">
            <h4><i class="fas fa-user-plus"></i> Aggiungi Nuovo Utente</h4>
            <form id="new-user-form">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="new-username">Username</label>
                        <input type="text" class="form-control" id="new-username" name="username" 
                               required minlength="3" maxlength="20" 
                               pattern="[a-zA-Z0-9_]+" 
                               placeholder="Username (solo lettere, numeri, _)">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-password">Password</label>
                        <input type="password" class="form-control" id="new-password" name="password" 
                               required minlength="6" placeholder="Password (min 6 caratteri)">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-password-confirm">Conferma Password</label>
                        <input type="password" class="form-control" id="new-password-confirm" name="password_confirm" 
                               required placeholder="Ripeti password">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-role">Ruolo Utente</label>
                        <select class="form-control form-select" id="new-role" name="role" required>
                            {% if 'all' in permissions %}
                            <option value="admin">👑 Amministratore</option>
                            {% endif %}
                            <option value="manager">👔 Gestore Utenti</option>
                            <option value="viewer">👁️ Solo Visualizzazione</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="new-note">Note (opzionale)</label>
                    <input type="text" class="form-control" id="new-note" name="note" 
                           placeholder="Note aggiuntive sull'utente">
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-user-plus"></i> Crea Utente
                </button>
            </form>
        </div>
        {% endif %}
        
        <!-- Lista Utenti Esistenti -->
        <div class="card">
            <h4><i class="fas fa-list"></i> Utenti Esistenti</h4>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Ruolo</th>
                            <th>Ultimo Accesso</th>
                            <th>Stato</th>
                            <th>Note</th>
                            {% if 'all' in permissions or 'users' in permissions %}
                            <th>Azioni</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="6" class="text-center">
                                <span class="loading">Caricamento utenti...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Statistiche Accessi Utenti -->
        <div class="card">
            <h4><i class="fas fa-chart-pie"></i> Statistiche Accessi per Ruolo</h4>
            <div id="user-stats" class="grid grid-3">
                <div class="loading">Caricamento statistiche...</div>
            </div>
        </div>
        
        <!-- Log Attività Utenti Dashboard -->
        <div class="card">
            <h4><i class="fas fa-history"></i> Log Attività Dashboard</h4>
            <p class="text-muted">Ultime attività degli utenti sulla dashboard amministrativa</p>
            <div id="dashboard-activity-log">
                <div class="loading">Caricamento log attività...</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modifica Utente -->
<div id="edit-user-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; margin: 5% auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4><i class="fas fa-user-edit"></i> Modifica Utente</h4>
            <button onclick="closeEditModal()" style="border: none; background: none; font-size: 1.5em; cursor: pointer;">&times;</button>
        </div>
        
        <form id="edit-user-form">
            <input type="hidden" id="edit-username" name="username">
            
            <div class="form-group">
                <label class="form-label" for="edit-new-password">Nuova Password (lascia vuoto per non modificare)</label>
                <input type="password" class="form-control" id="edit-new-password" name="new_password" 
                       minlength="6" placeholder="Nuova password">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="edit-role">Ruolo</label>
                <select class="form-control form-select" id="edit-role" name="role">
                    {% if 'all' in permissions %}
                    <option value="admin">👑 Amministratore</option>
                    {% endif %}
                    <option value="manager">👔 Gestore Utenti</option>
                    <option value="viewer">👁️ Solo Visualizzazione</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="edit-note">Note</label>
                <input type="text" class="form-control" id="edit-note" name="note" placeholder="Note">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="edit-active" name="active" checked>
                    Utente attivo
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Salva Modifiche
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Overlay Modal -->
<div id="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;"></div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
        loadUserStats();
        loadDashboardActivityLog();
    });
    
    // Carica lista utenti
    async function loadUsers() {
        try {
            const response = await fetch('/api/users/list');
            const data = await response.json();
            
            if (data.success) {
                const tbody = document.getElementById('users-table-body');
                let html = '';
                
                data.users.forEach(user => {
                    const roleInfo = getRoleInfo(user.ruolo);
                    const lastAccess = user.ultimo_accesso ? 
                        new Date(user.ultimo_accesso).toLocaleString('it-IT') : 
                        'Mai';
                    
                    html += `
                        <tr>
                            <td>
                                <strong>${user.username}</strong>
                                ${user.username === '{{ session.username }}' ? '<small class="text-muted">(Tu)</small>' : ''}
                            </td>
                            <td>
                                <span class="status-badge ${roleInfo.class}">
                                    ${roleInfo.icon} ${roleInfo.name}
                                </span>
                            </td>
                            <td><small>${lastAccess}</small></td>
                            <td>
                                <span class="status-badge ${user.attivo ? 'status-online' : 'status-offline'}">
                                    ${user.attivo ? '✅ Attivo' : '❌ Inattivo'}
                                </span>
                            </td>
                            <td><small class="text-muted">${user.note || '-'}</small></td>
                            {% if 'all' in permissions or 'users' in permissions %}
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editUser('${user.username}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${user.username !== '{{ session.username }}' ? `
                                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                            {% endif %}
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="6" class="text-center text-muted">Nessun utente trovato</td></tr>';
            }
        } catch (error) {
            console.error('Errore caricamento utenti:', error);
            document.getElementById('users-table-body').innerHTML = 
                '<tr><td colspan="6" class="text-center text-muted">Errore caricamento</td></tr>';
        }
    }
    
    function getRoleInfo(role) {
        const roles = {
            'admin': { name: 'Amministratore', icon: '👑', class: 'status-warning' },
            'manager': { name: 'Gestore Utenti', icon: '👔', class: 'status-online' },
            'viewer': { name: 'Solo Visualizzazione', icon: '👁️', class: 'status-offline' }
        };
        return roles[role] || { name: 'Sconosciuto', icon: '❓', class: 'status-offline' };
    }
    
    // Carica statistiche utenti
    async function loadUserStats() {
        try {
            const response = await fetch('/api/users/stats');
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('user-stats');
                let html = '';
                
                Object.entries(data.stats).forEach(([role, count]) => {
                    const roleInfo = getRoleInfo(role);
                    html += `
                        <div class="card" style="padding: 15px; text-align: center;">
                            <strong>${roleInfo.icon} ${roleInfo.name}</strong><br>
                            <span style="font-size: 1.5em; color: #667eea;">${count}</span><br>
                            <small class="text-muted">utenti</small>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        } catch (error) {
            console.error('Errore caricamento statistiche:', error);
        }
    }
    
    // Carica log attività dashboard
    async function loadDashboardActivityLog() {
        try {
            const response = await fetch('/api/users/dashboard-activity');
            const data = await response.json();
            
            if (data.success && data.activities.length > 0) {
                const container = document.getElementById('dashboard-activity-log');
                let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Orario</th><th>Utente</th><th>Azione</th></tr></thead><tbody>';
                
                data.activities.forEach(activity => {
                    html += `
                        <tr>
                            <td><small>${new Date(activity.timestamp).toLocaleString('it-IT')}</small></td>
                            <td>${activity.username}</td>
                            <td><small>${activity.action}</small></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                document.getElementById('dashboard-activity-log').innerHTML = 
                    '<p class="text-muted">Nessuna attività recente</p>';
            }
        } catch (error) {
            console.error('Errore caricamento log attività:', error);
        }
    }
    
    // Nuovo utente
    document.getElementById('new-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const password = formData.get('password');
        const passwordConfirm = formData.get('password_confirm');
        
        if (password !== passwordConfirm) {
            showAlert('Le password non corrispondono', 'danger');
            return;
        }
        
        const userData = {
            username: formData.get('username'),
            password: password,
            role: formData.get('role'),
            note: formData.get('note') || ''
        };
        
        try {
            const response = await fetch('/api/users/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(userData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Utente creato con successo', 'success');
                this.reset();
                loadUsers();
                loadUserStats();
            } else {
                showAlert(data.error || 'Errore creazione utente', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    });
    
    // Modifica utente
    async function editUser(username) {
        try {
            const response = await fetch(`/api/users/get/${username}`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('edit-username').value = username;
                document.getElementById('edit-role').value = data.user.ruolo;
                document.getElementById('edit-note').value = data.user.note || '';
                document.getElementById('edit-active').checked = data.user.attivo;
                document.getElementById('edit-new-password').value = '';
                
                showEditModal();
            } else {
                showAlert('Errore caricamento dati utente', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    }
    
    function showEditModal() {
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('edit-user-modal').style.display = 'block';
    }
    
    function closeEditModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('edit-user-modal').style.display = 'none';
    }
    
    // Salva modifiche utente
    document.getElementById('edit-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const userData = {
            username: formData.get('username'),
            role: formData.get('role'),
            note: formData.get('note'),
            active: formData.get('active') === 'on'
        };
        
        if (formData.get('new_password')) {
            userData.new_password = formData.get('new_password');
        }
        
        try {
            const response = await fetch('/api/users/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(userData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Utente aggiornato con successo', 'success');
                closeEditModal();
                loadUsers();
                loadUserStats();
            } else {
                showAlert(data.error || 'Errore aggiornamento utente', 'danger');
            }
        } catch (error) {
            showAlert('Errore comunicazione', 'danger');
        }
    });
    
    // Elimina utente
    async function deleteUser(username) {
        if (confirm(`Sei sicuro di voler eliminare l'utente "${username}"?`)) {
            try {
                const response = await fetch('/api/users/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: username})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Utente eliminato con successo', 'success');
                    loadUsers();
                    loadUserStats();
                } else {
                    showAlert(data.error || 'Errore eliminazione utente', 'danger');
                }
            } catch (error) {
                showAlert('Errore comunicazione', 'danger');
            }
        }
    }
    
    // Chiudi modal cliccando sull'overlay
    document.getElementById('modal-overlay').addEventListener('click', closeEditModal);
</script>
{% endblock %}
"""

# ===============================
# ROUTES GESTIONE UTENTI
# ===============================

@app.route('/utenti')
@require_auth
@require_permission('users')
def utenti():
    """Pagina gestione utenti"""
    nome_isola = config_manager.get('sistema.nome_isola', '')
    if not nome_isola:
        nome_isola = "Isola Ecologica"
    else:
        nome_isola = f"Isola Ecologica {nome_isola}"
    
    user_role = session.get('role', 'viewer')
    user_role_name = USER_ROLES.get(user_role, {}).get('name', 'Utente')
    permissions = session.get('permissions', [])
    
    return render_template_string(UTENTI_TEMPLATE, 
                                island_name=nome_isola,
                                user_role_name=user_role_name,
                                permissions=permissions,
                                session=session)

# ===============================
# API ENDPOINTS UTENTI
# ===============================

@app.route('/api/users/list')
@require_auth
@require_permission('users')
def api_users_list():
    """Lista utenti dashboard"""
    try:
        utenti = config_manager.get('utenti', {})
        users_list = []
        
        for username, user_data in utenti.items():
            users_list.append({
                'username': username,
                'ruolo': user_data.get('ruolo', 'viewer'),
                'ultimo_accesso': user_data.get('ultimo_accesso'),
                'attivo': user_data.get('attivo', True),
                'note': user_data.get('note', '')
            })
        
        return jsonify({
            'success': True,
            'users': users_list
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/users/stats')
@require_auth
@require_permission('users')
def api_users_stats():
    """Statistiche utenti per ruolo"""
    try:
        utenti = config_manager.get('utenti', {})
        stats = {'admin': 0, 'manager': 0, 'viewer': 0}
        
        for user_data in utenti.values():
            role = user_data.get('ruolo', 'viewer')
            if role in stats:
                stats[role] += 1
        
        return jsonify({
            'success': True,
            'stats': stats
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/users/dashboard-activity')
@require_auth
@require_permission('users')
def api_dashboard_activity():
    """Log attività dashboard (mock data per ora)"""
    try:
        # Per ora restituiamo dati mock
        # In futuro qui andrà implementato un vero sistema di logging
        activities = []
        
        return jsonify({
            'success': True,
            'activities': activities
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/users/create', methods=['POST'])
@require_auth
@require_permission('users')
def api_create_user():
    """Crea nuovo utente"""
    try:
        data = request.get_json()
        
        # Validazione
        username = data.get('username', '').strip()
        password = data.get('password', '')
        role = data.get('role', 'viewer')
        note = data.get('note', '').strip()
        
        if not username or not password:
            return jsonify({'success': False, 'error': 'Username e password sono obbligatori'}), 400
        
        if len(username) < 3 or len(password) < 6:
            return jsonify({'success': False, 'error': 'Username min 3 caratteri, password min 6'}), 400
        
        if role not in USER_ROLES:
            return jsonify({'success': False, 'error': 'Ruolo non valido'}), 400
        
        # Verifica che l'utente non esista già
        utenti = config_manager.get('utenti', {})
        if username in utenti:
            return jsonify({'success': False, 'error': 'Username già esistente'}), 400
        
        # Solo admin può creare altri admin
        if role == 'admin' and session.get('role') != 'admin':
            return jsonify({'success': False, 'error': 'Solo admin può creare amministratori'}), 403
        
        # Crea utente
        user_data = {
            'password_hash': generate_password_hash(password),
            'ruolo': role,
            'ultimo_accesso': None,
            'attivo': True,
            'note': note,
            'creato_da': session.get('username'),
            'creato_il': datetime.now().isoformat()
        }
        
        config_manager.set(f'utenti.{username}', user_data)
        
        return jsonify({
            'success': True,
            'message': f'Utente {username} creato con successo'
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/users/get/<username>')
@require_auth
@require_permission('users')
def api_get_user(username):
    """Ottieni dati utente"""
    try:
        utenti = config_manager.get('utenti', {})
        
        if username not in utenti:
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        user_data = utenti[username].copy()
        # Rimuovi password hash per sicurezza
        user_data.pop('password_hash', None)
        
        return jsonify({
            'success': True,
            'user': user_data
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/users/update', methods=['POST'])
@require_auth
@require_permission('users')
def api_update_user():
    """Aggiorna utente esistente"""
    try:
        data = request.get_json()
        
        username = data.get('username', '').strip()
        role = data.get('role', 'viewer')
        note = data.get('note', '').strip()
        active = data.get('active', True)
        new_password = data.get('new_password', '').strip()
        
        if not username:
            return jsonify({'success': False, 'error': 'Username richiesto'}), 400
        
        # Verifica che l'utente esista
        utenti = config_manager.get('utenti', {})
        if username not in utenti:
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Solo admin può modificare altri admin o creare admin
        if (role == 'admin' or utenti[username].get('ruolo') == 'admin') and session.get('role') != 'admin':
            return jsonify({'success': False, 'error': 'Solo admin può gestire amministratori'}), 403
        
        # Non si può disattivare se stesso
        if username == session.get('username') and not active:
            return jsonify({'success': False, 'error': 'Non puoi disattivare il tuo account'}), 400
        
        # Aggiorna dati
        user_data = utenti[username]
        user_data['ruolo'] = role
        user_data['note'] = note
        user_data['attivo'] = active
        user_data['modificato_da'] = session.get('username')
        user_data['modificato_il'] = datetime.now().isoformat()
        
        # Aggiorna password se fornita
        if new_password:
            if len(new_password) < 6:
                return jsonify({'success': False, 'error': 'Password deve essere almeno 6 caratteri'}), 400
            user_data['password_hash'] = generate_password_hash(new_password)
        
        config_manager.set(f'utenti.{username}', user_data)
        
        return jsonify({
            'success': True,
            'message': f'Utente {username} aggiornato con successo'
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/users/delete', methods=['POST'])
@require_auth
@require_permission('users')
def api_delete_user():
    """Elimina utente"""
    try:
        data = request.get_json()
        username = data.get('username', '').strip()
        
        if not username:
            return jsonify({'success': False, 'error': 'Username richiesto'}), 400
        
        # Non si può eliminare se stesso
        if username == session.get('username'):
            return jsonify({'success': False, 'error': 'Non puoi eliminare il tuo account'}), 400
        
        # Verifica che l'utente esista
        utenti = config_manager.get('utenti', {})
        if username not in utenti:
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Solo admin può eliminare altri admin
        if utenti[username].get('ruolo') == 'admin' and session.get('role') != 'admin':
            return jsonify({'success': False, 'error': 'Solo admin può eliminare amministratori'}), 403
        
        # Elimina utente
        del utenti[username]
        config_manager.set('utenti', utenti)
        
        return jsonify({
            'success': True,
            'message': f'Utente {username} eliminato con successo'
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

```

---

## File: utenti_autorizzati.py

**Percorso:** `api/modules/utenti_autorizzati.py`
**Directory:** `api/modules`
**Dimensione:** 8480 bytes
**Ultima modifica:** 2025-07-20 18:41:36
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/modules/utenti_autorizzati.py
from flask import Blueprint, render_template_string, request, jsonify, session
from functools import wraps
import sqlite3
import os
from datetime import datetime

# Import auth per i decoratori
from ..utils import require_auth, require_permission

utenti_autorizzati_bp = Blueprint('utenti_autorizzati', __name__)

# Database path
DB_PATH = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 'access.db')

def get_db_connection():
    """Connessione al database"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        return conn
    except Exception as e:
        print(f"Errore connessione DB: {e}")
        return None

@utenti_autorizzati_bp.route('/utenti-autorizzati')
@require_auth()
def utenti_autorizzati_page():
    """Pagina gestione utenti autorizzati"""
    with open(os.path.join(os.path.dirname(os.path.dirname(__file__)), 
              'templates', 'utenti_autorizzati.html'), 'r') as f:
        template = f.read()
    return render_template_string(template, session=session)

@utenti_autorizzati_bp.route('/api/utenti-autorizzati/list')
@require_auth()
def api_list_utenti_autorizzati():
    """Lista utenti autorizzati con filtro"""
    search = request.args.get('search', '').strip().upper()
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Query base
        query = """
            SELECT codice_fiscale, nome, data_inserimento,
                   data_aggiornamento, attivo, note,
                   creato_da, modificato_da
            FROM utenti_autorizzati
            WHERE 1=1
        """
        params = []
        
        # Aggiungi filtro di ricerca se presente
        if search:
            query += """
                AND (
                    UPPER(codice_fiscale) LIKE ? OR
                    UPPER(nome) LIKE ?
                )
            """
            search_param = f"%{search}%"
            params.extend([search_param, search_param])
        
        # Ordina per nome
        query += " ORDER BY nome"
        
        cursor.execute(query, params)
        results = cursor.fetchall()
        
        utenti = []
        for row in results:
            utenti.append({
                'codice_fiscale': row['codice_fiscale'],
                'nome': row['nome'],
                'data_inserimento': row['data_inserimento'],
                'data_aggiornamento': row['data_aggiornamento'],
                'attivo': bool(row['attivo']),
                'note': row['note'],
                'creato_da': row['creato_da'],
                'modificato_da': row['modificato_da']
            })
        
        return jsonify({
            'success': True,
            'utenti': utenti,
            'total': len(utenti)
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@utenti_autorizzati_bp.route('/api/utenti-autorizzati/toggle-active', methods=['POST'])
@require_auth()
@require_permission('all')
def api_toggle_active():
    """Attiva/disattiva utente autorizzato"""
    data = request.get_json()
    codice_fiscale = data.get('codice_fiscale', '').strip()
    
    if not codice_fiscale:
        return jsonify({'success': False, 'error': 'Codice fiscale mancante'}), 400
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Ottieni stato attuale
        cursor.execute("""
            SELECT attivo 
            FROM utenti_autorizzati 
            WHERE codice_fiscale = ?
        """, (codice_fiscale,))
        
        result = cursor.fetchone()
        if not result:
            return jsonify({'success': False, 'error': 'Utente non trovato'}), 404
        
        # Inverte lo stato
        new_state = not bool(result['attivo'])
        
        # Aggiorna
        cursor.execute("""
            UPDATE utenti_autorizzati 
            SET attivo = ?,
                data_aggiornamento = CURRENT_TIMESTAMP,
                modificato_da = ?
            WHERE codice_fiscale = ?
        """, (int(new_state), session.get('username'), codice_fiscale))
        
        conn.commit()
        
        status = "attivato" if new_state else "disattivato"
        return jsonify({
            'success': True,
            'message': f'Utente {status}',
            'new_state': new_state
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@utenti_autorizzati_bp.route('/api/utenti-autorizzati')
@require_auth()
def get_utenti():
    """Ottiene lista completa utenti autorizzati"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        cursor.execute('''
            SELECT codice_fiscale, nome
            FROM utenti_autorizzati
            WHERE attivo = 1
            ORDER BY nome
        ''')
        
        utenti = []
        for row in cursor.fetchall():
            utenti.append({
                'codice_fiscale': row['codice_fiscale'],
                'nome': row['nome'],
                'label': f"{row['nome']} ({row['codice_fiscale']})"
            })
        
        return jsonify({'success': True, 'utenti': utenti})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@utenti_autorizzati_bp.route('/api/utenti-autorizzati/disattivati')
@require_auth()
def get_utenti_disattivati():
    """Ottiene lista utenti disattivati"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Ottieni anno e mese correnti
        oggi = datetime.now()
        anno = oggi.year
        mese = oggi.month
        
        # Query per ottenere utenti disattivati con conteggio ingressi
        cursor.execute('''
            SELECT u.nome, u.codice_fiscale,
                   COALESCE(c.numero_ingressi, 0) as ingressi_mensili
            FROM utenti_autorizzati u
            LEFT JOIN conteggio_ingressi_mensili c 
                ON u.codice_fiscale = c.codice_fiscale
                AND c.anno = ? AND c.mese = ?
            WHERE u.attivo = 0
            ORDER BY u.nome
        ''', (anno, mese))
        
        utenti = []
        for row in cursor.fetchall():
            utenti.append({
                'nome': row['nome'],
                'codice_fiscale': row['codice_fiscale'],
                'ingressi_mensili': row['ingressi_mensili']
            })
        
        return jsonify({'success': True, 'utenti': utenti})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

@utenti_autorizzati_bp.route('/api/utenti-autorizzati/stats')
@require_auth()
def api_get_stats():
    """Statistiche utenti autorizzati"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Totale utenti
        cursor.execute("SELECT COUNT(*) as total FROM utenti_autorizzati")
        total = cursor.fetchone()['total']
        
        # Utenti attivi
        cursor.execute("SELECT COUNT(*) as active FROM utenti_autorizzati WHERE attivo = 1")
        active = cursor.fetchone()['active']
        
        
        # Ultimi inseriti
        cursor.execute("""
            SELECT COUNT(*) as recent
            FROM utenti_autorizzati
            WHERE data_inserimento >= date('now', '-30 days')
        """)
        recent = cursor.fetchone()['recent']
        
        return jsonify({
            'success': True,
            'stats': {
                'totale': total,
                'attivi': active,
                'nuovi_30gg': recent
            }
        })
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()

```

---

## File: backup.css

**Percorso:** `api/static/css/backup.css`
**Directory:** `api/static/css`
**Dimensione:** 1954 bytes
**Ultima modifica:** 2025-07-19 14:02:19
**Permessi:** 664

### Contenuto:

```css
/* Stili per la pagina di backup */

/* Navbar */
.navbar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Card statistiche */
.stat-card {
    transition: transform 0.2s;
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
}

/* Tabella backup */
.table {
    margin-bottom: 0;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.table td {
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* Bottoni azioni */
.btn-group-action .btn {
    margin: 0 2px;
}

/* Spinner caricamento */
.spinner-border {
    width: 1.5rem;
    height: 1.5rem;
    margin: 2rem auto;
}

/* Card azioni */
.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.card-header {
    background-color: transparent;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    padding: 1rem 1.25rem;
}

.card-header h5 {
    margin: 0;
    font-weight: 600;
}

/* Bottoni principali */
.btn-action {
    padding: 1rem;
    text-align: center;
    border-radius: 10px;
    transition: all 0.3s;
}

.btn-action i {
    margin-bottom: 0.5rem;
}

.btn-action small {
    display: block;
    opacity: 0.8;
}

/* Form configurazione */
.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-select, .form-control {
    border-radius: 8px;
    border: 1px solid #ced4da;
}

/* Badges e icone */
.badge {
    padding: 0.5em 0.8em;
    font-weight: 500;
}

.fa-check-circle {
    color: #28a745;
}

/* Responsive */
@media (max-width: 768px) {
    .stat-card {
        margin-bottom: 1rem;
    }
    
    .btn-action {
        margin-bottom: 1rem;
    }
    
    .table-responsive {
        margin-bottom: 1rem;
    }
}

```

---

## File: clock.css

**Percorso:** `api/static/css/clock.css`
**Directory:** `api/static/css`
**Dimensione:** 660 bytes
**Ultima modifica:** 2025-07-20 21:51:31
**Permessi:** 664

### Contenuto:

```css
.system-clock {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: rgba(255,255,255,0.95);
    font-size: 1rem;
    padding: 0.5rem 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    margin: 0 1rem;
    min-width: 300px;
    justify-content: center;
}

.system-clock i {
    color: rgba(255,255,255,0.8);
    font-size: 0.9rem;
}

.clock-time {
    font-family: 'Roboto Mono', monospace;
    font-weight: 500;
    letter-spacing: 0.5px;
}

.clock-date {
    color: rgba(255,255,255,0.8);
    font-size: 0.9rem;
    margin-left: 0.75rem;
    padding-left: 0.75rem;
    border-left: 1px solid rgba(255,255,255,0.2);
}

```

---

## File: configurazione_orari.css

**Percorso:** `api/static/css/configurazione_orari.css`
**Directory:** `api/static/css`
**Dimensione:** 2307 bytes
**Ultima modifica:** 2025-07-20 13:42:55
**Permessi:** 664

### Contenuto:

```css
/* Navbar */
.navbar { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.navbar .btn-outline-light {
    border-width: 2px;
    font-weight: 500;
    padding: 0.375rem 1rem;
}

.navbar .btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Layout orari */
.day-row {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.day-row:last-child {
    border-bottom: none;
}

.day-name {
    width: 120px;
    font-weight: bold;
}

.time-slots {
    display: flex;
    gap: 2rem;
}

.time-slot {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.time-label {
    font-weight: 500;
    width: 80px;
}

.time-select {
    width: 100px;
}

.time-separator {
    margin: 0 0.5rem;
}

.disabled {
    opacity: 0.5;
    pointer-events: none;
}

/* Cards */
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

/* Form elements */
.form-group {
    margin-bottom: 1rem;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Table */
.table {
    margin-bottom: 0;
}

.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

/* Buttons */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-primary {
    background-color: #667eea;
    border-color: #667eea;
}

.btn-primary:hover {
    background-color: #5a6fd6;
    border-color: #5a6fd6;
}

.btn-success {
    background-color: #48bb78;
    border-color: #48bb78;
}

.btn-success:hover {
    background-color: #38a169;
    border-color: #38a169;
}

/* Alerts */
.alert {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    max-width: 500px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Search field */
#cercaCF {
    max-width: 300px;
}

/* Table responsive */
.table-responsive {
    margin-top: 1rem;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
}

/* Icons */
.fas {
    width: 1.25em;
    text-align: center;
}

```

---

## File: dashboard.css

**Percorso:** `api/static/css/dashboard.css`
**Directory:** `api/static/css`
**Dimensione:** 6897 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```css
/* File: /opt/access_control/src/api/static/api/static/css/dashboard.css */
/* Stili per Dashboard Sistema Controllo Accessi */

/* ===== STILI BASE ===== */
body { 
    background-color: #f8f9fa; 
}

.navbar { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
}

/* ===== CARDS ===== */
.stat-card { 
    border: none; 
    border-radius: 15px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    transition: transform 0.2s; 
}

.stat-card:hover { 
    transform: translateY(-5px); 
}

.stat-number { 
    font-size: 2.5rem; 
    font-weight: bold; 
}

.hardware-card { 
    border-radius: 15px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
}

/* ===== MODAL USB-RLY08 ===== */
.relay-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 20px;
}

.relay-box {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: default;
}

.relay-box.active {
    background: #28a745;
    color: white;
    border-color: #28a745;
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
}

.relay-box i {
    font-size: 2em;
    display: block;
    margin-bottom: 10px;
}

.relay-box.active i {
    animation: pulse 0.5s ease-in-out infinite;
}

/* ===== VISUALIZZAZIONE CANCELLO ===== */
.gate-visual {
    width: 200px;
    height: 100px;
    background: #343a40;
    border: 3px solid #6c757d;
    border-radius: 5px;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
    transition: all 0.5s ease;
}

.gate-visual.open {
    background: #28a745;
    border-color: #28a745;
}

.gate-bars {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
        90deg,
        #ffc107,
        #ffc107 10px,
        #343a40 10px,
        #343a40 20px
    );
    transition: transform 0.8s ease;
}

.gate-visual.open .gate-bars {
    transform: translateX(-100%);
}

.gate-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    z-index: 10;
}

/* ===== LED INDICATORS ===== */
.led-indicator {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin: 10px;
    display: inline-block;
    border: 2px solid #dee2e6;
    transition: all 0.3s ease;
}

.led-indicator.led-red { background: #ffcccc; }
.led-indicator.led-green { background: #ccffcc; }
.led-indicator.led-yellow { background: #ffffcc; }

.led-indicator.active {
    border-width: 0;
    box-shadow: 0 0 30px currentColor;
}

.led-indicator.led-red.active { background: #dc3545; }
.led-indicator.led-green.active { background: #28a745; }
.led-indicator.led-yellow.active { background: #ffc107; }

.led-indicator.blink {
    animation: blink 0.5s ease-in-out infinite;
}

/* ===== BUZZER ===== */
.buzzer-visual {
    display: inline-block;
    font-size: 2em;
    transition: all 0.3s ease;
}

.buzzer-visual.active {
    animation: buzz 0.2s ease-in-out infinite;
    color: #17a2b8;
}

/* ===== LOG AREAS ===== */
.relay-log {
    background: #000;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    padding: 15px;
    height: 200px;
    overflow-y: auto;
    border-radius: 8px;
    font-size: 0.9em;
}

.integrated-log {
    background: #000;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    padding: 15px;
    height: 400px;
    overflow-y: auto;
    border-radius: 8px;
    font-size: 0.9em;
}

.integrated-log .log-line {
    margin-bottom: 5px;
    padding: 2px 0;
}

/* ===== TEST INTEGRATO ===== */
.access-simulation {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 30px;
    min-height: 400px;
}

.card-reader-container {
    position: relative;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 50px;
}

.card-animation {
    width: 120px;
    height: 80px;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    border-radius: 10px;
    position: relative;
    transition: all 0.5s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.card-animation.waiting {
    animation: pulse 2s ease-in-out infinite;
}

.card-animation.inserting {
    transform: translateX(50px);
}

.card-animation.success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.card-animation.denied {
    background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    animation: shake 0.5s ease-in-out;
}

.card-chip {
    width: 25px;
    height: 20px;
    background: gold;
    border-radius: 4px;
    position: absolute;
    top: 20px;
    left: 20px;
}

.card-text {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    text-align: center;
    color: white;
    font-size: 10px;
    font-weight: bold;
}

/* ===== READER VISUAL ===== */
.reader-visual {
    width: 150px;
    height: 100px;
    background: #343a40;
    border-radius: 10px;
    position: relative;
    border: 3px solid #495057;
}

.reader-visual.scanning .reader-light {
    background: #ffc107;
    animation: blink 0.5s ease-in-out infinite;
}

.reader-visual.active .reader-light {
    background: #17a2b8;
}

.reader-visual.success .reader-light {
    background: #28a745;
}

.reader-visual.denied .reader-light {
    background: #dc3545;
}

.reader-slot {
    width: 100px;
    height: 5px;
    background: #000;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.reader-light {
    width: 15px;
    height: 15px;
    background: #6c757d;
    border-radius: 50%;
    position: absolute;
    top: 20px;
    right: 20px;
    transition: all 0.3s ease;
}

.devices-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.animated-text {
    animation: pulse-text 1.5s ease-in-out infinite;
    font-weight: bold;
    font-size: 1.2em;
}

/* ===== ANIMAZIONI ===== */
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

@keyframes buzz {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

@keyframes pulse-text {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.05); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .relay-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .card-reader-container {
        flex-direction: column;
        gap: 20px;
    }
}

```

---

## File: profilo.css

**Percorso:** `api/static/css/profilo.css`
**Directory:** `api/static/css`
**Dimensione:** 1714 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```css
/* File: /opt/access_control/src/api/static/css/profilo.css */
/* Stili per la pagina profilo utente */

.profile-container {
    max-width: 600px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.profile-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.profile-card h2 {
    margin-bottom: 1.5rem;
    color: #2a5298;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.user-details {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.detail-row:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.detail-label {
    font-weight: 600;
    color: #666;
}

.detail-value {
    color: #333;
}

.role-badge {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.role-admin {
    background: #ff6b6b;
    color: white;
}

.role-gestore {
    background: #f39c12;
    color: white;
}

.role-readonly {
    background: #27ae60;
    color: white;
}

.password-form {
    margin-top: 1.5rem;
}

.password-strength {
    margin-top: 0.5rem;
    font-size: 0.9rem;
}

.strength-weak {
    color: #dc3545;
}

.strength-medium {
    color: #ffc107;
}

.strength-strong {
    color: #28a745;
}

.password-tips {
    background: #e3f2fd;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #1565c0;
}

#profile-message {
    margin-bottom: 1rem;
}

```

---

## File: test-accessi.css

**Percorso:** `api/static/css/test-accessi.css`
**Directory:** `api/static/css`
**Dimensione:** 4874 bytes
**Ultima modifica:** 2025-07-20 22:59:45
**Permessi:** 664

### Contenuto:

```css
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-group {
    margin-bottom: 1rem;
}

.table {
    margin-bottom: 0;
}

.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.alert {
    margin-bottom: 1rem;
}

.alert-dismissible {
    padding-right: 3rem;
}

#cercaCF {
    max-width: 300px;
}

.search-container {
    position: relative;
    max-width: 300px;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
}

.search-results .result-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
}

.search-results .result-item:hover {
    background-color: #f8f9fa;
}

.search-results .result-item:last-child {
    border-bottom: none;
}

.table-responsive {
    margin-top: 1rem;
}

/* Stili per i dropdown */
select.form-control {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 12 12'%3E%3Cpath d='M6 8.5L1.5 4h9L6 8.5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 12px;
    padding-right: 2rem;
}

/* Stili per i pulsanti */
.btn-primary {
    margin-right: 0.5rem;
}

/* Stili per gli alert */
.alert {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    max-width: 500px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Stili per il test accessi */
.test-accessi-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.test-accessi-title {
    color: #2c3e50;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

/* Animazioni relè */
.relay-status {
    display: flex;
    gap: 2rem;
    margin: 2rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.relay-component {
    text-align: center;
    padding: 1rem;
    border-radius: 6px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.led {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin: 0 auto 1rem;
    transition: all 0.3s ease;
}

.led-green {
    background: #e0e0e0;
}

.led-green.active {
    background: #2ecc71;
    box-shadow: 0 0 20px #2ecc71;
    animation: pulse 1s infinite;
}

.led-red {
    background: #e0e0e0;
}

.led-red.active {
    background: #e74c3c;
    box-shadow: 0 0 20px #e74c3c;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.gate {
    width: 100px;
    height: 60px;
    margin: 0 auto 1rem;
    background: #34495e;
    position: relative;
    transition: all 0.5s ease;
}

.gate.opening {
    animation: slideGate 4s ease-in-out;
}

@keyframes slideGate {
    0% { transform: scaleX(1); }
    50% { transform: scaleX(0.1); }
    90% { transform: scaleX(0.1); }
    100% { transform: scaleX(1); }
}

.buzzer {
    width: 40px;
    height: 40px;
    margin: 0 auto 1rem;
    background: #95a5a6;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.buzzer.active {
    animation: buzz 0.2s infinite;
}

@keyframes buzz {
    0% { transform: translateX(-2px) rotate(-2deg); }
    50% { transform: translateX(2px) rotate(2deg); }
    100% { transform: translateX(-2px) rotate(-2deg); }
}

/* Layout migliorato */
.test-section {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.test-section-title {
    font-size: 1.2rem;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.input-group {
    margin-bottom: 1.5rem;
}

.btn-test {
    background: #6c5ce7;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.btn-test:hover {
    background: #5b4cc4;
    transform: translateY(-1px);
}

.btn-test:active {
    transform: translateY(0);
}

.result-message {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 6px;
    background: #f8f9fa;
    border-left: 4px solid #6c5ce7;
}

```

---

## File: user-menu.css

**Percorso:** `api/static/css/user-menu.css`
**Directory:** `api/static/css`
**Dimensione:** 4933 bytes
**Ultima modifica:** 2025-07-19 17:37:37
**Permessi:** 664

### Contenuto:

```css
/* File: /opt/access_control/src/api/static/css/user-menu.css */
/* Menu utente moderno con glassmorphism */

.user-menu-container {
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.user-avatar:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
}

.user-menu-trigger {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 25px;
    padding: 5px 15px 5px 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.user-menu-trigger:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.user-menu-info {
    text-align: right;
    margin-right: 5px;
}

.user-menu-name {
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    line-height: 1.2;
}

.user-menu-role {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.75rem;
}

.user-menu-dropdown {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    min-width: 250px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 5px 15px rgba(0, 0, 0, 0.08);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    overflow: hidden;
}

.user-menu-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.user-menu-header {
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.user-menu-header .avatar-large {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: 3px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin: 0 auto 10px;
}

.user-menu-header .user-name {
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 5px;
}

.user-menu-header .user-email {
    font-size: 0.85rem;
    opacity: 0.8;
    text-align: center;
}

.user-menu-items {
    padding: 10px;
}

.user-menu-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 15px;
    color: #333;
    text-decoration: none;
    border-radius: 10px;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.user-menu-item:hover {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    transform: translateX(5px);
}

.user-menu-item i {
    width: 20px;
    text-align: center;
    font-size: 1.1rem;
}

.user-menu-item-text {
    flex: 1;
    font-size: 0.9rem;
    font-weight: 500;
}

.user-menu-divider {
    height: 1px;
    background: rgba(0, 0, 0, 0.1);
    margin: 10px 15px;
}

.user-menu-item.logout {
    color: #e74c3c;
}

.user-menu-item.logout:hover {
    background: rgba(231, 76, 60, 0.1);
    color: #c0392b;
}

/* Badge per notifiche */
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 0.7rem;
    font-weight: bold;
    animation: pulse 2s ease-in-out infinite;
}

/* Overlay per chiudere il menu */
.user-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 999;
    display: none;
}

.user-menu-overlay.active {
    display: block;
}

/* Animazioni */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .user-menu-dropdown {
        background: rgba(30, 30, 30, 0.95);
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    .user-menu-item {
        color: #f0f0f0;
    }
    
    .user-menu-item:hover {
        background: rgba(102, 126, 234, 0.2);
    }
    
    .user-menu-divider {
        background: rgba(255, 255, 255, 0.1);
    }
}

/* Responsive */
@media (max-width: 768px) {
    .user-menu-info {
        display: none;
    }
    
    .user-menu-trigger {
        padding: 5px;
        background: transparent;
        border: none;
    }
    
    .user-menu-dropdown {
        right: -10px;
        min-width: 280px;
    }
}

```

---

## File: favicon.ico

**Percorso:** `api/static/favicon.ico`
**Directory:** `api/static`
**Dimensione:** 0 bytes
**Ultima modifica:** 2025-07-19 14:36:33
**Permessi:** 664

### Contenuto:

```text

```

---

## File: backup_modal.html

**Percorso:** `api/static/html/backup_modal.html`
**Directory:** `api/static/html`
**Dimensione:** 16847 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```html
<!-- File: /opt/access_control/src/api/static/backup_modal.html -->
<!-- Modal Gestione Backup -->

<div class="modal fade" id="backupModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">
                    <i class="fas fa-database me-2"></i>Gestione Backup Sistema
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#backup-status">
                            <i class="fas fa-info-circle"></i> Stato
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#backup-create">
                            <i class="fas fa-plus-circle"></i> Crea Backup
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#backup-list">
                            <i class="fas fa-list"></i> Lista Backup
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#backup-settings">
                            <i class="fas fa-cog"></i> Impostazioni
                        </a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3">
                    <!-- Tab Stato -->
                    <div class="tab-pane fade show active" id="backup-status">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-hdd fa-2x text-primary mb-2"></i>
                                        <h6>Spazio Utilizzato</h6>
                                        <h4 id="backup-total-size">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-archive fa-2x text-success mb-2"></i>
                                        <h6>Backup Totali</h6>
                                        <h4 id="backup-total-count">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                        <h6>Ultimo Backup</h6>
                                        <h4 id="backup-last-date">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-chart-pie fa-2x text-info mb-2"></i>
                                        <h6>Disco Utilizzato</h6>
                                        <h4 id="backup-disk-usage">-</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Operazioni in corso -->
                        <div class="mt-4" id="backup-operations" style="display:none;">
                            <h6>Operazioni in Corso</h6>
                            <div id="backup-operations-list"></div>
                        </div>
                    </div>

                    <!-- Tab Crea Backup -->
                    <div class="tab-pane fade" id="backup-create">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-archive fa-3x text-primary mb-3"></i>
                                        <h5>Backup Completo</h5>
                                        <p class="text-muted">Include codice, configurazioni, database e documentazione</p>
                                        <button class="btn btn-primary" onclick="createBackup('complete')">
                                            <i class="fas fa-play me-2"></i>Avvia Backup Completo
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-database fa-3x text-success mb-3"></i>
                                        <h5>Backup Database</h5>
                                        <p class="text-muted">Backup rapido solo del database accessi</p>
                                        <button class="btn btn-success" onclick="createBackup('database')">
                                            <i class="fas fa-play me-2"></i>Avvia Backup Database
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-warning" onclick="cleanupBackups()">
                                <i class="fas fa-broom me-2"></i>Pulizia Backup Vecchi
                            </button>
                            <small class="text-muted ms-2">Elimina backup secondo la policy di retention</small>
                        </div>
                    </div>

                    <!-- Tab Lista Backup -->
                    <div class="tab-pane fade" id="backup-list">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome File</th>
                                        <th>Tipo</th>
                                        <th>Dimensione</th>
                                        <th>Data</th>
                                        <th>Età</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="backup-list-tbody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Caricamento...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab Impostazioni -->
                    <div class="tab-pane fade" id="backup-settings">
                        <form id="backup-settings-form">
                            <div class="row">
                                <!-- Backup Automatici -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-clock me-2"></i>Backup Automatici</h6>
                                    
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="auto-backup-enabled">
                                        <label class="form-check-label" for="auto-backup-enabled">
                                            Abilita backup automatici
                                        </label>
                                    </div>
                                    
                                    <div id="auto-backup-options">
                                        <!-- Giornaliero -->
                                        <div class="card mb-2">
                                            <div class="card-body">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="daily-backup-enabled">
                                                    <label class="form-check-label" for="daily-backup-enabled">
                                                        Backup giornaliero database
                                                    </label>
                                                </div>
                                                <div class="mt-2">
                                                    <label>Orario:</label>
                                                    <input type="time" class="form-control form-control-sm" id="daily-backup-time" value="02:00">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Settimanale -->
                                        <div class="card mb-2">
                                            <div class="card-body">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="weekly-backup-enabled">
                                                    <label class="form-check-label" for="weekly-backup-enabled">
                                                        Backup settimanale completo
                                                    </label>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col">
                                                        <label>Giorno:</label>
                                                        <select class="form-select form-select-sm" id="weekly-backup-day">
                                                            <option value="0">Domenica</option>
                                                            <option value="1">Lunedì</option>
                                                            <option value="2">Martedì</option>
                                                            <option value="3">Mercoledì</option>
                                                            <option value="4">Giovedì</option>
                                                            <option value="5">Venerdì</option>
                                                            <option value="6">Sabato</option>
                                                        </select>
                                                    </div>
                                                    <div class="col">
                                                        <label>Orario:</label>
                                                        <input type="time" class="form-control form-control-sm" id="weekly-backup-time" value="03:00">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Retention Policy -->
                                <div class="col-md-6">
                                    <h6><i class="fas fa-history me-2"></i>Policy di Retention</h6>
                                    
                                    <div class="mb-3">
                                        <label>Mantieni backup giornalieri per:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="daily-retention" min="1" max="30" value="7">
                                            <span class="input-group-text">giorni</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label>Mantieni backup settimanali per:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="weekly-retention" min="1" max="52" value="4">
                                            <span class="input-group-text">settimane</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label>Mantieni backup mensili per:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="monthly-retention" min="1" max="24" value="6">
                                            <span class="input-group-text">mesi</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label>Limite spazio totale backup:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="max-backup-size" min="1" max="100" value="10">
                                            <span class="input-group-text">GB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary" onclick="loadBackupConfig()">
                                    <i class="fas fa-undo me-2"></i>Ripristina
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Salva Impostazioni
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.backup-operation {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.backup-operation.running {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

.backup-operation.completed {
    border-color: #198754;
    background-color: #d1e7dd;
}

.backup-operation.error {
    border-color: #dc3545;
    background-color: #f8d7da;
}

.backup-file-actions button {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

#backup-settings-form .card {
    background-color: #f8f9fa;
}

.progress {
    height: 25px;
}

.progress-bar {
    font-size: 0.9rem;
    line-height: 25px;
}
</style>

```

---

## File: dashboard_template.html

**Percorso:** `api/static/html/dashboard_template.html`
**Directory:** `api/static/html`
**Dimensione:** 7954 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```html
<!-- File: /opt/access_control/src/api/static/html/dashboard_template.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Sistema Controllo Accessi - Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="static/css/dashboard.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-shield-alt me-2"></i>Sistema Controllo Accessi
            </span>
            <div class="d-flex align-items-center gap-3">
                <span class="navbar-text me-3">Isola Ecologica RAEE - Rende</span>
                
                <!-- Include il menu utente -->
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <!-- Sezione per User Manager -->
    {% if session.role == 'user_manager' %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> Gestione Visualizzatori</h5>
                </div>
                <div class="card-body">
                    <a href="/user-management" class="btn btn-primary">
                        <i class="fas fa-users-cog"></i> Gestisci Utenti Viewer
                    </a>
                    <a href="/logs" class="btn btn-info">
                        <i class="fas fa-list"></i> Visualizza Log
                    </a>
                    <button class="btn btn-success" onclick="openExportModal()">
                        <i class="fas fa-file-excel"></i> Esporta Log Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sezione per Viewer -->
    {% if session.role == 'viewer' %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-eye"></i> Visualizzazione Log</h5>
                </div>
                <div class="card-body">
                    <a href="/logs" class="btn btn-info">
                        <i class="fas fa-list"></i> Visualizza Log Accessi
                    </a>
                    <p class="text-muted mt-2">
                        <i class="fas fa-info-circle"></i> 
                        Puoi visualizzare e filtrare i log di accesso per date
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="container-fluid mt-4">
        <!-- Statistiche -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-primary mb-3"></i>
                        <div class="stat-number text-primary" id="accessi-oggi">-</div>
                        <h6 class="text-muted">Accessi Oggi</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                        <div class="stat-number text-success" id="autorizzati">-</div>
                        <h6 class="text-muted">Autorizzati</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x text-info mb-3"></i>
                        <div class="stat-number text-info" id="utenti-totali">-</div>
                        <h6 class="text-muted">Utenti Totali</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hardware Test + Accessi Recenti -->
        <div class="row">
            <div class="col-md-6">
                <div class="card hardware-card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>Test Hardware</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-primary w-100" onclick="testReader()">
                                    <i class="fas fa-credit-card"></i><br><small>Lettore</small>
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-warning w-100" onclick="testRelay()">
                                    <i class="fas fa-microchip"></i><br><small>USB-RLY08</small>
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-success w-100" onclick="testGate()">
                                    <i class="fas fa-door-open"></i><br><small>Cancello</small>
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <button class="btn btn-info w-100" onclick="testIntegrated()">
                                    <i class="fas fa-id-card me-2"></i>Test Completo Accesso (Simula Tessera)
                                </button>
                            </div>
                        </div>
                        <div id="hardware-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Ultimi Accessi</h5>
                    </div>
                    <div class="card-body" id="recent-accesses">
                        <div class="text-center text-muted">Caricamento...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include modals -->
    <div id="modals-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script>
        // Carica modals
        fetch('/static/html/modals.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modals-container').innerHTML = html;
                // Inizializza event listeners per modals dopo il caricamento
                initializeModalListeners();
            });
        
        // Inizializza dashboard
        loadDashboardData();
        setInterval(loadDashboardData, 5000);
    </script>
    <link href="/static/css/user-menu.css" rel="stylesheet">
        <script src="/static/js/user-menu.js"></script>
        <script>
            // Carica il menu utente
            fetch('/api/user-menu-html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('user-menu-placeholder').innerHTML = html;
                    // Re-inizializza il menu dopo il caricamento
                    new UserMenu();
                });
        </script>
</body>
</html>

```

---

## File: logs.html

**Percorso:** `api/static/html/logs.html`
**Directory:** `api/static/html`
**Dimensione:** 6507 bytes
**Ultima modifica:** 2025-07-20 21:29:34
**Permessi:** 664

### Contenuto:

```html
<!-- File: /opt/access_control/src/api/static/html/logs.html -->
<!-- Pagina visualizzazione log -->

<!DOCTYPE html>
<html>
<head>
    <title>Log Accessi - Sistema Controllo Accessi</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-shield-alt me-2"></i>Log Accessi
            </span>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Filtri -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filtri Ricerca</h5>
            </div>
            <div class="card-body">
                <form id="filter-form">
                    <div class="row">
                        <div class="col-md-3">
                            <label>Data Da</label>
                            <input type="date" class="form-control" id="date-from">
                        </div>
                        <div class="col-md-3">
                            <label>Data A</label>
                            <input type="date" class="form-control" id="date-to">
                        </div>
                        <div class="col-md-3">
                            <label>Stato</label>
                            <select class="form-select" id="status-filter">
                                <option value="all">Tutti</option>
                                <option value="authorized">Solo Autorizzati</option>
                                <option value="denied">Solo Negati</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Ricerca</label>
                            <input type="text" class="form-control" id="search-text" 
                                   placeholder="Nome o CF">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Cerca
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            {% if session.role in ['admin', 'user_manager'] %}
                            <button type="button" class="btn btn-success" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Esporta Excel
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Statistiche -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5>Totale Accessi</h5>
                        <h3 id="stat-total">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5>Autorizzati</h5>
                        <h3 id="stat-authorized" class="text-success">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5>Negati</h5>
                        <h3 id="stat-denied" class="text-danger">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5>Tasso Successo</h5>
                        <h3 id="stat-rate" class="text-info">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabella Log -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Log Accessi</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data/Ora</th>
                                <th>Codice Fiscale</th>
                                <th>Nome</th>
                                <th>Stato</th>
                                <th>Comune</th>
                                <th>Tempo (ms)</th>
                                <th>Terminale</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border" role="status"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginazione -->
                <nav id="pagination"></nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/logs.js"></script>
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
</body>
</html>

```

---

## File: modals.html

**Percorso:** `api/static/html/modals.html`
**Directory:** `api/static/html`
**Dimensione:** 9631 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```html
<!-- File: /opt/access_control/src/api/static/html/modals.html -->
<!-- Modals per Dashboard Sistema Controllo Accessi -->

<!-- Modal Test Lettore -->
<div class="modal fade" id="readerTestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-credit-card me-2"></i>Test Lettore OMNIKEY 5427CK
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reader-test-log" style="background: #000; color: #00ff00; padding: 15px; font-family: 'Courier New', monospace; height: 400px; overflow-y: auto; border-radius: 8px; scroll-behavior: smooth;">
                    <div id="reader-log-content">Cliccare "Avvia Test" per iniziare...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="start-reader-test">
                    <i class="fas fa-play"></i> Avvia Test
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Test USB-RLY08 -->
<div class="modal fade" id="relayTestModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-microchip me-2"></i>Test Controller USB-RLY08
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Griglia Relè -->
                <div class="relay-grid">
                    <div class="relay-box" id="relay-1">
                        <i class="fas fa-door-open"></i>
                        <strong>Relè 1</strong>
                        <small>Cancello</small>
                    </div>
                    <div class="relay-box" id="relay-2">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Relè 2</strong>
                        <small>LED Rosso</small>
                    </div>
                    <div class="relay-box" id="relay-3">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Relè 3</strong>
                        <small>LED Verde</small>
                    </div>
                    <div class="relay-box" id="relay-4">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Relè 4</strong>
                        <small>LED Giallo</small>
                    </div>
                    <div class="relay-box" id="relay-5">
                        <i class="fas fa-bell"></i>
                        <strong>Relè 5</strong>
                        <small>Buzzer</small>
                    </div>
                    <div class="relay-box" id="relay-6">
                        <i class="fas fa-plug"></i>
                        <strong>Relè 6</strong>
                        <small>Aux 1</small>
                    </div>
                    <div class="relay-box" id="relay-7">
                        <i class="fas fa-plug"></i>
                        <strong>Relè 7</strong>
                        <small>Aux 2</small>
                    </div>
                    <div class="relay-box" id="relay-8">
                        <i class="fas fa-plug"></i>
                        <strong>Relè 8</strong>
                        <small>Aux 3</small>
                    </div>
                </div>
                
                <!-- Visualizzazione Dispositivi -->
                <div class="text-center mb-3">
                    <h6>Dispositivi Collegati</h6>
                    
                    <!-- Cancello -->
                    <div class="gate-visual" id="gate-visual">
                        <div class="gate-bars"></div>
                        <div class="gate-label">CANCELLO</div>
                    </div>
                    
                    <!-- LED e Buzzer -->
                    <div class="mt-3">
                        <span class="led-indicator led-red" id="led-red" title="LED Rosso"></span>
                        <span class="led-indicator led-green" id="led-green" title="LED Verde"></span>
                        <span class="led-indicator led-yellow" id="led-yellow" title="LED Giallo"></span>
                        <span class="buzzer-visual" id="buzzer" title="Buzzer">
                            <i class="fas fa-bell"></i>
                        </span>
                    </div>
                </div>
                
                <!-- Log -->
                <div class="relay-log" id="relay-log">
                    Pronto per il test. Clicca "Avvia Test Sequenziale" per iniziare...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="start-relay-test" onclick="startRelaySequence()">
                    <i class="fas fa-play me-2"></i>Avvia Test Sequenziale
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Test Integrato -->
<div class="modal fade" id="integratedTestModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-id-card me-2"></i>Test Completo Sistema Accesso
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Colonna sinistra: Animazione -->
                    <div class="col-md-6">
                        <h6 class="text-center mb-3">Simulazione Processo Accesso</h6>
                        
                        <!-- Tessera e Lettore -->
                        <div class="access-simulation">
                            <div class="card-reader-container">
                                <div id="card-visual" class="card-animation">
                                    <div class="card-chip"></div>
                                    <div class="card-text">TESSERA SANITARIA</div>
                                </div>
                                <div id="reader-visual" class="reader-visual">
                                    <div class="reader-slot"></div>
                                    <div class="reader-light"></div>
                                </div>
                            </div>
                            
                            <!-- Status -->
                            <div class="text-center mt-3">
                                <h5 id="integrated-status">
                                    <i class="fas fa-info-circle"></i> Pronto
                                </h5>
                            </div>
                            
                            <!-- Dispositivi -->
                            <div class="devices-container mt-4">
                                <!-- Cancello -->
                                <div class="gate-visual" id="integrated-gate">
                                    <div class="gate-bars"></div>
                                    <div class="gate-label">CANCELLO</div>
                                </div>
                                
                                <!-- LED e Buzzer -->
                                <div class="text-center mt-3">
                                    <span class="led-indicator led-red" id="integrated-led-red" title="Accesso Negato"></span>
                                    <span class="led-indicator led-green" id="integrated-led-green" title="Accesso Autorizzato"></span>
                                    <span class="led-indicator led-yellow" id="integrated-led-yellow" title="Attesa"></span>
                                    <span class="buzzer-visual" id="integrated-buzzer" title="Buzzer">
                                        <i class="fas fa-bell"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Colonna destra: Log -->
                    <div class="col-md-6">
                        <h6 class="text-center mb-3">Log Operazioni</h6>
                        <div class="integrated-log" id="integrated-log">
                            <div class="text-muted text-center">Clicca "Avvia Test" per iniziare...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="restart-integrated-test" onclick="testIntegrated()" disabled>
                    <i class="fas fa-redo me-2"></i>Avvia Test
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

```

---

## File: test-accessi.html

**Percorso:** `api/static/html/test-accessi.html`
**Directory:** `api/static/html`
**Dimensione:** 6836 bytes
**Ultima modifica:** 2025-07-20 23:19:34
**Permessi:** 664

### Contenuto:

```html
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Accessi</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
    <link href="/static/css/test-accessi.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-door-open me-2"></i>
                <span class="navbar-brand mb-0 h1">Test Accessi</span>
            </div>
            <div class="system-clock mx-auto">
                <i class="fas fa-clock"></i>
                <span class="clock-time"></span>
                <span class="clock-date"></span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Test Accessi -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Test Accessi</h5>
            </div>
            <div class="card-body">
                <form id="testAccessoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="utente">Cerca Utente</label>
                                <div class="search-container">
                                    <input type="text" class="form-control" id="utente" placeholder="Cerca utente autorizzato..." required>
                                    <div id="searchResults" class="search-results" style="display: none;"></div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="ingressiMensili">Ingressi Effettuati nel Mese Corrente</label>
                                <input type="number" class="form-control" id="ingressiMensili" min="0" required>
                                <small class="form-text text-muted">Numero di ingressi già effettuati questo mese</small>
                            </div>

                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary" id="salvaIngressi">
                                    <i class="fas fa-save me-2"></i>
                                    Salva Conteggio
                                </button>
                                <button type="button" class="btn btn-success ms-2" id="simulaAccesso">
                                    <i class="fas fa-door-open me-2"></i>
                                    Simula Accesso
                                </button>
                            </div>

                            <!-- Animazione Relè -->
                            <div class="relay-status">
                                <div class="relay-component">
                                    <div class="led led-green"></div>
                                    <span>LED Verde</span>
                                </div>
                                <div class="relay-component">
                                    <div class="led led-red"></div>
                                    <span>LED Rosso</span>
                                </div>
                                <div class="relay-component">
                                    <div class="buzzer"></div>
                                    <span>Buzzer</span>
                                </div>
                                <div class="relay-component">
                                    <div class="gate"></div>
                                    <span>Cancello</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Utenti Disattivati -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Utenti Disattivati</h5>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label for="cercaCF">Cerca per Codice Fiscale</label>
                    <input type="text" class="form-control" id="cercaCF" placeholder="Inserisci il codice fiscale...">
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Cognome</th>
                                <th>Codice Fiscale</th>
                                <th>Ingressi Mensili</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="utentiDisattivati">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/static/js/alerts.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
    <script src="/static/js/test-accessi.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                // Inizializza menu utente dopo un breve delay per assicurarsi che il DOM sia aggiornato
                setTimeout(() => {
                    window.userMenu = new UserMenu();
                }, 100);
            })
            .catch(error => {
                console.error('Errore caricamento menu utente:', error);
            });
    </script>
</body>
</html>

```

---

## File: user-management.html

**Percorso:** `api/static/html/user-management.html`
**Directory:** `api/static/html`
**Dimensione:** 12262 bytes
**Ultima modifica:** 2025-07-20 21:30:05
**Permessi:** 664

### Contenuto:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Gestione Utenti Sistema - Controllo Accessi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
    <style>
        .navbar { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .role-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
        }
        .role-admin { 
            background: #4a5568; 
            color: white; 
        }
        .role-manager { 
            background: #4c51bf; 
            color: white; 
        }
        .role-viewer { 
            background: #2b6cb0; 
            color: white; 
        }
        .table th { 
            background: #f8f9fa; 
        }
        .btn-success {
            background-color: #2c7a7b;
            border-color: #2c7a7b;
        }
        .btn-success:hover {
            background-color: #285e61;
            border-color: #285e61;
        }
        .btn-outline-danger {
            color: #63171b;
            border-color: #63171b;
        }
        .btn-outline-danger:hover {
            background-color: #63171b;
            border-color: #63171b;
        }
        .btn-outline-success {
            color: #2c7a7b;
            border-color: #2c7a7b;
        }
        .btn-outline-success:hover {
            background-color: #2c7a7b;
            border-color: #2c7a7b;
        }
        .btn-outline-primary {
            color: #4c51bf;
            border-color: #4c51bf;
        }
        .btn-outline-primary:hover {
            background-color: #4c51bf;
            border-color: #4c51bf;
        }
        .modal-header.bg-success {
            background-color: #2c7a7b !important;
        }
        .badge.bg-success {
            background-color: #2c7a7b !important;
        }
        .badge.bg-danger {
            background-color: #63171b !important;
        }
        .text-danger {
            color: #63171b !important;
        }
        .text-primary {
            color: #4c51bf !important;
        }
        .text-success {
            color: #2c7a7b !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-users-cog me-2"></i>Gestione Utenti Sistema
            </span>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistiche -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-crown fa-2x text-danger mb-3"></i>
                        <h3 class="text-danger" id="admin-count">-</h3>
                        <h6 class="text-muted">Amministratori</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-user-tie fa-2x text-primary mb-3"></i>
                        <h3 class="text-primary" id="manager-count">-</h3>
                        <h6 class="text-muted">Gestori</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-eye fa-2x text-success mb-3"></i>
                        <h3 class="text-success" id="viewer-count">-</h3>
                        <h6 class="text-muted">Visualizzatori</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x text-info mb-3"></i>
                        <h3 class="text-info" id="total-count">-</h3>
                        <h6 class="text-muted">Totale Utenti</h6>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Lista Utenti -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Lista Utenti
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshUsers()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportUsers()">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Ruolo</th>
                                        <th>Creato Da</th>
                                        <th>Ultimo Accesso</th>
                                        <th>Stato</th>
                                        <th class="text-end">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Caricamento...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Nuovo Utente -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user-plus me-2"></i>Nuovo Utente
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="create-user-form">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="new-username" 
                                       required minlength="3" pattern="[a-zA-Z0-9_]+"
                                       placeholder="es. mario_rossi">
                                <div class="form-text">Solo lettere, numeri e underscore</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" id="new-password" 
                                       required minlength="8"
                                       placeholder="Password sicura">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ruolo</label>
                                <select class="form-select" id="new-role">
                                    <option value="admin">👑 Amministratore</option>
                                    <option value="user_manager">👔 Gestore Utenti</option>
                                    <option value="viewer" selected>👁️ Visualizzatore</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-plus-circle me-2"></i>Crea Utente
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Attività Recenti -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Attività Recenti
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="recent-activities" class="list-group list-group-flush">
                            <div class="list-group-item text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Password -->
    <div class="modal fade" id="tempPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>Password Temporanea
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Copia questa password temporanea e comunicala all'utente.
                        <br>Non sarà più visibile dopo la chiusura!
                    </div>
                    <h5>Username: <span id="temp-username" class="text-primary"></span></h5>
                    <div class="d-flex justify-content-center align-items-center gap-2 my-3">
                        <code id="temp-password" class="h4 mb-0"></code>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyTempPassword()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
    <script src="/static/js/users.js"></script>
    <script src="/static/js/recent-activities.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
    </script>
</body>
</html>

```

---

## File: user-menu.html

**Percorso:** `api/static/html/user-menu.html`
**Directory:** `api/static/html`
**Dimensione:** 2140 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```html
<!-- File: /opt/access_control/src/api/static/html/user-menu.html -->
<!-- Template menu utente da includere nella navbar -->

<div class="user-menu-container">
    <!-- Trigger Menu -->
    <div class="user-menu-trigger">
        <div class="user-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="user-menu-info">
            <div class="user-menu-name">{{ session.username }}</div>
            <div class="user-menu-role">{{ user_role_name }}</div>
        </div>
        <i class="fas fa-chevron-down" style="color: white; font-size: 0.8rem;"></i>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="user-menu-dropdown">
        <div class="user-menu-header">
            <div class="avatar-large">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-name">{{ session.username }}</div>
            <div class="user-email">{{ user_role_name }}</div>
        </div>
        
        <div class="user-menu-items">
            <a href="#" class="user-menu-item" data-action="profile">
                <i class="fas fa-user-circle"></i>
                <span class="user-menu-item-text">Il Mio Profilo</span>
            </a>
            
            <a href="#" class="user-menu-item" data-action="change-password">
                <i class="fas fa-key"></i>
                <span class="user-menu-item-text">Cambio Password</span>
            </a>
            
            <a href="#" class="user-menu-item" data-action="settings">
                <i class="fas fa-cog"></i>
                <span class="user-menu-item-text">Impostazioni</span>
                {% if session.role == 'admin' %}
                <span class="notification-badge">New</span>
                {% endif %}
            </a>
            
            <div class="user-menu-divider"></div>
            
            <a href="/logout" class="user-menu-item logout">
                <i class="fas fa-sign-out-alt"></i>
                <span class="user-menu-item-text">Logout</span>
            </a>
        </div>
    </div>
</div>

<!-- Overlay -->
<div class="user-menu-overlay"></div>


```

---

## File: admin-functions.js

**Percorso:** `api/static/js/admin-functions.js`
**Directory:** `api/static/js`
**Dimensione:** 7014 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/admin-functions.js
// JavaScript aggiuntivo per le funzioni admin

// Funzioni per Gestione Utenti Admin
function loadUsersData() {
    // Simula caricamento dati utenti
    console.log('Caricamento dati utenti dal sistema...');
    
    // In futuro qui si collegherà alle API reali
    const mockUsers = [
        {username: 'admin', role: 'admin', lastLogin: 'Ora', active: true},
        {username: 'manager', role: 'user_manager', lastLogin: 'Mai', active: true},
        {username: 'viewer', role: 'viewer', lastLogin: 'Mai', active: true}
    ];
    
    // Aggiorna contatori
    document.getElementById('admin-count').textContent = mockUsers.filter(u => u.role === 'admin').length;
    document.getElementById('manager-count').textContent = mockUsers.filter(u => u.role === 'user_manager').length;
    document.getElementById('viewer-count').textContent = mockUsers.filter(u => u.role === 'viewer').length;
    document.getElementById('total-users').textContent = mockUsers.length;
}

// Funzioni per Configurazioni Sistema
function loadSystemConfig() {
    console.log('Caricamento configurazioni sistema...');
    
    // Simula chiamata API
    fetch('/api/system/config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Configurazioni caricate:', data.config);
                // Popola i form con i dati reali
            }
        })
        .catch(error => {
            console.error('Errore caricamento configurazioni:', error);
        });
}

function saveSystemConfig(formData) {
    console.log('Salvataggio configurazioni...', formData);
    
    // Simula salvataggio
    return fetch('/api/system/config/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json());
}

// Funzioni per Backup & Restore (estende backup.js esistente)
function initializeBackupPage() {
    // Carica stato backup dalla API esistente
    loadBackupStatus();
    
    // Avvia polling per operazioni in corso
    setInterval(checkBackupOperations, 3000);
}

function loadBackupStatus() {
    fetch('/api/backup/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBackupStats(data);
                updateBackupsList(data.backups);
            }
        })
        .catch(error => {
            console.error('Errore caricamento stato backup:', error);
        });
}

function updateBackupStats(data) {
    // Aggiorna le statistiche nella UI
    if (document.getElementById('total-backups')) {
        document.getElementById('total-backups').textContent = data.total_backups || '0';
    }
    if (document.getElementById('total-size')) {
        document.getElementById('total-size').textContent = data.total_size || '-';
    }
    if (document.getElementById('last-backup')) {
        document.getElementById('last-backup').textContent = data.last_backup || 'Mai';
    }
    if (document.getElementById('disk-usage')) {
        document.getElementById('disk-usage').textContent = (data.disk_used_percent || 0) + '%';
    }
}

function updateBackupsList(backups) {
    const tbody = document.querySelector('#backups-table tbody');
    if (!tbody || !backups || backups.length === 0) {
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nessun backup trovato</td></tr>';
        }
        return;
    }
    
    let html = '';
    backups.forEach(backup => {
        const typeIcon = backup.type === 'complete' ? 'archive' : 'database';
        const typeColor = backup.type === 'complete' ? 'primary' : 'success';
        const typeLabel = backup.type === 'complete' ? 'Completo' : 'Database';
        
        html += `
            <tr>
                <td><i class="fas fa-${typeIcon} me-2 text-${typeColor}"></i>${backup.name}</td>
                <td><span class="badge bg-${typeColor}">${typeLabel}</span></td>
                <td>${backup.size}</td>
                <td>${new Date(backup.date).toLocaleString('it-IT')}</td>
                <td class="${backup.age_days < 7 ? 'text-success' : backup.age_days < 30 ? 'text-warning' : 'text-danger'}">${backup.age_days} giorni</td>
                <td>${backup.has_checksum ? '<i class="fas fa-check-circle text-success" title="Verificato"></i>' : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="downloadBackup('${backup.name}')" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    ${backup.can_restore ? `
                        <button class="btn btn-sm btn-success" onclick="restoreBackup('${backup.name}')" title="Ripristina">
                            <i class="fas fa-undo"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.name}')" title="Elimina">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Funzioni di utilità
function showAlert(message, type = 'info') {
    // Crea notifica Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Rimuovi dopo 5 secondi
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function formatFileSize(bytes) {
    const sizes = ['B', 'KB', 'MB', 'GB'];
    if (bytes === 0) return '0 B';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('it-IT');
}

// Esporta funzioni per uso globale
window.AdminFunctions = {
    loadUsersData,
    loadSystemConfig,
    saveSystemConfig,
    initializeBackupPage,
    loadBackupStatus,
    showAlert,
    formatFileSize,
    formatDate
};

// Auto-inizializzazione per le pagine admin
document.addEventListener('DOMContentLoaded', function() {
    // Rileva quale pagina admin è caricata e inizializza di conseguenza
    const path = window.location.pathname;
    
    if (path.includes('/admin/users')) {
        loadUsersData();
    } else if (path.includes('/admin/config')) {
        loadSystemConfig();
    } else if (path.includes('/admin/backup')) {
        initializeBackupPage();
    }
});

```

---

## File: alerts.js

**Percorso:** `api/static/js/alerts.js`
**Directory:** `api/static/js`
**Dimensione:** 904 bytes
**Ultima modifica:** 2025-07-20 13:56:17
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/alerts.js

function showAlert(message, type = 'info') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Rimuovi alert esistenti
    document.querySelectorAll('.alert').forEach(alert => alert.remove());
    
    // Inserisci nuovo alert all'inizio del container
    document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-chiudi dopo 5 secondi
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// Esporta per uso globale
window.showAlert = showAlert;

```

---

## File: backup.js

**Percorso:** `api/static/js/backup.js`
**Directory:** `api/static/js`
**Dimensione:** 8894 bytes
**Ultima modifica:** 2025-07-21 06:30:26
**Permessi:** 664

### Contenuto:

```javascript
// Backup & Restore Management

// Carica stato backup
function loadBackupStatus() {
    fetch('/api/backup/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Aggiorna statistiche
                document.querySelector('#backup-total .stat-number').textContent = data.backups.length;
                document.querySelector('#backup-size .stat-number').textContent = data.total_size;
                document.querySelector('#disk-usage .stat-number').textContent = data.disk_used_percent + '%';
                
                // Aggiorna tabella backup
                const tbody = document.querySelector('#backup-list tbody');
                tbody.innerHTML = '';
                
                data.backups.forEach(backup => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <i class="fas fa-${backup.type === 'complete' ? 'archive' : 'database'} me-2 
                               text-${backup.type === 'complete' ? 'primary' : 'success'}"></i>
                            ${backup.name}
                        </td>
                        <td>
                            <span class="badge bg-${backup.type === 'complete' ? 'primary' : 'success'}">
                                ${backup.type === 'complete' ? 'Completo' : 'Database'}
                            </span>
                        </td>
                        <td>${backup.size}</td>
                        <td>${new Date(backup.date).toLocaleString()}</td>
                        <td class="${backup.age_days < 1 ? 'text-success' : 
                                   backup.age_days < 7 ? 'text-warning' : 'text-danger'}">
                            ${backup.age_days < 1 ? 
                              Math.round((Date.now() - new Date(backup.date)) / 3600000) + ' ore' : 
                              backup.age_days + ' giorni'}
                        </td>
                        <td>
                            ${backup.has_checksum ? 
                              '<i class="fas fa-check-circle text-success" title="Verificato"></i>' : 
                              '-'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="downloadBackup('${backup.name}')" 
                                    title="Download" ${backup.can_download ? '' : 'disabled'}>
                                <i class="fas fa-download"></i>
                            </button>
                            ${backup.can_restore ? `
                                <button class="btn btn-sm btn-success" onclick="restoreBackup('${backup.name}')"
                                        title="Ripristina">
                                    <i class="fas fa-undo"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.name}')"
                                    title="Elimina">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Aggiorna configurazione backup automatico
                if (data.config) {
                    document.querySelector('#auto-backup').checked = data.config.auto_backup.enabled;
                    document.querySelector('#backup-frequency').value = 
                        Object.entries(data.config.auto_backup)
                              .find(([k, v]) => k !== 'enabled' && v.enabled)[0];
                    document.querySelector('#retention-days').value = data.config.retention.daily_keep;
                }
            }
        })
        .catch(error => console.error('Errore caricamento stato backup:', error));
}

// Crea nuovo backup
function createBackup(type) {
    if (!confirm(`Creare un backup ${type === 'complete' ? 'completo' : 'database'}?\n\nL'operazione potrebbe richiedere alcuni minuti.`)) {
        return;
    }
    
    fetch('/api/backup/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({type: type})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Backup ${type} avviato!\n\nOperation ID: ${data.operation_id}`);
            // Ricarica stato dopo 5 secondi
            setTimeout(loadBackupStatus, 5000);
        } else {
            alert('Errore durante la creazione del backup: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Errore creazione backup:', error);
        alert('Errore durante la creazione del backup');
    });
}

// Download backup
function downloadBackup(filename) {
    // Crea un link temporaneo per il download
    const link = document.createElement('a');
    link.href = `/api/backup/download/${filename}`;
    link.download = filename; // Suggerisce il nome del file
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Ripristina backup
function restoreBackup(filename) {
    if (!confirm(`Ripristinare il backup ${filename}?\n\nATTENZIONE: Questa operazione sovrascriverà i dati attuali!`)) {
        return;
    }
    
    fetch('/api/backup/restore/' + filename, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Backup ripristinato con successo!\n\n' + data.message);
            loadBackupStatus();
        } else {
            alert('Errore durante il ripristino: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Errore ripristino backup:', error);
        alert('Errore durante il ripristino del backup');
    });
}

// Elimina backup
function deleteBackup(filename) {
    if (!confirm(`Eliminare il backup ${filename}?\n\nQuesta operazione non può essere annullata.`)) {
        return;
    }
    
    fetch('/api/backup/delete/' + filename, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Backup eliminato con successo!');
            loadBackupStatus();
        } else {
            alert('Errore durante l\'eliminazione: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Errore eliminazione backup:', error);
        alert('Errore durante l\'eliminazione del backup');
    });
}

// Pulizia backup vecchi
function cleanupBackups() {
    if (!confirm('Eliminare i backup vecchi secondo la policy di retention?\n\nQuesta operazione non può essere annullata.')) {
        return;
    }
    
    fetch('/api/backup/cleanup', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Pulizia backup completata!\n\n${data.cleaned_files} file eliminati, ${data.freed_space} liberati`);
            loadBackupStatus();
        } else {
            alert('Errore durante la pulizia: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Errore pulizia backup:', error);
        alert('Errore durante la pulizia dei backup');
    });
}

// Salva configurazione backup automatico
function saveBackupConfig() {
    const config = {
        auto_backup: {
            enabled: document.querySelector('#auto-backup').checked,
            daily: {enabled: false},
            weekly: {enabled: false},
            monthly: {enabled: false}
        },
        retention: {
            daily_keep: parseInt(document.querySelector('#retention-days').value),
            weekly_keep: 4,
            monthly_keep: 6,
            max_size_gb: 10
        }
    };
    
    // Imposta frequenza selezionata
    const frequency = document.querySelector('#backup-frequency').value;
    config.auto_backup[frequency] = {
        enabled: true,
        time: "03:00",
        day: frequency === 'weekly' ? 0 : 1
    };
    
    fetch('/api/backup/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Configurazione backup salvata con successo!');
        } else {
            alert('Errore durante il salvataggio: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Errore salvataggio config:', error);
        alert('Errore durante il salvataggio della configurazione');
    });
}

// Carica stato iniziale
document.addEventListener('DOMContentLoaded', loadBackupStatus);

```

---

## File: clock.js

**Percorso:** `api/static/js/clock.js`
**Directory:** `api/static/js`
**Dimensione:** 1325 bytes
**Ultima modifica:** 2025-07-20 21:50:27
**Permessi:** 664

### Contenuto:

```javascript
// Orologio live per tutte le pagine
class Clock {
    constructor() {
        // Trova l'elemento orologio esistente invece di crearne uno nuovo
        this.clockElement = document.querySelector('.system-clock');
        if (!this.clockElement) {
            console.error('Elemento orologio non trovato nella navbar');
            return;
        }
        
        // Avvia l'orologio
        this.updateClock();
        setInterval(() => this.updateClock(), 1000);
    }
    
    updateClock() {
        if (!this.clockElement) return;
        
        const now = new Date();
        const time = now.toLocaleTimeString('it-IT', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const date = now.toLocaleDateString('it-IT', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        
        const timeEl = this.clockElement.querySelector('.clock-time');
        const dateEl = this.clockElement.querySelector('.clock-date');
        
        if (timeEl) timeEl.textContent = time;
        if (dateEl) dateEl.textContent = date;
    }
}

// Inizializza quando il DOM è pronto
document.addEventListener('DOMContentLoaded', () => {
    window.systemClock = new Clock();
});

```

---

## File: configurazione_orari.js

**Percorso:** `api/static/js/configurazione_orari.js`
**Directory:** `api/static/js`
**Dimensione:** 17397 bytes
**Ultima modifica:** 2025-07-20 23:38:05
**Permessi:** 664

### Contenuto:

```javascript
class ScheduleManager {
    constructor() {
        this.lastModifiedDayId = null;  // Traccia l'ultimo giorno modificato
        this.daysOfWeek = [
            { id: 0, name: 'Lunedi' },
            { id: 1, name: 'Martedi' },
            { id: 2, name: 'Mercoledi' },
            { id: 3, name: 'Giovedi' },
            { id: 4, name: 'Venerdi' },
            { id: 5, name: 'Sabato' },
            { id: 6, name: 'Domenica' }
        ];
        
        this.timeSlots = {
            morning: {
                open: ['00:00', '00:30', '01:00', '01:30', '02:00', '02:30', '03:00', '03:30', '04:00', '04:30', '05:00', '05:30', '06:00', '06:30', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00'],
                close: ['00:30', '01:00', '01:30', '02:00', '02:30', '03:00', '03:30', '04:00', '04:30', '05:00', '05:30', '06:00', '06:30', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00']
            },
            afternoon: {
                open: ['12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00', '21:30', '22:00', '22:30', '23:00', '23:30'],
                close: ['12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00', '21:30', '22:00', '22:30', '23:00', '23:30', '23:59']
            }
        };
        
        this.init();
    }
    
    init() {
        this.generateDays();
        this.setupEventListeners();
        this.loadCurrentSchedule();
    }
    
    generateDays() {
        const container = document.getElementById('days-container');
        container.innerHTML = ''; // Pulisci il contenitore
        
        this.daysOfWeek.forEach(day => {
            const dayHtml = this.generateDayRow(day);
            container.insertAdjacentHTML('beforeend', dayHtml);
            
            // Setup switch event
            const switchEl = document.getElementById(`${day.id}-switch`);
            if (switchEl) {
                switchEl.addEventListener('change', (e) => {
                    this.toggleDaySchedule(day.id, e.target.checked);
                });
            }
        });
    }
    
    generateDayRow(day) {
        return `
            <div class="day-row d-flex align-items-center">
                <div class="day-name">${day.name}</div>
                <div class="form-check form-switch me-3">
                    <input class="form-check-input" type="checkbox" id="${day.id}-switch" checked>
                    <label class="form-check-label" for="${day.id}-switch">Aperto</label>
                </div>
                <div class="time-slots flex-grow-1" id="${day.id}-slots">
                    <div class="time-slot morning">
                        <span class="time-label">Mattina</span>
                        <select class="form-select time-select" name="${day.id}-morning-open">
                            ${this.generateTimeOptions(this.timeSlots.morning.open, '00:00')}
                        </select>
                        <span class="time-separator">-</span>
                        <select class="form-select time-select" name="${day.id}-morning-close">
                            ${this.generateTimeOptions(this.timeSlots.morning.close, '12:00')}
                        </select>
                    </div>
                    <div class="time-slot afternoon">
                        <span class="time-label">Pomeriggio</span>
                        <select class="form-select time-select" name="${day.id}-afternoon-open">
                            ${this.generateTimeOptions(this.timeSlots.afternoon.open, '15:00')}
                        </select>
                        <span class="time-separator">-</span>
                        <select class="form-select time-select" name="${day.id}-afternoon-close">
                            ${this.generateTimeOptions(this.timeSlots.afternoon.close, '23:59')}
                        </select>
                    </div>
                </div>
            </div>
        `;
    }
    
    generateTimeOptions(times, selected) {
        return times.map(time => 
            `<option value="${time}" ${time === selected ? 'selected' : ''}>${time}</option>`
        ).join('');
    }
    
    toggleDaySchedule(dayId, isOpen) {
        const slots = document.getElementById(`${dayId}-slots`);
        const selects = slots.querySelectorAll('select');
        
        if (isOpen) {
            slots.classList.remove('disabled');
            selects.forEach(select => select.disabled = false);
        } else {
            slots.classList.add('disabled');
            selects.forEach(select => select.disabled = true);
        }
    }
    
    setupEventListeners() {
        // Salva configurazione
        document.getElementById('save-schedule').addEventListener('click', () => {
            this.saveSchedule();
        });
        
        // Copia su tutti i giorni
        document.getElementById('copy-to-all').addEventListener('click', () => {
            this.copyToAllDays();
        });
        
        // Salva limite ingressi
        document.getElementById('save-limits').addEventListener('click', () => {
            this.saveLimits();
        });

        // Aggiungi listener per tracciare l'ultimo giorno modificato
        this.daysOfWeek.forEach(day => {
            const daySlots = document.getElementById(`${day.id}-slots`);
            if (daySlots) {
                const selects = daySlots.querySelectorAll('select');
                selects.forEach(select => {
                    select.addEventListener('change', () => {
                        this.lastModifiedDayId = day.id;
                    });
                });
            }
        });
    }
    
    async loadCurrentSchedule() {
        try {
            const response = await fetch('/api/configurazione/orari');
            const data = await response.json();
            
            if (data.success && data.orari) {
                console.log('Orari caricati:', data.orari);
                
                // Mappa i giorni per nome
                const orariMap = {};
                data.orari.forEach(orario => {
                    orariMap[orario.giorno] = orario;
                    console.log(`Orari per ${orario.giorno}:`, orario);
                });
                
                this.daysOfWeek.forEach(day => {
                    const dayConfig = orariMap[day.name];
                    console.log(`Configurazione per ${day.name}:`, dayConfig);
                    
                    if (dayConfig) {
                        // Imposta switch
                        const switchEl = document.getElementById(`${day.id}-switch`);
                        if (switchEl) {
                            switchEl.checked = dayConfig.aperto;
                            this.toggleDaySchedule(day.id, dayConfig.aperto);
                        }
                        
                        // Imposta orari mattina
                        const morningOpen = document.querySelector(`select[name="${day.id}-morning-open"]`);
                        const morningClose = document.querySelector(`select[name="${day.id}-morning-close"]`);
                        if (morningOpen && morningClose) {
                            morningOpen.value = dayConfig.mattina_inizio || '00:00';
                            morningClose.value = dayConfig.mattina_fine || '12:00';
                            console.log(`Mattina ${day.name}:`, morningOpen.value, '-', morningClose.value);
                        }
                        
                        // Imposta orari pomeriggio
                        const afternoonOpen = document.querySelector(`select[name="${day.id}-afternoon-open"]`);
                        const afternoonClose = document.querySelector(`select[name="${day.id}-afternoon-close"]`);
                        if (afternoonOpen && afternoonClose) {
                            afternoonOpen.value = dayConfig.pomeriggio_inizio || '15:00';
                            afternoonClose.value = dayConfig.pomeriggio_fine || '23:59';
                            console.log(`Pomeriggio ${day.name}:`, afternoonOpen.value, '-', afternoonClose.value);
                        }
                    }
                });
            }
            
            // Carica limite ingressi
            const limitsResponse = await fetch('/api/configurazione/limiti');
            const limitsData = await limitsResponse.json();
            
            if (limitsData.success) {
                document.getElementById('max-entries').value = limitsData.max_ingressi_mensili;
            }
            
        } catch (error) {
            console.error('Errore caricamento configurazione:', error);
            showAlert('Errore caricamento configurazione', 'danger');
        }
    }
    
    async saveSchedule() {
        const orari = this.daysOfWeek.map(day => {
            const isOpen = document.getElementById(`${day.id}-switch`).checked;
            
            return {
                giorno: day.name,
                aperto: isOpen,
                mattina_inizio: isOpen ? document.querySelector(`select[name="${day.id}-morning-open"]`).value : null,
                mattina_fine: isOpen ? document.querySelector(`select[name="${day.id}-morning-close"]`).value : null,
                pomeriggio_inizio: isOpen ? document.querySelector(`select[name="${day.id}-afternoon-open"]`).value : null,
                pomeriggio_fine: isOpen ? document.querySelector(`select[name="${day.id}-afternoon-close"]`).value : null
            };
        });
        
        try {
            console.log('Salvataggio orari:', orari);
            
            const response = await fetch('/api/configurazione/orari', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orari })
            });
            
            const data = await response.json();
            console.log('Risposta salvataggio orari:', data);
            
            if (data.success) {
                showAlert('Configurazione orari salvata con successo', 'success');
                
                // Attendi un momento prima di ricaricare
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Ricarica la configurazione
                const configResponse = await fetch('/api/configurazione/orari');
                const configData = await configResponse.json();
                console.log('Risposta ricaricamento orari:', configData);
                
                if (configData.success && configData.orari) {
                    // Aggiorna l'interfaccia con i valori salvati
                    const orariMap = {};
                    configData.orari.forEach(orario => {
                        orariMap[orario.giorno] = orario;
                    });
                    
                    this.daysOfWeek.forEach(day => {
                        const dayConfig = orariMap[day.name];
                        if (dayConfig) {
                            const switchEl = document.getElementById(`${day.id}-switch`);
                            if (switchEl) {
                                switchEl.checked = dayConfig.aperto;
                                this.toggleDaySchedule(day.id, dayConfig.aperto);
                            }
                            
                            if (dayConfig.mattina_inizio) {
                                document.querySelector(`select[name="${day.id}-morning-open"]`).value = dayConfig.mattina_inizio;
                                document.querySelector(`select[name="${day.id}-morning-close"]`).value = dayConfig.mattina_fine;
                            }
                            
                            if (dayConfig.pomeriggio_inizio) {
                                document.querySelector(`select[name="${day.id}-afternoon-open"]`).value = dayConfig.pomeriggio_inizio;
                                document.querySelector(`select[name="${day.id}-afternoon-close"]`).value = dayConfig.pomeriggio_fine;
                            }
                        }
                    });
                }
            } else {
                showAlert(data.error || 'Errore salvataggio configurazione', 'danger');
            }
            
        } catch (error) {
            console.error('Errore salvataggio:', error);
            showAlert('Errore di connessione al server', 'danger');
        }
    }
    

    copyToAllDays() {
        if (this.lastModifiedDayId === null) {
            showAlert('Modifica prima un giorno per copiarlo sugli altri', 'warning');
            return;
        }

        // Prendi i valori dall'ultimo giorno modificato
        const sourceSwitch = document.getElementById(`${this.lastModifiedDayId}-switch`);
        const sourceMorningOpen = document.querySelector(`select[name="${this.lastModifiedDayId}-morning-open"]`);
        const sourceMorningClose = document.querySelector(`select[name="${this.lastModifiedDayId}-morning-close"]`);
        const sourceAfternoonOpen = document.querySelector(`select[name="${this.lastModifiedDayId}-afternoon-open"]`);
        const sourceAfternoonClose = document.querySelector(`select[name="${this.lastModifiedDayId}-afternoon-close"]`);
        
        // Applica a tutti gli altri giorni
        this.daysOfWeek.forEach(day => {
            if (day.id !== this.lastModifiedDayId) {
                const daySwitch = document.getElementById(`${day.id}-switch`);
                daySwitch.checked = sourceSwitch.checked;
                this.toggleDaySchedule(day.id, sourceSwitch.checked);
                
                document.querySelector(`select[name="${day.id}-morning-open"]`).value = sourceMorningOpen.value;
                document.querySelector(`select[name="${day.id}-morning-close"]`).value = sourceMorningClose.value;
                document.querySelector(`select[name="${day.id}-afternoon-open"]`).value = sourceAfternoonOpen.value;
                document.querySelector(`select[name="${day.id}-afternoon-close"]`).value = sourceAfternoonClose.value;
            }
        });
        
        showAlert('Orari copiati su tutti i giorni', 'success');
    }
    
    async saveLimits() {
        const maxEntries = document.getElementById('max-entries').value;
        
        if (!maxEntries || maxEntries < 1) {
            showAlert('Inserire un numero valido di ingressi mensili', 'danger');
            return;
        }
        
        try {
            console.log('Salvataggio limite:', maxEntries);
            
            const response = await fetch('/api/configurazione/limiti', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ max_ingressi_mensili: parseInt(maxEntries) })
            });
            
            const data = await response.json();
            console.log('Risposta salvataggio:', data);
            
            if (data.success) {
                showAlert('Limite ingressi mensili salvato con successo', 'success');
                
                // Attendi un momento prima di ricaricare
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Ricarica il valore salvato
                const limitsResponse = await fetch('/api/configurazione/limiti');
                const limitsData = await limitsResponse.json();
                console.log('Risposta ricaricamento:', limitsData);
                
                if (limitsData.success) {
                    document.getElementById('max-entries').value = limitsData.max_ingressi_mensili;
                    console.log('Valore aggiornato:', limitsData.max_ingressi_mensili);
                }
            } else {
                showAlert(data.error || 'Errore salvataggio limite', 'danger');
            }
            
        } catch (error) {
            console.error('Errore salvataggio:', error);
            showAlert('Errore di connessione al server', 'danger');
        }
    }
}

// Funzione per mostrare alert
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Rimuovi alert esistenti
    document.querySelectorAll('.alert').forEach(alert => alert.remove());
    
    // Inserisci nuovo alert all'inizio del container
    document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-chiudi dopo 5 secondi
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// Inizializza quando il DOM è pronto
document.addEventListener('DOMContentLoaded', () => {
    new ScheduleManager();
});

```

---

## File: dashboard.js

**Percorso:** `api/static/js/dashboard.js`
**Directory:** `api/static/js`
**Dimensione:** 26258 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/dashboard.js
// JavaScript per Dashboard Sistema Controllo Accessi

// Variabili globali per evitare inizializzazioni multiple
let dashboardInitialized = false;
let refreshInterval = null;

// ===== FUNZIONI CARICAMENTO DATI =====

function loadDashboardData() {
    // Statistiche
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('accessi-oggi').textContent = data.accessi_oggi || '0';
                document.getElementById('autorizzati').textContent = data.autorizzati_oggi || '0';
            }
        })
        .catch(error => console.error('Errore stats:', error));

    // Utenti totali
    fetch('/api/users/count')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('utenti-totali').textContent = data.count || '0';
            }
        })
        .catch(error => console.error('Errore users count:', error));

    // Accessi recenti
    fetch('/api/recent-accesses')
        .then(response => response.json())
        .then(data => {
            if (!data.error && data.accesses) {
                let html = '';
                data.accesses.slice(0, 5).forEach(access => {
                    const status = access.autorizzato ? 
                        '<span class="badge bg-success">Autorizzato</span>' : 
                        '<span class="badge bg-danger">Negato</span>';
                    const time = new Date(access.timestamp).toLocaleTimeString();
                    html += `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>${access.nome}</strong><br>
                                <small class="text-muted">${access.codice_fiscale}</small>
                            </div>
                            <div class="text-end">
                                ${status}<br>
                                <small class="text-muted">${time}</small>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('recent-accesses').innerHTML = html || '<div class="text-muted">Nessun accesso recente</div>';
            }
        })
        .catch(error => console.error('Errore recent accesses:', error));
}

// ===== TEST HARDWARE =====

// Test cancello
function testGate() {
    const status = document.getElementById('hardware-status');
    status.innerHTML = '<div class="alert alert-info">Test cancello in corso...</div>';
    
    fetch('/api/test/gate')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                status.innerHTML = '<div class="alert alert-success">✅ Test cancello completato con successo</div>';
            } else {
                status.innerHTML = `<div class="alert alert-danger">❌ ${data.error}</div>`;
            }
        })
        .catch(error => {
            status.innerHTML = `<div class="alert alert-danger">❌ Errore comunicazione: ${error}</div>`;
        })
        .finally(() => {
            setTimeout(() => status.innerHTML = '', 5000);
        });
}

// Test lettore con modal real-time
function testReader() {
    const modal = new bootstrap.Modal(document.getElementById('readerTestModal'));
    modal.show();
    
    const logContent = document.getElementById('reader-log-content');
    logContent.innerHTML = 'Cliccare "Avvia Test" per iniziare...';
    window.continuousTestMode = false;
    window.testRestarting = false;
    
    document.getElementById('start-reader-test').onclick = function() {
        if (window.continuousTestMode) {
            window.continuousTestMode = false;
            this.innerHTML = '<i class="fas fa-play"></i> Avvia Test';
            addLogLine('⏹️ ARRESTO TEST RICHIESTO', 'warning');
            addLogLine('Il test verrà fermato al prossimo ciclo');
            return;
        }
        
        window.continuousTestMode = true;
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test in corso...';
        
        logContent.innerHTML = '';
        addLogLine('🚀 AVVIO TEST LETTORE OMNIKEY 5427CK');
        addLogLine('═'.repeat(50));
        
        fetch('/api/hardware/test-reader', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    startReaderPolling();
                } else {
                    addLogLine(`❌ ERRORE: ${data.error}`, 'error');
                    resetTestButton();
                }
            });
    };
}

// Test USB-RLY08
function testRelay() {
    const modal = new bootstrap.Modal(document.getElementById('relayTestModal'));
    modal.show();
}

// Test integrato completo con tessera reale
function testIntegrated() {
    const modal = new bootstrap.Modal(document.getElementById('integratedTestModal'));
    modal.show();
    resetIntegratedTest();
    
    fetch('/api/test/integrated', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                pollIntegratedStatus();
            } else {
                document.getElementById('integrated-log').innerHTML = 
                    `<div class="text-danger">Errore: ${data.error}</div>`;
            }
        });
}

// ===== FUNZIONI POLLING =====

// Polling real-time per test lettore
function startReaderPolling() {
    const pollInterval = setInterval(() => {
        fetch('/api/hardware/status?test_id=reader')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.test) {
                    const test = data.test;
                    
                    if (test.details && test.details.length > 0) {
                        const logContent = document.getElementById('reader-log-content');
                        const currentLines = logContent.querySelectorAll('.log-line').length;
                        
                        for (let i = currentLines - 2; i < test.details.length; i++) {
                            if (i >= 0 && test.details[i]) {
                                addLogLine(test.details[i]);
                            }
                        }
                    }
                    
                    if (test.status !== 'running') {
                        if (test.status === 'success') {
                            addLogLine('🎯 TEST COMPLETATO CON SUCCESSO!', 'success');
                        } else if (test.status === 'warning') {
                            addLogLine('⚠️ TEST COMPLETATO CON AVVISI', 'warning');
                        } else {
                            addLogLine('❌ TEST FALLITO', 'error');
                        }
                        
                        addLogLine('═'.repeat(50));
                        
                        if (window.continuousTestMode && !window.testRestarting) {
                            window.testRestarting = true;
                            clearInterval(pollInterval);
                            
                            setTimeout(() => {
                                addLogLine('');
                                addLogLine('⏳ ATTESA PROSSIMA TESSERA...', 'status');
                                addLogLine('Inserire tessera per continuare il test', 'normal');
                                addLogLine('');
                            }, 500);
                            
                            setTimeout(() => {
                                window.testRestarting = false;
                                if (window.continuousTestMode) {
                                    fetch('/api/hardware/test-reader', {method: 'POST'})
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                startReaderPolling();
                                            }
                                        });
                                }
                            }, 2000);
                        } else {
                            clearInterval(pollInterval);
                        }
                        
                        resetTestButton();
                    }
                }
            })
            .catch(error => {
                clearInterval(pollInterval);
                addLogLine(`❌ Errore polling: ${error}`, 'error');
                resetTestButton();
            });
    }, 1000);
}

// Funzione per test sequenziale relay con animazioni real-time
function startRelaySequence() {
    const btn = document.getElementById('start-relay-test');
    const log = document.getElementById('relay-log');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Test in corso...';
    
    log.innerHTML = 'Avvio test USB-RLY08...\n';
    
    for (let i = 1; i <= 8; i++) {
        document.getElementById(`relay-${i}`).classList.remove('active');
    }
    resetDevices();
    
    fetch('/api/test_relay', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            pollRelayStatus();
        } else {
            log.innerHTML = 'ERRORE: ' + (data.error || 'Errore sconosciuto');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play me-2"></i>Avvia Test Sequenziale';
        }
    })
    .catch(error => {
        log.innerHTML = 'ERRORE CONNESSIONE: ' + error.message;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i>Avvia Test Sequenziale';
    });
}

// Polling stato relay per animazioni real-time
function pollRelayStatus() {
    const pollInterval = setInterval(() => {
        fetch('/api/relay_status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'idle') {
                    clearInterval(pollInterval);
                    return;
                }
                
                if (data.log) {
                    document.getElementById('relay-log').innerHTML = data.log.join('\n');
                    const logDiv = document.getElementById('relay-log');
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
                
                if (data.relay_states) {
                    updateRelayVisuals(data.relay_states);
                }
                
                if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(pollInterval);
                    const btn = document.getElementById('start-relay-test');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play me-2"></i>Avvia Test Sequenziale';
                    
                    setTimeout(() => {
                        for (let i = 1; i <= 8; i++) {
                            document.getElementById(`relay-${i}`).classList.remove('active');
                        }
                        resetDevices();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Errore polling:', error);
                clearInterval(pollInterval);
            });
    }, 100);
}

// Polling stato test integrato
function pollIntegratedStatus() {
    const pollInterval = setInterval(() => {
        fetch('/api/integrated_status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'idle') {
                    clearInterval(pollInterval);
                    return;
                }
                
                if (data.log) {
                    const logHtml = data.log.map(line => {
                        let className = 'log-line';
                        if (line.includes('✅')) className += ' text-success';
                        else if (line.includes('❌')) className += ' text-danger';
                        else if (line.includes('🟡') || line.includes('💳')) className += ' text-warning';
                        else if (line.includes('📄') || line.includes('👤')) className += ' text-info';
                        return `<div class="${className}">${line}</div>`;
                    }).join('');
                    
                    document.getElementById('integrated-log').innerHTML = logHtml;
                    
                    const logDiv = document.getElementById('integrated-log');
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
                
                updateIntegratedAnimations(data);
                
                if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(pollInterval);
                    document.getElementById('restart-integrated-test').disabled = false;
                }
            })
            .catch(error => {
                console.error('Errore polling:', error);
                clearInterval(pollInterval);
            });
    }, 100);
}

// ===== FUNZIONI HELPER =====

// Aggiungi linea al log con SCROLL FUNZIONANTE
function addLogLine(text, type = 'normal') {
    const logContent = document.getElementById('reader-log-content');
    const timestamp = new Date().toLocaleTimeString();
    
    let color = '#00ff00';
    if (type === 'error') color = '#ff4444';
    if (type === 'warning') color = '#ffaa00';
    if (type === 'success') color = '#44ff44';
    if (type === 'status') color = '#00aaff';
    
    const line = document.createElement('div');
    line.className = 'log-line';
    line.style.color = color;
    line.style.marginBottom = '2px';
    line.innerHTML = `[${timestamp}] ${text}`;
    
    logContent.appendChild(line);
    
    const logContainer = document.getElementById('reader-test-log');
    if (logContainer) {
        const isScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 50;
        
        if (isScrolledToBottom) {
            setTimeout(() => {
                logContainer.scrollTop = logContainer.scrollHeight;
            }, 10);
        }
    }
}

// Reset pulsante test
function resetTestButton() {
    const btn = document.getElementById('start-reader-test');
    btn.disabled = false;
    if (window.continuousTestMode) {
        btn.innerHTML = '<i class="fas fa-stop"></i> Ferma Test';
    } else {
        btn.innerHTML = '<i class="fas fa-play"></i> Avvia Test';
    }
}

// Aggiorna visualizzazione relay e dispositivi collegati
function updateRelayVisuals(relayStates) {
    for (let i = 1; i <= 8; i++) {
        const relayBox = document.getElementById(`relay-${i}`);
        if (relayStates[i]) {
            relayBox.classList.add('active');
        } else {
            relayBox.classList.remove('active');
        }
    }
    
    // Aggiorna dispositivi in base ai relay attivi
    if (relayStates[1]) {
        document.getElementById('gate-visual').classList.add('open');
    } else {
        document.getElementById('gate-visual').classList.remove('open');
    }
    
    if (relayStates[2]) {
        document.getElementById('led-red').classList.add('active');
    } else {
        document.getElementById('led-red').classList.remove('active');
    }
    
    if (relayStates[3]) {
        document.getElementById('led-green').classList.add('active');
    } else {
        document.getElementById('led-green').classList.remove('active');
    }
    
    if (relayStates[4]) {
        document.getElementById('led-yellow').classList.add('active');
    } else {
        document.getElementById('led-yellow').classList.remove('active');
    }
    
    if (relayStates[5]) {
        document.getElementById('buzzer').classList.add('active');
    } else {
        document.getElementById('buzzer').classList.remove('active');
    }
}

// Reset tutti i dispositivi
function resetDevices() {
    document.getElementById('gate-visual').classList.remove('open');
    document.getElementById('led-red').classList.remove('active');
    document.getElementById('led-green').classList.remove('active');
    document.getElementById('led-yellow').classList.remove('active');
    document.getElementById('buzzer').classList.remove('active');
}

// Aggiorna animazioni test integrato
function updateIntegratedAnimations(data) {
    const cardVisual = document.getElementById('card-visual');
    const readerVisual = document.getElementById('reader-visual');
    const gateVisual = document.getElementById('integrated-gate');
    const statusText = document.getElementById('integrated-status');
    
    switch(data.phase) {
        case 'connecting':
            statusText.innerHTML = '<i class="fas fa-sync fa-spin"></i> Connessione hardware...';
            statusText.className = 'text-info';
            break;
            
        case 'waiting_card':
            cardVisual.className = 'card-animation waiting';
            readerVisual.className = 'reader-visual scanning';
            statusText.innerHTML = '<i class="fas fa-hand-paper"></i> INSERIRE TESSERA NEL LETTORE';
            statusText.className = 'text-warning animated-text';
            document.getElementById('integrated-led-yellow').classList.add('blink');
            break;
            
        case 'reading_card':
            cardVisual.className = 'card-animation inserting';
            readerVisual.className = 'reader-visual active';
            statusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lettura tessera in corso...';
            statusText.className = 'text-info';
            document.getElementById('integrated-led-yellow').classList.remove('blink');
            break;
            
        case 'access_granted':
            cardVisual.className = 'card-animation success';
            readerVisual.className = 'reader-visual success';
            statusText.innerHTML = '<i class="fas fa-check-circle"></i> ACCESSO AUTORIZZATO!';
            statusText.className = 'text-success fw-bold';
            document.getElementById('integrated-led-green').classList.add('active');
            document.getElementById('integrated-led-red').classList.remove('active');
            gateVisual.classList.add('open');
            document.getElementById('integrated-buzzer').classList.add('active');
            setTimeout(() => {
                document.getElementById('integrated-buzzer').classList.remove('active');
            }, 200);
            break;
            
        case 'access_denied':
            cardVisual.className = 'card-animation denied';
            readerVisual.className = 'reader-visual denied';
            statusText.innerHTML = '<i class="fas fa-times-circle"></i> ACCESSO NEGATO!';
            statusText.className = 'text-danger fw-bold';
            document.getElementById('integrated-led-red').classList.add('active');
            document.getElementById('integrated-led-green').classList.remove('active');
            let beepCount = 0;
            const beepInterval = setInterval(() => {
                document.getElementById('integrated-buzzer').classList.toggle('active');
                beepCount++;
                if (beepCount >= 6) clearInterval(beepInterval);
            }, 150);
            break;
        
        case 'timeout':
            cardVisual.className = 'card-animation';
            readerVisual.className = 'reader-visual';
            statusText.innerHTML = '<i class="fas fa-clock"></i> Timeout - Nessuna tessera inserita';
            statusText.className = 'text-warning';
            document.getElementById('integrated-led-yellow').classList.remove('blink');
            break;
            
        case 'error':
            statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Errore durante il test';
            statusText.className = 'text-danger';
            break;
            
        case 'completed':
            setTimeout(() => {
                if (data.authorized) {
                    gateVisual.classList.remove('open');
                    document.getElementById('integrated-led-green').classList.remove('active');
                } else {
                    document.getElementById('integrated-led-red').classList.remove('active');
                }
                document.getElementById('integrated-led-yellow').classList.remove('blink');
                cardVisual.className = 'card-animation';
                statusText.innerHTML = '<i class="fas fa-check"></i> Test completato';
                statusText.className = 'text-info';
            }, 3000);
            break;
    }
}

// Reset test integrato
function resetIntegratedTest() {
    document.getElementById('integrated-log').innerHTML = 
        '<div class="text-muted text-center">Clicca "Avvia Test" per iniziare...</div>';
    document.getElementById('integrated-status').innerHTML = 
        '<i class="fas fa-info-circle"></i> Pronto';
    document.getElementById('integrated-status').className = '';
    document.getElementById('card-visual').className = 'card-animation';
    document.getElementById('reader-visual').className = 'reader-visual';
    document.getElementById('integrated-gate').classList.remove('open');
    document.getElementById('integrated-led-green').classList.remove('active');
    document.getElementById('integrated-led-red').classList.remove('active');
    document.getElementById('integrated-led-yellow').classList.remove('active', 'blink');
    document.getElementById('integrated-buzzer').classList.remove('active');
    document.getElementById('restart-integrated-test').disabled = true;
}

// Funzione globale per pulire backdrop residui
function cleanupModals() {
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    const bodyAttributes = ['data-bs-padding-right', 'data-bs-overflow'];
    bodyAttributes.forEach(attr => document.body.removeAttribute(attr));
}

// ===== INIZIALIZZAZIONE =====

// Inizializza event listeners per modals dopo il caricamento
function initializeModalListeners() {
    const integratedModal = document.getElementById('integratedTestModal');
    if (integratedModal) {
        integratedModal.addEventListener('shown.bs.modal', function () {
            document.getElementById('restart-integrated-test').disabled = false;
        });
        
        integratedModal.addEventListener('hidden.bs.modal', function () {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        });
    }
    
    const relayModal = document.getElementById('relayTestModal');
    if (relayModal) {
        relayModal.addEventListener('hidden.bs.modal', function () {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style = '';
        });
    }
    
    const readerModal = document.getElementById('readerTestModal');
    if (readerModal) {
        readerModal.addEventListener('hidden.bs.modal', function () {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style = '';
        });
    }
}

// ===== INIZIALIZZAZIONE AL CARICAMENTO PAGINA =====
// UN SOLO EVENT LISTENER DOMContentLoaded!

document.addEventListener('DOMContentLoaded', function() {
    if (dashboardInitialized) return;
    dashboardInitialized = true;
    
    // Inizializza listeners per i modal (solo se è admin)
    if (window.userRole === 'admin') {
        initializeModalListeners();
    }
    
    // Carica i dati della dashboard UNA SOLA VOLTA
    loadDashboardData();
    
    // Clear any existing interval
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    // Auto-refresh ogni 5 secondi con un singolo interval
    refreshInterval = setInterval(loadDashboardData, 5000);
    
    // Cleanup quando si lascia la pagina
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    });
    
    // Controlla se deve aprire automaticamente il profilo
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show_profile') === 'true') {
        window.history.replaceState({}, document.title, '/');
        setTimeout(() => {
            if (window.userMenu) {
                window.userMenu.showProfileModal();
            }
        }, 500);
    }
});

// Funzioni helper per la nuova gestione utenti

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Funzioni per User Manager
function showCreateViewerModal() {
    // Implementa modal per creare viewer
    alert('TODO: Implementare modal creazione viewer');
}

function openExportModal() {
    // Implementa modal per export log
    alert('TODO: Implementare modal export Excel');
}
```

---

## File: hardware-manager.js

**Percorso:** `api/static/js/hardware-manager.js`
**Directory:** `api/static/js`
**Dimensione:** 19980 bytes
**Ultima modifica:** 2025-07-24 11:54:36
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/hardware-manager.js
// Interfaccia hardware semplice: RILEVA + CONFIGURA

class SimpleHardwareManager {
    constructor() {
        this.hardwareList = document.getElementById('hardware-list');
        this.detectButton = document.getElementById('detect-hardware');
        this.saveButton = document.getElementById('save-hardware-config');
        
        this.detectedHardware = {
            usb_devices: [],
            serial_ports: [],
            hid_devices: []
        };
        this.deviceAssignments = {};
        
        this.init();
    }
    
    init() {
        if (this.detectButton) {
            this.detectButton.addEventListener('click', () => this.detectHardware());
        }
        
        if (this.saveButton) {
            this.saveButton.addEventListener('click', () => this.saveConfiguration());
        }
        
        // Carica configurazione esistente
        this.loadConfiguration();
        
        // Auto-rilevamento iniziale
        this.detectHardware();
    }
    
    async detectHardware() {
        if (!this.detectButton) return;
        
        this.detectButton.disabled = true;
        this.detectButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Rilevamento...';
        this.showLoadingMessage();
        
        try {
            const response = await fetch('/api/hardware/detect');
            const data = await response.json();
            
            console.log('Hardware rilevato:', data);
            
            if (data.success) {
                this.detectedHardware = data;
                this.displayHardware(data);
                this.showAlert('success', data.message);
            } else {
                this.showAlert('danger', `Errore: ${data.error}`);
                this.showErrorMessage(data.error);
            }
        } catch (error) {
            console.error('Errore rilevamento:', error);
            this.showAlert('danger', `Errore comunicazione: ${error.message}`);
            this.showErrorMessage(error.message);
        } finally {
            this.detectButton.disabled = false;
            this.detectButton.innerHTML = '<i class="fas fa-search me-2"></i>Rileva Hardware';
        }
    }
    
    displayHardware(data) {
        if (!this.hardwareList) return;
        
        let html = `
            <div class="row">
                <!-- PARTE 1: HARDWARE RILEVATO -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                Hardware Rilevato (comandi Linux)
                            </h5>
                        </div>
                        <div class="card-body">
                            ${this.generateDetectedHardwareSection(data)}
                        </div>
                    </div>
                </div>
                
                <!-- PARTE 2: CONFIGURAZIONE -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                Configurazione Software
                            </h5>
                        </div>
                        <div class="card-body">
                            ${this.generateConfigurationSection()}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        this.hardwareList.innerHTML = html;
        this.attachEventHandlers();
    }
    
    generateDetectedHardwareSection(data) {
        let html = '';
        
        // Dispositivi USB
        if (data.usb_devices && data.usb_devices.length > 0) {
            html += '<h6><i class="fas fa-usb me-2 text-primary"></i>Dispositivi USB (lsusb)</h6>';
            html += '<div class="table-responsive mb-4">';
            html += '<table class="table table-sm table-striped">';
            html += '<thead><tr><th>ID</th><th>Descrizione</th><th>Bus/Dev</th><th>Azioni</th></tr></thead><tbody>';
            
            data.usb_devices.forEach((device, index) => {
                html += `
                    <tr>
                        <td><code>${device.device_id}</code></td>
                        <td>${device.description}</td>
                        <td>Bus ${device.bus}, Dev ${device.device}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="hardwareManager.selectForConfig('usb', ${index})">
                                <i class="fas fa-arrow-right"></i> Usa
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        // Porte seriali
        if (data.serial_ports && data.serial_ports.length > 0) {
            html += '<h6><i class="fas fa-plug me-2 text-warning"></i>Porte Seriali (ls /dev/tty*)</h6>';
            html += '<div class="table-responsive mb-4">';
            html += '<table class="table table-sm table-striped">';
            html += '<thead><tr><th>Porta</th><th>Tipo</th><th>Stato</th><th>Azioni</th></tr></thead><tbody>';
            
            data.serial_ports.forEach((port, index) => {
                const statusBadge = port.accessible 
                    ? '<span class="badge bg-success">OK</span>' 
                    : '<span class="badge bg-danger">Inaccessibile</span>';
                
                html += `
                    <tr>
                        <td><code>${port.port}</code></td>
                        <td>${port.type}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="hardwareManager.selectForConfig('serial', ${index})">
                                <i class="fas fa-arrow-right"></i> Usa
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        // Dispositivi HID
        if (data.hid_devices && data.hid_devices.length > 0) {
            html += '<h6><i class="fas fa-keyboard me-2 text-info"></i>Dispositivi HID (ls /dev/hidraw*)</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-striped">';
            html += '<thead><tr><th>Dispositivo</th><th>Tipo</th><th>Azioni</th></tr></thead><tbody>';
            
            data.hid_devices.forEach((device, index) => {
                html += `
                    <tr>
                        <td><code>${device.device}</code></td>
                        <td>${device.type}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="hardwareManager.selectForConfig('hid', ${index})">
                                <i class="fas fa-arrow-right"></i> Usa
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        if (!data.usb_devices?.length && !data.serial_ports?.length && !data.hid_devices?.length) {
            html = '<div class="alert alert-warning">Nessun hardware rilevato</div>';
        }
        
        return html;
    }
    
    generateConfigurationSection() {
        return `
            <div class="mb-3">
                <label class="form-label"><strong>Lettore Tessere:</strong></label>
                <select class="form-select mb-2" id="card-reader-select">
                    <option value="">-- Seleziona dispositivo --</option>
                </select>
                <button class="btn btn-sm btn-outline-success" onclick="hardwareManager.testDevice('card_reader')">
                    <i class="fas fa-vial"></i> Test
                </button>
                <div id="card-reader-test-result" class="mt-2"></div>
            </div>
            
            <div class="mb-3">
                <label class="form-label"><strong>Controller Relè:</strong></label>
                <select class="form-select mb-2" id="relay-controller-select">
                    <option value="">-- Seleziona dispositivo --</option>
                </select>
                <button class="btn btn-sm btn-outline-success" onclick="hardwareManager.testDevice('relay_controller')">
                    <i class="fas fa-vial"></i> Test
                </button>
                <div id="relay-controller-test-result" class="mt-2"></div>
            </div>
            
            <div class="d-grid">
                <button class="btn btn-primary" onclick="hardwareManager.saveConfiguration()">
                    <i class="fas fa-save me-2"></i>Salva Configurazione
                </button>
            </div>
            
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Seleziona i dispositivi dalla lista a sinistra, poi clicca "Usa" per assegnarli.
                </small>
            </div>
        `;
    }
    
    selectForConfig(sourceType, deviceIndex) {
        let device = null;
        let deviceKey = '';
        let deviceName = '';
        
        if (sourceType === 'usb') {
            device = this.detectedHardware.usb_devices[deviceIndex];
            deviceKey = `usb:${device.device_id}`;
            deviceName = `${device.description} (${device.device_id})`;
        } else if (sourceType === 'serial') {
            device = this.detectedHardware.serial_ports[deviceIndex];
            deviceKey = `serial:${device.port}`;
            deviceName = `${device.port} (${device.type})`;
        } else if (sourceType === 'hid') {
            device = this.detectedHardware.hid_devices[deviceIndex];
            deviceKey = `hid:${device.device}`;
            deviceName = `${device.device} (HID)`;
        }
        
        if (!device) return;
        
        // Mostra modal per selezione funzione
        this.showDeviceAssignmentModal(deviceKey, deviceName, device);
    }
    
    showDeviceAssignmentModal(deviceKey, deviceName, deviceData) {
        const modalContent = `
            <div class="modal fade" id="assignmentModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Assegna Funzione Dispositivo</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Dispositivo:</strong> ${deviceName}</p>
                            <div class="mb-3">
                                <label class="form-label">Funzione nel software:</label>
                                <select class="form-select" id="device-function-select">
                                    <option value="">-- Seleziona funzione --</option>
                                    <option value="card_reader">Lettore Tessere</option>
                                    <option value="relay_controller">Controller Relè</option>
                                    <option value="other">Altro (non utilizzato)</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                            <button type="button" class="btn btn-primary" onclick="hardwareManager.confirmAssignment('${deviceKey}', '${deviceName}')">
                                Assegna
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Rimuovi modal esistente
        const existingModal = document.getElementById('assignmentModal');
        if (existingModal) existingModal.remove();
        
        // Aggiungi nuovo modal
        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('assignmentModal'));
        modal.show();
    }
    
    confirmAssignment(deviceKey, deviceName) {
        const functionSelect = document.getElementById('device-function-select');
        const selectedFunction = functionSelect.value;
        
        if (!selectedFunction) {
            alert('Seleziona una funzione per il dispositivo');
            return;
        }
        
        // Salva assegnazione
        this.deviceAssignments[selectedFunction] = {
            device_key: deviceKey,
            device_name: deviceName
        };
        
        // Aggiorna dropdown configurazione
        this.updateConfigurationDropdowns();
        
        // Chiudi modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('assignmentModal'));
        modal.hide();
        
        this.showAlert('success', `${deviceName} assegnato come ${this.getFunctionDisplayName(selectedFunction)}`);
    }
    
    updateConfigurationDropdowns() {
        // Aggiorna dropdown lettore tessere
        const cardReaderSelect = document.getElementById('card-reader-select');
        if (cardReaderSelect) {
            cardReaderSelect.innerHTML = '<option value="">-- Seleziona dispositivo --</option>';
            if (this.deviceAssignments.card_reader) {
                cardReaderSelect.innerHTML += `<option value="card_reader" selected>${this.deviceAssignments.card_reader.device_name}</option>`;
            }
        }
        
        // Aggiorna dropdown controller relè
        const relaySelect = document.getElementById('relay-controller-select');
        if (relaySelect) {
            relaySelect.innerHTML = '<option value="">-- Seleziona dispositivo --</option>';
            if (this.deviceAssignments.relay_controller) {
                relaySelect.innerHTML += `<option value="relay_controller" selected>${this.deviceAssignments.relay_controller.device_name}</option>`;
            }
        }
    }
    
    getFunctionDisplayName(functionKey) {
        const names = {
            'card_reader': 'Lettore Tessere',
            'relay_controller': 'Controller Relè',
            'other': 'Altro'
        };
        return names[functionKey] || functionKey;
    }
    
    async testDevice(deviceType) {
        const assignment = this.deviceAssignments[deviceType];
        if (!assignment) {
            this.showAlert('warning', 'Nessun dispositivo assegnato per il test');
            return;
        }
        
        const resultDiv = document.getElementById(`${deviceType.replace('_', '-')}-test-result`);
        if (resultDiv) {
            resultDiv.innerHTML = '<small class="text-info">Test in corso...</small>';
        }
        
        try {
            const response = await fetch('/api/hardware/test-connection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type: deviceType,
                    device_path: assignment.device_key,
                    device_id: assignment.device_key
                })
            });
            
            const data = await response.json();
            this.showTestResult(deviceType, data.success, data);
            
        } catch (error) {
            this.showTestResult(deviceType, false, {error: error.message});
        }
    }
    
    showTestResult(deviceType, success, data) {
        const resultDiv = document.getElementById(`${deviceType.replace('_', '-')}-test-result`);
        if (!resultDiv) return;
        
        const alertClass = success ? 'alert-success' : 'alert-danger';
        const icon = success ? 'fa-check-circle' : 'fa-times-circle';
        const message = data.message || (success ? 'Test OK' : data.error || 'Test fallito');
        
        resultDiv.innerHTML = `
            <div class="alert ${alertClass} alert-sm mb-0">
                <small><i class="fas ${icon} me-1"></i> ${message}</small>
            </div>
        `;
    }
    
    async loadConfiguration() {
        try {
            const response = await fetch('/api/hardware/config');
            const data = await response.json();
            
            if (data.success && data.config) {
                this.deviceAssignments = data.config.assignments || {};
                this.updateConfigurationDropdowns();
            }
        } catch (error) {
            console.error('Errore caricamento configurazione:', error);
        }
    }
    
    async saveConfiguration() {
        try {
            const response = await fetch('/api/hardware/config/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    assignments: this.deviceAssignments
                })
            });
            
            const data = await response.json();
            if (data.success) {
                this.showAlert('success', 'Configurazione salvata con successo');
            } else {
                this.showAlert('danger', `Errore salvataggio: ${data.error}`);
            }
        } catch (error) {
            this.showAlert('danger', `Errore: ${error.message}`);
        }
    }
    
    showLoadingMessage() {
        if (this.hardwareList) {
            this.hardwareList.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p>Esecuzione comandi Linux di rilevamento...</p>
                    <small class="text-muted">lsusb, ls /dev/tty*, ls /dev/hidraw*</small>
                </div>
            `;
        }
    }
    
    showErrorMessage(error) {
        if (this.hardwareList) {
            this.hardwareList.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Errore Rilevamento</h6>
                    <p><code>${error}</code></p>
                    <button class="btn btn-primary" onclick="hardwareManager.detectHardware()">
                        <i class="fas fa-redo me-2"></i>Riprova
                    </button>
                </div>
            `;
        }
    }
    
    showAlert(type, message) {
        // Implementazione alert (uguale a prima)
        const existingAlerts = document.querySelectorAll('.hardware-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show hardware-alert`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        if (this.hardwareList && this.hardwareList.parentNode) {
            this.hardwareList.parentNode.insertBefore(alertDiv, this.hardwareList);
        }
        
        setTimeout(() => alertDiv?.remove(), 5000);
    }
    
    attachEventHandlers() {
        // Event handlers già gestiti negli onclick inline
    }
}

// Inizializza
document.addEventListener('DOMContentLoaded', function() {
    window.hardwareManager = new SimpleHardwareManager();
});
```

---

## File: hardware_test.js

**Percorso:** `api/static/js/hardware_test.js`
**Directory:** `api/static/js`
**Dimensione:** 6964 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript

// File: /opt/access_control/src/api/static/hardware_test.js
// JavaScript per test hardware real-time

// Variabili per polling test
let testPollingIntervals = {};

// Funzione per avviare test lettore
async function startReaderTest() {
    const button = document.getElementById('test-reader-btn');
    const output = document.getElementById('reader-test-output');
    
    if (!button || !output) {
        console.error('Elementi test lettore non trovati');
        return;
    }
    
    // Disabilita pulsante
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test in corso...';
    
    // Pulisci output
    output.innerHTML = '<div class="loading">Avvio test lettore...</div>';
    
    try {
        // Avvia test
        const response = await fetch('/api/test/reader', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Avvia polling per aggiornamenti
            startTestPolling('reader', output, button, 'Test Lettore');
        } else {
            output.innerHTML = `<div class="error">❌ ${data.error}</div>`;
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-play"></i> Test Lettore';
        }
    } catch (error) {
        output.innerHTML = `<div class="error">❌ Errore: ${error.message}</div>`;
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-play"></i> Test Lettore';
    }
}

// Funzione per avviare test USB-RLY08
async function startRelayTest() {
    const button = document.getElementById('test-relay-btn');
    const output = document.getElementById('relay-test-output');
    
    if (!button || !output) {
        console.error('Elementi test relay non trovati');
        return;
    }
    
    // Disabilita pulsante
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test in corso...';
    
    // Pulisci output
    output.innerHTML = '<div class="loading">Avvio test USB-RLY08...</div>';
    
    try {
        // Avvia test
        const response = await fetch('/api/test/relay', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Avvia polling per aggiornamenti
            startTestPolling('relay', output, button, 'Test USB-RLY08');
        } else {
            output.innerHTML = `<div class="error">❌ ${data.error}</div>`;
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-play"></i> Test USB-RLY08';
        }
    } catch (error) {
        output.innerHTML = `<div class="error">❌ Errore: ${error.message}</div>`;
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-play"></i> Test USB-RLY08';
    }
}

// Polling per aggiornamenti test
function startTestPolling(testId, outputElement, buttonElement, buttonText) {
    // Ferma polling precedente se esiste
    if (testPollingIntervals[testId]) {
        clearInterval(testPollingIntervals[testId]);
    }
    
    testPollingIntervals[testId] = setInterval(async () => {
        try {
            const response = await fetch(`/api/test/status?test_id=${testId}`);
            const data = await response.json();
            
            if (data.success && data.test) {
                const test = data.test;
                
                // Aggiorna output
                let html = `<div class="test-status test-${test.status}">`;
                html += `<strong>Status:</strong> ${test.message}<br>`;
                html += `<strong>Tempo:</strong> ${new Date(test.timestamp * 1000).toLocaleTimeString()}<br><br>`;
                
                if (test.details && test.details.length > 0) {
                    html += '<strong>Dettagli:</strong><br>';
                    html += '<div class="test-details">';
                    test.details.forEach(detail => {
                        html += `${detail}<br>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                outputElement.innerHTML = html;
                
                // Se test completato, riabilita pulsante
                if (test.status !== 'running') {
                    clearInterval(testPollingIntervals[testId]);
                    delete testPollingIntervals[testId];
                    
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = `<i class="fas fa-play"></i> ${buttonText}`;
                }
            }
        } catch (error) {
            console.error('Errore polling test:', error);
        }
    }, 1000); // Aggiorna ogni secondo
}

// Cleanup polling quando si cambia pagina
window.addEventListener('beforeunload', function() {
    Object.values(testPollingIntervals).forEach(interval => {
        clearInterval(interval);
    });
});

// Aggiungi CSS per styling test
function addTestStyles() {
    if (document.getElementById('test-hardware-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'test-hardware-styles';
    style.textContent = `
        .test-status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .test-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .test-running {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .test-details {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-output {
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
    `;
    document.head.appendChild(style);
}

// Inizializza quando DOM è pronto
document.addEventListener('DOMContentLoaded', function() {
    addTestStyles();
});

```

---

## File: profilo.js

**Percorso:** `api/static/js/profilo.js`
**Directory:** `api/static/js`
**Dimensione:** 4005 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/profilo.js
// JavaScript per la gestione del profilo utente

// Funzione per mostrare messaggi
function showProfileMessage(message, type = 'info') {
    const container = document.getElementById('profile-message');
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 'alert-info';
    const icon = type === 'error' ? 'fa-exclamation-circle' : 
                type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
    
    container.innerHTML = `
        <div class="alert ${alertClass}">
            <i class="fas ${icon}"></i> ${message}
        </div>
    `;
    
    // Rimuovi il messaggio dopo 5 secondi
    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}

// Valutazione forza password
function checkPasswordStrength(password) {
    let strength = 0;
    const strengthDiv = document.getElementById('password-strength');
    
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]+/)) strength++;
    if (password.match(/[A-Z]+/)) strength++;
    if (password.match(/[0-9]+/)) strength++;
    if (password.match(/[^a-zA-Z0-9]+/)) strength++;
    
    if (password.length < 6) {
        strengthDiv.innerHTML = '';
        return;
    }
    
    let strengthText = '';
    let strengthClass = '';
    
    if (strength <= 2) {
        strengthText = 'Password debole';
        strengthClass = 'strength-weak';
    } else if (strength <= 3) {
        strengthText = 'Password media';
        strengthClass = 'strength-medium';
    } else {
        strengthText = 'Password forte';
        strengthClass = 'strength-strong';
    }
    
    strengthDiv.innerHTML = `<span class="${strengthClass}">
        <i class="fas fa-shield-alt"></i> ${strengthText}
    </span>`;
}

// Inizializzazione quando il DOM è pronto
document.addEventListener('DOMContentLoaded', function() {
    // Event listener per la valutazione password
    const newPasswordField = document.getElementById('new-password');
    if (newPasswordField) {
        newPasswordField.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
    }
    
    // Gestione form cambio password
    const changePasswordForm = document.getElementById('change-password-form');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Validazione lato client
            if (data.new_password !== data.confirm_password) {
                showProfileMessage('Le password non coincidono', 'error');
                return;
            }
            
            if (data.new_password.length < 6) {
                showProfileMessage('La password deve essere di almeno 6 caratteri', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/profile/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showProfileMessage('Password aggiornata con successo', 'success');
                    this.reset();
                    document.getElementById('password-strength').innerHTML = '';
                } else {
                    showProfileMessage(result.error || 'Errore durante il cambio password', 'error');
                }
            } catch (error) {
                showProfileMessage('Errore di connessione al server', 'error');
                console.error('Errore:', error);
            }
        });
    }
});

```

---

## File: recent-activities.js

**Percorso:** `api/static/js/recent-activities.js`
**Directory:** `api/static/js`
**Dimensione:** 3147 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript
// Gestione attività recenti
const activitiesContainer = document.getElementById('recent-activities');

// Carica attività recenti
function loadRecentActivities() {
    fetch('/api/recent-activities')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '';
                data.activities.forEach(activity => {
                    html += getActivityItem(activity);
                });
                activitiesContainer.innerHTML = html || `
                    <div class="list-group-item text-center text-muted">
                        <small>Nessuna attività recente</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Errore caricamento attività:', error);
            activitiesContainer.innerHTML = `
                <div class="list-group-item text-center text-danger">
                    <small>Errore caricamento attività</small>
                </div>
            `;
        });
}

// Formatta elemento attività
function getActivityItem(activity) {
    const icons = {
        'CONFIG_UPDATE': 'fas fa-cog',
        'USER_CREATE': 'fas fa-user-plus',
        'USER_UPDATE': 'fas fa-user-edit',
        'USER_DELETE': 'fas fa-user-times',
        'LOGIN': 'fas fa-sign-in-alt',
        'LOGOUT': 'fas fa-sign-out-alt',
        'PASSWORD_RESET': 'fas fa-key',
        'SYSTEM': 'fas fa-server'
    };

    const icon = icons[activity.type] || 'fas fa-info-circle';
    const time = formatActivityTime(activity.timestamp);

    return `
        <div class="list-group-item">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="${icon} fa-lg text-primary"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="mb-1">${activity.message}</div>
                    <small class="text-muted">${time}</small>
                </div>
            </div>
        </div>
    `;
}

// Formatta timestamp
function formatActivityTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    // Meno di un minuto
    if (diff < 60000) {
        return 'Adesso';
    }
    
    // Meno di un'ora
    if (diff < 3600000) {
        const minutes = Math.floor(diff / 60000);
        return `${minutes} minut${minutes === 1 ? 'o' : 'i'} fa`;
    }
    
    // Meno di un giorno
    if (diff < 86400000) {
        const hours = Math.floor(diff / 3600000);
        return `${hours} or${hours === 1 ? 'a' : 'e'} fa`;
    }
    
    // Meno di una settimana
    if (diff < 604800000) {
        const days = Math.floor(diff / 86400000);
        return `${days} giorn${days === 1 ? 'o' : 'i'} fa`;
    }
    
    // Data completa
    return date.toLocaleString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Aggiorna ogni minuto
setInterval(loadRecentActivities, 60000);

// Carica attività iniziali
loadRecentActivities();

```

---

## File: sistema.js

**Percorso:** `api/static/js/sistema.js`
**Directory:** `api/static/js`
**Dimensione:** 12463 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/sistema.js
// JavaScript per Dashboard Salvataggio parametri di Sistema

// ===== GESTIONE CONFIGURAZIONI SISTEMA =====

// Variabili globali
let configData = {};

// Inizializza al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    loadSystemConfig();
    
    // Event listeners per i form
    document.getElementById('sistema-form').addEventListener('submit', saveSistemaConfig);
    document.getElementById('hardware-form').addEventListener('submit', saveHardwareConfig);
    document.getElementById('sicurezza-form').addEventListener('submit', saveSicurezzaConfig);
    document.getElementById('email-form').addEventListener('submit', saveEmailConfig);
});

// Carica configurazioni dal server
function loadSystemConfig() {
    fetch('/api/system/config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                configData = data.config;
                populateSystemForms(data.config);
            } else {
                showToast('Errore caricamento configurazioni', 'error');
            }
        })
        .catch(error => {
            console.error('Errore:', error);
            showToast('Errore comunicazione con il server', 'error');
        });
}

// Popola i form con i dati caricati
function populateSystemForms(config) {
    // Sistema
    if (config.sistema) {
        document.getElementById('nome-installazione').value = config.sistema.nome_installazione || '';
        document.getElementById('porta-web').value = config.sistema.porta_web || 5000;
        document.getElementById('debug-mode').checked = config.sistema.debug_mode || false;
        document.getElementById('timeout-sessione').value = config.sistema.timeout_sessione || 1800;
        document.getElementById('ambiente').value = config.sistema.ambiente || 'production';
    }
    
    // Hardware
    if (config.hardware) {
        document.getElementById('lettore-porta').value = config.hardware.lettore_porta || '/dev/ttyACM0';
        document.getElementById('relay-porta').value = config.hardware.relay_porta || '/dev/ttyUSB0';
        document.getElementById('relay-baudrate').value = config.hardware.relay_baudrate || 19200;
        document.getElementById('gate-duration').value = config.hardware.gate_duration || 8;
    }
    
    // Sicurezza
    if (config.sicurezza) {
        document.getElementById('max-tentativi').value = config.sicurezza.max_tentativi_login || 5;
        document.getElementById('durata-blocco').value = config.sicurezza.durata_blocco_minuti || 15;
        document.getElementById('rotazione-password').value = config.sicurezza.rotazione_password_giorni || 90;
        document.getElementById('log-audit').checked = config.sicurezza.log_audit_abilitato !== false;
    }
    
    // Email
    if (config.email) {
        document.getElementById('smtp-server').value = config.email.smtp_server || '';
        document.getElementById('smtp-porta').value = config.email.smtp_porta || 587;
        document.getElementById('email-mittente').value = config.email.mittente || '';
        document.getElementById('report-automatici').checked = config.email.report_automatici || false;
        document.getElementById('frequenza-report').value = config.email.frequenza_report || 'weekly';
    }
}

// Salva configurazioni Sistema
function saveSistemaConfig(e) {
    e.preventDefault();
    
    const config = {
        sistema: {
            nome_installazione: document.getElementById('nome-installazione').value,
            porta_web: parseInt(document.getElementById('porta-web').value),
            debug_mode: document.getElementById('debug-mode').checked,
            timeout_sessione: parseInt(document.getElementById('timeout-sessione').value),
            ambiente: document.getElementById('ambiente').value
        }
    };
    
    saveConfiguration(config, 'sistema');
}

// Salva configurazioni Hardware
function saveHardwareConfig(e) {
    e.preventDefault();
    
    const config = {
        hardware: {
            lettore_porta: document.getElementById('lettore-porta').value,
            relay_porta: document.getElementById('relay-porta').value,
            relay_baudrate: parseInt(document.getElementById('relay-baudrate').value),
            gate_duration: parseFloat(document.getElementById('gate-duration').value)
        }
    };
    
    saveConfiguration(config, 'hardware');
}

// Salva configurazioni Sicurezza
function saveSicurezzaConfig(e) {
    e.preventDefault();
    
    const config = {
        sicurezza: {
            max_tentativi_login: parseInt(document.getElementById('max-tentativi').value),
            durata_blocco_minuti: parseInt(document.getElementById('durata-blocco').value),
            rotazione_password_giorni: parseInt(document.getElementById('rotazione-password').value),
            log_audit_abilitato: document.getElementById('log-audit').checked
        }
    };
    
    saveConfiguration(config, 'sicurezza');
}

// Salva configurazioni Email
function saveEmailConfig(e) {
    e.preventDefault();
    
    const config = {
        email: {
            smtp_server: document.getElementById('smtp-server').value,
            smtp_porta: parseInt(document.getElementById('smtp-porta').value),
            mittente: document.getElementById('email-mittente').value,
            report_automatici: document.getElementById('report-automatici').checked,
            frequenza_report: document.getElementById('frequenza-report').value
        }
    };
    
    saveConfiguration(config, 'email');
}

// Funzione generica per salvare configurazioni
function saveConfiguration(config, section) {
    // Mostra loading
    showToast(`Salvataggio configurazioni ${section}...`, 'info');
    
    fetch('/api/system/config/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Aggiorna i dati locali
            Object.assign(configData, config);
            showToast(`Configurazioni ${section} salvate con successo!`, 'success');
            
            // Se cambiate configurazioni critiche, suggerisci riavvio
            if (section === 'sistema' || section === 'hardware') {
                setTimeout(() => {
                    if (confirm('Le modifiche richiedono un riavvio del sistema. Riavviare ora?')) {
                        restartSystem();
                    }
                }, 1000);
            }
        } else {
            showToast(`Errore salvataggio: ${data.error || 'Errore sconosciuto'}`, 'error');
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        showToast('Errore comunicazione con il server', 'error');
    });
}

// Riavvia sistema
function restartSystem() {
    if (!confirm('Sei sicuro di voler riavviare il sistema?\n\nTutte le sessioni attive verranno terminate.')) {
        return;
    }
    
    showToast('Riavvio sistema in corso...', 'warning');
    
    fetch('/api/system/restart', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Sistema in riavvio. La pagina si ricaricherà tra 30 secondi.', 'info');
            
            // Disabilita tutti i controlli
            document.querySelectorAll('button, input, select').forEach(el => {
                el.disabled = true;
            });
            
            // Ricarica la pagina dopo 30 secondi
            setTimeout(() => {
                window.location.reload();
            }, 30000);
        } else {
            showToast('Errore durante il riavvio del sistema', 'error');
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        showToast('Errore comunicazione con il server', 'error');
    });
}

// Esporta configurazioni
function exportConfig() {
    fetch('/api/system/config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Crea file JSON da scaricare
                const jsonStr = JSON.stringify(data.config, null, 2);
                const blob = new Blob([jsonStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                // Crea link temporaneo per download
                const a = document.createElement('a');
                a.href = url;
                a.download = `config_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Configurazioni esportate con successo', 'success');
            }
        })
        .catch(error => {
            console.error('Errore:', error);
            showToast('Errore durante l\'export delle configurazioni', 'error');
        });
}

// Ripristina configurazioni default
function resetToDefaults() {
    if (!confirm('Ripristinare tutte le configurazioni ai valori default?\n\nQuesta operazione non può essere annullata.')) {
        return;
    }
    
    // Per sicurezza, chiedi una seconda conferma
    if (!confirm('Sei ASSOLUTAMENTE SICURO di voler ripristinare i valori di default?\n\nTutte le personalizzazioni andranno perse.')) {
        return;
    }
    
    showToast('Ripristino configurazioni in corso...', 'warning');
    
    fetch('/api/system/config/reset', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Configurazioni ripristinate. Ricaricamento pagina...', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast('Errore durante il ripristino', 'error');
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        showToast('Errore comunicazione con il server', 'error');
    });
}

// Utility per mostrare notifiche toast
function showToast(message, type = 'info') {
    // Rimuovi toast esistenti
    const existingToasts = document.querySelectorAll('.toast-notification');
    existingToasts.forEach(toast => toast.remove());
    
    // Mappa colori per tipo
    const colors = {
        'success': '#28a745',
        'error': '#dc3545',
        'warning': '#ffc107',
        'info': '#17a2b8'
    };
    
    // Crea elemento toast
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 9999;
        min-width: 250px;
        animation: slideIn 0.3s ease-out;
    `;
    
    // Aggiungi icona
    const icons = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
    };
    
    toast.innerHTML = `
        <i class="${icons[type] || icons.info} me-2"></i>
        <span>${message}</span>
    `;
    
    // Aggiungi al body
    document.body.appendChild(toast);
    
    // Rimuovi dopo 5 secondi
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Aggiungi stili per animazioni
if (!document.getElementById('toast-styles')) {
    const style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

```

---

## File: test-accessi.js

**Percorso:** `api/static/js/test-accessi.js`
**Directory:** `api/static/js`
**Dimensione:** 10543 bytes
**Ultima modifica:** 2025-07-20 23:01:24
**Permessi:** 664

### Contenuto:

```javascript
class TestAccessi {
    constructor() {
        this.initElements();
        this.initRelayElements();
        this.loadUtenti();
        this.loadUtentiDisattivati();
        this.setupEventListeners();
    }

    initElements() {
        this.utenteInput = document.getElementById('utente');
        this.searchResults = document.getElementById('searchResults');
        this.ingressiInput = document.getElementById('ingressiMensili');
        this.testForm = document.getElementById('testAccessoForm');
        this.utentiDisattivatiTable = document.getElementById('utentiDisattivati');
        this.cercaCFInput = document.getElementById('cercaCF');
        this.utentiList = []; // Cache degli utenti
        this.selectedUtente = null; // Utente selezionato
    }

    setupEventListeners() {
        // Form test accesso
        this.testForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.salvaIngressi();
        });

        // Simula accesso
        document.getElementById('simulaAccesso').addEventListener('click', () => {
            this.simulaAccesso();
        });

        // Ricerca CF
        this.cercaCFInput.addEventListener('input', () => {
            this.filtraUtentiDisattivati();
        });

        // Ricerca utente inline
        this.utenteInput.addEventListener('input', (e) => {
            this.selectedUtente = null; // Reset selezione quando l'utente digita
            this.filtraUtenti(e.target.value);
        });

        // Chiudi risultati quando si clicca fuori
        document.addEventListener('click', (e) => {
            if (!this.utenteInput.contains(e.target) && !this.searchResults.contains(e.target)) {
                this.searchResults.style.display = 'none';
            }
        });

        // Focus sul campo di ricerca mostra i risultati
        this.utenteInput.addEventListener('focus', () => {
            if (this.utentiList.length > 0) {
                this.filtraUtenti(this.utenteInput.value);
            }
        });
    }

    async loadUtenti() {
        try {
            const response = await fetch('/api/utenti-autorizzati');
            const data = await response.json();
            
            if (data.success) {
                this.utentiList = data.utenti;
            }
        } catch (error) {
            console.error('Errore caricamento utenti:', error);
            showAlert('Errore caricamento lista utenti', 'danger');
        }
    }

    filtraUtenti(searchTerm) {
        searchTerm = searchTerm.toLowerCase().trim();
        
        const utentiFiltrati = searchTerm ? 
            this.utentiList.filter(utente => 
                utente.label.toLowerCase().includes(searchTerm) || 
                utente.codice_fiscale.toLowerCase().includes(searchTerm)
            ) : this.utentiList;
        
        this.renderRisultatiRicerca(utentiFiltrati);
    }

    renderRisultatiRicerca(utenti) {
        if (utenti.length === 0) {
            this.searchResults.style.display = 'none';
            return;
        }

        this.searchResults.innerHTML = utenti.map(utente => `
            <div class="result-item" data-cf="${utente.codice_fiscale}">
                ${utente.label}
            </div>
        `).join('');

        // Aggiungi event listener per la selezione
        this.searchResults.querySelectorAll('.result-item').forEach(item => {
            item.addEventListener('click', () => {
                const cf = item.dataset.cf;
                const utente = this.utentiList.find(u => u.codice_fiscale === cf);
                this.selezionaUtente(utente);
            });
        });

        this.searchResults.style.display = 'block';
    }

    selezionaUtente(utente) {
        this.selectedUtente = utente;
        this.utenteInput.value = utente.label;
        this.searchResults.style.display = 'none';
    }

    async loadUtentiDisattivati() {
        try {
            const response = await fetch('/api/utenti-autorizzati/disattivati');
            const data = await response.json();
            
            if (data.success) {
                this.renderUtentiDisattivati(data.utenti);
            }
        } catch (error) {
            console.error('Errore caricamento utenti disattivati:', error);
            showAlert('Errore caricamento utenti disattivati', 'danger');
        }
    }

    renderUtentiDisattivati(utenti) {
        const searchTerm = this.cercaCFInput.value.trim().toUpperCase();
        
        const filteredUtenti = searchTerm ? 
            utenti.filter(u => u.codice_fiscale.toUpperCase().includes(searchTerm)) : 
            utenti;
        
        this.utentiDisattivatiTable.innerHTML = filteredUtenti.map(utente => `
            <tr>
                <td>${utente.nome}</td>
                <td>${utente.cognome}</td>
                <td>${utente.codice_fiscale}</td>
                <td>${utente.ingressi_mensili}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="testAccessi.resetContatore('${utente.codice_fiscale}')">
                        <i class="fas fa-redo me-1"></i>
                        Reset
                    </button>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="5" class="text-center">Nessun utente disattivato trovato</td></tr>';
    }

    filtraUtentiDisattivati() {
        this.loadUtentiDisattivati();
    }

    async salvaIngressi() {
        if (!this.selectedUtente) {
            showAlert('Seleziona un utente', 'warning');
            return;
        }
        const codice_fiscale = this.selectedUtente.codice_fiscale;
        const ingressi = parseInt(this.ingressiInput.value);
        
        if (!codice_fiscale) {
            showAlert('Seleziona un utente', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/configurazione/test/set-ingressi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codice_fiscale, ingressi })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Conteggio ingressi aggiornato', 'success');
                this.loadUtentiDisattivati();
            } else {
                showAlert(data.error || 'Errore aggiornamento conteggio', 'danger');
            }
            
        } catch (error) {
            console.error('Errore salvataggio:', error);
            showAlert('Errore di connessione al server', 'danger');
        }
    }

    // Gestione animazioni relè
    initRelayElements() {
        this.ledGreen = document.querySelector('.led-green');
        this.ledRed = document.querySelector('.led-red');
        this.buzzer = document.querySelector('.buzzer');
        this.gate = document.querySelector('.gate');
    }

    activateLedGreen(duration = 3000) {
        this.ledGreen.classList.add('active');
        setTimeout(() => this.ledGreen.classList.remove('active'), duration);
    }

    activateLedRed(duration = 3000) {
        this.ledRed.classList.add('active');
        setTimeout(() => this.ledRed.classList.remove('active'), duration);
    }

    activateBuzzer(duration = 500) {
        this.buzzer.classList.add('active');
        setTimeout(() => this.buzzer.classList.remove('active'), duration);
    }

    activateGate(duration = 8000) {
        this.gate.classList.add('opening');
        setTimeout(() => this.gate.classList.remove('opening'), duration);
    }

    async simulateAccessGranted() {
        // LED Verde + Buzzer breve
        this.activateLedGreen();
        this.activateBuzzer(500);
        
        // Apri cancello dopo 500ms
        setTimeout(() => {
            this.activateGate();
        }, 500);
    }

    async simulateAccessDenied() {
        // LED Rosso
        this.activateLedRed();
        
        // Pattern buzzer: 3 beep
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                this.activateBuzzer(200);
            }, i * 500);
        }
    }

    async simulaAccesso() {
        if (!this.selectedUtente) {
            showAlert('Seleziona un utente', 'warning');
            return;
        }
        const codice_fiscale = this.selectedUtente.codice_fiscale;
        
        if (!codice_fiscale) {
            showAlert('Seleziona un utente', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/configurazione/test/simula-accesso', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codice_fiscale })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message, 'success');
                // Simula sequenza accesso autorizzato
                await this.simulateAccessGranted();
                // Ricarica dati
                this.loadUtentiDisattivati();
                this.ingressiInput.value = '';
            } else {
                showAlert(data.error || 'Errore simulazione accesso', 'danger');
                // Simula sequenza accesso negato
                await this.simulateAccessDenied();
            }
            
        } catch (error) {
            console.error('Errore simulazione:', error);
            showAlert('Errore di connessione al server', 'danger');
        }
    }

    async resetContatore(codice_fiscale) {
        try {
            const response = await fetch('/api/configurazione/test/reset-contatore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codice_fiscale })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Contatore resettato con successo', 'success');
                this.loadUtentiDisattivati();
            } else {
                showAlert(data.error || 'Errore reset contatore', 'danger');
            }
            
        } catch (error) {
            console.error('Errore reset:', error);
            showAlert('Errore di connessione al server', 'danger');
        }
    }
}

// Inizializza quando il DOM è pronto
document.addEventListener('DOMContentLoaded', () => {
    window.testAccessi = new TestAccessi();
});

```

---

## File: user-management.js

**Percorso:** `api/static/js/user-management.js`
**Directory:** `api/static/js`
**Dimensione:** 4847 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/user-management.js
// Gestione utenti viewer

document.addEventListener('DOMContentLoaded', function() {
    if (session.role === 'user_manager') {
        loadViewers();
        setupCreateForm();
    }
});

function loadViewers() {
    fetch('/api/viewers/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderViewersTable(data.viewers);
            }
        })
        .catch(error => console.error('Errore caricamento viewers:', error));
}

function renderViewersTable(viewers) {
    const tbody = document.getElementById('viewers-table');
    
    if (viewers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nessun visualizzatore trovato</td></tr>';
        return;
    }
    
    let html = '';
    viewers.forEach(viewer => {
        const statusBadge = viewer.active ? 
            '<span class="badge bg-success">Attivo</span>' : 
            '<span class="badge bg-danger">Disattivato</span>';
        
        html += `
            <tr>
                <td><strong>${viewer.username}</strong></td>
                <td>${viewer.created_by}</td>
                <td>${formatDate(viewer.created_at)}</td>
                <td>${viewer.last_login}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="resetPassword('${viewer.username}')">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                    <button class="btn btn-${viewer.active ? 'danger' : 'success'} btn-sm" 
                            onclick="toggleActive('${viewer.username}')">
                        <i class="fas fa-${viewer.active ? 'ban' : 'check'}"></i>
                        ${viewer.active ? 'Disattiva' : 'Attiva'}
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function setupCreateForm() {
    const form = document.getElementById('create-viewer-form');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('new-username').value.trim().toLowerCase();
            
            try {
                const response = await fetch('/api/viewers/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: username})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showTempPassword(username, data.temp_password);
                    form.reset();
                    loadViewers();
                } else {
                    showAlert(data.error, 'danger');
                }
            } catch (error) {
                showAlert('Errore creazione utente', 'danger');
            }
        });
    }
}

function resetPassword(username) {
    if (confirm(`Resettare la password per ${username}?`)) {
        fetch('/api/viewers/reset-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: username})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showTempPassword(username, data.temp_password);
            } else {
                showAlert(data.error, 'danger');
            }
        });
    }
}

function toggleActive(username) {
    fetch('/api/viewers/toggle-active', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username: username})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadViewers();
        } else {
            showAlert(data.error, 'danger');
        }
    });
}

function showTempPassword(username, password) {
    document.getElementById('temp-username').textContent = username;
    document.getElementById('temp-password').textContent = password;
    
    const modal = new bootstrap.Modal(document.getElementById('tempPasswordModal'));
    modal.show();
}

function copyTempPassword() {
    const password = document.getElementById('temp-password').textContent;
    navigator.clipboard.writeText(password).then(() => {
        showAlert('Password copiata negli appunti', 'success');
    });
}

function formatDate(dateString) {
    if (!dateString) return 'N/D';
    const date = new Date(dateString);
    return date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT');
}

```

---

## File: user-menu.js

**Percorso:** `api/static/js/user-menu.js`
**Directory:** `api/static/js`
**Dimensione:** 17782 bytes
**Ultima modifica:** 2025-07-19 17:37:37
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/user-menu.js
// JavaScript per gestione menu utente moderno

class UserMenu {
    constructor() {
        this.menuTrigger = null;
        this.menuDropdown = null;
        this.overlay = null;
        this.isOpen = false;
        this.init();
    }
    
    init() {
        // Attendi che il DOM sia carico
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.setup());
        } else {
            this.setup();
        }
    }
    
    setup() {
        this.menuTrigger = document.querySelector('.user-menu-trigger');
        this.menuDropdown = document.querySelector('.user-menu-dropdown');
        this.overlay = document.querySelector('.user-menu-overlay');
        
        if (!this.menuTrigger || !this.menuDropdown) {
            console.error('Menu utente: elementi non trovati');
            return;
        }
        
        // Event listeners
        this.menuTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggle();
        });
        
        // Click su overlay per chiudere
        if (this.overlay) {
            this.overlay.addEventListener('click', () => this.close());
        }
        
        // Click fuori per chiudere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu-container')) {
                this.close();
            }
        });
        
        // Escape per chiudere
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) {
                this.close();
            }
        });
        
        // Gestione link menu con animazioni
        this.setupMenuItems();
    }
    
    toggle() {
        if (this.isOpen) {
            this.close();
        } else {
            this.open();
        }
    }
    
    open() {
        this.isOpen = true;
        this.menuDropdown.classList.add('active');
        if (this.overlay) {
            this.overlay.classList.add('active');
        }
        
        // Animazione apertura
        this.animateOpen();
    }
    
    close() {
        this.isOpen = false;
        this.menuDropdown.classList.remove('active');
        if (this.overlay) {
            this.overlay.classList.remove('active');
        }
    }
    
    animateOpen() {
        const items = this.menuDropdown.querySelectorAll('.user-menu-item');
        items.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, index * 50);
        });
    }
    
    setupMenuItems() {
        // Gestione click su Profilo
        const profileLink = document.querySelector('[data-action="profile"]');
        if (profileLink) {
            profileLink.addEventListener('click', (e) => {
                e.preventDefault();
                this.close();
                this.showProfileModal();
            });
        }
        
        // Gestione click su Cambio Password
        const passwordLink = document.querySelector('[data-action="change-password"]');
        if (passwordLink) {
            passwordLink.addEventListener('click', (e) => {
                e.preventDefault();
                this.close();
                this.showPasswordModal();
            });
        }
        
        // Gestione click su Impostazioni
        const settingsLink = document.querySelector('[data-action="settings"]');
        if (settingsLink) {
            settingsLink.addEventListener('click', (e) => {
                e.preventDefault();
                this.close();
                showAlert('Impostazioni disponibili prossimamente', 'info');
            });
        }
    }
    
    showProfileModal() {
        // Crea modal profilo se non esiste
        let modal = document.getElementById('profileModal');
        if (!modal) {
            modal = this.createProfileModal();
            document.body.appendChild(modal);
        }
        
        // Mostra modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Carica dati profilo
        this.loadProfileData();
    }
    
    showPasswordModal() {
        // Crea modal password se non esiste
        let modal = document.getElementById('passwordModal');
        if (!modal) {
            modal = this.createPasswordModal();
            document.body.appendChild(modal);
        }
        
        // Mostra modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    createProfileModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'profileModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-user-circle me-2"></i>Il Mio Profilo
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <div class="avatar-xlarge mx-auto mb-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <h4 id="profile-username">-</h4>
                            <span id="profile-role-badge" class="badge">-</span>
                        </div>
                        
                        <div class="profile-info">
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-at"></i> Username:
                                </span>
                                <span id="profile-username-detail" class="info-value">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-shield-alt"></i> Ruolo:
                                </span>
                                <span id="profile-role-detail" class="info-value">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-key"></i> Permessi:
                                </span>
                                <span id="profile-permissions" class="info-value">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="fas fa-clock"></i> Ultimo accesso:
                                </span>
                                <span id="profile-last-login" class="info-value">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Chiudi
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Aggiungi stili inline per il modal
        const style = document.createElement('style');
        style.textContent = `
            .avatar-xlarge {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 3rem;
                box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            }
            
            .profile-info {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 20px;
            }
            
            .info-row {
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid #e9ecef;
            }
            
            .info-row:last-child {
                border-bottom: none;
            }
            
            .info-label {
                font-weight: 600;
                color: #6c757d;
            }
            
            .info-value {
                color: #333;
            }
        `;
        document.head.appendChild(style);
        
        return modal;
    }
    
    createPasswordModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'passwordModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-key me-2"></i>Cambio Password
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="change-password-form-modal">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Password Attuale</label>
                                <input type="password" class="form-control" name="current_password" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nuova Password</label>
                                <input type="password" class="form-control" name="new_password" 
                                       required minlength="6" id="new-password-modal">
                                <div id="password-strength-modal" class="mt-2"></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Conferma Nuova Password</label>
                                <input type="password" class="form-control" name="confirm_password" required>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                La password deve contenere almeno 6 caratteri
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i> Annulla
                            </button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Aggiorna Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Aggiungi event listener per il form
        setTimeout(() => {
            const form = document.getElementById('change-password-form-modal');
            const newPasswordField = document.getElementById('new-password-modal');
            
            if (newPasswordField) {
                newPasswordField.addEventListener('input', function() {
                    checkPasswordStrength(this.value, 'password-strength-modal');
                });
            }
            
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handlePasswordChange(e);
                });
            }
        }, 100);
        
        return modal;
    }
    
    async loadProfileData() {
        try {
            const response = await fetch('/api/profile/info');
            const data = await response.json();
            
            if (data.success) {
                const user = data.user;
                
                // Aggiorna elementi del modal
                document.getElementById('profile-username').textContent = user.username;
                document.getElementById('profile-username-detail').textContent = user.username;
                
                // Ruolo con badge colorato
                const roleMap = {
                    'admin': { name: 'Amministratore', class: 'bg-danger', icon: '👑' },
                    'gestore': { name: 'Gestore', class: 'bg-warning', icon: '👔' },
                    'readonly': { name: 'Solo Lettura', class: 'bg-success', icon: '👁️' }
                };
                
                const roleInfo = roleMap[user.role] || { name: 'Utente', class: 'bg-secondary', icon: '👤' };
                
                const roleBadge = document.getElementById('profile-role-badge');
                roleBadge.textContent = `${roleInfo.icon} ${roleInfo.name}`;
                roleBadge.className = `badge ${roleInfo.class}`;
                
                document.getElementById('profile-role-detail').textContent = roleInfo.name;
                
                // Permessi
                const permissions = {
                    'admin': 'Accesso completo al sistema',
                    'gestore': 'Gestione accessi e visualizzazione log',
                    'readonly': 'Solo visualizzazione log'
                };
                
                document.getElementById('profile-permissions').textContent = 
                    permissions[user.role] || 'Permessi base';
                
                // Ultimo accesso (simulato)
                const lastLogin = user.login_time || new Date().toLocaleString('it-IT');
                document.getElementById('profile-last-login').textContent = lastLogin;
            }
        } catch (error) {
            console.error('Errore caricamento profilo:', error);
            showAlert('Errore caricamento dati profilo', 'danger');
        }
    }
    
    async handlePasswordChange(e) {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Validazione
        if (data.new_password !== data.confirm_password) {
            showAlert('Le password non coincidono', 'danger');
            return;
        }
        
        if (data.new_password.length < 6) {
            showAlert('La password deve essere di almeno 6 caratteri', 'danger');
            return;
        }
        
        try {
            const response = await fetch('/api/profile/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Password aggiornata con successo', 'success');
                // Chiudi modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
                modal.hide();
                // Reset form
                e.target.reset();
            } else {
                showAlert(result.error || 'Errore durante il cambio password', 'danger');
            }
        } catch (error) {
            showAlert('Errore di connessione al server', 'danger');
            console.error('Errore:', error);
        }
    }
}

// Funzione per valutare forza password
function checkPasswordStrength(password, targetId = 'password-strength') {
    let strength = 0;
    const strengthDiv = document.getElementById(targetId);
    
    if (!strengthDiv) return;
    
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]+/)) strength++;
    if (password.match(/[A-Z]+/)) strength++;
    if (password.match(/[0-9]+/)) strength++;
    if (password.match(/[^a-zA-Z0-9]+/)) strength++;
    
    if (password.length < 6) {
        strengthDiv.innerHTML = '';
        return;
    }
    
    let strengthText = '';
    let strengthClass = '';
    let strengthColor = '';
    
    if (strength <= 2) {
        strengthText = 'Password debole';
        strengthClass = 'text-danger';
        strengthColor = '#dc3545';
    } else if (strength <= 3) {
        strengthText = 'Password media';
        strengthClass = 'text-warning';
        strengthColor = '#ffc107';
    } else {
        strengthText = 'Password forte';
        strengthClass = 'text-success';
        strengthColor = '#28a745';
    }
    
    strengthDiv.innerHTML = `
        <div class="${strengthClass}" style="font-size: 0.875rem;">
            <i class="fas fa-shield-alt"></i> ${strengthText}
            <div class="progress mt-1" style="height: 5px;">
                <div class="progress-bar" style="width: ${strength * 20}%; background-color: ${strengthColor};"></div>
            </div>
        </div>
    `;
}

// Inizializza menu utente quando il DOM è pronto
const userMenu = new UserMenu();

// Esporta per uso globale se necessario
window.UserMenu = UserMenu;

```

---

## File: users.js

**Percorso:** `api/static/js/users.js`
**Directory:** `api/static/js`
**Dimensione:** 10936 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```javascript
// Gestione utenti sistema
let usersTable = document.getElementById('users-table');

// Carica conteggi utenti
function loadUserCounts() {
    fetch('/api/users/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const counts = {
                    admin: 0,
                    user_manager: 0,
                    viewer: 0,
                    total: 0
                };
                
                data.users.forEach(user => {
                    counts[user.role]++;
                    counts.total++;
                });

                document.getElementById('admin-count').textContent = counts.admin;
                document.getElementById('manager-count').textContent = counts.user_manager;
                document.getElementById('viewer-count').textContent = counts.viewer;
                document.getElementById('total-count').textContent = counts.total;
            }
        })
        .catch(error => console.error('Errore caricamento conteggi:', error));
}

// Carica lista utenti
function loadUsers() {
    fetch('/api/users/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '';
                data.users.forEach(user => {
                    const roleBadge = getRoleBadge(user.role, user.role_name);
                    const statusBadge = getStatusBadge(user.attivo);
                    
                    html += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${roleBadge}</td>
                            <td>
                                <small class="text-muted">
                                    ${user.created_by}<br>
                                    ${formatDate(user.created_at)}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    ${formatDate(user.last_login)}
                                </small>
                            </td>
                            <td>${statusBadge}</td>
                            <td class="text-end">
                                ${getUserActions(user)}
                            </td>
                        </tr>
                    `;
                });
                usersTable.innerHTML = html;

                // Inizializza tooltip e popover
                const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
            }
        })
        .catch(error => console.error('Errore caricamento utenti:', error));
}

// Formatta data
function formatDate(dateStr) {
    if (!dateStr || dateStr === 'Mai') return 'Mai';
    const date = new Date(dateStr);
    return date.toLocaleString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Badge ruolo
function getRoleBadge(role, roleName) {
    const badges = {
        admin: 'role-badge role-admin',
        user_manager: 'role-badge role-manager',
        viewer: 'role-badge role-viewer'
    };
    return `<span class="${badges[role]}">${roleName}</span>`;
}

// Badge stato
function getStatusBadge(active) {
    return active 
        ? '<span class="badge bg-success">Attivo</span>'
        : '<span class="badge bg-danger">Disattivato</span>';
}

// Pulsanti azioni
function getUserActions(user) {
    const btnSize = 'btn-sm';
    return `
        <div class="btn-group">
            ${user.attivo 
                ? `<button class="btn ${btnSize} btn-outline-danger" 
                     onclick="toggleUserStatus('${user.username}', false)"
                     data-bs-toggle="tooltip" title="Disattiva">
                     <i class="fas fa-ban"></i>
                   </button>`
                : `<button class="btn ${btnSize} btn-outline-success" 
                     onclick="toggleUserStatus('${user.username}', true)"
                     data-bs-toggle="tooltip" title="Attiva">
                     <i class="fas fa-check"></i>
                   </button>`
            }
            <button class="btn ${btnSize} btn-outline-primary" 
                    onclick="resetPassword('${user.username}')"
                    data-bs-toggle="tooltip" title="Reset Password">
                <i class="fas fa-key"></i>
            </button>
            <button class="btn ${btnSize} btn-outline-danger" 
                    onclick="deleteUser('${user.username}')"
                    data-bs-toggle="tooltip" title="Elimina">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
}

// Crea nuovo utente
document.getElementById('create-user-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = {
        username: document.getElementById('new-username').value,
        password: document.getElementById('new-password').value,
        role: document.getElementById('new-role').value
    };
    
    fetch('/api/users/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset form
            e.target.reset();
            
            // Ricarica dati
            loadUsers();
            loadUserCounts();
            
            // Mostra password temporanea
            document.getElementById('temp-username').textContent = data.username;
            document.getElementById('temp-password').textContent = data.password;
            new bootstrap.Modal(document.getElementById('tempPasswordModal')).show();
        } else {
            alert(data.error || 'Errore creazione utente');
        }
    })
    .catch(error => {
        console.error('Errore creazione utente:', error);
        alert('Errore durante la creazione utente');
    });
});

// Attiva/disattiva utente
function toggleUserStatus(username, active) {
    if (!confirm(`${active ? 'Attivare' : 'Disattivare'} l'utente ${username}?`)) return;
    
    fetch('/api/users/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            username: username,
            attivo: active
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadUsers();
        } else {
            alert(data.error || 'Errore aggiornamento stato');
        }
    })
    .catch(error => {
        console.error('Errore aggiornamento stato:', error);
        alert('Errore durante l\'aggiornamento');
    });
}

// Reset password
function resetPassword(username) {
    if (!confirm(`Resettare la password per l'utente ${username}?`)) return;
    
    const tempPassword = generateTempPassword();
    
    fetch('/api/users/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            username: username,
            password: tempPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('temp-username').textContent = username;
            document.getElementById('temp-password').textContent = data.password;
            new bootstrap.Modal(document.getElementById('tempPasswordModal')).show();
        } else {
            alert(data.error || 'Errore reset password');
        }
    })
    .catch(error => {
        console.error('Errore reset password:', error);
        alert('Errore durante il reset password');
    });
}

// Elimina utente
function deleteUser(username) {
    if (!confirm(`Eliminare definitivamente l'utente ${username}?`)) return;
    
    fetch('/api/users/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: username })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadUsers();
            loadUserCounts();
        } else {
            alert(data.error || 'Errore eliminazione utente');
        }
    })
    .catch(error => {
        console.error('Errore eliminazione utente:', error);
        alert('Errore durante l\'eliminazione');
    });
}


// Copia password temporanea
// Genera password temporanea
function generateTempPassword() {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

function copyTempPassword() {
    const password = document.getElementById('temp-password').textContent;
    navigator.clipboard.writeText(password)
        .then(() => {
            const btn = document.querySelector('[onclick="copyTempPassword()"]');
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
        })
        .catch(err => console.error('Errore copia password:', err));
}

// Ricarica utenti
function refreshUsers() {
    loadUsers();
    loadUserCounts();
}

// Export utenti
function exportUsers() {
    fetch('/api/users/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const csv = [
                    ['Username', 'Ruolo', 'Stato', 'Creato Da', 'Data Creazione', 'Ultimo Accesso']
                ];
                
                data.users.forEach(user => {
                    csv.push([
                        user.username,
                        user.role_name,
                        user.attivo ? 'Attivo' : 'Disattivato',
                        user.created_by,
                        formatDate(user.created_at),
                        formatDate(user.last_login)
                    ]);
                });
                
                const csvContent = csv.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'utenti_sistema.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }
        })
        .catch(error => console.error('Errore export:', error));
}

// Carica dati iniziali
loadUsers();
loadUserCounts();

```

---

## File: utenti_autorizzati.js

**Percorso:** `api/static/js/utenti_autorizzati.js`
**Directory:** `api/static/js`
**Dimensione:** 6357 bytes
**Ultima modifica:** 2025-07-20 18:42:52
**Permessi:** 664

### Contenuto:

```javascript
// File: /opt/access_control/src/api/static/js/utenti_autorizzati.js

// Elementi DOM
const searchInput = document.getElementById('search-input');
const searchClear = document.getElementById('search-clear');
const tableBody = document.getElementById('users-table-body');
const loadingSpinner = document.getElementById('loading-spinner');
const noResults = document.getElementById('no-results');

// Statistiche
const statTotale = document.getElementById('stat-totale');
const statAttivi = document.getElementById('stat-attivi');
const statNuovi = document.getElementById('stat-nuovi');

// Debounce per la ricerca
let searchTimeout = null;

// Carica dati iniziali
document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadStats();
});

// Event listener per la ricerca
searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        loadUsers(e.target.value);
    }, 300);
});

// Event listener per pulire la ricerca
searchClear.addEventListener('click', () => {
    searchInput.value = '';
    loadUsers();
});

// Carica statistiche
async function loadStats() {
    try {
        const response = await fetch('/api/utenti-autorizzati/stats');
        const data = await response.json();
        
        if (data.success) {
            statTotale.textContent = data.stats.totale;
            statAttivi.textContent = data.stats.attivi;
            statNuovi.textContent = data.stats.nuovi_30gg;
        }
    } catch (error) {
        console.error('Errore caricamento statistiche:', error);
    }
}

// Carica utenti con filtro opzionale
async function loadUsers(search = '') {
    showLoading(true);
    
    try {
        const url = `/api/utenti-autorizzati/list${search ? `?search=${encodeURIComponent(search)}` : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            renderUsers(data.utenti);
            noResults.classList.toggle('d-none', data.utenti.length > 0);
        } else {
            showError('Errore caricamento utenti');
        }
    } catch (error) {
        console.error('Errore caricamento utenti:', error);
        showError('Errore di rete');
    } finally {
        showLoading(false);
    }
}

// Renderizza tabella utenti
function renderUsers(users) {
    tableBody.innerHTML = '';
    
    users.forEach(user => {
        const row = document.createElement('tr');
        
        // Formatta date
        const dataInserimento = new Date(user.data_inserimento).toLocaleDateString('it-IT');
        const dataAggiornamento = new Date(user.data_aggiornamento).toLocaleDateString('it-IT');
        
        // Stato attivo/inattivo
        const statoBadge = user.attivo ?
            '<span class="badge bg-success status-badge">Attivo</span>' :
            '<span class="badge bg-danger status-badge">Inattivo</span>';
        
        row.innerHTML = `
            <td>${user.codice_fiscale}</td>
            <td>${user.nome || '-'}</td>
            <td>${dataInserimento}</td>
            <td>${dataAggiornamento}</td>
            <td>${user.creato_da || '-'}</td>
            <td>${user.modificato_da || '-'}</td>
            <td>${user.note || '-'}</td>
            <td>${statoBadge}</td>
            <td>
                <button class="btn btn-sm btn-${user.attivo ? 'danger' : 'success'}"
                        onclick="toggleUserStatus('${user.codice_fiscale}', ${user.attivo})">
                    <i class="fas fa-${user.attivo ? 'ban' : 'check'}"></i>
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

// Attiva/disattiva utente
async function toggleUserStatus(codiceFiscale, currentStatus) {
    try {
        const response = await fetch('/api/utenti-autorizzati/toggle-active', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ codice_fiscale: codiceFiscale })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Ricarica dati e statistiche
            loadUsers(searchInput.value);
            loadStats();
            
            // Notifica
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    } catch (error) {
        console.error('Errore toggle stato:', error);
        showNotification('Errore di rete', 'danger');
    }
}

// Utility per mostrare/nascondere loading
function showLoading(show) {
    loadingSpinner.classList.toggle('d-none', !show);
    tableBody.classList.toggle('d-none', show);
}

// Utility per mostrare errori
function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger mt-3';
    alert.textContent = message;
    
    tableBody.innerHTML = '';
    tableBody.appendChild(alert);
}

// Utility per mostrare notifiche toast
function showNotification(message, type = 'success') {
    // Crea toast container se non esiste
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Crea toast
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toastEl);
    
    // Inizializza e mostra toast
    const toast = new bootstrap.Toast(toastEl, {
        autohide: true,
        delay: 3000
    });
    toast.show();
    
    // Rimuovi dopo nascosto
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}

```

---

## File: configurazione_orari.html

**Percorso:** `api/templates/configurazione_orari.html`
**Directory:** `api/templates`
**Dimensione:** 8938 bytes
**Ultima modifica:** 2025-07-20 23:04:25
**Permessi:** 664

### Contenuto:

```html
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurazione Orari Accesso</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/configurazione_orari.css" rel="stylesheet">
    <link href="/static/css/user-menu.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
    <link href="/static/css/test-accessi.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-clock me-2"></i>
                <span class="navbar-brand mb-0 h1">Configurazione Orari Accesso</span>
            </div>
            <div class="system-clock mx-auto">
                <i class="fas fa-clock"></i>
                <span class="clock-time"></span>
                <span class="clock-date"></span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Orari Settimanali</h5>
            </div>
            <div class="card-body">
                <div id="days-container">
                    <!-- Generato dinamicamente da JS -->
                </div>
                
                <div class="mt-4">
                    <button id="copy-to-all" class="btn btn-outline-primary">
                        <i class="fas fa-copy me-2"></i>
                        Copia orari su tutti i giorni
                    </button>
                    <button id="save-schedule" class="btn btn-primary ms-2">
                        <i class="fas fa-save me-2"></i>
                        Salva Configurazione
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Limite Ingressi Mensili</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-6">
                        <label for="max-entries" class="form-label">Numero massimo di ingressi mensili per utente</label>
                        <input type="number" class="form-control" id="max-entries" min="1">
                        <div class="form-text">
                            Superato questo limite, l'utente verrà automaticamente disattivato fino al mese successivo
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button id="save-limits" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Salva Limite
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Accessi -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Test Accessi</h5>
            </div>
            <div class="card-body">
                <form id="testAccessoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="utente">Cerca Utente</label>
                                <div class="search-container">
                                    <input type="text" class="form-control" id="utente" placeholder="Cerca utente autorizzato..." required>
                                    <div id="searchResults" class="search-results" style="display: none;"></div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="ingressiMensili">Ingressi Effettuati nel Mese Corrente</label>
                                <input type="number" class="form-control" id="ingressiMensili" min="0" required>
                                <small class="form-text text-muted">Numero di ingressi già effettuati questo mese</small>
                            </div>

                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary" id="salvaIngressi">
                                    <i class="fas fa-save me-2"></i>
                                    Salva Conteggio
                                </button>
                                <button type="button" class="btn btn-success ms-2" id="simulaAccesso">
                                    <i class="fas fa-door-open me-2"></i>
                                    Simula Accesso
                                </button>
                            </div>

                            <!-- Animazione Relè -->
                            <div class="relay-status">
                                <div class="relay-component">
                                    <div class="led led-green"></div>
                                    <span>LED Verde</span>
                                </div>
                                <div class="relay-component">
                                    <div class="led led-red"></div>
                                    <span>LED Rosso</span>
                                </div>
                                <div class="relay-component">
                                    <div class="buzzer"></div>
                                    <span>Buzzer</span>
                                </div>
                                <div class="relay-component">
                                    <div class="gate"></div>
                                    <span>Cancello</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Utenti Disattivati -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Utenti Disattivati</h5>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label for="cercaCF">Cerca per Codice Fiscale</label>
                    <input type="text" class="form-control" id="cercaCF" placeholder="Inserisci il codice fiscale...">
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Cognome</th>
                                <th>Codice Fiscale</th>
                                <th>Ingressi Mensili</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="utentiDisattivati">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/static/js/alerts.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/clock.js"></script>
    <script src="/static/js/configurazione_orari.js"></script>
    <script src="/static/js/test-accessi.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                // Inizializza menu utente dopo un breve delay per assicurarsi che il DOM sia aggiornato
                setTimeout(() => {
                    window.userMenu = new UserMenu();
                }, 100);
            })
            .catch(error => {
                console.error('Errore caricamento menu utente:', error);
            });
    </script>
</body>
</html>

```

---

## File: hardware_test_section.html

**Percorso:** `api/templates/hardware_test_section.html`
**Directory:** `api/templates`
**Dimensione:** 2991 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```html

<!-- File: /opt/access_control/src/api/templates/hardware_test_section.html -->
<!-- HTML per sezione test hardware da inserire nella pagina dispositivi -->
<style>
    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
        background: white;
    }
    .btn-primary {
        background: #4c51bf;
        border-color: #4c51bf;
    }
    .btn-primary:hover {
        background: #434190;
        border-color: #434190;
    }
    .btn-success {
        background: #2c7a7b;
        border-color: #2c7a7b;
    }
    .btn-success:hover {
        background: #285e61;
        border-color: #285e61;
    }
    .test-output {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    .text-muted {
        color: #718096 !important;
    }
    h3, h4 {
        color: #2d3748;
        margin-bottom: 1rem;
    }
    .fas {
        color: #4a5568;
    }
</style>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <h3><i class="fas fa-flask"></i> Test Hardware Real-Time</h3>
            <p class="text-muted">Test funzionamento hardware con feedback visivo in tempo reale</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <h4><i class="fas fa-credit-card"></i> Test Lettore Tessere</h4>
            <p class="text-muted">Test funzionamento lettore OMNIKEY 5427CK con sequenza APDU</p>
            
            <button id="test-reader-btn" class="btn btn-primary mb-3" onclick="startReaderTest()">
                <i class="fas fa-play"></i> Test Lettore
            </button>
            
            <div id="reader-test-output" class="test-output">
                <div class="text-muted">
                    <i class="fas fa-info-circle"></i> Cliccare "Test Lettore" per avviare il test.<br>
                    Il test verificherà la connessione e la sequenza APDU ISO7816.
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <h4><i class="fas fa-microchip"></i> Test Controller USB-RLY08</h4>
            <p class="text-muted">Test funzionamento controller relè USB-RLY08 con test sicuri</p>
            
            <button id="test-relay-btn" class="btn btn-success mb-3" onclick="startRelayTest()">
                <i class="fas fa-play"></i> Test USB-RLY08
            </button>
            
            <div id="relay-test-output" class="test-output">
                <div class="text-muted">
                    <i class="fas fa-info-circle"></i> Cliccare "Test USB-RLY08" per avviare il test.<br>
                    Il test verificherà connessione e funzionamento relè con lampeggi sicuri.
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/hardware_test.js"></script>

```

---

## File: profilo.html

**Percorso:** `api/templates/profilo.html`
**Directory:** `api/templates`
**Dimensione:** 7805 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 664

### Contenuto:

```html
<!-- File: /opt/access_control/src/api/templates/profilo.html -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo Utente - Sistema Controllo Accessi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <style>
        .navbar { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .profile-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            background: white;
        }
        .role-badge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .role-admin {
            background: #4a5568;
            color: white;
        }
        .role-gestore {
            background: #4c51bf;
            color: white;
        }
        .role-viewer {
            background: #2b6cb0;
            color: white;
        }
        .btn-primary {
            background: #4c51bf;
            border-color: #4c51bf;
        }
        .btn-primary:hover {
            background: #434190;
            border-color: #434190;
        }
        .alert-info {
            background: #ebf8ff;
            border-color: #bee3f8;
            color: #2b6cb0;
        }
        .password-tips {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        .form-control:focus {
            border-color: #4c51bf;
            box-shadow: 0 0 0 0.2rem rgba(76, 81, 191, 0.25);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-shield-alt me-2"></i>Sistema Controllo Accessi
            </span>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <div id="user-menu-placeholder"></div>
            </div>
        </div>
    </nav>

    <div class="profile-container">
        <!-- Messaggio di stato -->
        <div id="profile-message"></div>
        
        <!-- Informazioni Utente -->
        <div class="profile-card">
            <h2><i class="fas fa-user-circle"></i> Il Mio Profilo</h2>
            
            <div class="user-details">
                <div class="detail-row">
                    <span class="detail-label">Username:</span>
                    <span class="detail-value">{{ session.username }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ruolo:</span>
                    <span class="detail-value">
                        <span class="role-badge role-{{ session.role }}">
                            {% if session.role == 'admin' %}
                                <i class="fas fa-crown"></i> Amministratore
                            {% elif session.role == 'gestore' %}
                                <i class="fas fa-user-tie"></i> Gestore
                            {% else %}
                                <i class="fas fa-eye"></i> Solo Lettura
                            {% endif %}
                        </span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Permessi:</span>
                    <span class="detail-value">
                        {% if session.role == 'admin' %}
                            Accesso completo al sistema
                        {% elif session.role == 'gestore' %}
                            Gestione accessi e visualizzazione log
                        {% else %}
                            Solo visualizzazione log
                        {% endif %}
                    </span>
                </div>
            </div>
            
            {% if session.role == 'admin' %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Come amministratore, hai accesso completo a tutte le funzionalità del sistema.
            </div>
            {% elif session.role == 'gestore' %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Come gestore, puoi gestire gli accessi e visualizzare i log del sistema.
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Il tuo account ha permessi di sola lettura.
            </div>
            {% endif %}
        </div>
        
        <!-- Cambio Password -->
        <div class="profile-card">
            <h2><i class="fas fa-key"></i> Cambio Password</h2>
            
            <form id="change-password-form" class="password-form">
                <div class="form-group">
                    <label class="form-label" for="current-password">Password Attuale</label>
                    <input type="password" class="form-control" id="current-password" 
                           name="current_password" required placeholder="Inserisci la password attuale">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-password">Nuova Password</label>
                    <input type="password" class="form-control" id="new-password" 
                           name="new_password" required minlength="6" 
                           placeholder="Minimo 6 caratteri">
                    <div id="password-strength" class="password-strength"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="confirm-password">Conferma Nuova Password</label>
                    <input type="password" class="form-control" id="confirm-password" 
                           name="confirm_password" required placeholder="Ripeti la nuova password">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Aggiorna Password
                </button>
            </form>
            
            <div class="password-tips">
                <i class="fas fa-lightbulb"></i> 
                <strong>Suggerimenti per una password sicura:</strong>
                <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                    <li>Usa almeno 8 caratteri</li>
                    <li>Combina lettere maiuscole e minuscole</li>
                    <li>Includi numeri e simboli</li>
                    <li>Evita parole comuni o informazioni personali</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/user-menu.js"></script>
    <script src="/static/js/profilo.js"></script>
    <script>
        // Carica menu utente
        fetch('/api/user-menu-html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('user-menu-placeholder').innerHTML = html;
                new UserMenu();
            });
    </script>
</body>
</html>

```

---

## File: utenti_autorizzati.html

**Percorso:** `api/templates/utenti_autorizzati.html`
**Directory:** `api/templates`
**Dimensione:** 10824 bytes
**Ultima modifica:** 2025-07-20 22:08:32
**Permessi:** 664

### Contenuto:

```html
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Utenti Autorizzati</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link href="/static/css/clock.css" rel="stylesheet">
    <style>
        .navbar { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .navbar .btn-outline-light {
            border-width: 2px;
            font-weight: 500;
            padding: 0.375rem 1rem;
        }
        .navbar .btn-outline-light:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Stili Menu Utente */
        .user-menu-container {
            position: relative;
            z-index: 1000;
        }
        
        .user-menu-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-menu-trigger:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        
        .user-menu-info {
            color: white;
            line-height: 1.2;
        }
        
        .user-menu-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-menu-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .user-menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-menu-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: white;
            margin: 0 auto 10px;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .user-email {
            font-size: 0.9rem;
            color: #666;
        }
        
        .user-menu-items {
            padding: 10px;
        }
        
        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            color: #333;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .user-menu-item:hover {
            background: #f8f9fa;
            color: #333;
        }
        
        .user-menu-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
            color: #666;
        }
        
        .user-menu-divider {
            height: 1px;
            background: #eee;
            margin: 10px 0;
        }
        
        .user-menu-item.logout {
            color: #dc3545;
        }
        
        .user-menu-item.logout i {
            color: #dc3545;
        }
        
        .user-menu-item.logout:hover {
            background: #dc3545;
            color: white;
        }
        
        .user-menu-item.logout:hover i {
            color: white;
        }
        
        .user-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .user-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .dropdown-toggle::after {
            display: none;
        }
        .dropdown-menu {
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
        }
        .dropdown-item {
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        .dropdown-item i {
            width: 1.5rem;
            text-align: center;
        }
        .search-box {
            max-width: 500px;
            margin: 20px auto;
        }
        .stats-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .table-responsive {
            margin-top: 20px;
        }
        .status-badge {
            width: 80px;
        }
        .search-clear {
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .search-clear:hover {
            color: #666;
        }
        .bg-primary {
            background: #4c51bf !important;
        }
        .bg-success {
            background: #2c7a7b !important;
        }
        .bg-warning {
            background: #744210 !important;
        }
        .bg-info {
            background: #2b6cb0 !important;
        }
        .text-primary {
            color: #4c51bf !important;
        }
        .table th {
            background: #f8f9fa;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <i class="fas fa-users me-2"></i>
            <span class="navbar-brand mb-0 h1">Gestione Utenti Autorizzati</span>
        </div>
        <div class="system-clock mx-auto">
            <i class="fas fa-clock"></i>
            <span class="clock-time"></span>
            <span class="clock-date"></span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <a href="/" class="btn btn-outline-light btn-sm">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>
            <div id="user-menu-placeholder"></div>
        </div>
    </div>
</nav>

<div class="container-fluid py-4">
    
    <!-- Statistiche -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Totale Utenti</h5>
                    <h2 class="mb-0" id="stat-totale">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Utenti Attivi</h5>
                    <h2 class="mb-0" id="stat-attivi">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Nuovi (30gg)</h5>
                    <h2 class="mb-0" id="stat-nuovi">-</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ricerca -->
    <div class="search-box position-relative">
        <input type="text" 
               id="search-input" 
               class="form-control form-control-lg" 
               placeholder="Cerca per nome completo o codice fiscale..."
               autocomplete="off">
        <i class="fas fa-times search-clear" id="search-clear"></i>
    </div>
    
    <!-- Tabella Utenti -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Codice Fiscale</th>
                    <th>Nome Completo</th>
                    <th>Data Inserimento</th>
                    <th>Ultimo Aggiornamento</th>
                    <th>Creato Da</th>
                    <th>Modificato Da</th>
                    <th>Note</th>
                    <th>Stato</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <!-- Righe generate dinamicamente -->
            </tbody>
        </table>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Caricamento...</span>
        </div>
    </div>
    
    <!-- Nessun Risultato -->
    <div id="no-results" class="text-center mt-4 d-none">
        <h4 class="text-muted">Nessun utente trovato</h4>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script src="/static/js/user-menu.js"></script>
<script src="/static/js/clock.js"></script>
<script src="/static/js/utenti_autorizzati.js"></script>
<script>
    // Carica menu utente
    fetch('/api/user-menu-html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('user-menu-placeholder').innerHTML = html;
            new UserMenu();
        });
</script>

</body>
</html>

```

---

## File: test_hardware_integration.py

**Percorso:** `api/test_hardware_integration.py`
**Directory:** `api`
**Dimensione:** 19294 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/test_hardware_integration.py
# Integrazione test hardware reali nella dashboard

import sys
import os
import json
import time
import threading
from flask import jsonify, request
from pathlib import Path

# Aggiungi path per importare moduli hardware
sys.path.append('/opt/access_control/src')

try:
    from hardware.card_reader import CardReader
    from hardware.usb_rly08_controller import USBRLY08Controller
except ImportError as e:
    print(f"⚠️ Errore import hardware: {e}")
    CardReader = None
    USBRLY08Controller = None

# Variabili globali per test
test_results = {}
test_lock = threading.Lock()

def api_test_reader():
    """Test lettore tessere OMNIKEY 5427CK"""
    global test_results
    
    with test_lock:
        test_results['reader'] = {
            'status': 'running',
            'message': 'Test lettore in corso...',
            'timestamp': time.time(),
            'details': []
        }
    
    def run_reader_test():
        """Esegue test lettore in thread separato"""
        try:
            if CardReader is None:
                with test_lock:
                    test_results['reader'] = {
                        'status': 'error',
                        'message': 'Modulo CardReader non disponibile',
                        'timestamp': time.time(),
                        'details': ['Verificare installazione pyscard']
                    }
                return
            
            details = []
            
            # STEP 1: Inizializzazione
            details.append("🔄 Inizializzazione lettore...")
            reader = CardReader()
            
            # STEP 2: Test connessione
            details.append("🔌 Test connessione lettori...")
            if reader.test_connection():
                details.append(f"✅ Trovati {len(reader.readers)} lettori")
                for i, r in enumerate(reader.readers):
                    details.append(f"   {i+1}: {str(r)}")
            else:
                details.append("❌ Nessun lettore trovato")
                with test_lock:
                    test_results['reader'] = {
                        'status': 'error',
                        'message': 'Nessun lettore smart card trovato',
                        'timestamp': time.time(),
                        'details': details
                    }
                return
            
            # STEP 3: Test lettura tessera (timeout breve)
            details.append("💳 Test lettura tessera (10s timeout)...")
            details.append("   Inserire tessera sanitaria...")
            
            # Aggiorna risultati parziali
            with test_lock:
                test_results['reader']['details'] = details.copy()
                test_results['reader']['message'] = 'Attendere inserimento tessera...'
            
            # Test lettura con timeout
            start_time = time.time()
            timeout = 10  # 10 secondi
            card_found = False
            
            while (time.time() - start_time) < timeout and not card_found:
                try:
                    cf = reader._read_card_robust(timeout=1)
                    if cf:
                        details.append(f"✅ Tessera letta: {cf}")
                        details.append("✅ Sequenza APDU funzionante")
                        details.append("✅ Estrazione CF riuscita")
                        card_found = True
                        break
                except Exception as e:
                    # Normale durante attesa
                    pass
                
                # Aggiorna countdown
                remaining = int(timeout - (time.time() - start_time))
                with test_lock:
                    test_results['reader']['message'] = f'Tessera non rilevata (timeout: {remaining}s)'
            
            if not card_found:
                details.append("⚠️ Timeout - nessuna tessera inserita")
                details.append("💡 Test hardware OK, nessuna tessera da testare")
                final_status = 'warning'
                final_message = 'Hardware OK - Nessuna tessera testata'
            else:
                details.append("🎯 Test completato con successo!")
                final_status = 'success'
                final_message = 'Lettore completamente funzionante'
            
            # Risultato finale
            with test_lock:
                test_results['reader'] = {
                    'status': final_status,
                    'message': final_message,
                    'timestamp': time.time(),
                    'details': details
                }
                
        except Exception as e:
            with test_lock:
                test_results['reader'] = {
                    'status': 'error',
                    'message': f'Errore test lettore: {str(e)}',
                    'timestamp': time.time(),
                    'details': details + [f"❌ Errore: {str(e)}"]
                }
    
    # Avvia test in thread separato
    threading.Thread(target=run_reader_test, daemon=True).start()
    
    return jsonify({
        'success': True,
        'message': 'Test lettore avviato',
        'test_id': 'reader'
    })

def api_test_relay():
    """Test USB-RLY08 Controller"""
    global test_results
    
    with test_lock:
        test_results['relay'] = {
            'status': 'running',
            'message': 'Test USB-RLY08 in corso...',
            'timestamp': time.time(),
            'details': []
        }
    
    def run_relay_test():
        """Esegue test relè in thread separato"""
        try:
            if USBRLY08Controller is None:
                with test_lock:
                    test_results['relay'] = {
                        'status': 'error',
                        'message': 'Modulo USB-RLY08 non disponibile',
                        'timestamp': time.time(),
                        'details': ['Verificare installazione pyserial']
                    }
                return
            
            details = []
            
            # STEP 1: Inizializzazione
            details.append("🔄 Inizializzazione USB-RLY08...")
            
            # Test diverse porte possibili
            ports_to_test = ["/dev/ttyACM0", "/dev/ttyUSB0"]
            controller = None
            connected_port = None
            
            for port in ports_to_test:
                try:
                    details.append(f"🔌 Test connessione {port}...")
                    test_controller = USBRLY08Controller(port=port)
                    
                    if test_controller.connect():
                        details.append(f"✅ Connesso a {port}")
                        controller = test_controller
                        connected_port = port
                        break
                    else:
                        details.append(f"❌ Connessione fallita a {port}")
                except Exception as e:
                    details.append(f"❌ Errore {port}: {str(e)}")
            
            if not controller:
                details.append("❌ USB-RLY08 non trovato su nessuna porta")
                with test_lock:
                    test_results['relay'] = {
                        'status': 'error',
                        'message': 'USB-RLY08 non collegato',
                        'timestamp': time.time(),
                        'details': details
                    }
                return
            
            # STEP 2: Test comunicazione
            details.append("📋 Test comunicazione...")
            if controller.health_check():
                details.append("✅ Comunicazione seriale OK")
            else:
                details.append("❌ Errore comunicazione")
                controller.disconnect()
                with test_lock:
                    test_results['relay'] = {
                        'status': 'error',
                        'message': 'Errore comunicazione USB-RLY08',
                        'timestamp': time.time(),
                        'details': details
                    }
                return
            
            # STEP 3: Test stati relè
            details.append("📊 Lettura stati relè...")
            states = controller.get_relay_states()
            if states:
                details.append(f"✅ Stati letti: {len(states)} relè")
                for name, state in states.items():
                    status = "ON" if state else "OFF"
                    details.append(f"   {name}: {status}")
            else:
                details.append("⚠️ Impossibile leggere stati relè")
            
            # STEP 4: Test sicuro relè (lampeggio rapido)
            details.append("🔧 Test sicuro relè...")
            
            # Test relè 1 (breve lampeggio)
            details.append("   Test Relè 1...")
            controller._set_relay_state(controller.RelayChannel.LED_GREEN, True)
            time.sleep(0.3)
            controller._set_relay_state(controller.RelayChannel.LED_GREEN, False)
            details.append("   ✅ Relè 1 OK")
            
            time.sleep(0.2)
            
            # Test relè 2 (breve lampeggio)
            details.append("   Test Relè 2...")
            controller._set_relay_state(controller.RelayChannel.LED_RED, True)
            time.sleep(0.3)
            controller._set_relay_state(controller.RelayChannel.LED_RED, False)
            details.append("   ✅ Relè 2 OK")
            
            # STEP 5: Test funzioni sistema
            details.append("🎯 Test funzioni sistema...")
            
            # Test segnalazione accesso
            details.append("   Test segnalazione accesso...")
            controller.access_granted()
            time.sleep(1)
            details.append("   ✅ Segnalazione accesso OK")
            
            time.sleep(0.5)
            
            # Spegni tutto
            details.append("�� Spegnimento tutti i relè...")
            controller.emergency_stop()
            details.append("✅ Test completato con successo!")
            
            # Disconnessione
            controller.disconnect()
            
            # Risultato finale
            with test_lock:
                test_results['relay'] = {
                    'status': 'success',
                    'message': f'USB-RLY08 completamente funzionante su {connected_port}',
                    'timestamp': time.time(),
                    'details': details
                }
                
        except Exception as e:
            if 'controller' in locals() and controller:
                try:
                    controller.disconnect()
                except:
                    pass
            
            with test_lock:
                test_results['relay'] = {
                    'status': 'error',
                    'message': f'Errore test USB-RLY08: {str(e)}',
                    'timestamp': time.time(),
                    'details': details + [f"❌ Errore: {str(e)}"]
                }
    
    # Avvia test in thread separato
    threading.Thread(target=run_relay_test, daemon=True).start()
    
    return jsonify({
        'success': True,
        'message': 'Test USB-RLY08 avviato',
        'test_id': 'relay'
    })

def api_test_status():
    """Ottieni stato test in corso"""
    global test_results
    
    test_id = request.args.get('test_id')
    
    with test_lock:
        if test_id and test_id in test_results:
            return jsonify({
                'success': True,
                'test': test_results[test_id]
            })
        else:
            return jsonify({
                'success': True,
                'tests': test_results
            })

def api_test_combined():
    """Test completo hardware (lettore + relè)"""
    global test_results
    
    with test_lock:
        test_results['combined'] = {
            'status': 'running',
            'message': 'Test completo hardware in corso...',
            'timestamp': time.time(),
            'details': []
        }
    
    def run_combined_test():
        """Test combinato in thread separato"""
        try:
            details = []
            details.append("🚀 AVVIO TEST COMPLETO HARDWARE")
            details.append("=" * 40)
            
            # Test 1: Lettore
            details.append("📋 FASE 1: Test lettore tessere...")
            if CardReader is None:
                details.append("❌ Modulo CardReader non disponibile")
                reader_ok = False
            else:
                try:
                    reader = CardReader()
                    if reader.test_connection():
                        details.append(f"✅ Lettore OK - {len(reader.readers)} dispositivi")
                        reader_ok = True
                    else:
                        details.append("❌ Lettore non connesso")
                        reader_ok = False
                except Exception as e:
                    details.append(f"❌ Errore lettore: {str(e)}")
                    reader_ok = False
            
            # Test 2: USB-RLY08
            details.append("�� FASE 2: Test USB-RLY08...")
            if USBRLY08Controller is None:
                details.append("❌ Modulo USB-RLY08 non disponibile")
                relay_ok = False
            else:
                try:
                    # Test porte
                    ports = ["/dev/ttyACM0", "/dev/ttyUSB0"]
                    controller = None
                    
                    for port in ports:
                        try:
                            test_ctrl = USBRLY08Controller(port=port)
                            if test_ctrl.connect():
                                controller = test_ctrl
                                details.append(f"✅ USB-RLY08 OK - {port}")
                                break
                        except:
                            continue
                    
                    if controller:
                        relay_ok = True
                        controller.disconnect()
                    else:
                        details.append("❌ USB-RLY08 non trovato")
                        relay_ok = False
                        
                except Exception as e:
                    details.append(f"❌ Errore USB-RLY08: {str(e)}")
                    relay_ok = False
            
            # Risultato finale
            details.append("=" * 40)
            if reader_ok and relay_ok:
                details.append("🎯 SISTEMA COMPLETO FUNZIONANTE!")
                details.append("✅ Lettore tessere: OK")
                details.append("✅ Controller USB-RLY08: OK")
                details.append("🚀 Sistema pronto per il funzionamento")
                final_status = 'success'
                final_message = 'Tutto l\'hardware è operativo'
            elif reader_ok or relay_ok:
                details.append("⚠️ SISTEMA PARZIALMENTE FUNZIONANTE")
                details.append(f"{'✅' if reader_ok else '❌'} Lettore tessere")
                details.append(f"{'✅' if relay_ok else '❌'} Controller USB-RLY08")
                final_status = 'warning'
                final_message = 'Hardware parzialmente operativo'
            else:
                details.append("❌ HARDWARE NON FUNZIONANTE")
                details.append("❌ Lettore tessere: Errore")
                details.append("❌ Controller USB-RLY08: Errore")
                final_status = 'error'
                final_message = 'Hardware non operativo'
            
            with test_lock:
                test_results['combined'] = {
                    'status': final_status,
                    'message': final_message,
                    'timestamp': time.time(),
                    'details': details,
                    'summary': {
                        'reader_ok': reader_ok,
                        'relay_ok': relay_ok,
                        'overall_ok': reader_ok and relay_ok
                    }
                }
                
        except Exception as e:
            with test_lock:
                test_results['combined'] = {
                    'status': 'error',
                    'message': f'Errore test completo: {str(e)}',
                    'timestamp': time.time(),
                    'details': details + [f"❌ Errore critico: {str(e)}"]
                }
    
    # Avvia test in thread separato
    threading.Thread(target=run_combined_test, daemon=True).start()
    
    return jsonify({
        'success': True,
        'message': 'Test completo avviato',
        'test_id': 'combined'
    })

# Funzioni per aggiornare web_api.py esistente
def register_hardware_test_routes(app):
    """Registra le route dei test hardware nell'app Flask esistente"""
    
    @app.route('/api/test/reader', methods=['POST'])
    def test_reader_endpoint():
        return api_test_reader()
    
    @app.route('/api/test/relay', methods=['POST'])
    def test_relay_endpoint():
        return api_test_relay()
    
    @app.route('/api/test/combined', methods=['POST'])
    def test_combined_endpoint():
        return api_test_combined()
    
    @app.route('/api/test/status')
    def test_status_endpoint():
        return api_test_status()
    
    # Aggiorna route esistente /test-hardware
    @app.route('/test-hardware')
    def enhanced_test_hardware():
        """Test hardware migliorato con test reali"""
        hardware_status = {
            'lettore_cf': {'status': 'unknown', 'message': 'Pronto per test'},
            'rele_usb': {'status': 'unknown', 'message': 'Pronto per test'},
            'rete': {'status': 'ok', 'message': 'Connessione web funzionante'}
        }
        
        # Test presenza file hardware
        card_reader_path = Path("/opt/access_control/src/hardware/card_reader.py")
        relay_path = Path("/opt/access_control/src/hardware/usb_rly08_controller.py")
        
        if card_reader_path.exists():
            hardware_status['lettore_cf']['status'] = 'ready'
            hardware_status['lettore_cf']['message'] = 'Modulo pronto - Cliccare "Test Lettore"'
        else:
            hardware_status['lettore_cf']['status'] = 'error'
            hardware_status['lettore_cf']['message'] = 'Modulo card_reader.py non trovato'
        
        if relay_path.exists():
            hardware_status['rele_usb']['status'] = 'ready'
            hardware_status['rele_usb']['message'] = 'Modulo pronto - Cliccare "Test USB-RLY08"'
        else:
            hardware_status['rele_usb']['status'] = 'error'
            hardware_status['rele_usb']['message'] = 'Modulo usb_rly08_controller.py non trovato'
        
        return {
            'status': 'success',
            'message': 'Test hardware avanzati disponibili',
            'hardware': hardware_status
        }
    
    print("✅ Route test hardware registrate")

if __name__ == "__main__":
    print("🔧 Modulo Test Hardware Integration")
    print("Importare in web_api.py con:")
    print("from test_hardware_integration import register_hardware_test_routes")
    print("register_hardware_test_routes(app)")

```

---

## File: user_menu.py

**Percorso:** `api/user_menu.py`
**Directory:** `api`
**Dimensione:** 3217 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/user_menu.py
# Endpoint per menu utente

from flask import render_template_string, session
from web_api import app, require_auth

@app.route('/api/user-menu-html')
@require_auth()
def get_user_menu_html():
    """Restituisce HTML del menu utente con dati sessione"""
    
    # Mappa ruoli
    role_names = {
        'admin': 'Amministratore',
        'user_manager': 'Gestore Utenti',
        'viewer': 'Visualizzatore'
    }

    # Aggiungi badge colorati per ruolo nel menu
    role_badges = {
        'admin': 'bg-danger',
        'user_manager': 'bg-primary', 
        'viewer': 'bg-success'
    }
    
    user_role = session.get('role', 'readonly')
    user_role_name = role_names.get(user_role, 'Utente')
    
    # Template del menu
    menu_template = """
    <div class="user-menu-container">
        <!-- Trigger Menu -->
        <div class="user-menu-trigger">
            <div class="user-avatar">
                {{ session.username[0].upper() }}
            </div>
            <div class="user-menu-info">
                <div class="user-menu-name">{{ session.username }}</div>
                <div class="user-menu-role">{{ user_role_name }}</div>
            </div>
            <i class="fas fa-chevron-down" style="color: white; font-size: 0.8rem;"></i>
        </div>
        
        <!-- Dropdown Menu -->
        <div class="user-menu-dropdown">
            <div class="user-menu-header">
                <div class="avatar-large">
                    {{ session.username[0].upper() }}
                </div>
                <div class="user-name">{{ session.username }}</div>
                <div class="user-email">{{ user_role_name }}</div>
            </div>
            
            <div class="user-menu-items">
                <a href="#" class="user-menu-item" data-action="profile">
                    <i class="fas fa-user-circle"></i>
                    <span class="user-menu-item-text">Il Mio Profilo</span>
                </a>
                
                <a href="#" class="user-menu-item" data-action="change-password">
                    <i class="fas fa-key"></i>
                    <span class="user-menu-item-text">Cambio Password</span>
                </a>
                
                <a href="#" class="user-menu-item" data-action="settings">
                    <i class="fas fa-cog"></i>
                    <span class="user-menu-item-text">Impostazioni</span>
                    {% if session.role == 'admin' %}
                    <span class="notification-badge">New</span>
                    {% endif %}
                </a>
                
                <div class="user-menu-divider"></div>
                
                <a href="/logout" class="user-menu-item logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="user-menu-item-text">Logout</span>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Overlay -->
    <div class="user-menu-overlay"></div>
    """
    
    return render_template_string(menu_template, 
                                session=session,
                                user_role_name=user_role_name)

```

---

## File: utils.py

**Percorso:** `api/utils.py`
**Directory:** `api`
**Dimensione:** 1763 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
from flask import jsonify, session, redirect, request
import sqlite3
import os

# Database path
DB_PATH = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'access.db')

def get_db_connection():
    """Connessione database"""
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        return conn
    except Exception as e:
        print(f"Errore connessione DB: {e}")
        return None

def require_auth():
    """Decorator autenticazione"""
    def decorator(f):
        def wrapper(*args, **kwargs):
            if 'username' not in session:
                if request.path.startswith('/api/'):
                    return jsonify({'error': 'Non autenticato'}), 401
                return redirect('/login')
            return f(*args, **kwargs)
        wrapper.__name__ = f.__name__
        return wrapper
    return decorator

def require_permission(*required_permissions):
    """Decorator per verificare permessi specifici"""
    def decorator(f):
        @require_auth()
        def wrapper(*args, **kwargs):
            user_role = session.get('role', 'viewer')
            from src.api.auth import USER_ROLES
            user_permissions = USER_ROLES.get(user_role, {}).get('permissions', [])
            
            # Admin ha sempre accesso
            if 'all' in user_permissions:
                return f(*args, **kwargs)
            
            # Controlla se l'utente ha almeno uno dei permessi richiesti
            if any(perm in user_permissions for perm in required_permissions):
                return f(*args, **kwargs)
            
            return jsonify({'error': 'Permessi insufficienti'}), 403
        
        wrapper.__name__ = f.__name__
        return wrapper
    return decorator

```

---

## File: web_api.py

**Percorso:** `api/web_api.py`
**Directory:** `api`
**Dimensione:** 45953 bytes
**Ultima modifica:** 2025-07-23 11:07:13
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/api/web_api.py
# Dashboard web modulare - API principale - FIXED IMPORTS

import os
import sys
import json
import sqlite3
import logging
import shutil
from datetime import datetime
from typing import Dict, Any, Tuple, Optional, List, Union, Callable

from flask import Flask, render_template_string, request, jsonify, session, redirect, send_from_directory, Response, Blueprint, current_app
from flask_cors import CORS
from werkzeug.exceptions import BadRequest, InternalServerError
from werkzeug.wrappers import Response as WerkzeugResponse
from werkzeug.datastructures import ImmutableMultiDict
from werkzeug.local import LocalProxy

# Assicurati che il path sia corretto
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Importazioni locali
from api.auth import verify_user, USER_ROLES
from api.utils import get_db_connection, require_auth, require_permission
import api.hardware_tests as hardware_tests
import api.backup_module as backup_module
import api.hardware_detection as hardware_detection
from core.config import get_config_manager
from api.dashboard_templates import LOGIN_TEMPLATE, get_dashboard_template, ADMIN_CONFIG_TEMPLATE, ADMIN_BACKUP_TEMPLATE

# Importazioni dei moduli
from api.modules.profilo import profilo_bp
from api.modules.user_management import user_management_bp
from api.modules.log_management import log_management_bp
from api.modules.utenti_autorizzati import utenti_autorizzati_bp
from api.modules.system_users import system_users_bp
from api.modules.activities import activities_bp
from api.modules.configurazione_accessi import configurazione_accessi_bp
from api.backup_module import backup_bp

# Definizione dei tipi personalizzati
FlaskResponse = Union[Response, str, Tuple[Union[Dict[str, Any], str], int]]
Request = Union[ImmutableMultiDict[str, str], Dict[str, Any]]

# Configurazione del logging
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# Queste importazioni sono già state definite sopra e non sono necessarie qui

# Questi import sono già stati definiti sopra e non sono necessari qui

from typing import Optional

# Definizione dei tipi personalizzati
FlaskResponse = Union[Response, str, Tuple[Union[Dict[str, Any], str], int]]
Request = Union[ImmutableMultiDict[str, str], Dict[str, Any]]

# Gestione delle eccezioni
def handle_exception(e: Exception) -> Tuple[Dict[str, Any], int]:
    logger.error(f"Errore: {str(e)}", exc_info=True)
    if isinstance(e, BadRequest):
        return jsonify({"success": False, "error": "Richiesta non valida"}), 400
    elif isinstance(e, InternalServerError):
        return jsonify({"success": False, "error": "Errore interno del server"}), 500
    else:
        return jsonify({"success": False, "error": str(e)}), 500

# Definizione dei tipi per le funzioni di Flask
def flask_route(rule: str, **options: Any) -> Callable[[Callable[..., FlaskResponse]], Callable[..., FlaskResponse]]:
    return app.route(rule, **options)

def flask_jsonify(*args: Any, **kwargs: Any) -> WerkzeugResponse:
    return jsonify(*args, **kwargs)

# Tipo per le funzioni di route
RouteFunction = Callable[..., FlaskResponse]

app = Flask(__name__)
app.secret_key = 'raee-2025-access-control-system'

# Configura CORS per permettere richieste cross-origin con credenziali
CORS(app, 
     supports_credentials=True,
     resources={r"/*": {"origins": "*"}},
     allow_headers=["Content-Type", "Authorization"],
     expose_headers=["Content-Type", "X-CSRFToken"],
     methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"])

# Configura sessione per funzionare cross-origin
app.config.update(
    SESSION_COOKIE_SECURE=False,  # Impostare a True se si usa HTTPS
    SESSION_COOKIE_HTTPONLY=True,
    SESSION_COOKIE_SAMESITE='Lax'
)

project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..'))
sys.path.insert(0, project_root)

# Database path persistente
DB_PATH = '/opt/access_control/src/access.db'

# IMPORTA I MODULI DOPO aver definito le funzioni condivise
from api.modules.profilo import profilo_bp
from api.modules.user_management import user_management_bp
from api.modules.log_management import log_management_bp
from api.modules.utenti_autorizzati import utenti_autorizzati_bp
from api.modules.system_users import system_users_bp
from api.modules.activities import activities_bp
from api.modules.configurazione_accessi import configurazione_accessi_bp

# Route di test per visualizzare tutte le routes
@app.route('/api/routes')
def list_routes():
    """Lista tutte le routes registrate"""
    routes = []
    for rule in app.url_map.iter_rules():
        routes.append({
            'endpoint': rule.endpoint,
            'methods': sorted(list(rule.methods)),
            'path': str(rule)
        })
    return jsonify({
        'success': True,
        'routes': sorted(routes, key=lambda x: x['path'])
    })

# Registra i blueprint
app.register_blueprint(profilo_bp)
app.register_blueprint(user_management_bp)
app.register_blueprint(log_management_bp)
app.register_blueprint(utenti_autorizzati_bp)
app.register_blueprint(system_users_bp)
app.register_blueprint(activities_bp)
app.register_blueprint(configurazione_accessi_bp)
app.register_blueprint(backup_bp)

# ===============================
# ROUTES PRINCIPALI
# ===============================

@flask_route('/')
@require_auth()
def dashboard() -> FlaskResponse:
    """Dashboard principale con template personalizzato per ruolo"""
    # Menu items per admin
    menu_items: List[Dict[str, str]] = []
    if session.get('role') == 'admin':
        menu_items = [
            {
                'url': '/utenti-autorizzati',
                'icon': 'fas fa-users',
                'text': 'Utenti Autorizzati'
            },
            {
                'url': '/admin/users',
                'icon': 'fas fa-users-cog',
                'text': 'Gestione Utenti Sistema'
            },
            {
                'url': '/configurazione-orari',
                'icon': 'fas fa-clock',
                'text': 'Configurazione Orari'
            },
            {
                'url': '/test-accessi',
                'icon': 'fas fa-door-open',
                'text': 'Test Accessi'
            }
        ]
    
    return render_template_string(
        get_dashboard_template(), 
        session=session,
        menu_items=menu_items
    )

@app.route('/utenti-autorizzati')
@require_auth()
@require_permission('all')
def utenti_autorizzati_page() -> FlaskResponse:
    """Pagina gestione utenti autorizzati"""
    with open(os.path.join(os.path.dirname(__file__), 'templates', 'utenti_autorizzati.html'), 'r') as f:
        template = f.read()
    return render_template_string(template, session=session)

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username', '').strip()
        password = request.form.get('password', '').strip()
        
        logger.debug(f"Tentativo di login per l'utente: {username}")
        
        if not username or not password:
            logger.debug("Username o password mancanti")
            return render_template_string(LOGIN_TEMPLATE, error="Inserire username e password")
        
        # Verifica credenziali nel database
        success, role = verify_user(username, password)
        
        logger.debug(f"Risultato verifica utente: success={success}, role={role}")
        
        if success:
            conn = get_db_connection()
            if conn:
                try:
                    cursor = conn.cursor()
                    # Aggiorna last_login
                    cursor.execute("""
                        UPDATE utenti_sistema 
                        SET last_login = CURRENT_TIMESTAMP,
                            modified_at = CURRENT_TIMESTAMP,
                            modified_by = 'system'
                        WHERE username = ?
                    """, (username,))
                    
                    # Log accesso
                    cursor.execute("""
                        INSERT INTO eventi_sistema (tipo_evento, livello, messaggio, componente)
                        VALUES (?, ?, ?, ?)
                    """, ('LOGIN', 'INFO', f'Login utente {username} ({role})', 'AUTH'))
                    
                    conn.commit()
                    logger.debug("Aggiornamento last_login e log accesso completati")
                except Exception as e:
                    logger.error(f"Errore durante l'aggiornamento del database: {e}")
                    conn.rollback()
                finally:
                    conn.close()

            # Imposta dati sessione
            session['username'] = username
            session['role'] = role
            session['logged_in'] = True
            session['login_time'] = datetime.now().strftime('%d/%m/%Y %H:%M')
            session['role_name'] = USER_ROLES.get(role, {}).get('name', 'Utente')
            session['permissions'] = USER_ROLES.get(role, {}).get('permissions', [])
            
            logger.debug("Dati sessione impostati correttamente")
            logger.debug(f"Sessione attuale: {session}")
            
            return redirect('/')
        else:
            logger.debug("Autenticazione fallita")
            return render_template_string(LOGIN_TEMPLATE, error="Credenziali non valide")
    
    # Mostra info sui livelli nel form di login
    login_info = """
    <div class="mt-4 text-center">
        <small class="text-muted">
            <strong>Utenti di test:</strong><br>
            🔴 admin/admin123 (Amministratore)<br>
            🔵 manager/manager123 (Gestore Utenti)<br>
            🟢 viewer/viewer123 (Visualizzatore)
        </small>
    </div>
    """
    
    return render_template_string(LOGIN_TEMPLATE + login_info)

@app.route('/logout')
def logout():
    """Gestisce il logout utente con gestione errori robusta"""
    try:
        username = session.get('username')
        role = session.get('role')
        
        # Log logout se possibile
        if username:
            try:
                conn = get_db_connection()
                if conn:
                    try:
                        cursor = conn.cursor()
                        cursor.execute("""
                            INSERT INTO eventi_sistema (tipo_evento, livello, messaggio, componente)
                            VALUES (?, ?, ?, ?)
                        """, ('LOGOUT', 'INFO', f'Logout utente {username} ({role})', 'AUTH'))
                        conn.commit()
                    except Exception as e:
                        logger.error(f"Errore logging logout: {e}")
                    finally:
                        conn.close()
            except Exception as e:
                logger.error(f"Errore connessione DB durante logout: {e}")
        
        # Pulisci la sessione in ogni caso
        session.clear()
        
        return redirect('/login')
        
    except Exception as e:
        logger.error(f"Errore durante logout: {e}")
        # Forza pulizia sessione anche in caso di errore
        session.clear()
        return redirect('/login')

@app.route('/api/profile/info')
@require_auth()
def api_profile_info():
    """Restituisce informazioni profilo dalla sessione"""
    return jsonify({
        'success': True,
        'user': {
            'username': session.get('username'),
            'role': session.get('role'),
            'login_time': session.get('login_time', datetime.now().strftime('%d/%m/%Y %H:%M'))
        }
    })

@app.route('/api/user-menu-html')
@require_auth()
def api_user_menu_html():
    """Restituisce HTML del menu utente con dati sessione"""
    
    # Mappa ruoli aggiornata per 3 livelli
    role_names = {
        'admin': 'Amministratore',
        'user_manager': 'Gestore Utenti', 
        'viewer': 'Visualizzatore'
    }
    
    user_role = session.get('role', 'viewer')
    user_role_name = role_names.get(user_role, 'Utente')
    username = session.get('username', 'user')
    
    # Template del menu inline
    menu_html = f'''
    <div class="user-menu-container">
        <!-- Trigger Menu -->
        <div class="user-menu-trigger">
            <div class="user-avatar">
                {username[0].upper()}
            </div>
            <div class="user-menu-info">
                <div class="user-menu-name">{username}</div>
                <div class="user-menu-role">{user_role_name}</div>
            </div>
            <i class="fas fa-chevron-down" style="color: white; font-size: 0.8rem;"></i>
        </div>
        
        <!-- Dropdown Menu -->
        <div class="user-menu-dropdown">
            <div class="user-menu-header">
                <div class="avatar-large">
                    {username[0].upper()}
                </div>
                <div class="user-name">{username}</div>
                <div class="user-email">{user_role_name}</div>
            </div>
            
            <div class="user-menu-items">
                <a href="#" class="user-menu-item" data-action="profile">
                    <i class="fas fa-user-circle"></i>
                    <span class="user-menu-item-text">Il Mio Profilo</span>
                </a>
                
                <a href="#" class="user-menu-item" data-action="change-password">
                    <i class="fas fa-key"></i>
                    <span class="user-menu-item-text">Cambio Password</span>
                </a>
                
                <div class="user-menu-divider"></div>
                
                <a href="/logout" class="user-menu-item logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="user-menu-item-text">Logout</span>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Overlay -->
    <div class="user-menu-overlay"></div>
    '''
    
    return menu_html

# ===============================
# STATIC FILES
# ===============================

@app.route('/static/<path:path>')
def send_static(path):
    return send_from_directory(os.path.join(os.path.dirname(__file__), 'static'), path)

# ===============================
# API ENDPOINTS - DATI
# ===============================

@app.route('/api/stats')
@require_auth()
def api_stats():
    """Statistiche usando schema database_manager.py"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        
        # Oggi
        today = datetime.now().strftime('%Y-%m-%d')
        
        # Accessi oggi
        cursor.execute("""
            SELECT COUNT(*) 
            FROM log_accessi 
            WHERE DATE(timestamp) = ?
        """, (today,))
        accessi_oggi = cursor.fetchone()[0]
        
        # Accessi autorizzati oggi
        cursor.execute("""
            SELECT COUNT(*) 
            FROM log_accessi 
            WHERE DATE(timestamp) = ? AND autorizzato = 1
        """, (today,))
        autorizzati_oggi = cursor.fetchone()[0]
        
        return jsonify({
            'accessi_oggi': accessi_oggi,
            'autorizzati_oggi': autorizzati_oggi
        })
        
    except Exception as e:
        print(f"Errore API stats: {e}")
        return jsonify({'error': str(e)}), 500
    finally:
        conn.close()

@app.route('/api/users/count')
@require_auth()
def api_users_count():
    """Count utenti usando schema database_manager.py"""
    conn = get_db_connection()
    if not conn:
        return jsonify({'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM utenti_autorizzati WHERE attivo = 1")
        count = cursor.fetchone()[0]
        return jsonify({'count': count})
    except Exception as e:
        print(f"Errore API users count: {e}")
        return jsonify({'error': str(e)}), 500
    finally:
        conn.close()

@app.route('/api/recent-accesses')
@require_auth()
def api_recent_accesses():
    """Accessi recenti usando schema database_manager.py"""
    limit = request.args.get('limit', 10, type=int)
    
    conn = get_db_connection()
    if not conn:
        return jsonify({'error': 'Database non disponibile'}), 500
    
    try:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT 
                la.timestamp, 
                la.codice_fiscale, 
                la.autorizzato,
                COALESCE(ua.nome, 'Utente sconosciuto') as nome_completo
            FROM log_accessi la
            LEFT JOIN utenti_autorizzati ua ON la.codice_fiscale = ua.codice_fiscale
            ORDER BY la.timestamp DESC
            LIMIT ?
        """, (limit,))
        
        results = cursor.fetchall()
        accesses = []
        
        for row in results:
            accesses.append({
                'timestamp': row[0],
                'codice_fiscale': row[1],
                'autorizzato': bool(row[2]),
                'nome': row[3]
            })
        
        return jsonify({'accesses': accesses})
        
    except Exception as e:
        print(f"Errore API recent accesses: {e}")
        return jsonify({'error': str(e)}), 500
    finally:
        conn.close()

# ===============================
# API ENDPOINTS - TEST HARDWARE
# ===============================

@app.route('/api/test/gate')
@require_auth()
def api_test_gate():
    """Test cancello"""
    return hardware_tests.test_gate(get_db_connection)

@app.route('/api/test_relay', methods=['POST'])
@require_auth()
def api_test_relay():
    """Test USB-RLY08"""
    return hardware_tests.test_relay()

@app.route('/api/test/integrated', methods=['POST'])
@require_auth()
def api_test_integrated():
    """Test integrato completo"""
    return hardware_tests.test_integrated(get_db_connection)

@app.route('/api/hardware/test-reader', methods=['POST'])
@require_auth()
def api_hardware_test_reader():
    """Test lettore tessere - CORRETTA CHIAMATA A hardware_tests"""
    return hardware_tests.test_reader()

# ===============================
# API ENDPOINTS - STATI
# ===============================

@app.route('/api/relay_status')
@require_auth()
def api_relay_status():
    """Stato test relay"""
    return hardware_tests.get_relay_status()

@app.route('/api/integrated_status')
@require_auth()
def api_integrated_status():
    """Stato test integrato"""
    return hardware_tests.get_integrated_status()

@app.route('/api/hardware/status')
@require_auth()
def api_hardware_status():
    """Stato test hardware"""
    test_id = request.args.get('test_id')
    return hardware_tests.get_hardware_status(test_id)

# ===============================
# API ENDPOINTS - RILEVAMENTO HARDWARE
# ===============================

@app.route('/api/hardware/detect')
@require_auth()
@require_permission('all')
def api_hardware_detect():
    """Rileva automaticamente l'hardware collegato"""
    return jsonify(hardware_detection.detect_hardware())

@app.route('/api/hardware/test-connection', methods=['POST'])
@require_auth()
@require_permission('all')
def api_hardware_test_connection():
    """Testa la connessione a un dispositivo hardware"""
    if not request.is_json:
        return jsonify({'success': False, 'error': 'Richiesta non valida, JSON richiesto'})
    
    data = request.get_json()
    hardware_type = data.get('type')
    device_path = data.get('device_path', data.get('port'))  # Supporta sia 'device_path' che 'port' per retrocompatibilità
    
    if not hardware_type or not device_path:
        return jsonify({
            'success': False,
            'error': 'Tipo di hardware e porta sono richiesti'
        })
    
    # Estrai parametri aggiuntivi specifici per tipo di hardware
    kwargs = {}
    
    # Per lettore tessere
    if hardware_type == 'card_reader':
        if 'reader_type' in data:
            kwargs['reader_type'] = data['reader_type']
    
    # Per controller relè
    elif hardware_type == 'relay':
        if 'baud_rate' in data:
            kwargs['baud_rate'] = data['baud_rate']
    
    # Log parametri
    logger.info(f"Test connessione hardware: tipo={hardware_type}, device_path={device_path}, kwargs={kwargs}")
    
    # Esegui test connessione con parametri aggiuntivi
    return jsonify(hardware_detection.test_hardware_connection(hardware_type, device_path, **kwargs))

@app.route('/api/hardware/config')
@require_auth()
@require_permission('all')
def api_hardware_config():
    """Carica la configurazione dell'hardware"""
    return jsonify(hardware_detection.load_hardware_config(get_db_connection))

@app.route('/api/hardware/config/save', methods=['POST'])
@require_auth()
@require_permission('all')
def api_hardware_config_save():
    """Salva la configurazione dell'hardware"""
    data = request.get_json()
    return jsonify(hardware_detection.save_hardware_config(data, get_db_connection))

# ===============================
# ROUTES GESTIONE SISTEMA ADMIN
# ===============================

@app.route('/admin/users')
@require_auth()
@require_permission('all')  # Solo admin
def admin_users():
    """Gestione completa utenti - Solo Admin"""
    with open(os.path.join(os.path.dirname(__file__), 'static', 'html', 'user-management.html'), 'r') as f:
        template = f.read()
    return render_template_string(template, session=session)

@app.route('/admin/config')
@require_auth()
@require_permission('all')  # Solo admin
def admin_config():
    """Configurazioni sistema - Solo Admin"""
    return render_template_string(ADMIN_CONFIG_TEMPLATE, session=session)

@app.route('/admin/backup')
@require_auth()
@require_permission('all')  # Solo admin
def admin_backup():
    """Backup & Restore - Solo Admin"""
    return render_template_string(ADMIN_BACKUP_TEMPLATE, session=session)

@app.route('/configurazione-orari')
@require_auth()
@require_permission('all')
def configurazione_orari():
    """Pagina configurazione orari accesso"""
    with open(os.path.join(os.path.dirname(__file__), 'templates', 'configurazione_orari.html'), 'r') as f:
        template = f.read()
    return render_template_string(template, session=session)

@app.route('/test-accessi')
@require_auth()
@require_permission('all')
def test_accessi():
    """Pagina test funzionalità accessi"""
    with open(os.path.join(os.path.dirname(__file__), 'static', 'html', 'test-accessi.html'), 'r') as f:
        template = f.read()
    return render_template_string(template, session=session)
# ===============================
# API ENDPOINTS BACKUP (utilizzando backup_module esistente)
# ===============================

@app.route('/api/backup/status')
@require_auth()
@require_permission('all')
def api_backup_status():
    return backup_module.get_backup_status()

@app.route('/api/backup/create', methods=['POST'])
@require_auth()
@require_permission('all')
def api_backup_create():
    data = request.get_json()
    backup_type = data.get('type', 'complete')
    return backup_module.create_backup(backup_type)

@app.route('/api/backup/cleanup', methods=['POST'])
@require_auth()
@require_permission('all')
def api_backup_cleanup():
    return backup_module.cleanup_old_backups()

@app.route('/api/backup/schedule', methods=['POST'])
@require_auth()
@require_permission('all')
def api_backup_schedule():
    """Salva configurazione schedulazione backup"""
    try:
        data = request.get_json()
        scheduling = data.get('scheduling', 'daily')
        retention = int(data.get('retention', 7))
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
        try:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                VALUES (?, ?, CURRENT_TIMESTAMP)
            ''', ('backup.scheduling', scheduling))
            cursor.execute('''
                INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                VALUES (?, ?, CURRENT_TIMESTAMP)
            ''', ('backup.retention', str(retention)))
            conn.commit()
            return jsonify({'success': True, 'message': 'Schedulazione backup salvata'})
        finally:
            conn.close()
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/backup/schedule')
@require_auth()
@require_permission('all')
def api_get_backup_schedule():
    """Restituisce configurazione schedulazione backup"""
    try:
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
        try:
            cursor = conn.cursor()
            cursor.execute("SELECT key, value FROM system_settings WHERE key LIKE 'backup.%'")
            settings = dict(cursor.fetchall())
            return jsonify({'success': True, 'schedule': settings})
        finally:
            conn.close()
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/backup/config', methods=['GET', 'POST'])
@require_auth()
@require_permission('all')
def api_backup_config():
    if request.method == 'GET':
        return backup_module.load_config()
    else:
        config = request.get_json()
        return backup_module.save_config(config)

# ===============================
# API ENDPOINTS CONFIGURAZIONI SISTEMA
# ===============================

@app.route('/api/system/config/save', methods=['POST'])
@require_auth()
@require_permission('all')
def api_save_system_config():
    """Salva configurazioni sistema"""
    try:
        data = request.get_json()
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
        try:
            cursor = conn.cursor()
            for section, values in data.items():
                for key, value in values.items():
                    # Forza il prefisso 'sistema.' per tutte le chiavi di sistema
                    if not section.startswith('sistema'):
                        config_key = f"sistema.{key}"
                    else:
                        config_key = f"{section}.{key}"
                    if isinstance(value, (dict, list)):
                        import json
                        json_value = json.dumps(value)
                    else:
                        json_value = str(value)
                    cursor.execute('''
                        INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                        VALUES (?, ?, CURRENT_TIMESTAMP)
                    ''', (config_key, json_value))
            conn.commit()
            # Log evento
            cursor.execute('''
                INSERT INTO eventi_sistema (tipo_evento, livello, messaggio, componente)
                VALUES (?, ?, ?, ?)
            ''', ('CONFIG_UPDATE', 'INFO', 'Configurazioni sistema aggiornate', 'SYSTEM'))
            conn.commit()
            return jsonify({
                'success': True, 
                'message': 'Configurazioni salvate con successo'
            })
        finally:
            conn.close()
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

# 3. AGGIUNGI il nuovo endpoint per il reset (dopo api_system_restart, circa riga 620)
@app.route('/api/system/config/reset', methods=['POST'])
@require_auth()
@require_permission('all')
def api_reset_system_config():
    """Ripristina configurazioni ai valori default"""
    try:
        # Ottieni configurazioni default
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
        
        try:
            cursor = conn.cursor()
            
            # Crea tabella se non esiste
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS system_settings (
                    key TEXT PRIMARY KEY,
                    value TEXT NOT NULL,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # Elimina tutte le configurazioni personalizzate
            cursor.execute('DELETE FROM system_settings')
            
            # Inserisci valori default
            default_values = {
                'sistema.nome_installazione': 'Isola Ecologica RAEE - Rende',
                'sistema.versione': '1.0.0',
                'sistema.ambiente': 'production',
                'sistema.debug_mode': 'false',
                'sistema.porta_web': '5000',
                'sistema.timeout_sessione': '1800',
                
                'hardware.lettore_porta': '/dev/ttyACM0',
                'hardware.relay_porta': '/dev/ttyUSB0',
                'hardware.relay_baudrate': '19200',
                'hardware.gate_duration': '8.0',
                
                'sicurezza.max_tentativi_login': '5',
                'sicurezza.durata_blocco_minuti': '15',
                'sicurezza.rotazione_password_giorni': '90',
                'sicurezza.log_audit_abilitato': 'true',
                
                'email.smtp_server': '',
                'email.smtp_porta': '587',
                'email.mittente': '',
                'email.report_automatici': 'false',
                'email.frequenza_report': 'weekly'
            }
            
            for key, value in default_values.items():
                cursor.execute('''
                    INSERT INTO system_settings (key, value, updated_at)
                    VALUES (?, ?, CURRENT_TIMESTAMP)
                ''', (key, value))
            
            conn.commit()
            
            # Log evento
            cursor.execute('''
                INSERT INTO eventi_sistema (tipo_evento, livello, messaggio, componente)
                VALUES (?, ?, ?, ?)
            ''', ('CONFIG_RESET', 'WARNING', 'Configurazioni ripristinate ai valori default', 'SYSTEM'))
            
            conn.commit();
            
            return jsonify({
                'success': True,
                'message': 'Configurazioni ripristinate ai valori default'
            })
            
        finally:
            conn.close()
            
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/system/restart', methods=['POST'])
@require_auth()
@require_permission('all')
def api_system_restart():
    """Riavvia realmente il sistema tramite systemd"""
    try:
        import subprocess
        # Riavvia il servizio systemd (modifica il nome se necessario)
        subprocess.Popen(['sudo', 'systemctl', 'restart', 'access-control-system'])
        return jsonify({
            'success': True,
            'message': 'Sistema in riavvio...'
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

# ===============================
# API ENDPOINTS CONFIGURAZIONI - USANDO CONFIG ESISTENTE
# ===============================



@app.route('/api/email/config')
@require_auth()
def api_get_email_config():
    """Ottieni configurazione email"""
    try:
        # Carica da database temporaneo
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
        
        try:
            cursor = conn.cursor()
            cursor.execute("SELECT key, value FROM system_settings WHERE key LIKE 'email.%'")
            settings = cursor.fetchall()
            
            config = {
                'smtp_server': '',
                'smtp_port': 587,
                'mittente': '',
                'frequenza_report': 'weekly',
                'orario_invio': '08:00',
                'includi_statistiche': True,
                'includi_errori': True
            }
            
            # Popola con valori salvati
            for key, value in settings:
                setting_name = key.replace('email.', '')
                if setting_name in config:
                    try:
                        # Prova a convertire numeri e boolean
                        if value.lower() in ('true', 'false'):
                            config[setting_name] = value.lower() == 'true'
                        elif value.isdigit():
                            config[setting_name] = int(value)
                        else:
                            config[setting_name] = value
                    except:
                        config[setting_name] = value
            
            return jsonify({'success': True, 'config': config})
            
        finally:
            conn.close()
            
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/email/save-smtp', methods=['POST'])
@require_auth()
@require_permission('all')
def api_save_smtp_config():
    """Salva configurazione SMTP"""
    try:
        data = request.get_json()
        
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
        
        try:
            cursor = conn.cursor()
            
            # Crea tabella se non esiste
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS system_settings (
                    key TEXT PRIMARY KEY,
                    value TEXT NOT NULL,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # Salva configurazioni email
            email_settings = {
                'smtp_server': data.get('smtp_server', ''),
                'smtp_port': str(data.get('smtp_port', 587)),
                'mittente': data.get('mittente', '')
            }
            
            for key, value in email_settings.items():
                cursor.execute('''
                    INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                    VALUES (?, ?, CURRENT_TIMESTAMP)
                ''', (f'email.{key}', value))
            
            # Non salvare password per sicurezza
            if data.get('password'):
                cursor.execute('''
                    INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                    VALUES (?, ?, CURRENT_TIMESTAMP)
                ''', ('email.password_set', 'true'))
            
            conn.commit()
            
            return jsonify({'success': True, 'message': 'Configurazione SMTP salvata'})
            
        finally:
            conn.close()
            
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/devices/config')
@require_auth()
def api_get_devices_config():
    """Ottieni configurazione dispositivi"""
    try:
        # Carica da database temporaneo
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500
        
        try:
            cursor = conn.cursor()
            cursor.execute("SELECT key, value FROM system_settings WHERE key LIKE 'dispositivi.%'")
            settings = cursor.fetchall()
            
            config = {
                'reader': {
                    'tipo': 'HID Omnikey 5427CK',
                    'porta': '/dev/ttyACM0',
                    'timeout': 30,
                    'retry_tentativi': 3
                },
                'relay': {
                    'porta': '/dev/ttyUSB0',
                    'baud_rate': 19200,
                    'modulo_id': 8
                }
            }
            
            # Popola con valori salvati
            for key, value in settings:
                parts = key.split('.')
                if len(parts) >= 3:
                    device = parts[1]  # lettore_cf o rele
                    setting = parts[2]
                    
                    if device == 'lettore_cf' and setting in config['reader']:
                        try:
                            if setting in ['timeout', 'retry_tentativi']:
                                config['reader'][setting] = int(value)
                            else:
                                config['reader'][setting] = value
                        except:
                            config['reader'][setting] = value
                    elif device == 'rele' and setting in config['relay']:
                        try:
                            if setting in ['baud_rate', 'modulo_id']:
                                config['relay'][setting] = int(value)
                            else:
                                config['relay'][setting] = value
                        except:
                            config['relay'][setting] = value
            
            return jsonify({'success': True, **config})
            
        finally:
            conn.close()
            
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/devices/config/reader', methods=['POST'])
@require_auth()
@require_permission('all')
def api_save_reader_config():
    """Salva configurazione lettore nel database"""
    try:
        data = request.get_json()
        if not data.get('tipo') or not data.get('porta'):
            return jsonify({'success': False, 'error': 'Configurazione incompleta'}), 400

        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500

        try:
            cursor = conn.cursor()
            settings = {
                'dispositivi.lettore_cf.tipo': data['tipo'],
                'dispositivi.lettore_cf.porta': data['porta'],
                'dispositivi.lettore_cf.timeout': str(data.get('timeout', 30)),
                'dispositivi.lettore_cf.retry_tentativi': str(data.get('retry_tentativi', 3))
            }
            for key, value in settings.items():
                cursor.execute('''
                    INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                    VALUES (?, ?, CURRENT_TIMESTAMP)
                ''', (key, value))
            conn.commit()
            return jsonify({'success': True, 'message': 'Configurazione lettore salvata'})
        finally:
            conn.close()
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/devices/config/relay', methods=['POST'])
@require_auth()
@require_permission('all')
def api_save_relay_config():
    """Salva configurazione relè nel database"""
    try:
        data = request.get_json()
        if not data.get('porta') or not data.get('baud_rate'):
            return jsonify({'success': False, 'error': 'Configurazione incompleta'}), 400

        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500

        try:
            cursor = conn.cursor()
            settings = {
                'dispositivi.rele.porta': data['porta'],
                'dispositivi.rele.baud_rate': str(data['baud_rate']),
                'dispositivi.rele.modulo_id': str(data.get('modulo_id', 8))
            }
            for key, value in settings.items():
                cursor.execute('''
                    INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                    VALUES (?, ?, CURRENT_TIMESTAMP)
                ''', (key, value))
            # Salva mapping se presente
            if 'mapping' in data:
                import json
                cursor.execute('''
                    INSERT OR REPLACE INTO system_settings (key, value, updated_at)
                    VALUES (?, ?, CURRENT_TIMESTAMP)
                ''', ('dispositivi.rele.mapping', json.dumps(data['mapping'])))
            conn.commit()
            return jsonify({'success': True, 'message': 'Configurazione relè salvata'})
        finally:
            conn.close()
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/system/config')
@require_auth()
def api_get_system_config():
    """Restituisce tutte le configurazioni di sistema dal database"""
    try:
        conn = get_db_connection()
        if not conn:
            return jsonify({'success': False, 'error': 'Database non disponibile'}), 500

        try:
            cursor = conn.cursor()
            # Prendi tutte le chiavi di sistema, hardware, sicurezza, email
            cursor.execute("""
                SELECT key, value FROM system_settings
                WHERE key LIKE 'sistema.%'
                   OR key LIKE 'hardware.%'
                   OR key LIKE 'sicurezza.%'
                   OR key LIKE 'email.%'
            """)
            settings = cursor.fetchall()
            config = {}
            for key, value in settings:
                section, name = key.split('.', 1)
                if section not in config:
                    config[section] = {}
                config[section][name] = value
            return jsonify({'success': True, 'config': config})
        finally:
            conn.close()
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

BACKUP_DIR = os.path.join(project_root, 'backups')
if not os.path.exists(BACKUP_DIR):
    os.makedirs(BACKUP_DIR)

def get_db_connection():
    """Connessione database come database_manager.py"""
    try:
        # Crea la directory se non esiste
        db_dir = os.path.dirname(DB_PATH)
        if not os.path.exists(db_dir):
            os.makedirs(db_dir)
            
        # Crea il database se non esiste
        if not os.path.exists(DB_PATH):
            conn = sqlite3.connect(DB_PATH)
            conn.row_factory = sqlite3.Row
            print(f"Database creato in: {DB_PATH}")
            return conn
            
        conn = sqlite3.connect(DB_PATH)
        conn.row_factory = sqlite3.Row
        return conn
    except Exception as e:
        print(f"Errore connessione DB: {e}")
        return None

def ensure_system_settings_table():
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS system_settings (
                    key TEXT PRIMARY KEY,
                    value TEXT NOT NULL,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            conn.commit()
        finally:
            conn.close()

def ensure_eventi_sistema_table():
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS eventi_sistema (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    tipo_evento TEXT,
                    livello TEXT,
                    messaggio TEXT,
                    componente TEXT,
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            conn.commit()
        finally:
            conn.close()

# Ora puoi chiamarla!
config_manager = get_config_manager()
ensure_system_settings_table()
ensure_eventi_sistema_table()

# ===============================
# MAIN
# ===============================

if __name__ == '__main__':
    print("🌐 Avvio dashboard web modulare")
    print(f"📄 Database: {DB_PATH}")
    print("🔗 URL: http://0.0.0.0:5000")
    
    # Crea directory static se non esiste
    static_dir = os.path.join(os.path.dirname(__file__), 'static')
    if not os.path.exists(static_dir):
        os.makedirs(static_dir)
        print(f"📁 Creata directory static: {static_dir}")
    
    app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)

print("=== ENDPOINTS REGISTRATI ===")
for rule in app.url_map.iter_rules():
    print(rule)
print("============================")

def scheduled_backup():
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    backup_filename = f'access_{timestamp}.db'
    src = DB_PATH
    dst = os.path.join(BACKUP_DIR, backup_filename)
    shutil.copy2(src, dst)
    print(f"[SCHEDULER] Backup creato: {backup_filename}")

    # Retention
    conn = get_db_connection()
    retention = 7
    if conn:
        try:
            cursor = conn.cursor()
            cursor.execute("SELECT value FROM system_settings WHERE key='backup.retention'")
            row = cursor.fetchone()
            if row:
                retention = int(row[0])
        finally:
            conn.close()
    files = sorted(
        [os.path.join(BACKUP_DIR, f) for f in os.listdir(BACKUP_DIR) if os.path.isfile(os.path.join(BACKUP_DIR, f))],
        key=lambda x: os.path.getmtime(x)
    )
    to_delete = files[:-retention]
    for f in to_delete:
        os.remove(f)
        print(f"[SCHEDULER] Backup eliminato per retention: {os.path.basename(f)}")

# Scarica backup
@app.route('/api/backup/download/<filename>')
@require_auth()
@require_permission('all')
def api_backup_download(filename: str) -> FlaskResponse:
    return backup_module.download_backup(filename)

# Elimina backup
@app.route('/api/backup/delete/<filename>', methods=['DELETE'])
@require_auth()
@require_permission('all')
def api_backup_delete(filename: str) -> FlaskResponse:
    return backup_module.delete_backup(filename)

# Ripristina backup (sovrascrive access.db)
@app.route('/api/backup/restore/<filename>', methods=['POST'])
@require_auth()
@require_permission('all')
def api_backup_restore(filename: str) -> FlaskResponse:
    return backup_module.restore_backup(filename)

```

---

## File: __init__.py

**Percorso:** `core/__init__.py`
**Directory:** `core`
**Dimensione:** 0 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python

```

---

## File: config.py

**Percorso:** `core/config.py`
**Directory:** `core`
**Dimensione:** 12139 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/core/config.py
# Gestione configurazioni multi-ambiente

import os
import yaml
import logging
from pathlib import Path
from dataclasses import dataclass, field, asdict
from typing import Dict, Any, Optional
from datetime import datetime

logger = logging.getLogger(__name__)

@dataclass
class HardwareConfig:
    """Configurazioni hardware"""
    arduino_port: str = "/dev/ttyACM0"
    arduino_baudrate: int = 9600
    relay_port: str = "/dev/ttyUSB0"
    relay_baudrate: int = 19200
    card_reader_timeout: int = 10
    gate_open_duration: int = 5

@dataclass
class DatabaseConfig:
    """Configurazioni database"""
    path: str = "/opt/access_control/src/access.db"
    backup_interval: int = 86400  # 24 ore
    max_backups: int = 30
    vacuum_interval: int = 604800  # 7 giorni

@dataclass
class ServerConfig:
    """Configurazioni server centrale"""
    url: str = "https://server-centrale.example.com/api"
    username: str = "terminal_001"
    password: str = "changeme"
    sync_interval: int = 3600  # 1 ora
    timeout: int = 30
    retry_attempts: int = 3
    ssl_verify: bool = True

@dataclass
class SecurityConfig:
    """Configurazioni sicurezza"""
    encrypt_database: bool = True
    max_failed_attempts: int = 5
    lockout_duration: int = 300  # 5 minuti
    session_timeout: int = 1800  # 30 minuti
    audit_log: bool = True

@dataclass
class LoggingConfig:
    """Configurazioni logging"""
    level: str = "INFO"
    max_size: str = "10MB"
    backup_count: int = 5
    format: str = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    console_output: bool = True

@dataclass
class WebConfig:
    """Configurazioni interfaccia web"""
    host: str = "0.0.0.0"
    port: int = 5000
    debug: bool = False
    secret_key: str = "changeme-in-production"
    admin_user: str = "admin"
    admin_password: str = "changeme"

@dataclass
class SystemConfig:
    """Configurazione sistema completa"""
    environment: str = "production"
    terminal_id: str = "TERM-001"
    installation_date: str = ""
    version: str = "1.0.0"
    debug_mode: bool = False
    
    hardware: HardwareConfig = None
    database: DatabaseConfig = None
    server: ServerConfig = None
    security: SecurityConfig = None
    logging: LoggingConfig = None
    web: WebConfig = None
    
    def __post_init__(self):
        if self.hardware is None:
            self.hardware = HardwareConfig()
        if self.database is None:
            self.database = DatabaseConfig()
        if self.server is None:
            self.server = ServerConfig()
        if self.security is None:
            self.security = SecurityConfig()
        if self.logging is None:
            self.logging = LoggingConfig()
        if self.web is None:
            self.web = WebConfig()
        if not self.installation_date:
            self.installation_date = datetime.now().isoformat()

class ConfigManager:
    """Gestore configurazioni multi-ambiente"""
    
    def __init__(self, config_dir: str = "/opt/access_control/config"):
        self.config_dir = Path(config_dir)
        self.config: SystemConfig = SystemConfig()
        self.environment = os.getenv('ACCESS_CONTROL_ENV', 'production')
        
        # Percorsi file configurazione
        self.base_config_file = self.config_dir / "base.yml"
        self.env_config_file = self.config_dir / "environments" / f"{self.environment}.yml"
        self.local_config_file = self.config_dir / "local.yml"
        self.secrets_file = self.config_dir / ".secrets.yml"
        
        self.load_configuration()
    
    def load_configuration(self):
        """Carica configurazione da file multipli con precedenza"""
        try:
            # 1. Configurazione base
            if self.base_config_file.exists():
                self._merge_config(self._load_yaml(self.base_config_file))
            
            # 2. Configurazione ambiente specifico
            if self.env_config_file.exists():
                self._merge_config(self._load_yaml(self.env_config_file))
            
            # 3. Configurazione locale (override)
            if self.local_config_file.exists():
                self._merge_config(self._load_yaml(self.local_config_file))
            
            # 4. Secrets (non in version control)
            if self.secrets_file.exists():
                self._merge_config(self._load_yaml(self.secrets_file))
            
            # 5. Variabili ambiente (precedenza massima)
            self._load_from_environment()
            
            logger.info(f"Configurazione caricata per ambiente: {self.environment}")
            
        except Exception as e:
            logger.error(f"Errore caricamento configurazione: {e}")
            # Usa configurazione di default se caricamento fallisce
            self.config = SystemConfig()
    
    def _load_yaml(self, file_path: Path) -> Dict[str, Any]:
        """Carica file YAML"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                return yaml.safe_load(f) or {}
        except Exception as e:
            logger.warning(f"Impossibile caricare {file_path}: {e}")
            return {}
    
    def _merge_config(self, config_dict: Dict[str, Any]):
        """Merge configurazione nel sistema config"""
        if not config_dict:
            return
        
        # Update configurazioni specifiche
        if 'hardware' in config_dict:
            self._update_dataclass(self.config.hardware, config_dict['hardware'])
        
        if 'database' in config_dict:
            self._update_dataclass(self.config.database, config_dict['database'])
        
        if 'server' in config_dict:
            self._update_dataclass(self.config.server, config_dict['server'])
        
        if 'security' in config_dict:
            self._update_dataclass(self.config.security, config_dict['security'])
        
        if 'logging' in config_dict:
            self._update_dataclass(self.config.logging, config_dict['logging'])
        
        if 'web' in config_dict:
            self._update_dataclass(self.config.web, config_dict['web'])
        
        # Update configurazione sistema
        for key, value in config_dict.items():
            if hasattr(self.config, key) and key not in ['hardware', 'database', 'server', 'security', 'logging', 'web']:
                setattr(self.config, key, value)
    
    def _update_dataclass(self, target_obj, source_dict: Dict[str, Any]):
        """Aggiorna dataclass con valori da dizionario"""
        for key, value in source_dict.items():
            if hasattr(target_obj, key):
                setattr(target_obj, key, value)
    
    def _load_from_environment(self):
        """Carica configurazioni da variabili ambiente"""
        env_mappings = {
            'ACCESS_CONTROL_ENV': 'environment',
            'ACCESS_CONTROL_TERMINAL_ID': 'terminal_id',
            'ACCESS_CONTROL_DEBUG': 'debug_mode',
            'ACCESS_CONTROL_ARDUINO_PORT': 'hardware.arduino_port',
            'ACCESS_CONTROL_RELAY_PORT': 'hardware.relay_port',
            'ACCESS_CONTROL_DB_PATH': 'database.path',
            'ACCESS_CONTROL_SERVER_URL': 'server.url',
            'ACCESS_CONTROL_SERVER_USER': 'server.username',
            'ACCESS_CONTROL_SERVER_PASS': 'server.password',
            'ACCESS_CONTROL_WEB_PORT': 'web.port',
            'ACCESS_CONTROL_WEB_HOST': 'web.host',
            'ACCESS_CONTROL_SECRET_KEY': 'web.secret_key',
        }
        
        for env_var, config_path in env_mappings.items():
            value = os.getenv(env_var)
            if value is not None:
                self._set_nested_attr(config_path, value)
    
    def _set_nested_attr(self, path: str, value: str):
        """Imposta attributo nested usando dot notation"""
        parts = path.split('.')
        obj = self.config
        
        for part in parts[:-1]:
            obj = getattr(obj, part)
        
        # Conversione tipo automatica
        final_attr = parts[-1]
        if hasattr(obj, final_attr):
            current_value = getattr(obj, final_attr)
            if isinstance(current_value, bool):
                value = value.lower() in ('true', '1', 'yes', 'on')
            elif isinstance(current_value, int):
                value = int(value)
            elif isinstance(current_value, float):
                value = float(value)
            
            setattr(obj, final_attr, value)
    
    def save_configuration(self, file_path: Optional[Path] = None):
        """Salva configurazione su file"""
        if file_path is None:
            file_path = self.local_config_file
        
        try:
            # Crea directory se non esiste
            file_path.parent.mkdir(parents=True, exist_ok=True)
            
            # Converte in dizionario
            config_dict = asdict(self.config)
            
            # Salva in YAML
            with open(file_path, 'w', encoding='utf-8') as f:
                yaml.dump(config_dict, f, default_flow_style=False, indent=2)
            
            logger.info(f"Configurazione salvata in {file_path}")
            return True
        except Exception as e:
            logger.error(f"Errore salvataggio configurazione: {e}")
            return False
    
    def get_config(self) -> SystemConfig:
        """Restituisce configurazione corrente"""
        return self.config
    
    def set_config_value(self, path: str, value: Any):
        """Imposta valore configurazione usando dot notation"""
        try:
            self._set_nested_attr(path, value)
            return True
        except Exception as e:
            logger.error(f"Errore impostazione {path}: {e}")
            return False
    
    def validate_configuration(self) -> list:
        """Valida configurazione corrente"""
        errors = []
        
        # Validazione porte hardware
        if not self.config.hardware.arduino_port.startswith('/dev/'):
            errors.append(f"Porta Arduino non valida: {self.config.hardware.arduino_port}")
        
        if not self.config.hardware.relay_port.startswith('/dev/'):
            errors.append(f"Porta relay non valida: {self.config.hardware.relay_port}")
        
        # Validazione database path
        db_dir = Path(self.config.database.path).parent
        if not db_dir.exists():
            errors.append(f"Directory database non esiste: {db_dir}")
        
        # Validazione server URL
        if not self.config.server.url.startswith(('http://', 'https://')):
            errors.append("URL server deve iniziare con http:// o https://")
        
        # Validazione credenziali default
        if self.config.server.password == "changeme":
            errors.append("Password server deve essere cambiata")
        
        if self.config.web.secret_key == "changeme-in-production":
            errors.append("Secret key web deve essere cambiata")
        
        return errors
    
    def get_hardware_config(self) -> HardwareConfig:
        """Configurazione hardware"""
        return self.config.hardware
    
    def get_database_config(self) -> DatabaseConfig:
        """Configurazione database"""
        return self.config.database
    
    def get_server_config(self) -> ServerConfig:
        """Configurazione server"""
        return self.config.server
    
    def get_security_config(self) -> SecurityConfig:
        """Configurazione sicurezza"""
        return self.config.security
    
    def get_logging_config(self) -> LoggingConfig:
        """Configurazione logging"""
        return self.config.logging
    
    def get_web_config(self) -> WebConfig:
        """Configurazione web"""
        return self.config.web

# Singleton pattern
_config_manager = None

def get_config_manager() -> ConfigManager:
    """Restituisce istanza singleton ConfigManager"""
    global _config_manager
    if _config_manager is None:
        _config_manager = ConfigManager()
    return _config_manager

def get_config() -> SystemConfig:
    """Shortcut per ottenere configurazione sistema"""
    return get_config_manager().get_config()
```

---

## File: database_manager.py

**Percorso:** `database/database_manager.py`
**Directory:** `database`
**Dimensione:** 22305 bytes
**Ultima modifica:** 2025-07-19 14:26:00
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/database/database_manager.py
# Database manager per sistema controllo accessi

import sqlite3
import logging
import os
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, Optional, Tuple, List

logger = logging.getLogger(__name__)

class DatabaseManager:
    """Gestore database SQLite per sistema controllo accessi"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.ensure_database_exists()
        self.init_database()
        logger.info(f"🗄️ Database manager inizializzato: {db_path}")
    
    def ensure_database_exists(self):
        """Assicura che la directory del database esista"""
        db_dir = Path(self.db_path).parent
        db_dir.mkdir(parents=True, exist_ok=True)
    
    def init_database(self):
        """Inizializza database e tabelle"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                
                # Abilita foreign keys
                cursor.execute("PRAGMA foreign_keys = ON")
                
                # Tabella utenti autorizzati
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS utenti_autorizzati (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        codice_fiscale TEXT UNIQUE NOT NULL,
                        nome TEXT,
                        cognome TEXT,
                        email TEXT,
                        telefono TEXT,
                        reparto TEXT,
                        ruolo TEXT,
                        data_inserimento TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        data_aggiornamento TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        data_scadenza DATE,
                        attivo BOOLEAN DEFAULT 1,
                        note TEXT,
                        creato_da TEXT,
                        modificato_da TEXT
                    )
                ''')
                
                # Tabella log accessi
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS log_accessi (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        timestamp TIMESTAMP NOT NULL,
                        codice_fiscale TEXT NOT NULL,
                        autorizzato BOOLEAN NOT NULL,
                        durata_elaborazione REAL,
                        ip_client TEXT,
                        user_agent TEXT,
                        terminale_id TEXT,
                        errore TEXT,
                        metodo_lettura TEXT,
                        qualita_lettura INTEGER,
                        sincronizzato BOOLEAN DEFAULT 0,
                        data_sincronizzazione TIMESTAMP,
                        note TEXT
                    )
                ''')
                
                # Tabella configurazioni
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS configurazioni (
                        chiave TEXT PRIMARY KEY,
                        valore TEXT NOT NULL,
                        tipo TEXT DEFAULT 'string',
                        descrizione TEXT,
                        categoria TEXT,
                        modificabile BOOLEAN DEFAULT 1,
                        data_modifica TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        modificato_da TEXT
                    )
                ''')
                
                # Tabella eventi sistema
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS eventi_sistema (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        tipo_evento TEXT NOT NULL,
                        livello TEXT DEFAULT 'INFO',
                        messaggio TEXT NOT NULL,
                        dettagli TEXT,
                        componente TEXT,
                        risolto BOOLEAN DEFAULT 0
                    )
                ''')
                
                # Tabella statistiche giornaliere
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS statistiche (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        data DATE NOT NULL,
                        totale_accessi INTEGER DEFAULT 0,
                        accessi_autorizzati INTEGER DEFAULT 0,
                        accessi_negati INTEGER DEFAULT 0,
                        tempo_medio_elaborazione REAL,
                        uptime_sistema REAL,
                        errori_hardware INTEGER DEFAULT 0,
                        UNIQUE(data)
                    )
                ''')
                
                # Indici per performance
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_cf ON utenti_autorizzati(codice_fiscale)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_cf_attivo ON utenti_autorizzati(codice_fiscale, attivo)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_log_timestamp ON log_accessi(timestamp)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_log_sync ON log_accessi(sincronizzato)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_log_cf ON log_accessi(codice_fiscale)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_eventi_timestamp ON eventi_sistema(timestamp)')
                cursor.execute('CREATE INDEX IF NOT EXISTS idx_statistiche_data ON statistiche(data)')
                
                # Trigger per aggiornamento timestamp
                cursor.execute('''
                    CREATE TRIGGER IF NOT EXISTS update_utente_timestamp 
                    AFTER UPDATE ON utenti_autorizzati
                    FOR EACH ROW
                    BEGIN
                        UPDATE utenti_autorizzati 
                        SET data_aggiornamento = CURRENT_TIMESTAMP 
                        WHERE id = NEW.id;
                    END;
                ''')
                
                conn.commit()
                
                # Inserisci dati di test se database vuoto
                self._insert_test_data_if_empty(cursor)
                conn.commit()
                
                logger.info("✅ Database inizializzato correttamente")
                
        except Exception as e:
            logger.error(f"❌ Errore inizializzazione database: {e}")
            raise
    
    def _insert_test_data_if_empty(self, cursor):
        """Inserisce dati di test se il database è vuoto"""
        # Controlla se ci sono utenti
        cursor.execute("SELECT COUNT(*) FROM utenti_autorizzati")
        user_count = cursor.fetchone()[0]
        
        if user_count == 0:
            logger.info("📝 Inserimento dati di test...")
            
            # Utenti di test
            test_users = [
                {
                    'codice_fiscale': 'RSSMRA80A01H501Z',
                    'nome': 'Mario',
                    'cognome': 'Rossi',
                    'email': 'mario.rossi@test.com',
                    'reparto': 'Amministrazione',
                    'ruolo': 'Impiegato',
                    'note': 'Utente di test - Autorizzato'
                },
                {
                    'codice_fiscale': 'BNCGVN75L15F205X',
                    'nome': 'Giovanni',
                    'cognome': 'Bianchi',
                    'email': 'giovanni.bianchi@test.com',
                    'reparto': 'IT',
                    'ruolo': 'Tecnico',
                    'note': 'Utente di test - Autorizzato'
                },
                {
                    'codice_fiscale': 'VRDLCA85T45Z404Y',
                    'nome': 'Luca',
                    'cognome': 'Verdi',
                    'email': 'luca.verdi@test.com',
                    'reparto': 'Sicurezza',
                    'ruolo': 'Responsabile',
                    'note': 'Utente di test - Autorizzato'
                }
            ]
            
            for user in test_users:
                cursor.execute('''
                    INSERT INTO utenti_autorizzati 
                    (codice_fiscale, nome, cognome, email, reparto, ruolo, note, creato_da)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    user['codice_fiscale'],
                    user['nome'],
                    user['cognome'],
                    user['email'],
                    user['reparto'],
                    user['ruolo'],
                    user['note'],
                    'SYSTEM_INIT'
                ))
            
            # Configurazioni iniziali
            cursor.execute('''
                INSERT OR IGNORE INTO configurazioni (chiave, valore, descrizione, categoria)
                VALUES ('db_version', '1.0.0', 'Versione schema database', 'sistema')
            ''')
            
            cursor.execute('''
                INSERT OR IGNORE INTO configurazioni (chiave, valore, descrizione, categoria)
                VALUES ('installation_date', ?, 'Data installazione sistema', 'sistema')
            ''', (datetime.now().isoformat(),))
            
            logger.info(f"✅ Inseriti {len(test_users)} utenti di test")
    
    def health_check(self) -> bool:
        """Controlla salute del database"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                
                # Test connessione
                cursor.execute("SELECT 1")
                
                # Test integrità
                cursor.execute("PRAGMA integrity_check")
                result = cursor.fetchone()[0]
                
                if result != "ok":
                    logger.error(f"❌ Database integrity check failed: {result}")
                    return False
                
                # Test tabelle principali
                cursor.execute("SELECT COUNT(*) FROM utenti_autorizzati")
                user_count = cursor.fetchone()[0]
                
                logger.debug(f"Database OK - {user_count} utenti autorizzati")
                return True
                
        except Exception as e:
            logger.error(f"❌ Database health check failed: {e}")
            return False
    
    def verify_access(self, codice_fiscale: str) -> Tuple[bool, Optional[Dict[str, Any]]]:
        """Verifica se un codice fiscale è autorizzato"""
        try:
            from api.modules.configurazione_accessi import verifica_orario, verifica_limite_mensile
            
            # Verifica orario prima di tutto
            if not verifica_orario():
                logger.warning(f"Accesso negato per {codice_fiscale}: fuori orario consentito")
                return False, None
                
            # Verifica limite mensile
            if not verifica_limite_mensile(codice_fiscale):
                logger.warning(f"Accesso negato per {codice_fiscale}: limite mensile superato")
                return False, None
            
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    SELECT id, nome, cognome, email, reparto, ruolo, note
                    FROM utenti_autorizzati 
                    WHERE codice_fiscale = ? AND attivo = 1
                    AND (data_scadenza IS NULL OR data_scadenza > date('now'))
                ''', (codice_fiscale.upper(),))
                
                result = cursor.fetchone()
                
                if result:
                    user_data = {
                        'id': result[0],
                        'nome': result[1],
                        'cognome': result[2],
                        'email': result[3],
                        'reparto': result[4],
                        'ruolo': result[5],
                        'note': result[6]
                    }
                    logger.debug(f"✅ Accesso autorizzato per {user_data['nome']} {user_data['cognome']}")
                    return True, user_data
                else:
                    logger.debug(f"❌ Accesso negato per {codice_fiscale}")
                    return False, None
                    
        except Exception as e:
            logger.error(f"❌ Errore verifica accesso: {e}")
            return False, None
    
    def log_access(self, codice_fiscale: str, authorized: bool, processing_time: float = None, 
                   user_data: Dict = None, error: str = None, terminal_id: str = None):
        """Registra tentativo di accesso"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    INSERT INTO log_accessi 
                    (timestamp, codice_fiscale, autorizzato, durata_elaborazione, errore, terminale_id)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (
                    datetime.now(),
                    codice_fiscale.upper(),
                    authorized,
                    processing_time,
                    error,
                    terminal_id
                ))
                conn.commit()
                
                # Log dettagliato
                status = "AUTORIZZATO" if authorized else "NEGATO"
                user_info = ""
                if user_data:
                    user_info = f" - {user_data.get('nome', '')} {user_data.get('cognome', '')}"
                
                logger.info(f"📝 Accesso {status}: {codice_fiscale}{user_info}")
                
        except Exception as e:
            logger.error(f"❌ Errore registrazione accesso: {e}")
    
    def get_user_list(self, active_only: bool = True) -> List[Dict[str, Any]]:
        """Ottiene lista utenti autorizzati"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                
                query = '''
                    SELECT codice_fiscale, nome, cognome, email, reparto, ruolo, 
                           data_inserimento, data_scadenza, attivo, note
                    FROM utenti_autorizzati
                '''
                
                if active_only:
                    query += " WHERE attivo = 1"
                
                query += " ORDER BY cognome, nome"
                
                cursor.execute(query)
                results = cursor.fetchall()
                
                users = []
                for row in results:
                    users.append({
                        'codice_fiscale': row[0],
                        'nome': row[1],
                        'cognome': row[2],
                        'email': row[3],
                        'reparto': row[4],
                        'ruolo': row[5],
                        'data_inserimento': row[6],
                        'data_scadenza': row[7],
                        'attivo': bool(row[8]),
                        'note': row[9]
                    })
                
                return users
                
        except Exception as e:
            logger.error(f"❌ Errore recupero lista utenti: {e}")
            return []
    
    def add_user(self, codice_fiscale: str, nome: str, cognome: str, 
                 email: str = None, reparto: str = None, ruolo: str = None,
                 data_scadenza: str = None, note: str = None, created_by: str = None) -> bool:
        """Aggiunge nuovo utente autorizzato"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    INSERT INTO utenti_autorizzati 
                    (codice_fiscale, nome, cognome, email, reparto, ruolo, data_scadenza, note, creato_da)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    codice_fiscale.upper(),
                    nome,
                    cognome,
                    email,
                    reparto,
                    ruolo,
                    data_scadenza,
                    note,
                    created_by
                ))
                conn.commit()
                
                logger.info(f"✅ Utente aggiunto: {nome} {cognome} ({codice_fiscale})")
                return True
                
        except sqlite3.IntegrityError:
            logger.warning(f"⚠️ Utente già esistente: {codice_fiscale}")
            return False
        except Exception as e:
            logger.error(f"❌ Errore aggiunta utente: {e}")
            return False
    
    def remove_user(self, codice_fiscale: str, soft_delete: bool = True) -> bool:
        """Rimuove utente (soft delete o hard delete)"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                
                if soft_delete:
                    # Soft delete - disattiva utente
                    cursor.execute('''
                        UPDATE utenti_autorizzati 
                        SET attivo = 0, data_aggiornamento = CURRENT_TIMESTAMP
                        WHERE codice_fiscale = ?
                    ''', (codice_fiscale.upper(),))
                    action = "disattivato"
                else:
                    # Hard delete - elimina record
                    cursor.execute('''
                        DELETE FROM utenti_autorizzati 
                        WHERE codice_fiscale = ?
                    ''', (codice_fiscale.upper(),))
                    action = "eliminato"
                
                if cursor.rowcount > 0:
                    conn.commit()
                    logger.info(f"✅ Utente {action}: {codice_fiscale}")
                    return True
                else:
                    logger.warning(f"⚠️ Utente non trovato: {codice_fiscale}")
                    return False
                    
        except Exception as e:
            logger.error(f"❌ Errore rimozione utente: {e}")
            return False
    
    def get_access_logs(self, limit: int = 100, codice_fiscale: str = None) -> List[Dict[str, Any]]:
        """Ottiene log accessi"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                
                query = '''
                    SELECT timestamp, codice_fiscale, autorizzato, durata_elaborazione, 
                           errore, terminale_id
                    FROM log_accessi
                '''
                params = []
                
                if codice_fiscale:
                    query += " WHERE codice_fiscale = ?"
                    params.append(codice_fiscale.upper())
                
                query += " ORDER BY timestamp DESC LIMIT ?"
                params.append(limit)
                
                cursor.execute(query, params)
                results = cursor.fetchall()
                
                logs = []
                for row in results:
                    logs.append({
                        'timestamp': row[0],
                        'codice_fiscale': row[1],
                        'autorizzato': bool(row[2]),
                        'durata_elaborazione': row[3],
                        'errore': row[4],
                        'terminale_id': row[5]
                    })
                
                return logs
                
        except Exception as e:
            logger.error(f"❌ Errore recupero log: {e}")
            return []
    
    def get_statistics(self, days: int = 30) -> Dict[str, Any]:
        """Ottiene statistiche accessi"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                
                # Statistiche ultimi N giorni
                cursor.execute('''
                    SELECT 
                        COUNT(*) as totale,
                        SUM(CASE WHEN autorizzato = 1 THEN 1 ELSE 0 END) as autorizzati,
                        SUM(CASE WHEN autorizzato = 0 THEN 1 ELSE 0 END) as negati,
                        AVG(durata_elaborazione) as tempo_medio
                    FROM log_accessi 
                    WHERE timestamp >= datetime('now', '-{} days')
                '''.format(days))
                
                result = cursor.fetchone()
                
                stats = {
                    'periodo_giorni': days,
                    'totale_accessi': result[0] or 0,
                    'accessi_autorizzati': result[1] or 0,
                    'accessi_negati': result[2] or 0,
                    'tempo_medio_elaborazione': result[3] or 0,
                    'tasso_successo': 0
                }
                
                if stats['totale_accessi'] > 0:
                    stats['tasso_successo'] = (stats['accessi_autorizzati'] / stats['totale_accessi']) * 100
                
                return stats
                
        except Exception as e:
            logger.error(f"❌ Errore calcolo statistiche: {e}")
            return {}
    
    def backup_database(self, backup_path: str = None) -> bool:
        """Crea backup del database"""
        try:
            if backup_path is None:
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                backup_dir = Path(self.db_path).parent / "backups"
                backup_dir.mkdir(exist_ok=True)
                backup_path = backup_dir / f"access_backup_{timestamp}.db"
            
            # Backup usando SQLite VACUUM INTO
            with sqlite3.connect(self.db_path) as conn:
                conn.execute(f"VACUUM INTO '{backup_path}'")
            
            logger.info(f"✅ Backup creato: {backup_path}")
            return True
            
        except Exception as e:
            logger.error(f"❌ Errore backup database: {e}")
            return False
    
    def close(self):
        """Chiude connessioni database"""
        # SQLite non richiede chiusura esplicita con context manager
        logger.debug("Database manager chiuso")

```

---

## File: database_schema.sql

**Percorso:** `database_schema.sql`
**Directory:** `.`
**Dimensione:** 7729 bytes
**Ultima modifica:** 2025-07-22 07:40:42
**Permessi:** 664

### Contenuto:

```sql
CREATE TABLE IF NOT EXISTS "utenti_autorizzati_backup" (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        codice_fiscale TEXT UNIQUE NOT NULL,
                        nome TEXT,
                        cognome TEXT,
                        email TEXT,
                        telefono TEXT,
                        reparto TEXT,
                        ruolo TEXT,
                        data_inserimento TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        data_aggiornamento TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        data_scadenza DATE,
                        attivo BOOLEAN DEFAULT 1,
                        note TEXT,
                        creato_da TEXT,
                        modificato_da TEXT
                    );
CREATE TABLE sqlite_sequence(name,seq);
CREATE TABLE log_accessi (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        timestamp TIMESTAMP NOT NULL,
                        codice_fiscale TEXT NOT NULL,
                        autorizzato BOOLEAN NOT NULL,
                        durata_elaborazione REAL,
                        ip_client TEXT,
                        user_agent TEXT,
                        terminale_id TEXT,
                        errore TEXT,
                        metodo_lettura TEXT,
                        qualita_lettura INTEGER,
                        sincronizzato BOOLEAN DEFAULT 0,
                        data_sincronizzazione TIMESTAMP,
                        note TEXT
                    , tipo_accesso TEXT);
CREATE TABLE configurazioni (
                        chiave TEXT PRIMARY KEY,
                        valore TEXT NOT NULL,
                        tipo TEXT DEFAULT 'string',
                        descrizione TEXT,
                        categoria TEXT,
                        modificabile BOOLEAN DEFAULT 1,
                        data_modifica TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        modificato_da TEXT
                    );
CREATE TABLE eventi_sistema (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        tipo_evento TEXT NOT NULL,
                        livello TEXT DEFAULT 'INFO',
                        messaggio TEXT NOT NULL,
                        dettagli TEXT,
                        componente TEXT,
                        risolto BOOLEAN DEFAULT 0
                    );
CREATE TABLE statistiche (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        data DATE NOT NULL,
                        totale_accessi INTEGER DEFAULT 0,
                        accessi_autorizzati INTEGER DEFAULT 0,
                        accessi_negati INTEGER DEFAULT 0,
                        tempo_medio_elaborazione REAL,
                        uptime_sistema REAL,
                        errori_hardware INTEGER DEFAULT 0,
                        UNIQUE(data)
                    );
CREATE INDEX idx_cf ON "utenti_autorizzati_backup"(codice_fiscale);
CREATE INDEX idx_cf_attivo ON "utenti_autorizzati_backup"(codice_fiscale, attivo);
CREATE INDEX idx_log_timestamp ON log_accessi(timestamp);
CREATE INDEX idx_log_sync ON log_accessi(sincronizzato);
CREATE INDEX idx_log_cf ON log_accessi(codice_fiscale);
CREATE INDEX idx_eventi_timestamp ON eventi_sistema(timestamp);
CREATE INDEX idx_statistiche_data ON statistiche(data);
CREATE TRIGGER update_utente_timestamp 
                    AFTER UPDATE ON "utenti_autorizzati_backup"
                    FOR EACH ROW
                    BEGIN
                        UPDATE "utenti_autorizzati_backup" 
                        SET data_aggiornamento = CURRENT_TIMESTAMP 
                        WHERE id = NEW.id;
                    END;
CREATE VIEW authorized_people AS 
SELECT 
    codice_fiscale,
    nome,
    cognome,
    nome || ' ' || cognome as name,
    email,
    telefono as phone,
    attivo as active,
    data_inserimento as created_at
FROM "utenti_autorizzati_backup"
/* authorized_people(codice_fiscale,nome,cognome,name,email,phone,active,created_at) */;
CREATE VIEW access_log AS
SELECT 
    id,
    timestamp,
    codice_fiscale,
    autorizzato as authorized,
    durata_elaborazione as processing_time,
    errore as error_message,
    terminale_id as terminal_id
FROM log_accessi
/* access_log(id,timestamp,codice_fiscale,authorized,processing_time,error_message,terminal_id) */;
CREATE TABLE system_settings (
                    key TEXT PRIMARY KEY,
                    value TEXT NOT NULL,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
CREATE TABLE IF NOT EXISTS "utenti_sistema" (username TEXT PRIMARY KEY, password TEXT NOT NULL, role TEXT NOT NULL, attivo INTEGER DEFAULT 1, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, created_by TEXT, modified_at TIMESTAMP, modified_by TEXT, last_login TIMESTAMP);
CREATE TABLE configurazione_accessi (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  ora_apertura TIME NOT NULL,
  ora_chiusura TIME NOT NULL,
  max_ingressi_mensili INTEGER NOT NULL DEFAULT 10,
  modificato_da TEXT,
  data_modifica TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE orari_settimanali (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    giorno INTEGER NOT NULL CHECK (giorno BETWEEN 0 AND 6),
    mattina_apertura TIME,
    mattina_chiusura TIME,
    pomeriggio_apertura TIME,
    pomeriggio_chiusura TIME,
    isola_aperta BOOLEAN DEFAULT 1,
    modificato_da TEXT,
    data_modifica TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(giorno)
);
CREATE TABLE limiti_utenti (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    codice_fiscale TEXT NOT NULL,
    max_ingressi_mensili INTEGER NOT NULL DEFAULT 10,
    modificato_da TEXT,
    data_modifica TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(codice_fiscale)
);
CREATE TABLE conteggio_ingressi_mensili (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    codice_fiscale TEXT NOT NULL,
    mese INTEGER NOT NULL,
    anno INTEGER NOT NULL,
    numero_ingressi INTEGER DEFAULT 0,
    ultimo_ingresso TIMESTAMP,
    UNIQUE(codice_fiscale, mese, anno)
);
CREATE TABLE conteggio_ingressi_mensili_archive (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    codice_fiscale TEXT NOT NULL,
    mese INTEGER NOT NULL,
    anno INTEGER NOT NULL,
    numero_ingressi INTEGER,
    ultimo_ingresso TIMESTAMP,
    data_archiviazione TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE orari_accesso (
                giorno TEXT PRIMARY KEY,
                aperto BOOLEAN DEFAULT true,
                mattina_inizio TIME,
                mattina_fine TIME,
                pomeriggio_inizio TIME,
                pomeriggio_fine TIME,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_by TEXT
            );
CREATE TABLE limiti_accesso (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                max_ingressi_mensili INTEGER DEFAULT 3,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_by TEXT
            );
CREATE TABLE log_forzature (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                tipo TEXT NOT NULL,
                utente TEXT NOT NULL,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                dettagli TEXT
            );
CREATE TABLE IF NOT EXISTS "utenti_autorizzati" (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    codice_fiscale TEXT UNIQUE NOT NULL,
    nome TEXT,
    data_inserimento TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_aggiornamento TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    attivo BOOLEAN DEFAULT 1,
    note TEXT,
    creato_da TEXT,
    modificato_da TEXT
);

```

---

## File: LoadCrt288lib.c

**Percorso:** `drivers/288K/288K-linux-sample/288K/LoadCrt288lib.c`
**Directory:** `drivers/288K/288K-linux-sample/288K`
**Dimensione:** 11580 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```c
#include "LoadCrt288lib.h"

static void *  hModule  = NULL;
static bool returnValue = false;

Crt288_drv g_crt288_drv;

bool LoadMyLib(const char lpDllPath[], char ErrorInfo[])
{
	//¶¨Òå±äÁ¿
	returnValue = false;
	//ÅÐ¶Ï²ÎÊý
	if(ErrorInfo == NULL)
	{
		goto ExitLine;
	}
	//¼ÓÔØ¶¯Ì¬¿â
	if(hModule)
	{
		returnValue = true;
		goto ExitLine;
	}

	hModule = dlopen(lpDllPath, RTLD_LAZY);
	if(hModule == NULL)
	{
		sprintf(ErrorInfo, "¼ÓÔØ´«Èë:%sÊ§°Ü!",lpDllPath);
		//¼ÓÔØ´«ÈëÂ·¾¶Ê§°Ü£¬ÔÙ¼ÓÔØÒ»´Îµ±Ç°Â·¾¶Ä¬ÈÏDLL
		hModule = dlopen("./crt_288x_ur.so", RTLD_LAZY);
		if(hModule == NULL)
		{
			sprintf(ErrorInfo, "%s--Ä¬ÈÏÂ·¾¶¼ÓÔØÒ²Ê§°Ü!", ErrorInfo);
			goto ExitLine;
		}
	}

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_OpenConnection
	g_crt288_drv.CRT288x_OpenConnection = (pCRT288x_OpenConnection)dlsym(hModule, "CRT288x_OpenConnection");
	if(!g_crt288_drv.CRT288x_OpenConnection)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_OpenConnection'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_CloseConnection
	g_crt288_drv.CRT288x_CloseConnection = (pCRT288x_CloseConnection)dlsym(hModule, "CRT288x_CloseConnection");
	if(!g_crt288_drv.CRT288x_CloseConnection)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_CloseConnection'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_ExeCommand
	g_crt288_drv.CRT288x_ExeCommand = (pCRT288x_ExeCommand)dlsym(hModule, "CRT288x_ExeCommand");
	if(!g_crt288_drv.CRT288x_ExeCommand)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_ExeCommand'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_InitDev
	g_crt288_drv.CRT288x_InitDev = (pCRT288x_InitDev)dlsym(hModule, "CRT288x_InitDev");
	if(!g_crt288_drv.CRT288x_InitDev)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_InitDev'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_GetCardStatus
	g_crt288_drv.CRT288x_GetCardStatus = (pCRT288x_GetCardStatus)dlsym(hModule, "CRT288x_GetCardStatus");
	if(!g_crt288_drv.CRT288x_GetCardStatus)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_GetCardStatus'Ê§°Ü!");
		goto ExitLine;
	}

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_GetLockStatus
	g_crt288_drv.CRT288x_GetLockStatus = (pCRT288x_GetLockStatus)dlsym(hModule, "CRT288x_GetLockStatus");
	if(!g_crt288_drv.CRT288x_GetLockStatus)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_GetLockStatus'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_LockedProcess
	g_crt288_drv.CRT288x_LockedProcess = (pCRT288x_LockedProcess)dlsym(hModule, "CRT288x_LockedProcess");
	if(!g_crt288_drv.CRT288x_LockedProcess)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_LockedProcess'Ê§°Ü!");
		goto ExitLine;
	}

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_LEDProcess
	g_crt288_drv.CRT288x_LEDProcess = (pCRT288x_LEDProcess)dlsym(hModule, "CRT288x_LEDProcess");
	if(!g_crt288_drv.CRT288x_LEDProcess)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_LEDProcess'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_SetLEDFlashTime
	g_crt288_drv.CRT288x_SetLEDFlashTime = (pCRT288x_SetLEDFlashTime)dlsym(hModule, "CRT288x_SetLEDFlashTime");
	if(!g_crt288_drv.CRT288x_SetLEDFlashTime)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SetLEDFlashTime'Ê§°Ü!");
		goto ExitLine;
	}
	
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_SetReaderMagType
	g_crt288_drv.CRT288x_SetReaderMagType = (pCRT288x_SetReaderMagType)dlsym(hModule, "CRT288x_SetReaderMagType");
	if(!g_crt288_drv.CRT288x_SetReaderMagType)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SetReaderMagType'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_ReadTrack
	g_crt288_drv.CRT288x_ReadTrack = (pCRT288x_ReadTrack)dlsym(hModule, "CRT288x_ReadTrack");
	if(!g_crt288_drv.CRT288x_ReadTrack)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_ReadTrack'Ê§°Ü!");
		goto ExitLine;
	}
		
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_ReadAllTracks
	g_crt288_drv.CRT288x_ReadAllTracks = (pCRT288x_ReadAllTracks)dlsym(hModule, "CRT288x_ReadAllTracks");
	if(!g_crt288_drv.CRT288x_ReadAllTracks)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_ReadAllTracks'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_ClearTrackData
	g_crt288_drv.CRT288x_ClearTrackData = (pCRT288x_ClearTrackData)dlsym(hModule, "CRT288x_ClearTrackData");
	if(!g_crt288_drv.CRT288x_ClearTrackData)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_ClearTrackData'Ê§°Ü!");
		goto ExitLine;
	}

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_GetICType
	g_crt288_drv.CRT288x_GetICType = (pCRT288x_GetICType)dlsym(hModule, "CRT288x_GetICType");
	if(!g_crt288_drv.CRT288x_GetICType)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_GetICType'Ê§°Ü!");
		goto ExitLine;
	}

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_GetRFType
	g_crt288_drv.CRT288x_GetRFType = (pCRT288x_GetRFType)dlsym(hModule, "CRT288x_GetRFType");
	if(!g_crt288_drv.CRT288x_GetRFType)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_GetRFType'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_ChipPower
	g_crt288_drv.CRT288x_ChipPower = (pCRT288x_ChipPower)dlsym(hModule, "CRT288x_ChipPower");
	if(!g_crt288_drv.CRT288x_ChipPower)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_ChipPower'Ê§°Ü!");
		goto ExitLine;
	}

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_ChipIO
	g_crt288_drv.CRT288x_ChipIO = (pCRT288x_ChipIO)dlsym(hModule, "CRT288x_ChipIO");
	if(!g_crt288_drv.CRT288x_ChipIO)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_ChipIO'Ê§°Ü!");
		goto ExitLine;
	}

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_GetCardActiveStatus
	g_crt288_drv.CRT288x_GetCardActiveStatus = (pCRT288x_GetCardActiveStatus)dlsym(hModule, "CRT288x_GetCardActiveStatus");
	if(!g_crt288_drv.CRT288x_GetCardActiveStatus)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_GetCardActiveStatus'Ê§°Ü!");
		goto ExitLine;
	}
	
	//******************************************************************************************************************
	//¼ÓÔØCRT288x_SAMSlotChange
	g_crt288_drv.CRT288x_SAMSlotChange = (pCRT288x_SAMSlotChange)dlsym(hModule, "CRT288x_SAMSlotChange");
	if(!g_crt288_drv.CRT288x_SAMSlotChange)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SAMSlotChange'Ê§°Ü!");
		goto ExitLine;
	}	

	//******************************************************************************************************************
	//¼ÓÔØCRT288x_SetVcc
	g_crt288_drv.CRT288x_SetVcc = (pCRT288x_SetVcc)dlsym(hModule, "CRT288x_SetVcc");
	if(!g_crt288_drv.CRT288x_SetVcc)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SetVcc'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288x_SL4442CheckPasswd
	g_crt288_drv.CRT288x_SL4442CheckPasswd = (pCRT288x_SL4442CheckPasswd)dlsym(hModule, "CRT288x_SL4442CheckPasswd");
	if(!g_crt288_drv.CRT288x_SL4442CheckPasswd)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SL4442CheckPasswd'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288x_SL4442Process
	g_crt288_drv.CRT288x_SL4442Process = (pCRT288x_SL4442Process)dlsym(hModule, "CRT288x_SL4442Process");
	if(!g_crt288_drv.CRT288x_SL4442Process)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SL4442Process'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288x_SL4428CheckPasswd
	g_crt288_drv.CRT288x_SL4428CheckPasswd = (pCRT288x_SL4428CheckPasswd)dlsym(hModule, "CRT288x_SL4428CheckPasswd");
	if(!g_crt288_drv.CRT288x_SL4428CheckPasswd)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SL4428CheckPasswd'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288x_SL4428Process
	g_crt288_drv.CRT288x_SL4428Process = (pCRT288x_SL4428Process)dlsym(hModule, "CRT288x_SL4428Process");
	if(!g_crt288_drv.CRT288x_SL4428Process)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_SL4428Process'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288x_24CxProcess
	g_crt288_drv.CRT288x_24CxProcess = (pCRT288x_24CxProcess)dlsym(hModule, "CRT288x_24CxProcess");
	if(!g_crt288_drv.CRT288x_24CxProcess)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_24CxProcess'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288x_MifareKeyProcess
	g_crt288_drv.CRT288x_MifareKeyProcess = (pCRT288x_MifareKeyProcess)dlsym(hModule, "CRT288x_MifareKeyProcess");
	if(!g_crt288_drv.CRT288x_MifareKeyProcess)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_MifareKeyProcess'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288x_MifareCardProcess
	g_crt288_drv.CRT288x_MifareCardProcess = (pCRT288x_MifareCardProcess)dlsym(hModule, "CRT288x_MifareCardProcess");
	if(!g_crt288_drv.CRT288x_MifareCardProcess)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288x_MifareCardProcess'Ê§°Ü!");
		goto ExitLine;
	}

//******************************************************************************************************************
	//¼ÓÔØCRT288C_GetHidCardNums
	g_crt288_drv.CRT288C_GetHidCardNums = (pCRT288C_GetHidCardNums)dlsym(hModule, "CRT288C_GetHidCardNums");
	if(!g_crt288_drv.CRT288C_GetHidCardNums)
	{
		sprintf(ErrorInfo, "¼ÓÔØ'CRT288C_GetHidCardNums'Ê§°Ü!");
		goto ExitLine;
	}


	
	returnValue = true;

ExitLine:
	if(!returnValue && hModule){
		dlclose(hModule);
		hModule = NULL;
	}
	return returnValue;
}



int UnLoadMyLib()
{
	if(hModule){
		dlclose(hModule);
	}
	hModule = NULL;
	
	return 0;
}

```

---

## File: LoadCrt288lib.h

**Percorso:** `drivers/288K/288K-linux-sample/288K/LoadCrt288lib.h`
**Directory:** `drivers/288K/288K-linux-sample/288K`
**Dimensione:** 19578 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```c
#ifndef  __LOAD_CRT288_LIB_H__
#define  __LOAD_CRT288_LIB_H__

#include <stdio.h>       //±ê×¼ÊäÈëÊä³ö¶¨Òå
#include <string.h>
#include <stdlib.h>      //±ê×¼º¯Êý¿â¶¨Òå
#include <unistd.h>      //Unix±ê×¼º¯Êý¶¨Òå
#include <sys/types.h>
#include <sys/stat.h>  
#include <fcntl.h>       //ÎÄ¼þ¿ØÖÆ¶¨Òå
#include <termios.h>     //PPSIXÖÕ¶Ë¿ØÖÆ¶¨Òå
#include <errno.h>       //´íÎóºÅ¶¨Òå
#include <stdbool.h>

#include <dlfcn.h>

#define BYTE unsigned char
#define WORD unsigned short

//Í¨Ñ¶Ð­Òé
#define ENQ  0x05
#define ACK  0x06
#define NAK  0x15
#define EOT  0x04
#define CAN  0x18
#define STX  0xF2
#define ETX  0x03
#define US   0x1F

//´íÎóÂë
#define CRT_ERRCOUNT                 -200
#define CRT_ERR_CMD                  (CRT_ERRCOUNT-1) //ÃüÁî×Ö´íÎó
#define CRT_ERR_CMDPARAM             (CRT_ERRCOUNT-2) //ÃüÁî²ÎÊý´íÎó
#define CRT_ERR_CMDDENIAL            (CRT_ERRCOUNT-3) //ÃüÁî²»ÄÜ±»Ö´ÐÐ
#define CRT_ERR_DEVNOTSUP            (CRT_ERRCOUNT-4) //Ó²¼þ²»Ö§³Ö
#define CRT_ERR_CMDDATA              (CRT_ERRCOUNT-5) //ÃüÁîÊý¾Ý´íÎó
#define CRT_ERR_LOCKCARD             (CRT_ERRCOUNT-11) //Ëø¿¨¹³²Ù×÷Ê§°Ü
#define CRT_ERR_EEPROM               (CRT_ERRCOUNT-15) //EEPROM error
#define CRT_ERR_TRACKCHECK           (CRT_ERRCOUNT-20) //¶Á´Å¿¨´í£¨Ð£Ñé´í£©
#define CRT_ERR_READTRACK            (CRT_ERRCOUNT-21) //¶Á´Å¿¨´í
#define CRT_ERR_POWERDOWN            (CRT_ERRCOUNT-30) //¿¨»úµôµç£¨Power down£©
#define CRT_ERR_ICPROCESS            (CRT_ERRCOUNT-41) //IC¿¨Ä£¿é²Ù×÷Ê§°Ü
#define CRT_ERR_ICPOWERSHORT         (CRT_ERRCOUNT-60) //IC¿¨µçÔ´¶ÌÂ·
#define CRT_ERR_ICACTIVATIONFAIL     (CRT_ERRCOUNT-61) //IC¿¨¼¤»îÊ§°Ü
#define CRT_ERR_ICDENIAL             (CRT_ERRCOUNT-62) //IC¿¨²»Ö§³Öµ±Ç°ÃüÁî
#define CRT_ERR_ICNOTRESPOND         (CRT_ERRCOUNT-63) //IC¿¨Í¨Ñ¶³ö´í
#define CRT_ERR_ICNOTRESPOND_OTHER   (CRT_ERRCOUNT-64) //IC¿¨Í¨Ñ¶³ö´í(ÆäËû)
#define CRT_ERR_ICNOTACTIVATION      (CRT_ERRCOUNT-65) //IC¿¨Î´¼¤»î
#define CRT_ERR_ICNOTSUP             (CRT_ERRCOUNT-66) //¿¨»ú²»Ö§³ÖÕâÖÖIC¿¨
#define CRT_ERR_ICEMV                (CRT_ERRCOUNT-66) //²»Ö§³ÖEMVÄ£Ê½
#define CRT_ERR_COMMTIMEOUT	         (CRT_ERRCOUNT-80) //Í¨Ñ¶Ê§°Ü³¬Ê±
#define CRT_ERR_CANCEL	             (CRT_ERRCOUNT-84) //ÃüÁîÈ¡Ïû
#define CRT_ERR_PWDPROCESS	         (CRT_ERRCOUNT-90) //Ð£ÑéÃÜÂë²Ù×÷Ê§°Ü
#define CRT_ERR_PWDCHECK	         (CRT_ERRCOUNT-91) //ÃÜÂëÐ£ÑéÊ§°Ü
#define CRT_ERR_PWDSCRAP	         (CRT_ERRCOUNT-92) //ÃÜÂëÐ£ÑéÊ§°Ü£¬¿¨ËøËÀ
#define CRT_ERR_PWDADDROVERFLOW	     (CRT_ERRCOUNT-93) //²Ù×÷µØÖ·Òç³ö
#define CRT_ERR_PWDLENOVERFLOW	     (CRT_ERRCOUNT-94) //²Ù×÷³¤¶ÈÒç³ö
#define CRT_ERR_PWDPMERR	         (CRT_ERRCOUNT-95) //PM ´íÎó
#define CRT_ERR_PWDCMERR	         (CRT_ERRCOUNT-96) //CM ´íÎó
#define CRT_ERR_UNKNOWN              (CRT_ERRCOUNT-99) //Î´Öª´íÎó

//´ò¿ªÉè±¸
#define CRT_OPEN_TYPEUSB             0 //USB¿Ú·½Ê½´ò¿ªÉè±¸
#define CRT_OPEN_TYPERS232           1 //RS232¿Ú·½Ê½´ò¿ªÉè±¸

//³õÊ¼»¯
#define CRT_INIT_NOTUNLOCK          0 //³õÊ¼»¯ÎÞ¶¯×÷
#define CRT_INIT_UNLOCK             1 //³õÊ¼»¯½âËø


//¿¨×´Ì¬
#define CRT_CARDST_NOCARD             1 //ÎÞ¿¨
#define CRT_CARDST_INDOOR             2 //¿¨¿Ú
#define CRT_CARDST_INSIDE             3 //¿¨ÄÚ
#define CRT_CARDST_UNKNOW             9 //Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª

//Ëø¿¨×´Ì¬
#define CRT_LOCKCARD_NOTLOCK            1 //Î´Ëø¿¨
#define CRT_LOCKCARD_LOCKED             2 //ÒÑËø¿¨
#define CRT_LOCKCARD_UNKNOW             9 //Éè±¸²»ÔÚÏß,Ëø¿¨×´Ì¬Î´Öª

//¶Á¿¨Æ÷¶¯×÷
#define CRT_RDACTION_NOACTION           0 //ÎÞ¶¯×÷
#define CRT_RDACTION_UNLOCK             1 //½âËø
#define CRT_RDACTION_LOCKED             2 //Ëø¿¨
#define CRT_RDACTION_AUTOLOCKED         3 //ÓÐ¿¨×Ô¶¯Ëø¿¨
#define CRT_RDACTION_NOTAUTOLOCK        4 //ÓÐ¿¨²»×Ô¶¯Ëø¿¨

//²Ù×÷Ö¸Ê¾µÆ
#define  CRT_LED_RED                    0 //²Ù×÷ºìÉ«Ö¸Ê¾µÆ
#define  CRT_LED_BLUE                   1 //²Ù×÷À¶É«Ö¸Ê¾µÆ
#define  CRT_LED_ALL                    2 //²Ù×÷ËùÓÐÖ¸Ê¾µÆ

//µÆ¿ØÖÆ
#define  CRT_LED_OFF                    0 //Ö¸Ê¾µÆ¹Ø±Õ
#define  CRT_LED_ON                     1 //Ö¸Ê¾µÆ´ò¿ª
#define  CRT_LED_FLASHING               2 //Ö¸Ê¾µÆÉÁË¸

//´ÅÌõ¿¨¶ÁÈ¡ÉèÖÃ
#define CRT_SETMAGTYPE_READASCII        0x00000000 //ÒÔASCIIÂë¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_READHEX          0x00000001 //ÒÔ¶þ½øÖÆ·½Ê½¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_AUTOUPLOAD       0x00000000 //Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_NOTUPLOAD        0x00000010 //½ûÖ¹Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_EFFINSERT        0x00000000 //²åÈë¶Á´ÅµÀÊý¾ÝÓÐÐ§
#define CRT_SETMAGTYPE_EFFUPPLUG        0x00000100 //°Î³ö¶Á´ÅµÀÊý¾ÝÓÐÐ§

//¶Á´ÅµÀÊý
#define CRT_ReadTracks_Track1           1 //´ÅµÀ1Êý¾Ý
#define CRT_ReadTracks_Track2           2 //´ÅµÀ2Êý¾Ý
#define CRT_ReadTracks_Track3           3 //´ÅµÀ3Êý¾Ý

/** 
 * @fn		CRT288x_OpenConnection() 
 * @detail	´ò¿ªÉè±¸
 * @see		...
 * @param	[in]iOpenMode--´ò¿ªÄ£Ê½:0 USBÁ¬½ÓÄ£Ê½£¬ 1 RS232Á¬½ÓÄ£Ê½
 * @param	[in]iComPort--ÉèÖÃCOM¿Ú(USBÄ£Ê½ÏÂ£¬ÎÞÐè´¦Àí)
 * @param	[in]lBaudRate--ÉèÖÃ²¨ÌØÂÊ(Ä¬ÈÏ 9600)
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó.
 * @exception ...
 * @example USBÁ¬½Ó£ºint iRet = (*pCRT288x_OpenConnection(0); 
            COM3,²¨ÌØÂÊ9600 Á¬½Ó£ºint iRet = (*pCRT288x_OpenConnection(1, 3, 9600);
 * @author	luowei
 * @date	2016/01/06
 */
typedef int (*pCRT288x_OpenConnection)(int iOpenMode, int iComPort, long lBaudRate);



/** 
 * @fn		CRT288x_CloseConnection() 
 * @detail	¹Ø±ÕÉè±¸
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 * @example int iRet = (*pCRT288x_CloseConnection(); 
 * @author	luowei
 * @date	2016/01/06
 */
typedef int (*pCRT288x_CloseConnection)();



/** 
 * @fn		CRT288x_ExeCommand() 
 * @detail	·¢ËÍÖ´ÐÐÃüÁî
 * @see		...
 * @param	[in]iSendDataLen:·¢ËÍµÄÃüÁî³¤¶È
 * @param	[in]bySendData:·¢ËÍµÄÃüÁî
 * @param	[out]iRecvDataLen:·µ»ØµÄÃüÁî³¤¶È
 * @param	[out]byRecvData:·µ»ØµÄÃüÁî
 * @param	[out]byStCode:·µ»ØµÄÖ´ÐÐ×´Ì¬Âë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_ExeCommand)(int iSendDataLen, BYTE bySendData[] , int* iRecvDataLen, BYTE byRecvData[],BYTE byStCode[]);



/** 
 * @fn		CRT288x_InitDev() 
 * @detail	³õÊ¼»¯Éè±¸
 * @see		...
 * @param	[in]InitMode--³õÊ¼»¯Ä£Ê½:0 ÎÞ¶¯×÷£¬ 1 ½âËø
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int (*pCRT288x_InitDev)(int InitMode );


/** 
 * @fn		CRT288x_GetCardStatus() 
 * @detail	»ñÈ¡¿¨Æ¬×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 ÎÞ¿¨£¬2 ¿¨ÔÚ¿¨¿Ú£¬ 3 ¿¨ÔÚ¶Á¿¨Æ÷ÄÚ£¬ 9 Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_GetCardStatus)();



/** 
 * @fn		CRT288x_GetLockStatus() 
 * @detail	»ñÈ¡Ëø¿¨×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 Î´Ëø¿¨£¬2 ÒÑËø¿¨£¬ 9 Éè±¸²»ÔÚÏß£¬Ëø¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_GetLockStatus)();



/** 
 * @fn		CRT288x_LockedProcess() 
 * @detail	Ëø¿¨²Ù×÷
 * @see		...
 * @param	[in]iLockType--¿¨»úËø¿¨²Ù×÷:0 ÎÞ¶¯×÷£¬ 1 ½âËø£¬ 2 Ëø¿¨£¬ 3 ÓÐ¿¨×Ô¶¯Ëø¿¨£¬ 4 ÓÐ¿¨²»×Ô¶¯Ëø¿¨
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_LockedProcess)(int iLockType);



/** 
 * @fn		CRT288x_LEDProcess() 
 * @detail	Ö¸Ê¾µÆ²Ù×÷
 * @see		...
 * @param	[in]iLightType--²Ù×÷Ö¸Ê¾µÆ:0 ºìÉ«Ö¸Ê¾µÆ£¬1 À¶É«Ö¸Ê¾µÆ£¬ 2 ËùÓÐÖ¸Ê¾µÆ
 * @param	[in]iFlag--Ö¸Ê¾µÆ×´Ì¬:0 Ãð£¬1 ÁÁ£¬ 2 ÉÁË¸
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_LEDProcess)(int iLightType, int iFlag);



/** 
 * @fn		CRT288x_SetLEDFlashTime() 
 * @detail	ÉèÖÃÖ¸Ê¾µÆÉÁË¸Ê±¼ä
 * @see		...
 * @param	[in]iOnTime--Ö¸Ê¾µÆÉÁË¸ ÁÁÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @param	[in]iOffTime--Ö¸Ê¾µÆÉÁË¸ ÃðÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SetLEDFlashTime)(int iOnTime, int iOffTime);



/** 
 * @fn		CRT288x_SetReaderMagType() 
 * @detail	ÉèÖÃ¶Á¿¨Æ÷¶Á´Å¿¨·½Ê½
 * @see		...
 * @param	[in]iReadMode--¶Á¿¨·½Ê½: 0 ASCIIÂë¶Á¿¨Êý¾Ý£¬ 1 ¶þ½øÖÆÂë¶Á¿¨Êý¾Ý
 * @param	[in]iDataMode--Êý¾ÝÓÐÐ§·½Ê½: 0 ²å¿¨Êý¾ÝÓÐÐ§£¬ 1 °Î¿¨Êý¾ÝÓÐÐ§ 
  * @param	[in]bAutoUpload--ÊÇ·ñÖ÷¶¯ÉÏ´«: TRUE ÔÊÐíÖ÷¶¯ÉÏ´«£¬ FALSE ½ûÖ¹Ö÷¶¯ÉÏ´« 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SetReaderMagType)(int iReadMode, int iDataMode, bool bAutoUpload);



/** 
 * @fn		CRT288x_ReadTrack() 
 * @detail	¶Áµ¥´ÅµÀÊý¾Ý
 * @see		...
 * @param	[in]iTrackNum--´ÅµÀºÅ: 1 Ò»´ÅµÀ£¬ 2 ¶þ´ÅµÀ£¬ 3 Èý´ÅµÀ
 * @param	[out]szTrackData--·µ»Ø´ÅµÀÊý¾Ý 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_ReadTrack)(int iTrackNum, char szTrackData[]);




/** 
 * @fn		CRT288x_ReadAllTracks() 
 * @detail	¶ÁËùÓÐ´ÅµÀÊý¾Ý
 * @see		...
 * @param	[out]szTrack1Data--·µ»ØÒ»´ÅµÀÊý¾Ý
 * @param	[out]szTrack2Data--·µ»Ø¶þ´ÅµÀÊý¾Ý
 * @param	[out]szTrack3Data--·µ»ØÈý´ÅµÀÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_ReadAllTracks)(char szTrack1Data[], char szTrack2Data[], char szTrack3Data[]);



/** 
 * @fn		CRT288x_ClearTrackData() 
 * @detail	Çå³ý»º´æÇø´ÅµÀÊý¾Ý
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_ClearTrackData)();



/** 
 * @fn		(*pCRT288x_GetICType() 
 * @detail	»ñÈ¡(½Ó´¥Ê½)IC¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªIC¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
                 33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨¡£ 
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_GetICType)();



/** 
 * @fn		CRT288x_GetRFType() 
 * @detail	»ñÈ¡(·Ç½Ó´¥Ê½)RF¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªRF¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_GetRFType)();



/** 
 * @fn		CRT288x_ChipPower() 
 * @detail	IC¿¨ÉÏµç²Ù×÷
 * @see		...
 * @param	[in]iICType--IC¿¨ÀàÐÍ:10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
							  33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨
							  110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨£¬ 210 SAM ¿¨¡£
 * @param	[in]wChipPower--ÉÏµç²Ù×÷: 0x02 Àä¸´Î»ÉÏµç£¬ 0x04 ÈÈ¸´Î»ÉÏµç£¬ 0x08 ÏÂµç¡£
 * @param	[out]byOutChipData--Àä¸´Î»·µ»ØATRÊý¾Ý
 * @param	[out]iOutChipDatalen--Àä¸´Î»·µ»ØATRÊý¾Ý³¤¶È
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_ChipPower)(int iICType, WORD wChipPower, BYTE byOutChipData[], int* iOutChipDatalen);




/** 
 * @fn		CRT288x_ChipIO() 
 * @detail	ÓëIC¿¨Ð¾Æ¬Í¨Ñ¶
 * @see		...
 * @param	[in]wChipProtocol--IC¿¨Í¨Ñ¶Ð­Òé: 0 ¶Á¿¨Æ÷×Ô¶¯Ñ¡ÔñÐ­Òé£¬1 T0Ð­Òé£¬ 2 T1Ð­Òé¡£
 * @param	[in]ulInChipDataLength--·¢ËÍAPDUÊý¾Ý³¤¶È¡£
 * @param	[in]lpInbChipData--·¢ËÍAPDUÊý¾Ý
 * @param	[out]ulOutChipDataLength--·µ»ØµÄAPDUÊý¾Ý³¤¶È
 * @param	[out]lpOutbChipData--·µ»ØµÄAPDUÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_ChipIO)(WORD wChipProtocol, int ulInChipDataLength , BYTE lpInbChipData[], int* ulOutChipDataLength , BYTE lpOutbChipData[]);




/** 
 * @fn		CRT288x_GetCardActiveStatus() 
 * @detail	²éÑ¯µ±Ç°ICÐ¾Æ¬µÄ¼¤»î×´Ì¬
 * @see		...
 * @return	½á¹û,1 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª3.57 MHZ£¬ 2 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª7.16 MHZ£¬ 3 Î´¼¤»î£¬ 9¼¤»î×´Ì¬Î´Öª£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_GetCardActiveStatus)();




/** 
 * @fn		CRT288x_SAMSlotChange() 
 * @detail	SAM¿¨ÇÐ»»¿¨×ù
 * @see		...
 * @param	[in]iSamNum--ÐèÇÐ»»µÄ¿¨×ù(1-10) 1 SAM1¿¨×ù£¬ 2 SAM2¿¨×ù£¬ 3 SAM3¿¨×ù£¬ 4 SAM4¿¨×ù
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SAMSlotChange)(int iSamNum);




/** 
 * @fn		CRT288x_SetVcc() 
 * @detail	ÉèÖÃÉÏµçVccÊôÐÔ
 * @see		...
 * @param	[in]iVcc--VccÊôÐÔ 1 5VµçÔ´£¬EMV·½Ê½¼¤»î£¬ 2 5VµçÔ´£¬ISO7816·½Ê½¼¤»î£¬ 3 3VµçÔ´£¬ISO7816·½Ê½¼¤»î
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SetVcc)(int iVcc);




/** 
 * @fn		CRT288x_SL4442CheckPasswd() 
 * @detail	SL4442¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4442¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó2 »òÐ¡ÓÚ2 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SL4442CheckPasswd)(int iMode, int uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4442Process() 
 * @detail	SL4442¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø£¬ 3 °²È«Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0xFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-128£¬ ±£»¤Î»Çø£º0-4£¬ °²È«Çø£º0-4)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SL4442Process)(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4428CheckPasswd() 
 * @detail	SL4428¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4428¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó7 »òÐ¡ÓÚ7 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SL4428CheckPasswd)(int iMode, int uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_SL4428Process() 
 * @detail	SL4428¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0x01FF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-256£¬ ±£»¤Î»Çø£º0-128)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_SL4428Process)(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_24CxProcess() 
 * @detail	24Cx¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(24C01: 0x00-0x07F, 24C02: 0x00-0xFF, 24C04: 0x00-0x01FF, 24C08: 0x00-0x03FF, 24C16: 0x00-0x07FF,
                                 24C32: 0x00-0x0FFF, 24C64: 0x00-0x1FFF, 24C128: 0x00-0x3FFF, 24C256: 0x00-0x7FFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_24CxProcess)(int iMode ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareKeyProcess() 
 * @detail	Mifare¿¨µÄÃÜÂë²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 Ð£ÑéÃÜÂë£¬ 2 ÏÂÔØÃÜÂëµ½EERPROM£¬ 3 ÐÞ¸ÄÃÜÂë
 * @param	[in]iKs--ÃÜÔ¿ÀàÐÍ    0 KeyA£¬ 1 KeyB
 * @param	[in]iSn--ÉÈÇøºÅ  (S50 card sn=00H-0FH, S70 card sn=00H-27H)
 * @param	[in][uDataLength--²Ù×÷µÄÃÜÂë³¤¶È
 * @param	[in]lpData--²Ù×÷µÄÃÜÂëÊý¾Ý(Ä¬ÈÏÃÜÂë£ºFFFFFFFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_MifareKeyProcess)(int iMode, int iKs, int iSn, int uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareCardProcess() 
 * @detail	Mifare¿¨²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶ÁÉÈÇø¿éÊý¾Ý£¬ 2 Ð´ÉÈÇø¿éÊý¾Ý£¬ 3 S50 S70 ³õÊ¼»¯£¬4 S50 S70 ¶ÁÓà¶î£¬ 5 S50 S70 ÔöÖµ£¬ 6 S50 S70 ¼õÖµ
 * @param	[in]iSn--ÉÈÇøºÅ  (Ultralight Card: iSn=00H-0FH, S50 card: iSn=00H-0FH, S70 card: iSn=00H-20H (iSn=21H-27H  S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iBn--²Ù×÷ÆðÊ¼¿éºÅ (Ultralight Card: iBn=00H, S50 card: iBn=00H-03H, S70 card: iBn=00H-03H  (iBn=00H-0FH   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iLc--²Ù×÷¿éÊýÄ¿ (Ultralight Card: iLc=01H-10H, S50 card: iLc=01H-04H, S70 card: iLc=01H-04H  (iLc=01H-10H   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(S50 S70 ³õÊ¼»¯£¬ÔöÖµ£¬¼õÖµÊ± Îª²Ù×÷µÄ½ð¶îÊý)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(ËùÓÐÐ´²Ù×÷ ÎªÊäÈë£¬ËùÓÐ¶Á²Ù×÷ ÎªÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int  (*pCRT288x_MifareCardProcess)(int iMode, int iSn, int iBn, int iLc, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288C_GetHidCardNums() 
 * @detail	»ñÈ¡Hid¿¨ºÅ
 * @see		...
 * @param	[out]szHidCardNums--»ñÈ¡µ½µÄHid¿¨ºÅ
 * @return ½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
typedef int (*pCRT288C_GetHidCardNums)(char szHidCardNums[]);


typedef struct
{
	pCRT288x_OpenConnection   CRT288x_OpenConnection;
	pCRT288x_CloseConnection  CRT288x_CloseConnection;
	pCRT288x_ExeCommand       CRT288x_ExeCommand;
	pCRT288x_InitDev          CRT288x_InitDev;
	pCRT288x_GetCardStatus    CRT288x_GetCardStatus;
	pCRT288x_GetLockStatus    CRT288x_GetLockStatus;
	pCRT288x_LockedProcess    CRT288x_LockedProcess;
	pCRT288x_LEDProcess       CRT288x_LEDProcess;
	pCRT288x_SetLEDFlashTime  CRT288x_SetLEDFlashTime;
	pCRT288x_SetReaderMagType CRT288x_SetReaderMagType;
	pCRT288x_ReadTrack        CRT288x_ReadTrack;
	pCRT288x_ReadAllTracks    CRT288x_ReadAllTracks;
	pCRT288x_ClearTrackData   CRT288x_ClearTrackData;
	pCRT288x_GetICType        CRT288x_GetICType;
	pCRT288x_GetRFType        CRT288x_GetRFType;
	pCRT288x_ChipPower        CRT288x_ChipPower;
	pCRT288x_ChipIO           CRT288x_ChipIO;
	pCRT288x_GetCardActiveStatus CRT288x_GetCardActiveStatus;
	pCRT288x_SAMSlotChange  CRT288x_SAMSlotChange;
	pCRT288x_SetVcc         CRT288x_SetVcc;
	pCRT288x_SL4442CheckPasswd CRT288x_SL4442CheckPasswd;
	pCRT288x_SL4442Process  CRT288x_SL4442Process;
	pCRT288x_SL4428CheckPasswd  CRT288x_SL4428CheckPasswd;
	pCRT288x_SL4428Process  CRT288x_SL4428Process;
	pCRT288x_24CxProcess  CRT288x_24CxProcess;
	pCRT288x_MifareKeyProcess CRT288x_MifareKeyProcess;
	pCRT288x_MifareCardProcess   CRT288x_MifareCardProcess;
	pCRT288C_GetHidCardNums  CRT288C_GetHidCardNums;
}Crt288_drv;

extern Crt288_drv g_crt288_drv;
bool LoadMyLib(const char lpDllPath[], char ErrorInfo[]);
int  UnLoadMyLib();


#endif 

```

---

## File: Makefile

**Percorso:** `drivers/288K/288K-linux-sample/288K/Makefile`
**Directory:** `drivers/288K/288K-linux-sample/288K`
**Dimensione:** 350 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```text


CC = gcc
LDFLAGS = -ldl -g
CFLAGS  = 
TAG = crt_288_test
INC = -I./
LIB = -L./
SRC = crt_288_test.c LoadCrt288lib.c  LoadCrt288lib.h
OBJS = crt_288_test.o LoadCrt288lib.o  



ALL:$(OBJS)
	$(CC) $(CFLAGS) -o  $(TAG) $(INC) $(LIB) $(LDFLAGS) $(OBJS)  

%.o:%.c
	$(CC) -c $< -o $@ $(INC) $(LIB) $(LDFLAGS)
	
clean:
	rm *.o




```

---

## File: Makefile-arm

**Percorso:** `drivers/288K/288K-linux-sample/288K/Makefile-arm`
**Directory:** `drivers/288K/288K-linux-sample/288K`
**Dimensione:** 395 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```text


CC = /opt/buildroot-2011.11/arm926t/usr/bin/arm-linux-gcc
LDFLAGS = -ldl -g
CFLAGS  = 
TAG = crt_288_test
INC = -I./
LIB = -L./
SRC = crt_288_test.c LoadCrt288lib.c  LoadCrt288lib.h
OBJS = crt_288_test.o LoadCrt288lib.o  



ALL:$(OBJS)
	$(CC) $(CFLAGS) -o  $(TAG) $(INC) $(LIB) $(LDFLAGS) $(OBJS)  

%.o:%.c
	$(CC) -c $< -o $@ $(INC) $(LIB) $(LDFLAGS)
	
clean:
	rm *.o


```

---

## File: crt_288_test

**Percorso:** `drivers/288K/288K-linux-sample/288K/crt_288_test`
**Directory:** `drivers/288K/288K-linux-sample/288K`
**Dimensione:** 39616 bytes
**Ultima modifica:** 2025-07-24 08:25:51
**Permessi:** 775

### Contenuto:

*[File binario - contenuto non visualizzabile]*

---

## File: crt_288_test.c

**Percorso:** `drivers/288K/288K-linux-sample/288K/crt_288_test.c`
**Directory:** `drivers/288K/288K-linux-sample/288K`
**Dimensione:** 18553 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```c
#include "LoadCrt288lib.h"

//-------------------------------------------------------------------------------------------
void get_int_input(char* szshow, int *ch)
{	
	printf("%s\t", szshow);
	while(scanf("%d",ch) == 0)
		while(getchar() == '\n');
}

void get_str_input(char* szshow, char *ch)
{
	printf("%s\n", szshow);
	while(scanf("%s",ch) == 0)
		while(getchar() == '\n');
}

int menu();
int test();

int main()
{
	char szErrInfo[256] = {0};
	if(!LoadMyLib("/usr/lib/crt_288x_ur.so", szErrInfo))
	{
		fprintf(stderr,"LoadMyLibrary:%s\n\n",szErrInfo);
		while(getchar() == '\n');
		exit(0);
	}
	
	menu();
	test();
	return 0;
}

int menu()
{
	
	printf("\n==========Welcome to using crt_603_vx_test==========\n");
	printf("\t0:  quit.\n");
	printf("\t1:  Show menu .\n");
	printf("\t2:  Turn on the device .\n");
	printf("\t3:  Initialize and unlock .\n");
	printf("\t4:  Check status .\n");
	printf("\t5:  Lock card status .\n");
	printf("\t6:  Lock card .\n");
	printf("\t7:  Indicator operation .\n");
	printf("\t8:  Read all tracks .\n");
	printf("\t9:  Clear track information .\n");
	printf("\t10: Test contact IC card .\n");
	printf("\t11: Test contactless IC card .\n");
}


int test()
{
	int iRet = 0;
	int ich;
	while(1)
	{
		printf("Please select a test option : ");

		//检查输入是否出错，出错继续输入
		while(scanf("%d",&ich) == 0)
			while(getchar() == '\n');
			

		switch(ich)
		{
			case 0:
			{
				g_crt288_drv.CRT288x_CloseConnection();
		   		UnLoadMyLib();
		    		printf("Byebye.\n\n");
		    		exit(0);
			}
			break;
			case 1:
			{
				 menu();
			}
			break;
			case 2:
			{	
				int iOpenType = 0;
				int iComPort = 1;
				int iBaudRate = 19200;
				get_int_input("Please enter the open type, 0 to open in USB mode, 1 to open in COM port mode ", &iOpenType);
				if(iOpenType == 0)
				{
					iRet = g_crt288_drv.CRT288x_OpenConnection(0, iComPort, iBaudRate);
				}
				else
				{
					get_int_input("Please enter the port number, for example, enter 1 for ttys1 :", &iComPort);
					get_int_input("Please enter the baud rate, such as 9600, 19200, 38400, 115200: ", &iBaudRate);
					iRet = g_crt288_drv.CRT288x_OpenConnection(1, iComPort, iBaudRate);
				}
				
				if(iRet != 0 ){
					fprintf(stderr,"CRT288x_OpenConnection Error iRet:%d\n\n", iRet);
				}
				else{
					printf("CRT288x_OpenConnection success! \n\n");
				}
			}
			break;
			case 3:
			{	
				int iType = 1; //解锁
				iRet = g_crt288_drv.CRT288x_InitDev(iType);
				if(iRet != 0 ){
					fprintf(stderr,"CRT288x_InitDev Error iRet:%d\n\n", iRet);
				}
				else{
					printf("CRT288x_InitDev success! \n\n");
				}
			}
			break;
			case 4:
			{	
				iRet = g_crt288_drv.CRT288x_GetCardStatus();
				switch(iRet)
				{
					case 1:
						printf("No card\n");
					    break;
					case 2:
						printf("card not readey\n");
					    break;
					case 3:
						printf("have card \n");
					    break;
					default:
						printf("error \n");
					    break;	
				}
			}
			break;
			case 5:
			{
				iRet = g_crt288_drv.CRT288x_GetLockStatus();
				switch(iRet)
				{
					case 1:
						printf("Not Locked\n");
					    break;
					case 2:
						printf("Locked\n");
					    break;
					default:
						printf("error \n");
					    break;	
				}
			}
			case 6:
			{
				int iLock = 2; //锁卡
				iRet = g_crt288_drv.CRT288x_LockedProcess(iLock);
				if(iRet != 0){
					fprintf(stderr,"CRT288x_LockedProcess Error iRet:%d\n\n", iRet);
				}
				else{
					printf("CRT288x_LockedProcess success! \n\n");
				}
				
			}
			break;
			case 7:
			{
				int iLightType = 2; //所有灯
				int iFlag = 1;   //亮
				iRet = g_crt288_drv.CRT288x_LEDProcess(iLightType, iFlag);
				if(iRet != 0){
					fprintf(stderr,"CRT288x_LEDProcess Error iRet:%d\n\n", iRet);
				}
				else{
					printf("CRT288x_LEDProcess success! \n\n");
				}
			}
			break;
			case 8:
			{
				char szTrack1Data[256] = {0};
				char szTrack2Data[256] = {0};
				char szTrack3Data[256] = {0};
				iRet = g_crt288_drv.CRT288x_ReadAllTracks(szTrack1Data, szTrack2Data, szTrack3Data);
				if(iRet != 0){
					fprintf(stderr,"CRT288x_ReadAllTracks Error iRet:%d\n\n", iRet);
				}
				else{
					printf("CRT288x_ReadAllTracks success! \n\n");
					printf("\tTrack1:%s\n\tTrack2:%s\n\tTrack3:%s \n\n", szTrack1Data, szTrack2Data, szTrack3Data);
				}
			}
			break;
			case 9:
			{
				iRet = g_crt288_drv.CRT288x_ClearTrackData();
				if(iRet != 0){
					fprintf(stderr,"CRT288x_ClearTrackData Error iRet:%d\n\n", iRet);
				}
				else{
					printf("CRT288x_ClearTrackData success! \n\n");
				}
			}
			break;
			case 10:
			{
				int iICType = 0;
				iICType = g_crt288_drv.CRT288x_GetICType();
				switch(iICType)
				{
					case 0:
						printf("Unknow IC Card\n");
						break;
					case 10:
						printf("T=0 CPU Card\n");
						break;
					case 11:
						printf("T=1 CPU Card\n");
						break;
					case 20:
						printf("SL4442 Card\n");
						break;
					case 21:
						printf("SL4428 Card\n");
						break;
					case 30:
						printf("AT24C01 Card\n");
						break;
					case 31:
						printf("AT24C02 Card\n");
						break;
					case 32:
						printf("AT24C04 Card\n");
						break;
					case 33:
						printf("AT24C08 Card\n");
						break;		
					case 34:
						printf("AT24C16 Card\n");
						break;
					case 35:
						printf("AT24C32 Card\n");
						break;
					case 36:
						printf("AT24C64 Card\n");
						break;
					case 37:
						printf("AT24C128 Card\n");
						break;		
					case 38:
						printf("AT24C256 Card\n");
						break;		
					default:
						printf("error");
						break;
				}
				WORD wChipPower = 0x02; //冷复位
				BYTE byAtr[56] = {0};
				int iAtr = 0;
				iRet = g_crt288_drv.CRT288x_ChipPower(iICType, wChipPower, byAtr, &iAtr);
				if(iRet != 0){
					fprintf(stderr,"CRT288x_ChipPower Error iRet:%d\n\n", iRet);
				}
				else{

					printf("CRT288x_ChipPower success! \n");
					int i;
					printf("ATR:");
					for(i=0;i<iAtr;i++)
						printf("%02x ", byAtr[i]);
					printf("\n");
					
					WORD wChipProtocol = 0;  //自动选择
					char sSendData[1024] = {0};
					int iSendLen = strlen(sSendData);
					BYTE byRecvData[1024] = {0};
					int iRecvLen =0;
					
					if(iICType == 10 || iICType == 11) //CPU卡
					{
// 						WORD wChipProtocol = 0;  //自动选择
// 						char sSendData[] = "80AE80006B46554C4C2046554E4354494F4E414C4761739001010010D20122010123456789303130323033303430353036303730383039304130424761739001010010010000000000000000000000000000009507012012310840FFC0008C0201084000000000000000005F03000057";
// 						int iSendLen = strlen(sSendData);
// 						BYTE byRecvData[1024] = {0};
// 						int iRecvLen =0;
					  
						wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00A4040007A0000000031010");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					sleep(1);
					if(iICType == 10 || iICType == 11) //CPU卡
					{
// 						WORD wChipProtocol = 0;  //自动选择
// 						char sSendData[] = "0084000008";
// 						int iSendLen = strlen(sSendData);
// 						BYTE byRecvData[1024] = {0};
// 						int iRecvLen =0;
					  
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2010C00");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					sleep(1);
					if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2011400");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					/* sleep(1);
					if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00A4040007A0000000031010");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					sleep(1);
					if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"80A8000013831108406040208E80F053FF00003AB1009614");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					sleep(1);
					if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2010C00");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					sleep(1);
					if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2011400");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					sleep(1);
					if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2021400");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					
										if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2031400");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					
										if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2011C00");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					
										if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2021C00");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					
										if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"00B2031C00");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					
										if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"80AE80006B46554C4C2046554E4354494F4E414C4761739001010010D20122010123456789303130323033303430353036303730383039304130424761739001010010010000000000000000000000000000009507012012310840FFC0008C0201084000000000000000005F03000057");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
					
										if(iICType == 10 || iICType == 11) //CPU卡
					{
					  	wChipProtocol = 0;  //自动选择
						
						strcpy(sSendData,"80AE400009CF29433980C0800080");
						iSendLen = strlen(sSendData);
						memset(byRecvData,0,1024);
						iRecvLen = 0;					  
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						
						if(iRet != 0)
						{
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else
						{
							printf("CRT288x_ChipIO success! [%s] \n",sSendData);
							printf("Recv:");
							
							for(i=0;i<iRecvLen;i++)
							  printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					} */
				}
				
			}
			break;
			case 11:
			{
				int iRFType = 0;
				iRFType = g_crt288_drv.CRT288x_GetRFType();
				switch(iRFType)
				{
					case 0:
						printf("Unknow RF Card\n");
						break;
					case 110:
						printf("S50 Card\n");
						break;
					case 111:
						printf("S70 Card\n");
						break;
					case 112:
						printf("UL Card\n");
						break;
					case 120:
						printf("TypeA CPU Card\n");
						break;
					case 130:
						printf("TypeB CPU Card\n");
						break;	
					default:
						printf("error");
						break;
				}
				WORD wChipPower = 0x02; //冷复位
				BYTE byAtr[56] = {0};
				int iAtr = 0;
				iRet = g_crt288_drv.CRT288x_ChipPower(iRFType, wChipPower, byAtr, &iAtr);
				if(iRet != 0){
					fprintf(stderr,"CRT288x_ChipPower Error iRet:%d\n\n", iRet);
				}
				else{
					printf("CRT288x_ChipPower success! \n");
					int i;
					printf("ATR:");
					for(i=0;i<iAtr;i++)
						printf("%02x ", byAtr[i]);
					printf("\n");
					
					if(iRFType == 120 || iRFType == 130) //CPU卡
					{
						WORD wChipProtocol = 0;  //自动选择
						char sSendData[] = "0084000008";
						int iSendLen = strlen(sSendData);
						BYTE byRecvData[1024] = {0};
						int iRecvLen =0;
						
						iRet = g_crt288_drv.CRT288x_ChipIO(wChipProtocol, iSendLen, (BYTE*)sSendData, &iRecvLen, byRecvData);
						if(iRet != 0){
							fprintf(stderr,"CRT288x_ChipIO Error iRet:%d\n\n", iRet);
						}
						else{
							printf("CRT288x_ChipIO success! \n");
							printf("Recv:");
							for(i=0;i<iRecvLen;i++)
							printf("%02x ", byRecvData[i]);
							printf("\n");
						}
					}
				}
				
			}
			break;
			default:
			printf("you chosen is error.\n\n");
			break;
			
		}
	}
}

```

---

## File: crt_288x_ur.h

**Percorso:** `drivers/288K/288K-linux-sample/288K/crt_288x_ur.h`
**Directory:** `drivers/288K/288K-linux-sample/288K`
**Dimensione:** 17331 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```c
#ifndef __CRT_288K_UR__
#define __CRT_288K_UR__
#include <stdbool.h>

#define BYTE unsigned char
#define WORD unsigned short 
#define DWORD unsigned int

//Í¨Ñ¶Ð­Òé
#define ENQ  0x05
#define ACK  0x06
#define NAK  0x15
#define EOT  0x04
#define CAN  0x18
#define STX  0xF2
#define ETX  0x03
#define US   0x1F

//´íÎóÂë
#define CRT_ERRCOUNT                 -200
#define CRT_ERR_CMD                  (CRT_ERRCOUNT-1) //ÃüÁî×Ö´íÎó
#define CRT_ERR_CMDPARAM             (CRT_ERRCOUNT-2) //ÃüÁî²ÎÊý´íÎó
#define CRT_ERR_CMDDENIAL            (CRT_ERRCOUNT-3) //ÃüÁî²»ÄÜ±»Ö´ÐÐ
#define CRT_ERR_DEVNOTSUP            (CRT_ERRCOUNT-4) //Ó²¼þ²»Ö§³Ö
#define CRT_ERR_CMDDATA              (CRT_ERRCOUNT-5) //ÃüÁîÊý¾Ý´íÎó
#define CRT_ERR_LOCKCARD             (CRT_ERRCOUNT-11) //Ëø¿¨¹³²Ù×÷Ê§°Ü
#define CRT_ERR_EEPROM               (CRT_ERRCOUNT-15) //EEPROM error
#define CRT_ERR_TRACKCHECK           (CRT_ERRCOUNT-20) //¶Á´Å¿¨´í£¨Ð£Ñé´í£©
#define CRT_ERR_READTRACK            (CRT_ERRCOUNT-21) //¶Á´Å¿¨´í
#define CRT_ERR_POWERDOWN            (CRT_ERRCOUNT-30) //¿¨»úµôµç£¨Power down£©
#define CRT_ERR_ICPROCESS            (CRT_ERRCOUNT-41) //IC¿¨Ä£¿é²Ù×÷Ê§°Ü
#define CRT_ERR_ICPOWERSHORT         (CRT_ERRCOUNT-60) //IC¿¨µçÔ´¶ÌÂ·
#define CRT_ERR_ICACTIVATIONFAIL     (CRT_ERRCOUNT-61) //IC¿¨¼¤»îÊ§°Ü
#define CRT_ERR_ICDENIAL             (CRT_ERRCOUNT-62) //IC¿¨²»Ö§³Öµ±Ç°ÃüÁî
#define CRT_ERR_ICNOTRESPOND         (CRT_ERRCOUNT-63) //IC¿¨Í¨Ñ¶³ö´í
#define CRT_ERR_ICNOTRESPOND_OTHER   (CRT_ERRCOUNT-64) //IC¿¨Í¨Ñ¶³ö´í(ÆäËû)
#define CRT_ERR_ICNOTACTIVATION      (CRT_ERRCOUNT-65) //IC¿¨Î´¼¤»î
#define CRT_ERR_ICNOTSUP             (CRT_ERRCOUNT-66) //¿¨»ú²»Ö§³ÖÕâÖÖIC¿¨
#define CRT_ERR_ICEMV                (CRT_ERRCOUNT-66) //²»Ö§³ÖEMVÄ£Ê½
#define CRT_ERR_COMMTIMEOUT	         (CRT_ERRCOUNT-80) //Í¨Ñ¶Ê§°Ü³¬Ê±
#define CRT_ERR_CANCEL	             (CRT_ERRCOUNT-84) //ÃüÁîÈ¡Ïû
#define CRT_ERR_PWDPROCESS	         (CRT_ERRCOUNT-90) //Ð£ÑéÃÜÂë²Ù×÷Ê§°Ü
#define CRT_ERR_PWDCHECK	         (CRT_ERRCOUNT-91) //ÃÜÂëÐ£ÑéÊ§°Ü
#define CRT_ERR_PWDSCRAP	         (CRT_ERRCOUNT-92) //ÃÜÂëÐ£ÑéÊ§°Ü£¬¿¨ËøËÀ
#define CRT_ERR_PWDADDROVERFLOW	     (CRT_ERRCOUNT-93) //²Ù×÷µØÖ·Òç³ö
#define CRT_ERR_PWDLENOVERFLOW	     (CRT_ERRCOUNT-94) //²Ù×÷³¤¶ÈÒç³ö
#define CRT_ERR_PWDPMERR	         (CRT_ERRCOUNT-95) //PM ´íÎó
#define CRT_ERR_PWDCMERR	         (CRT_ERRCOUNT-96) //CM ´íÎó
#define CRT_ERR_UNKNOWN              (CRT_ERRCOUNT-99) //Î´Öª´íÎó

//´ò¿ªÉè±¸
#define CRT_OPEN_TYPEUSB             0 //USB¿Ú·½Ê½´ò¿ªÉè±¸
#define CRT_OPEN_TYPERS232           1 //RS232¿Ú·½Ê½´ò¿ªÉè±¸

//³õÊ¼»¯
#define CRT_INIT_NOTUNLOCK          0 //³õÊ¼»¯ÎÞ¶¯×÷
#define CRT_INIT_UNLOCK             1 //³õÊ¼»¯½âËø


//¿¨×´Ì¬
#define CRT_CARDST_NOCARD             1 //ÎÞ¿¨
#define CRT_CARDST_INDOOR             2 //¿¨¿Ú
#define CRT_CARDST_INSIDE             3 //¿¨ÄÚ
#define CRT_CARDST_UNKNOW             9 //Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª

//Ëø¿¨×´Ì¬
#define CRT_LOCKCARD_NOTLOCK            1 //Î´Ëø¿¨
#define CRT_LOCKCARD_LOCKED             2 //ÒÑËø¿¨
#define CRT_LOCKCARD_UNKNOW             9 //Éè±¸²»ÔÚÏß,Ëø¿¨×´Ì¬Î´Öª

//¶Á¿¨Æ÷¶¯×÷
#define CRT_RDACTION_NOACTION           0 //ÎÞ¶¯×÷
#define CRT_RDACTION_UNLOCK             1 //½âËø
#define CRT_RDACTION_LOCKED             2 //Ëø¿¨
#define CRT_RDACTION_AUTOLOCKED         3 //ÓÐ¿¨×Ô¶¯Ëø¿¨
#define CRT_RDACTION_NOTAUTOLOCK        4 //ÓÐ¿¨²»×Ô¶¯Ëø¿¨

//²Ù×÷Ö¸Ê¾µÆ
#define  CRT_LED_RED                    0 //²Ù×÷ºìÉ«Ö¸Ê¾µÆ
#define  CRT_LED_BLUE                   1 //²Ù×÷À¶É«Ö¸Ê¾µÆ
#define  CRT_LED_ALL                    2 //²Ù×÷ËùÓÐÖ¸Ê¾µÆ

//µÆ¿ØÖÆ
#define  CRT_LED_OFF                    0 //Ö¸Ê¾µÆ¹Ø±Õ
#define  CRT_LED_ON                     1 //Ö¸Ê¾µÆ´ò¿ª
#define  CRT_LED_FLASHING               2 //Ö¸Ê¾µÆÉÁË¸

//´ÅÌõ¿¨¶ÁÈ¡ÉèÖÃ
#define CRT_SETMAGTYPE_READASCII        0x00000000 //ÒÔASCIIÂë¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_READHEX          0x00000001 //ÒÔ¶þ½øÖÆ·½Ê½¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_AUTOUPLOAD       0x00000000 //Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_NOTUPLOAD        0x00000010 //½ûÖ¹Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_EFFINSERT        0x00000000 //²åÈë¶Á´ÅµÀÊý¾ÝÓÐÐ§
#define CRT_SETMAGTYPE_EFFUPPLUG        0x00000100 //°Î³ö¶Á´ÅµÀÊý¾ÝÓÐÐ§

//¶Á´ÅµÀÊý
#define CRT_ReadTracks_Track1           1 //´ÅµÀ1Êý¾Ý
#define CRT_ReadTracks_Track2           2 //´ÅµÀ2Êý¾Ý
#define CRT_ReadTracks_Track3           3 //´ÅµÀ3Êý¾Ý

/** 
 * @fn		CRT288x_OpenConnection() 
 * @detail	´ò¿ªÉè±¸
 * @see		...
 * @param	[in]iOpenMode--´ò¿ªÄ£Ê½:0 USBÁ¬½ÓÄ£Ê½£¬ 1 RS232Á¬½ÓÄ£Ê½
 * @param	[in]iComPort--ÉèÖÃCOM¿Ú(USBÄ£Ê½ÏÂ£¬ÎÞÐè´¦Àí)
 * @param	[in]lBaudRate--ÉèÖÃ²¨ÌØÂÊ(Ä¬ÈÏ 9600)
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó.
 * @exception ...
 * @example USBÁ¬½Ó£ºint iRet = CRT288x_OpenConnection(0); 
            COM3,²¨ÌØÂÊ9600 Á¬½Ó£ºint iRet = CRT288x_OpenConnection(1, 3, 9600);
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_OpenConnection(int iOpenMode, int iComPort, long lBaudRate);



/** 
 * @fn		CRT288x_CloseConnection() 
 * @detail	¹Ø±ÕÉè±¸
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 * @example int iRet = CRT288x_CloseConnection(); 
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_CloseConnection();



/** 
 * @fn		CRT288x_ExeCommand() 
 * @detail	·¢ËÍÖ´ÐÐÃüÁî
 * @see		...
 * @param	[in]iSendDataLen:·¢ËÍµÄÃüÁî³¤¶È
 * @param	[in]bySendData:·¢ËÍµÄÃüÁî
 * @param	[out]iRecvDataLen:·µ»ØµÄÃüÁî³¤¶È
 * @param	[out]byRecvData:·µ»ØµÄÃüÁî
 * @param	[out]byStCode:·µ»ØµÄÖ´ÐÐ×´Ì¬Âë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ExeCommand(int iSendDataLen, BYTE bySendData[] , int* iRecvDataLen, BYTE byRecvData[],BYTE byStCode[]);



/** 
 * @fn		CRT288x_InitDev() 
 * @detail	³õÊ¼»¯Éè±¸
 * @see		...
 * @param	[in]InitMode--³õÊ¼»¯Ä£Ê½:0 ÎÞ¶¯×÷£¬ 1 ½âËø
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_InitDev(int InitMode );


/** 
 * @fn		CRT288x_GetCardStatus() 
 * @detail	»ñÈ¡¿¨Æ¬×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 ÎÞ¿¨£¬2 ¿¨ÔÚ¿¨¿Ú£¬ 3 ¿¨ÔÚ¶Á¿¨Æ÷ÄÚ£¬ 9 Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardStatus();



/** 
 * @fn		CRT288x_GetLockStatus() 
 * @detail	»ñÈ¡Ëø¿¨×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 Î´Ëø¿¨£¬2 ÒÑËø¿¨£¬ 9 Éè±¸²»ÔÚÏß£¬Ëø¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetLockStatus();



/** 
 * @fn		CRT288x_LockedProcess() 
 * @detail	Ëø¿¨²Ù×÷
 * @see		...
 * @param	[in]iLockType--¿¨»úËø¿¨²Ù×÷:0 ÎÞ¶¯×÷£¬ 1 ½âËø£¬ 2 Ëø¿¨£¬ 3 ÓÐ¿¨×Ô¶¯Ëø¿¨£¬ 4 ÓÐ¿¨²»×Ô¶¯Ëø¿¨
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LockedProcess(int iLockType);



/** 
 * @fn		CRT288x_LEDProcess() 
 * @detail	Ö¸Ê¾µÆ²Ù×÷
 * @see		...
 * @param	[in]iLightType--²Ù×÷Ö¸Ê¾µÆ:0 ºìÉ«Ö¸Ê¾µÆ£¬1 À¶É«Ö¸Ê¾µÆ£¬ 2 ËùÓÐÖ¸Ê¾µÆ
 * @param	[in]iFlag--Ö¸Ê¾µÆ×´Ì¬:0 Ãð£¬1 ÁÁ£¬ 2 ÉÁË¸
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LEDProcess(int iLightType, int iFlag);



/** 
 * @fn		CRT288x_SetLEDFlashTime() 
 * @detail	ÉèÖÃÖ¸Ê¾µÆÉÁË¸Ê±¼ä
 * @see		...
 * @param	[in]iOnTime--Ö¸Ê¾µÆÉÁË¸ ÁÁÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @param	[in]iOffTime--Ö¸Ê¾µÆÉÁË¸ ÃðÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetLEDFlashTime(int iOnTime, int iOffTime);



/** 
 * @fn		CRT288x_SetReaderMagType() 
 * @detail	ÉèÖÃ¶Á¿¨Æ÷¶Á´Å¿¨·½Ê½
 * @see		...
 * @param	[in]iReadMode--¶Á¿¨·½Ê½: 0 ASCIIÂë¶Á¿¨Êý¾Ý£¬ 1 ¶þ½øÖÆÂë¶Á¿¨Êý¾Ý
 * @param	[in]iDataMode--Êý¾ÝÓÐÐ§·½Ê½: 0 ²å¿¨Êý¾ÝÓÐÐ§£¬ 1 °Î¿¨Êý¾ÝÓÐÐ§ 
  * @param	[in]bAutoUpload--ÊÇ·ñÖ÷¶¯ÉÏ´«: TRUE ÔÊÐíÖ÷¶¯ÉÏ´«£¬ FALSE ½ûÖ¹Ö÷¶¯ÉÏ´« 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetReaderMagType(int iReadMode, int iDataMode, bool bAutoUpload);



/** 
 * @fn		CRT288x_ReadTrack() 
 * @detail	¶Áµ¥´ÅµÀÊý¾Ý
 * @see		...
 * @param	[in]iTrackNum--´ÅµÀºÅ: 1 Ò»´ÅµÀ£¬ 2 ¶þ´ÅµÀ£¬ 3 Èý´ÅµÀ
 * @param	[out]szTrackData--·µ»Ø´ÅµÀÊý¾Ý 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadTrack(int iTrackNum, char szTrackData[]);




/** 
 * @fn		CRT288x_ReadAllTracks() 
 * @detail	¶ÁËùÓÐ´ÅµÀÊý¾Ý
 * @see		...
 * @param	[out]szTrack1Data--·µ»ØÒ»´ÅµÀÊý¾Ý
 * @param	[out]szTrack2Data--·µ»Ø¶þ´ÅµÀÊý¾Ý
 * @param	[out]szTrack3Data--·µ»ØÈý´ÅµÀÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadAllTracks(char szTrack1Data[], char szTrack2Data[], char szTrack3Data[]);



/** 
 * @fn		CRT288x_ClearTrackData() 
 * @detail	Çå³ý»º´æÇø´ÅµÀÊý¾Ý
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ClearTrackData();



/** 
 * @fn		CRT288x_GetICType() 
 * @detail	»ñÈ¡(½Ó´¥Ê½)IC¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªIC¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
                 33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨¡£ 
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetICType();



/** 
 * @fn		CRT288x_GetRFType() 
 * @detail	»ñÈ¡(·Ç½Ó´¥Ê½)RF¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªRF¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetRFType();



/** 
 * @fn		CRT288x_ChipPower() 
 * @detail	IC¿¨ÉÏµç²Ù×÷
 * @see		...
 * @param	[in]iICType--IC¿¨ÀàÐÍ:10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
							  33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨
							  110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨£¬ 210 SAM ¿¨¡£
 * @param	[in]wChipPower--ÉÏµç²Ù×÷: 0x02 Àä¸´Î»ÉÏµç£¬ 0x04 ÈÈ¸´Î»ÉÏµç£¬ 0x08 ÏÂµç¡£
 * @param	[out]byOutChipData--Àä¸´Î»·µ»ØATRÊý¾Ý
 * @param	[out]iOutChipDatalen--Àä¸´Î»·µ»ØATRÊý¾Ý³¤¶È
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipPower(int iICType, WORD wChipPower, BYTE byOutChipData[], int* iOutChipDatalen);




/** 
 * @fn		CRT288x_ChipIO() 
 * @detail	ÓëIC¿¨Ð¾Æ¬Í¨Ñ¶
 * @see		...
 * @param	[in]wChipProtocol--IC¿¨Í¨Ñ¶Ð­Òé: 0 ¶Á¿¨Æ÷×Ô¶¯Ñ¡ÔñÐ­Òé£¬1 T0Ð­Òé£¬ 2 T1Ð­Òé¡£
 * @param	[in]ulInChipDataLength--·¢ËÍAPDUÊý¾Ý³¤¶È¡£
 * @param	[in]lpInbChipData--·¢ËÍAPDUÊý¾Ý
 * @param	[out]ulOutChipDataLength--·µ»ØµÄAPDUÊý¾Ý³¤¶È
 * @param	[out]lpOutbChipData--·µ»ØµÄAPDUÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipIO(WORD wChipProtocol, int ulInChipDataLength , BYTE lpInbChipData[], int* ulOutChipDataLength , BYTE lpOutbChipData[]);




/** 
 * @fn		CRT288x_GetCardActiveStatus() 
 * @detail	²éÑ¯µ±Ç°ICÐ¾Æ¬µÄ¼¤»î×´Ì¬
 * @see		...
 * @return	½á¹û,1 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª3.57 MHZ£¬ 2 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª7.16 MHZ£¬ 3 Î´¼¤»î£¬ 9¼¤»î×´Ì¬Î´Öª£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardActiveStatus();




/** 
 * @fn		CRT288x_SAMSlotChange() 
 * @detail	SAM¿¨ÇÐ»»¿¨×ù
 * @see		...
 * @param	[in]iSamNum--ÐèÇÐ»»µÄ¿¨×ù(1-10) 1 SAM1¿¨×ù£¬ 2 SAM2¿¨×ù£¬ 3 SAM3¿¨×ù£¬ 4 SAM4¿¨×ù
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SAMSlotChange(int iSamNum);




/** 
 * @fn		CRT288x_SetVcc() 
 * @detail	ÉèÖÃÉÏµçVccÊôÐÔ
 * @see		...
 * @param	[in]iVcc--VccÊôÐÔ 1 5VµçÔ´£¬EMV·½Ê½¼¤»î£¬ 2 5VµçÔ´£¬ISO7816·½Ê½¼¤»î£¬ 3 3VµçÔ´£¬ISO7816·½Ê½¼¤»î
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetVcc(int iVcc);




/** 
 * @fn		CRT288x_SL4442CheckPasswd() 
 * @detail	SL4442¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4442¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó2 »òÐ¡ÓÚ2 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4442Process() 
 * @detail	SL4442¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø£¬ 3 °²È«Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0xFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-128£¬ ±£»¤Î»Çø£º0-4£¬ °²È«Çø£º0-4)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4428CheckPasswd() 
 * @detail	SL4428¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4428¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó7 »òÐ¡ÓÚ7 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_SL4428Process() 
 * @detail	SL4428¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0x01FF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-256£¬ ±£»¤Î»Çø£º0-128)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_24CxProcess() 
 * @detail	24Cx¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(24C01: 0x00-0x07F, 24C02: 0x00-0xFF, 24C04: 0x00-0x01FF, 24C08: 0x00-0x03FF, 24C16: 0x00-0x07FF,
                                 24C32: 0x00-0x0FFF, 24C64: 0x00-0x1FFF, 24C128: 0x00-0x3FFF, 24C256: 0x00-0x7FFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_24CxProcess(int iMode ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareKeyProcess() 
 * @detail	Mifare¿¨µÄÃÜÂë²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 Ð£ÑéÃÜÂë£¬ 2 ÏÂÔØÃÜÂëµ½EERPROM£¬ 3 ÐÞ¸ÄÃÜÂë
 * @param	[in]iKs--ÃÜÔ¿ÀàÐÍ    0 KeyA£¬ 1 KeyB
 * @param	[in]iSn--ÉÈÇøºÅ  (S50 card sn=00H-0FH, S70 card sn=00H-27H)
 * @param	[in][uDataLength--²Ù×÷µÄÃÜÂë³¤¶È
 * @param	[in]lpData--²Ù×÷µÄÃÜÂëÊý¾Ý(Ä¬ÈÏÃÜÂë£ºFFFFFFFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareKeyProcess(int iMode, int iKs, int iSn, int uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareCardProcess() 
 * @detail	Mifare¿¨²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶ÁÉÈÇø¿éÊý¾Ý£¬ 2 Ð´ÉÈÇø¿éÊý¾Ý£¬ 3 S50 S70 ³õÊ¼»¯£¬4 S50 S70 ¶ÁÓà¶î£¬ 5 S50 S70 ÔöÖµ£¬ 6 S50 S70 ¼õÖµ
 * @param	[in]iSn--ÉÈÇøºÅ  (Ultralight Card: iSn=00H-0FH, S50 card: iSn=00H-0FH, S70 card: iSn=00H-20H (iSn=21H-27H  S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iBn--²Ù×÷ÆðÊ¼¿éºÅ (Ultralight Card: iBn=00H, S50 card: iBn=00H-03H, S70 card: iBn=00H-03H  (iBn=00H-0FH   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iLc--²Ù×÷¿éÊýÄ¿ (Ultralight Card: iLc=01H-10H, S50 card: iLc=01H-04H, S70 card: iLc=01H-04H  (iLc=01H-10H   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(S50 S70 ³õÊ¼»¯£¬ÔöÖµ£¬¼õÖµÊ± Îª²Ù×÷µÄ½ð¶îÊý)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(ËùÓÐÐ´²Ù×÷ ÎªÊäÈë£¬ËùÓÐ¶Á²Ù×÷ ÎªÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareCardProcess(int iMode, int iSn, int iBn, int iLc, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288C_GetHidCardNums() 
 * @detail	»ñÈ¡Hid¿¨ºÅ
 * @see		...
 * @param	[out]szHidCardNums--»ñÈ¡µ½µÄHid¿¨ºÅ
 * @return ½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288C_GetHidCardNums(char szHidCardNums[]);



#endif 

```

---

## File: MANUAL.md

**Percorso:** `drivers/288K/doc/MANUAL.md`
**Directory:** `drivers/288K/doc`
**Dimensione:** 45466 bytes
**Ultima modifica:** 2025-07-24 08:40:55
**Permessi:** 664

### Contenuto:

```text
# MANUALE COMPLETO
## Lettore Smart Card CRT288x
### Installazione e Configurazione su Ubuntu 22.04 LTS

---

**Versione Documento:** 1.0  
**Data:** Luglio 2025  
**Dispositivo:** CREATOR(CHINA)TECH CO.,LTD CRT-285/288x  
**Sistema Operativo:** Ubuntu 22.04 LTS (64-bit)  
**Autore:** Guida Tecnica Professionale  

---

## INDICE

1. [Panoramica del Sistema](#1-panoramica-del-sistema)
2. [Requisiti e Preparazione](#2-requisiti-e-preparazione)
3. [Identificazione Dispositivo](#3-identificazione-dispositivo)
4. [Struttura Driver e File](#4-struttura-driver-e-file)
5. [Procedura di Installazione](#5-procedura-di-installazione)
6. [Configurazione Sistema](#6-configurazione-sistema)
7. [Compilazione e Test](#7-compilazione-e-test)
8. [Sviluppo Applicazioni](#8-sviluppo-applicazioni)
9. [Wrapper Python](#9-wrapper-python)
10. [Risoluzione Problemi](#10-risoluzione-problemi)
11. [Manutenzione](#11-manutenzione)
12. [Appendici](#12-appendici)

---

## 1. PANORAMICA DEL SISTEMA

### 1.1 Specifiche Dispositivo

**Modello:** CRT-288-K001  
**Identificatori USB:**
- **Vendor ID:** `23d8` (CREATOR(CHINA)TECH CO.,LTD)
- **Product ID:** `0285`
- **Nome Dispositivo:** CRT-285

**Caratteristiche Tecniche:**
- Alimentazione USB: Bus-powered (5V dalla porta USB)
- Alimentazione RS232: DC 5V ±5% esterno obbligatorio
- Consumo: <200 mA
- Interfacce: USB 2.0/3.0 (bus-powered), RS232 (alimentazione esterna)
- Supporto carte: Magnetiche, IC Contact, RFID/NFC
- LED indicatori: Rosso, Blu
- Dimensioni: 118.5 x 99 x 35.1 mm
- Peso: ~240g

**Tipi di Carte Supportate:**
- **Magnetiche:** Track 1, 2, 3 (ISO 7811)
- **IC Contact:** T=0, T=1 CPU Cards, SL4442, SL4428, AT24Cxx
- **RFID/NFC:** Mifare S50/S70, Ultralight, TypeA/B CPU

### 1.2 Architettura Software

```
┌─────────────────────────────────────────┐
│           APPLICAZIONE UTENTE           │
├─────────────────────────────────────────┤
│     Wrapper Python / API C/C++         │
├─────────────────────────────────────────┤
│        libcrt_288x_ur.so (x64)         │
├─────────────────────────────────────────┤
│            libusb-1.0.x                 │
├─────────────────────────────────────────┤
│         Driver USB del Kernel           │
├─────────────────────────────────────────┤
│            Hardware CRT288x             │
└─────────────────────────────────────────┘
```

---

## 2. REQUISITI E PREPARAZIONE

### 2.1 Requisiti Sistema

**Sistema Operativo:**
- Ubuntu 22.04 LTS (64-bit) - **Raccomandato**
- Ubuntu 20.04 LTS (64-bit) - Compatibile
- Debian 11+ (64-bit) - Compatibile

**Hardware:**
- Porta USB 2.0 o superiore
- RAM: minimo 1GB disponibile
- Spazio disco: 50MB per driver e librerie

**Permessi Utente:**
- Accesso sudo per installazione
- Membership nei gruppi `plugdev` e `dialout`

### 2.2 Preparazione Ambiente

```bash
# Aggiorna il sistema
sudo apt update && sudo apt upgrade -y

# Installa dipendenze essenziali
sudo apt install -y \
    build-essential \
    autoconf \
    libtool \
    pkg-config \
    libusb-1.0-0-dev \
    libudev-dev \
    git \
    wget \
    unzip \
    python3 \
    python3-pip

# Installa headers del kernel (se necessario)
sudo apt install -y linux-headers-$(uname -r)
```

### 2.3 Verifica Sistema

```bash
# Verifica architettura (deve essere x86_64)
uname -m

# Verifica versione Ubuntu
lsb_release -a

# Verifica spazio disco
df -h /usr/local

# Verifica permessi USB
ls -la /dev/bus/usb/
```

---

## 3. IDENTIFICAZIONE DISPOSITIVO

### 3.1 Connessione Fisica

**⚠️ IMPORTANTE - Modalità di Alimentazione:**

1. **Modalità USB (Raccomandato):**
   - Collegare **SOLO** il cavo USB
   - Il dispositivo si alimenta direttamente dalla porta USB
   - **NON collegare alimentazione esterna** (causa errori di sistema)

2. **Modalità RS232:**
   - Collegare prima l'alimentatore DC 5V esterno
   - Verificare accensione LED rosso/blu
   - Poi collegare il cavo seriale RS232

**⚠️ ATTENZIONE**: Non mescolare mai le due modalità. Con connessione USB non usare mai alimentazione esterna, il sistema andrà in errore.

### 3.2 Verifica Riconoscimento

```bash
# Prima della connessione
lsusb > /tmp/usb_before.txt

# Collegare il dispositivo
echo "Collega ora il dispositivo CRT288x..."

# Dopo la connessione (attendere 5 secondi)
sleep 5
lsusb > /tmp/usb_after.txt

# Mostra nuovo dispositivo
echo "=== DISPOSITIVO RILEVATO ==="
diff /tmp/usb_before.txt /tmp/usb_after.txt

# Verifica specifica CRT288x
lsusb | grep -i "23d8:0285\|creator\|crt"

# Pulisci file temporanei
rm /tmp/usb_before.txt /tmp/usb_after.txt
```

**Output Atteso:**
```
Bus 001 Device 026: ID 23d8:0285 CREATOR(CHINA)TECH CO.,LTD CRT-285
```

### 3.3 Analisi Dettagliata Dispositivo

```bash
# Informazioni dettagliate dispositivo
lsusb -v -d 23d8:0285

# Controllo endpoints USB
sudo lsusb -v -d 23d8:0285 | grep -A 5 -B 5 "bEndpointAddress"

# Verifica configurazione USB
dmesg | tail -20
```

---

## 4. STRUTTURA DRIVER E FILE

### 4.1 Panoramica Pacchetti

Il software CRT288x viene distribuito nella struttura:

**Struttura directory principale:**
```
288K/
├── 288K-linux-sample/
│   └── 288K/                           # Codice esempio e test
│       ├── crt_288_test                # Eseguibile precompilato
│       ├── crt_288_test.c              # Programma di test
│       ├── crt_288_test.o              # File oggetto
│       ├── crt_288x_ur.h               # Header API
│       ├── crt_288x_ur.so              # Libreria locale
│       ├── libLoadCrt288lib.so         # Libreria caricamento dinamico
│       ├── LoadCrt288lib.c             # Caricatore dinamico
│       ├── LoadCrt288lib.h             # Header caricatore
│       ├── LoadCrt288lib.o             # File oggetto
│       ├── Makefile                    # Script compilazione x64
│       └── Makefile-arm                # Script compilazione ARM
├── linux_crt_288x/
│   └── drivers/                        # ← CARTELLA DRIVER PRINCIPALE
│       ├── libusb/
│       │   └── libusb-1.0.9.tar.bz2    # Dipendenza libusb
│       ├── x64/                        # ← DRIVER x64 (Ubuntu 22.04)
│       │   ├── crt_288x_ur.h           # Header API produzione
│       │   ├── crt_288x_ur.h(EN).txt   # Documentazione inglese
│       │   └── crt_288x_ur.so          # Libreria produzione 64-bit
│       └── x86/                        # Driver 32-bit (non usare)
│           ├── crt_288x_ur.h
│           ├── crt_288x_ur.h(EN).txt
│           └── crt_288x_ur.so
└── verifica_288x.sh                    # Script di verifica automatica
```

**Destinazione finale nel progetto:**
```
/opt/access_control/src/drivers/288K/
```

### 4.2 Identificazione Cartella Corrette

**Per Ubuntu 22.04 (64-bit) usare SEMPRE:**
```
📁 linux_crt_288x/drivers/x64/
```

**⚠️ NON usare:**
- Cartella `x86/` (architettura 32-bit)
- File dalla cartella `288K-linux-sample/288K/` per installazione sistema (solo per sviluppo/test)

### 4.3 File Essenziali

| File | Descrizione | Destinazione |
|------|-------------|--------------|
| `crt_288x_ur.so` | Libreria principale | `/usr/local/lib/` |
| `crt_288x_ur.h` | Header API | `/usr/local/include/` |
| `crt_288_test.c` | Codice test | Sviluppo |
| `LoadCrt288lib.c/h` | Caricamento dinamico | Sviluppo |

---

## 5. PROCEDURA DI INSTALLAZIONE

### 5.1 Installazione nel Progetto

```bash
# Installare nella directory del progetto
sudo mkdir -p /opt/access_control/src/drivers
sudo cp -r 288K/ /opt/access_control/src/drivers/

# Impostare proprietario e permessi
sudo chown -R $USER:$USER /opt/access_control/src/drivers/288K/
sudo chmod +x /opt/access_control/src/drivers/288K/verifica_288x.sh
```

### 5.2 Installazione Libreria Sistema

```bash
# Navigare nella cartella driver x64
cd linux_crt_288x/drivers/x64/

# Verificare presenza file
ls -la
# Output atteso:
# crt_288x_ur.h
# crt_288x_ur.h(EN).txt
# crt_288x_ur.so

# Installare libreria nel sistema
sudo cp crt_288x_ur.so /usr/local/lib/
sudo cp crt_288x_ur.h /usr/local/include/

# Impostare permessi corretti
sudo chmod 644 /usr/local/lib/crt_288x_ur.so
sudo chmod 644 /usr/local/include/crt_288x_ur.h

# Aggiornare cache librerie condivise
sudo ldconfig

# Verificare installazione
echo "=== VERIFICA INSTALLAZIONE ==="
ls -la /usr/local/lib/crt_288x_ur.so
ls -la /usr/local/include/crt_288x_ur.h
ldconfig -p | grep crt || echo "Libreria non nel cache (normale)"
```

### 5.3 Installazione Dipendenze libusb

**Opzione A: Usare versione sistema (Raccomandato)**
```bash
# Installare libusb dalla repository Ubuntu
sudo apt install -y libusb-1.0-0-dev

# Verificare installazione
pkg-config --modversion libusb-1.0
pkg-config --libs libusb-1.0
```

**Opzione B: Compilare versione specifica (Se necessario)**
```bash
# Solo se la versione sistema non funziona
cd "../libusb/libusb-1.0.9"

# Configurare e compilare
./configure --prefix=/usr/local
make
sudo make install
sudo ldconfig
```

### 5.4 Script di Installazione Automatica

```bash
#!/bin/bash
# install_crt288x.sh - Script di installazione automatica

set -e  # Exit on error

echo "=== INSTALLAZIONE CRT288x per Ubuntu 22.04 ==="
echo ""

# Verifica prerequisiti
echo "1. Verifica sistema..."
if [ "$(uname -m)" != "x86_64" ]; then
    echo "❌ ERRORE: Sistema non 64-bit"
    exit 1
fi

if ! command -v gcc &> /dev/null; then
    echo "❌ ERRORE: gcc non installato"
    echo "Esegui: sudo apt install build-essential"
    exit 1
fi

# Trova directory SDK
SDK_DIR=""
for dir in "CRT-288-K001 Linux SDK" "CRT-288-K001_Linux_SDK"; do
    if [ -d "$dir" ]; then
        SDK_DIR="$dir"
        break
    fi
done

if [ -z "$SDK_DIR" ]; then
    echo "❌ ERRORE: Directory SDK non trovata"
    echo "Estrai l'archivio CRT-288-K001 Linux SDK.zip"
    exit 1
fi

echo "✅ SDK trovato in: $SDK_DIR"

# Installazione libreria x64
echo ""
echo "2. Installazione libreria x64..."
X64_DIR="$SDK_DIR/linux-crt_288x_ur-09052016(RS232&USB)/x64"

if [ ! -d "$X64_DIR" ]; then
    echo "❌ ERRORE: Directory x64 non trovata"
    exit 1
fi

cd "$X64_DIR"

if [ ! -f "crt_288x_ur.so" ] || [ ! -f "crt_288x_ur.h" ]; then
    echo "❌ ERRORE: File essenziali mancanti in x64/"
    exit 1
fi

# Backup file esistenti
if [ -f "/usr/local/lib/crt_288x_ur.so" ]; then
    echo "⚠️  Backup libreria esistente..."
    sudo cp /usr/local/lib/crt_288x_ur.so /usr/local/lib/crt_288x_ur.so.backup
fi

# Installazione
sudo cp crt_288x_ur.so /usr/local/lib/
sudo cp crt_288x_ur.h /usr/local/include/
sudo chmod 644 /usr/local/lib/crt_288x_ur.so
sudo chmod 644 /usr/local/include/crt_288x_ur.h
sudo ldconfig

echo "✅ Libreria installata"

# Installazione dipendenze
echo ""
echo "3. Installazione dipendenze..."
sudo apt update
sudo apt install -y libusb-1.0-0-dev libudev-dev

echo "✅ Dipendenze installate"

# Configurazione utente
echo ""
echo "4. Configurazione utente..."
sudo usermod -a -G plugdev,dialout $USER

echo "✅ Utente aggiunto ai gruppi necessari"

# Configurazione udev
echo ""
echo "5. Configurazione regole udev..."
sudo tee /etc/udev/rules.d/99-crt288x.rules > /dev/null << EOF
# CRT288x Smart Card Reader
SUBSYSTEM=="usb", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", MODE="0666", GROUP="plugdev"
SUBSYSTEM=="usb_device", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", MODE="0666", GROUP="plugdev"
KERNEL=="ttyUSB*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev"
KERNEL=="ttyACM*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev"
EOF

sudo udevadm control --reload-rules
sudo udevadm trigger

echo "✅ Regole udev configurate"

# Preparazione ambiente test
echo ""
echo "6. Preparazione ambiente test..."
cd ../../
SAMPLE_DIR="288K-linux-sample source code"

if [ -d "$SAMPLE_DIR" ]; then
    # Crea directory test utente
    mkdir -p ~/crt288x-test
    cp "$SAMPLE_DIR"/* ~/crt288x-test/ 2>/dev/null || true
    cd ~/crt288x-test
    
    # Compila programma test
    if [ -f "Makefile" ]; then
        make clean 2>/dev/null || true
        if make; then
            echo "✅ Programma test compilato"
        else
            echo "⚠️  Compilazione test fallita"
        fi
    fi
else
    echo "⚠️  Directory sample non trovata"
fi

# Verifica finale
echo ""
echo "=== VERIFICA INSTALLAZIONE ==="
echo "Libreria installata:"
ls -la /usr/local/lib/crt_288x_ur.so 2>/dev/null && echo "✅ Libreria OK" || echo "❌ Libreria mancante"

echo "Header installato:"
ls -la /usr/local/include/crt_288x_ur.h 2>/dev/null && echo "✅ Header OK" || echo "❌ Header mancante"

echo "Dispositivo collegato:"
if lsusb | grep -q "23d8:0285"; then
    echo "✅ Dispositivo rilevato"
    lsusb | grep "23d8:0285"
else
    echo "⚠️  Dispositivo non rilevato (collegarlo se necessario)"
fi

echo ""
echo "=== INSTALLAZIONE COMPLETATA ==="
echo ""
echo "PROSSIMI PASSI:"
echo "1. Logout e login per applicare i gruppi utente"
echo "2. Collegare il dispositivo CRT288x"
echo "3. Testare con: cd ~/crt288x-test && ./crt_288_test"
echo ""
echo "Per sviluppo:"
echo "- Header API: /usr/local/include/crt_288x_ur.h"
echo "- Libreria: /usr/local/lib/crt_288x_ur.so"
echo "- Link con: -lcrt_288x_ur -L/usr/local/lib"
echo ""
```

---

## 6. CONFIGURAZIONE SISTEMA

### 6.1 Permessi Utente

```bash
# Aggiungere utente ai gruppi necessari
sudo usermod -a -G plugdev,dialout $USER

# Verificare appartenenza gruppi
groups $USER

# Applicare modifiche (logout/login richiesto)
echo "⚠️  IMPORTANTE: Eseguire logout/login per applicare i gruppi"
```

### 6.2 Regole udev

```bash
# Creare file regole udev
sudo nano /etc/udev/rules.d/99-crt288x.rules
```

**Contenuto file:**
```bash
# CRT288x Smart Card Reader Rules
# Vendor ID: 23d8, Product ID: 0285

# USB device rules
SUBSYSTEM=="usb", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"
SUBSYSTEM=="usb_device", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", MODE="0666", GROUP="plugdev"

# TTY device rules (for serial communication)
KERNEL=="ttyUSB*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"
KERNEL=="ttyACM*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"

# HID device rules (if applicable)
KERNEL=="hidraw*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"

# Alternative rules for different subsystems
SUBSYSTEMS=="usb", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev"
```

```bash
# Ricaricare regole udev
sudo udevadm control --reload-rules
sudo udevadm trigger

# Verificare regole
udevadm info -a -p $(udevadm info -q path -n /dev/bus/usb/001/026) | grep -i "23d8\|0285"
```

### 6.3 Configurazione Variabili Ambiente

```bash
# Aggiungere al ~/.bashrc
echo '# CRT288x Environment' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH' >> ~/.bashrc
echo 'export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH' >> ~/.bashrc
echo 'export C_INCLUDE_PATH=/usr/local/include:$C_INCLUDE_PATH' >> ~/.bashrc

# Ricaricare configurazione
source ~/.bashrc
```

### 6.4 Configurazione Sistemd (Opzionale)

Per applicazioni che richiedono avvio automatico:

```bash
# Creare servizio systemd
sudo nano /etc/systemd/system/crt288x-monitor.service
```

**Contenuto:**
```ini
[Unit]
Description=CRT288x Card Reader Monitor
After=multi-user.target
Wants=multi-user.target

[Service]
Type=simple
User=your_username
ExecStart=/usr/local/bin/crt288x-monitor
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

---

## 7. COMPILAZIONE E TEST

### 7.1 Preparazione Area Test

```bash
# Creare directory test
mkdir -p ~/crt288x-development
cd ~/crt288x-development

# Copiare file di esempio
cp "~/crt288x-install/CRT-288-K001 Linux SDK/288K-linux-sample source code"/* .

# Verificare file
ls -la
```

### 7.2 Compilazione Programma Test

```bash
# Pulire compilazioni precedenti
make clean 2>/dev/null || rm -f *.o crt_288_test 2>/dev/null

# Compilare usando Makefile
make

# Verificare eseguibile
ls -la crt_288_test
file crt_288_test
```

**Se make fallisce, compilazione manuale:**
```bash
# Compilare file oggetto
gcc -c crt_288_test.c -o crt_288_test.o -I/usr/local/include
gcc -c LoadCrt288lib.c -o LoadCrt288lib.o -I/usr/local/include

# Linkare eseguibile
gcc -o crt_288_test crt_288_test.o LoadCrt288lib.o -ldl -L/usr/local/lib

# Oppure compilazione diretta
gcc -o crt_288_test crt_288_test.c LoadCrt288lib.c -ldl -I/usr/local/include -L/usr/local/lib
```

### 7.3 Test Completo Dispositivo

#### 7.3.1 Preparazione Test

```bash
# Verificare dispositivo collegato
lsusb | grep "23d8:0285"
# Output atteso: Bus 001 Device XXX: ID 23d8:0285 CREATOR(CHINA)TECH CO.,LTD CRT-285

# Navigare nella directory test
cd 288K-linux-sample/288K/

# Verificare eseguibile compilato
ls -la crt_288_test
file crt_288_test

# Eseguire il programma di test
./crt_288_test
```

#### 7.3.2 Menu Programma Test

Il programma presenta questo menu interattivo:

```
==========Welcome to using crt_603_vx_test==========
	0:  quit.
	1:  Show menu .
	2:  Turn on the device .
	3:  Initialize and unlock .
	4:  Check status .
	5:  Lock card status .
	6:  Lock card .
	7:  Indicator operation .
	8:  Read all tracks .
	9:  Clear track information .
	10: Test contact IC card .
	11: Test contactless IC card .
Please select a test option :
```

#### 7.3.3 Sequenza Test Consigliata

**STEP 1: Connessione Dispositivo**
```bash
# Selezionare opzione: 2
Please select a test option : 2

# Selezionare modalità USB: 0
Please enter the open type, 0 to open in USB mode, 1 to open in COM port mode: 0

# Output atteso:
CRT288U_Open 
iGetLen:22
TempRecvBuf[2]:12
CRT288x_OpenConnection success!
```

**STEP 2: Inizializzazione**
```bash
# Selezionare opzione: 3
Please select a test option : 3

# Output atteso:
CRT288x_InitDev success!
```

**STEP 3: Test Status Carta**
```bash
# Selezionare opzione: 4 (ripetere per testare inserimento/rimozione carte)
Please select a test option : 4

# Output possibili:
No card                    # Nessuna carta
have card                  # Carta presente
```

**STEP 4: Test LED**
```bash
# Selezionare opzione: 7
Please select a test option : 7

# Output atteso:
CRT288x_LEDProcess success!
# I LED rosso e blu dovrebbero lampeggiare
```

**STEP 5: Test Carta Magnetica** (inserire carta con banda magnetica)
```bash
# Selezionare opzione: 8
Please select a test option : 8

# Output esempio:
CRT288x_ReadAllTracks success! 
	Track1: GRCMMM75D43C437UGRECO  MARIA EMMA
	Track2: 1234567890123456789
	Track3: 
```

**STEP 6: Test Carta IC/Chip** (inserire carta con chip)
```bash
# Selezionare opzione: 10
Please select a test option : 10

# Output esempio:
T=1 CPU Card
CRT288x_ChipPower success! 
ATR: 3b ff 18 00 00 81 31 fe 45 00 6b 05 05 91 20 01 f1 01 43 4e 53 10 31 80 38 03 d6 
CRT288x_ChipIO success! [00A4040007A0000000031010] 
Recv: 6a 82 03 25
```

**STEP 7: Test Carta Contactless** (avvicinare carta RFID/NFC)
```bash
# Selezionare opzione: 11
Please select a test option : 11

# Output varia in base al tipo di carta contactless
```

#### 7.3.4 Interpretazione Output

**Connessione Riuscita:**
- `CRT288x_OpenConnection success!`
- `iGetLen:22` - Lunghezza risposta dispositivo
- `TempRecvBuf[2]:12` - Codice risposta (esadecimale)

**Stati Carta:**
- `No card` - Nessuna carta nel lettore
- `have card` - Carta inserita correttamente

**Tipi Carte IC:**
- `T=0 CPU Card` - Carta CPU protocollo T=0
- `T=1 CPU Card` - Carta CPU protocollo T=1  
- `SL4442 Card` - Memory card SL4442
- `AT24C01 Card` - EEPROM AT24C01
- `Unknow IC Card` - Tipo non riconosciuto

**ATR (Answer To Reset):**
- Stringa esadecimale che identifica il tipo di carta chip
- Esempio: `3b ff 18 00 00...` 

**Comandi APDU:**
- `[00A4040007A0000000031010]` - Comando inviato alla carta
- `Recv: 6a 82 03 25` - Risposta della carta

#### 7.3.5 Risoluzione Problemi Test

**Errore Connessione:**
```bash
# Se ottieni errori di connessione:
CRT288x_OpenConnection Error iRet: -204

# Soluzioni:
1. Verificare dispositivo collegato: lsusb | grep "23d8:0285"
2. Controllare permessi utente: groups $USER
3. Verificare regole udev: cat /etc/udev/rules.d/99-crt288x.rules
4. Ricaricare regole: sudo udevadm control --reload-rules
```

**Problemi Lettura Carte:**
```bash
# Errori comuni lettura:
CRT288x_ReadAllTracks Error iRet: -221

# Soluzioni:
1. Pulire banda magnetica carta
2. Inserire carta completamente
3. Provare con carta diversa
4. Verificare che carta abbia banda magnetica
```

**Test Fallimento LED:**
```bash
# Se LED non si accendono:
1. Verificare alimentazione USB
2. Controllare connessione cavo
3. Verificare stato dispositivo con opzione 4
```

#### 7.3.6 Script Test Automatico

Per test automatizzati, creare script:

```bash
cat > test_automatico_crt288x.sh << 'EOF'
#!/bin/bash

echo "=== TEST AUTOMATICO CRT288x ==="

# Test connessione
echo "2" | timeout 10 ./crt_288_test | grep -q "success" && echo "✓ Connessione OK" || echo "✗ Connessione FAIL"

# Test inizializzazione  
echo -e "3\n0" | timeout 5 ./crt_288_test | grep -q "success" && echo "✓ Inizializzazione OK" || echo "✗ Inizializzazione FAIL"

# Test status
status_output=$(echo -e "4\n0" | timeout 5 ./crt_288_test)
if echo "$status_output" | grep -q "No card\|have card"; then
    echo "✓ Status check OK"
else
    echo "✗ Status check FAIL"
fi

echo "=== TEST COMPLETATO ==="
EOF

chmod +x test_automatico_crt288x.sh
./test_automatico_crt288x.sh
```

### 7.4 Test Avanzati

```bash
# Test con debugging
strace -e trace=openat,read,write ./crt_288_test

# Test memoria
valgrind ./crt_288_test

# Test prestazioni
time ./crt_288_test
```

---

## 8. SVILUPPO APPLICAZIONI

### 8.1 Template Applicazione C

```c
// crt288x_app_template.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "crt_288x_ur.h"

int main() {
    int result;
    
    printf("=== Applicazione CRT288x ===\n");
    
    // 1. Connessione dispositivo
    result = CRT288x_OpenConnection(0, 0, 9600);  // USB mode
    if (result != 0) {
        fprintf(stderr, "Errore connessione: %d\n", result);
        return 1;
    }
    printf("Dispositivo connesso\n");
    
    // 2. Inizializzazione
    result = CRT288x_InitDev(1);  // Unlock
    if (result != 0) {
        fprintf(stderr, "Errore inizializzazione: %d\n", result);
        CRT288x_CloseConnection();
        return 1;
    }
    printf("Dispositivo inizializzato\n");
    
    // 3. Loop principale applicazione
    while (1) {
        int card_status = CRT288x_GetCardStatus();
        
        switch (card_status) {
            case 1:  // No card
                break;
            case 2:  // Card at entrance
                printf("Carta rilevata all'ingresso\n");
                break;
            case 3:  // Card inside
                printf("Carta inserita\n");
                
                // Esempio lettura carta magnetica
                char track1[512], track2[512], track3[512];
                if (CRT288x_ReadAllTracks(track1, track2, track3) == 0) {
                    printf("Track 1: %s\n", track1);
                    printf("Track 2: %s\n", track2);
                    printf("Track 3: %s\n", track3);
                }
                
                // Esempio test carta IC
                int ic_type = CRT288x_GetICType();
                if (ic_type > 0) {
                    printf("Carta IC tipo: %d\n", ic_type);
                }
                
                break;
        }
        
        usleep(200000);  // 200ms delay
    }
    
    // 4. Cleanup
    CRT288x_CloseConnection();
    return 0;
}
```

### 8.2 Compilazione Template

```bash
# Compilare template
gcc -o crt288x_app crt288x_app_template.c -lcrt_288x_ur -L/usr/local/lib -I/usr/local/include

# Eseguire
./crt288x_app
```

### 8.3 Makefile per Sviluppo

```makefile
# Makefile per applicazioni CRT288x

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g
LDFLAGS = -L/usr/local/lib
LDLIBS = -lcrt_288x_ur -ldl
INCLUDES = -I/usr/local/include

# Targets
TARGETS = crt288x_app crt288x_test_simple

all: $(TARGETS)

crt288x_app: crt288x_app_template.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

crt288x_test_simple: crt288x_test_simple.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

%.o: %.c
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

clean:
	rm -f *.o $(TARGETS)

install: all
	sudo cp $(TARGETS) /usr/local/bin/

.PHONY: all clean install
```

### 8.4 Gestione Errori

```c
// Codici errore comuni
#define CRT_SUCCESS                  0
#define CRT_ERR_CMD                  -201
#define CRT_ERR_CMDPARAM             -202
#define CRT_ERR_DEVNOTSUP            -204
#define CRT_ERR_COMMTIMEOUT          -280

const char* crt_error_string(int error_code) {
    switch (error_code) {
        case CRT_SUCCESS: return "Success";
        case CRT_ERR_CMD: return "Command error";
        case CRT_ERR_CMDPARAM: return "Command parameter error";
        case CRT_ERR_DEVNOTSUP: return "Device not supported";
        case CRT_ERR_COMMTIMEOUT: return "Communication timeout";
        default: return "Unknown error";
    }
}

// Uso:
int result = CRT288x_OpenConnection(0, 0, 9600);
if (result != 0) {
    printf("Errore: %s (%d)\n", crt_error_string(result), result);
}
```

---

## 9. WRAPPER PYTHON

### 9.1 Installazione Wrapper

```bash
# Salvare wrapper Python
cd ~/crt288x-development
cat > crt288x_python.py << 'EOF'
#!/usr/bin/env python3
"""
CRT288x Python Wrapper - Versione Professionale
"""

import ctypes
import ctypes.util
import os
import sys
import time
from typing import Tuple, Optional, List, Union
from enum import IntEnum

class CardStatus(IntEnum):
    """Stati della carta"""
    NO_CARD = 1
    CARD_AT_ENTRANCE = 2
    CARD_INSIDE = 3
    DEVICE_OFFLINE = 9

class ICType(IntEnum):
    """Tipi di carte IC"""
    UNKNOWN = 0
    T0_CPU = 10
    T1_CPU = 11
    SL4442 = 20
    SL4428 = 21
    AT24C01 = 30
    AT24C02 = 31
    AT24C04 = 32
    AT24C08 = 33
    AT24C16 = 34
    AT24C32 = 35
    AT24C64 = 36

class LEDType(IntEnum):
    """Tipi LED"""
    RED = 0
    BLUE = 1
    ALL = 2

class LEDState(IntEnum):
    """Stati LED"""
    OFF = 0
    ON = 1
    FLASHING = 2

class CRT288xError(Exception):
    """Eccezione specifica per errori CRT288x"""
    pass

class CRT288x:
    """
    Wrapper Python professionale per CRT288x
    
    Esempio d'uso:
        with CRT288x() as device:
            if device.connect():
                status = device.get_card_status()
                if status == CardStatus.CARD_INSIDE:
                    tracks = device.read_magnetic_tracks()
    """
    
    def __init__(self, library_path: Optional[str] = None, debug: bool = False):
        self.lib = None
        self.is_connected = False
        self.debug = debug
        
        if library_path is None:
            library_path = self._find_library()
        
        self._load_library(library_path)
        self._setup_function_prototypes()
    
    def _find_library(self) -> str:
        """Trova la libreria CRT288x nel sistema"""
        search_paths = [
            '/usr/local/lib/libcrt_288x_ur.so',
            '/usr/lib/libcrt_288x_ur.so',
            './libcrt_288x_ur.so',
            './crt_288x_ur.so'
        ]
        
        for path in search_paths:
            if os.path.exists(path):
                if self.debug:
                    print(f"Libreria trovata: {path}")
                return path
        
        raise CRT288xError("Libreria CRT288x non trovata")
    
    def _load_library(self, path: str) -> None:
        """Carica la libreria condivisa"""
        try:
            self.lib = ctypes.CDLL(path)
            if self.debug:
                print(f"Libreria caricata: {path}")
        except OSError as e:
            raise CRT288xError(f"Errore caricamento libreria {path}: {e}")
    
    def _setup_function_prototypes(self) -> None:
        """Configura i prototipi delle funzioni C"""
        
        # CRT288x_OpenConnection
        self.lib.CRT288x_OpenConnection.argtypes = [
            ctypes.c_int, ctypes.c_int, ctypes.c_long
        ]
        self.lib.CRT288x_OpenConnection.restype = ctypes.c_int
        
        # CRT288x_CloseConnection
        self.lib.CRT288x_CloseConnection.argtypes = []
        self.lib.CRT288x_CloseConnection.restype = ctypes.c_int
        
        # CRT288x_InitDev
        self.lib.CRT288x_InitDev.argtypes = [ctypes.c_int]
        self.lib.CRT288x_InitDev.restype = ctypes.c_int
        
        # CRT288x_GetCardStatus
        self.lib.CRT288x_GetCardStatus.argtypes = []
        self.lib.CRT288x_GetCardStatus.restype = ctypes.c_int
        
        # CRT288x_GetICType
        self.lib.CRT288x_GetICType.argtypes = []
        self.lib.CRT288x_GetICType.restype = ctypes.c_int
        
        # CRT288x_LEDProcess
        self.lib.CRT288x_LEDProcess.argtypes = [ctypes.c_int, ctypes.c_int]
        self.lib.CRT288x_LEDProcess.restype = ctypes.c_int
        
        # CRT288x_ReadAllTracks
        self.lib.CRT288x_ReadAllTracks.argtypes = [
            ctypes.c_char_p, ctypes.c_char_p, ctypes.c_char_p
        ]
        self.lib.CRT288x_ReadAllTracks.restype = ctypes.c_int
    
    def connect(self, mode: int = 0, com_port: int = 0, baud_rate: int = 9600) -> bool:
        """
        Connette al dispositivo CRT288x
        
        Args:
            mode: 0 per USB, 1 per RS232
            com_port: Porta seriale (ignorata per USB)
            baud_rate: Velocità comunicazione
            
        Returns:
            True se connessione riuscita
            
        Raises:
            CRT288xError: Se connessione fallisce
        """
        result = self.lib.CRT288x_OpenConnection(mode, com_port, baud_rate)
        self.is_connected = (result == 0)
        
        if not self.is_connected:
            raise CRT288xError(f"Connessione fallita: codice errore {result}")
        
        if self.debug:
            print("Connessione stabilita")
        
        return True
    
    def disconnect(self) -> bool:
        """Disconnette dal dispositivo"""
        if not self.is_connected:
            return True
        
        result = self.lib.CRT288x_CloseConnection()
        self.is_connected = False
        
        if self.debug:
            print("Connessione chiusa")
        
        return result == 0
    
    def initialize(self, unlock: bool = True) -> bool:
        """
        Inizializza il dispositivo
        
        Args:
            unlock: True per sbloccare il meccanismo carte
            
        Returns:
            True se inizializzazione riuscita
        """
        if not self.is_connected:
            raise CRT288xError("Dispositivo non connesso")
        
        mode = 1 if unlock else 0
        result = self.lib.CRT288x_InitDev(mode)
        
        if result != 0:
            raise CRT288xError(f"Inizializzazione fallita: codice {result}")
        
        if self.debug:
            print("Dispositivo inizializzato")
        
        return True
    
    def get_card_status(self) -> CardStatus:
        """
        Ottiene lo stato della carta
        
        Returns:
            CardStatus enum value
        """
        if not self.is_connected:
            return CardStatus.DEVICE_OFFLINE
        
        status = self.lib.CRT288x_GetCardStatus()
        return CardStatus(status)
    
    def get_ic_type(self) -> ICType:
        """
        Ottiene il tipo di carta IC inserita
        
        Returns:
            ICType enum value
        """
        if not self.is_connected:
            raise CRT288xError("Dispositivo non connesso")
        
        ic_type = self.lib.CRT288x_GetICType()
        try:
            return ICType(ic_type)
        except ValueError:
            return ICType.UNKNOWN
    
    def control_led(self, led_type: LEDType, state: LEDState) -> bool:
        """
        Controlla i LED del dispositivo
        
        Args:
            led_type: Tipo di LED da controllare
            state: Stato desiderato del LED
            
        Returns:
            True se comando riuscito
        """
        if not self.is_connected:
            raise CRT288xError("Dispositivo non connesso")
        
        result = self.lib.CRT288x_LEDProcess(int(led_type), int(state))
        return result == 0
    
    def read_magnetic_tracks(self) -> Tuple[str, str, str]:
        """
        Legge tutte le tracce magnetiche
        
        Returns:
            Tupla (track1, track2, track3)
            
        Raises:
            CRT288xError: Se lettura fallisce
        """
        if not self.is_connected:
            raise CRT288xError("Dispositivo non connesso")
        
        # Crea buffer per le tracce
        track1_buf = ctypes.create_string_buffer(1024)
        track2_buf = ctypes.create_string_buffer(1024)
        track3_buf = ctypes.create_string_buffer(1024)
        
        result = self.lib.CRT288x_ReadAllTracks(
            track1_buf, track2_buf, track3_buf
        )
        
        if result != 0:
            raise CRT288xError(f"Lettura tracce fallita: codice {result}")
        
        # Decodifica dati
        track1 = track1_buf.value.decode('utf-8', errors='ignore').strip()
        track2 = track2_buf.value.decode('utf-8', errors='ignore').strip()
        track3 = track3_buf.value.decode('utf-8', errors='ignore').strip()
        
        return track1, track2, track3
    
    def wait_for_card(self, timeout: float = 30.0) -> bool:
        """
        Attende inserimento carta
        
        Args:
            timeout: Timeout in secondi
            
        Returns:
            True se carta inserita entro il timeout
        """
        start_time = time.time()
        
        while time.time() - start_time < timeout:
            if self.get_card_status() == CardStatus.CARD_INSIDE:
                return True
            time.sleep(0.1)
        
        return False
    
    def wait_for_card_removal(self, timeout: float = 30.0) -> bool:
        """
        Attende rimozione carta
        
        Args:
            timeout: Timeout in secondi
            
        Returns:
            True se carta rimossa entro il timeout
        """
        start_time = time.time()
        
        while time.time() - start_time < timeout:
            if self.get_card_status() == CardStatus.NO_CARD:
                return True
            time.sleep(0.1)
        
        return False
    
    def __enter__(self):
        """Context manager entry"""
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        """Context manager exit"""
        self.disconnect()

# Funzioni di utilità
def scan_for_devices() -> List[str]:
    """Scansiona dispositivi CRT288x collegati"""
    import subprocess
    
    try:
        result = subprocess.run(
            ['lsusb'], 
            capture_output=True, 
            text=True, 
            check=True
        )
        
        devices = []
        for line in result.stdout.split('\n'):
            if '23d8:0285' in line:
                devices.append(line.strip())
        
        return devices
    except subprocess.CalledProcessError:
        return []

def test_device_basic():
    """Test base del dispositivo"""
    print("=== Test Base CRT288x ===")
    
    # Cerca dispositivi
    devices = scan_for_devices()
    if not devices:
        print("❌ Nessun dispositivo CRT288x trovato")
        return False
    
    print(f"✅ Dispositivo trovato: {devices[0]}")
    
    try:
        with CRT288x(debug=True) as device:
            # Connetti
            device.connect()
            device.initialize()
            
            # Test LED
            print("Test LED...")
            device.control_led(LEDType.RED, LEDState.ON)
            time.sleep(1)
            device.control_led(LEDType.BLUE, LEDState.ON)
            time.sleep(1)
            device.control_led(LEDType.ALL, LEDState.OFF)
            
            # Test stato carta
            print("Controllo stato carta...")
            status = device.get_card_status()
            print(f"Stato: {status.name}")
            
            if status == CardStatus.CARD_INSIDE:
                print("Lettura carta...")
                try:
                    tracks = device.read_magnetic_tracks()
                    for i, track in enumerate(tracks, 1):
                        if track:
                            print(f"Track {i}: {track[:50]}...")
                except CRT288xError as e:
                    print(f"Errore lettura: {e}")
                
                # Test carta IC
                try:
                    ic_type = device.get_ic_type()
                    print(f"Tipo IC: {ic_type.name}")
                except CRT288xError as e:
                    print(f"Errore IC: {e}")
            
            print("✅ Test completato con successo")
            return True
            
    except CRT288xError as e:
        print(f"❌ Errore test: {e}")
        return False
    except Exception as e:
        print(f"❌ Errore imprevisto: {e}")
        return False

if __name__ == "__main__":
    test_device_basic()
EOF

# Rendere eseguibile
chmod +x crt288x_python.py
```

### 9.2 Test Wrapper Python

```bash
# Test base
python3 crt288x_python.py

# Test interattivo
python3 -c "
from crt288x_python import CRT288x
with CRT288x() as device:
    device.connect()
    device.initialize()
    print('Stato carta:', device.get_card_status().name)
"
```

---

## 10. RISOLUZIONE PROBLEMI

### 10.1 Problemi Comuni

**Problema: Dispositivo non riconosciuto**
```bash
# Verifica connessione fisica
lsusb | grep -i "23d8\|creator\|crt"

# Se non appare, verificare:
# 1. Cavo USB funzionante
# 2. Porta USB funzionante  
# 3. NON usare alimentazione esterna con USB (causa conflitti)
# 4. Per RS232: verificare alimentazione esterna 5V

# Test con dmesg
dmesg | tail -20

# Riprova connessione USB
sudo rmmod usbcore
sudo modprobe usbcore
```

**Problema: Permessi negati**
```bash
# Verificare gruppi utente
groups $USER

# Aggiungere ai gruppi mancanti
sudo usermod -a -G plugdev,dialout $USER

# Logout/login richiesto
# oppure
newgrp plugdev
```

**Problema: Libreria non trovata**
```bash
# Verificare installazione
ls -la /usr/local/lib/crt_288x_ur.so
ls -la /usr/local/include/crt_288x_ur.h

# Aggiornare cache
sudo ldconfig

# Verificare cache
ldconfig -p | grep crt

# Se mancante, reinstallare
sudo cp crt_288x_ur.so /usr/local/lib/
sudo ldconfig
```

**Problema: Compilazione fallisce**
```bash
# Verificare dipendenze
pkg-config --libs libusb-1.0
pkg-config --cflags libusb-1.0

# Installare se mancanti
sudo apt install libusb-1.0-0-dev

# Compilazione verbose
gcc -v -o test test.c -lcrt_288x_ur -L/usr/local/lib
```

### 10.2 Debug Avanzato

**Analisi comunicazione USB**
```bash
# Installare wireshark per USB
sudo apt install wireshark tshark

# Catturare traffico USB
sudo tshark -i usbmon1 -f "usb.device_address == 26"

# Oppure usare usbmon
sudo cat /sys/kernel/debug/usb/usbmon/1u
```

**Analisi chiamate sistema**
```bash
# Tracciare chiamate sistema
strace -e trace=openat,read,write,ioctl ./crt_288_test

# Tracciare solo USB
strace -e trace=ioctl ./crt_288_test 2>&1 | grep -i usb
```

**Test isolato libreria**
```bash
# Creare test minimo
cat > test_minimal.c << 'EOF'
#include <stdio.h>
#include <dlfcn.h>

int main() {
    void *lib = dlopen("/usr/local/lib/crt_288x_ur.so", RTLD_LAZY);
    if (!lib) {
        printf("Errore caricamento: %s\n", dlerror());
        return 1;
    }
    
    printf("Libreria caricata correttamente\n");
    dlclose(lib);
    return 0;
}
EOF

gcc -o test_minimal test_minimal.c -ldl
./test_minimal
```

### 10.3 Log e Diagnostica

**Abilitare log dettagliati**
```bash
# Creare script di diagnostica
cat > crt288x_diag.sh << 'EOF'
#!/bin/bash

echo "=== DIAGNOSTICA CRT288x ==="
echo "Data: $(date)"
echo "Sistema: $(uname -a)"
echo ""

echo "1. Dispositivi USB:"
lsusb | grep -E "(23d8|creator|crt|card|reader)" || echo "Nessun dispositivo trovato"
echo ""

echo "2. Moduli kernel USB:"
lsmod | grep usb
echo ""

echo "3. File dispositivo:"
ls -la /dev/bus/usb/001/ | grep -v "001"
echo ""

echo "4. Librerie installate:"
ls -la /usr/local/lib/crt*
ls -la /usr/local/include/crt*
echo ""

echo "5. Regole udev:"
cat /etc/udev/rules.d/99-crt288x.rules 2>/dev/null || echo "Regole non trovate"
echo ""

echo "6. Gruppi utente:"
groups $USER
echo ""

echo "7. Variabili ambiente:"
echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
echo ""

echo "8. Test libreria:"
if python3 -c "import ctypes; ctypes.CDLL('/usr/local/lib/crt_288x_ur.so')" 2>/dev/null; then
    echo "✅ Libreria caricabile"
else
    echo "❌ Problema caricamento libreria"
fi
echo ""

echo "=== FINE DIAGNOSTICA ==="
EOF

chmod +x crt288x_diag.sh
./crt288x_diag.sh
```

---

## 11. MANUTENZIONE

### 11.1 Aggiornamenti

**Backup configurazione corrente**
```bash
# Creare backup
mkdir -p ~/crt288x-backup/$(date +%Y%m%d)
cp /usr/local/lib/crt_288x_ur.so ~/crt288x-backup/$(date +%Y%m%d)/
cp /usr/local/include/crt_288x_ur.h ~/crt288x-backup/$(date +%Y%m%d)/
cp /etc/udev/rules.d/99-crt288x.rules ~/crt288x-backup/$(date +%Y%m%d)/
```

**Verifica integrità**
```bash
# Checksum file
md5sum /usr/local/lib/crt_288x_ur.so
sha256sum /usr/local/lib/crt_288x_ur.so

# Test funzionalità
python3 crt288x_python.py
```

### 11.2 Monitoraggio Sistema

**Script monitoraggio**
```bash
cat > crt288x_monitor.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/crt288x.log"
DEVICE_ID="23d8:0285"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

while true; do
    if lsusb | grep -q "$DEVICE_ID"; then
        if [ ! -f "/tmp/crt288x_connected" ]; then
            log_message "Dispositivo CRT288x connesso"
            touch "/tmp/crt288x_connected"
        fi
    else
        if [ -f "/tmp/crt288x_connected" ]; then
            log_message "Dispositivo CRT288x disconnesso"
            rm -f "/tmp/crt288x_connected"
        fi
    fi
    
    sleep 5
done
EOF

chmod +x crt288x_monitor.sh
```

### 11.3 Performance

**Ottimizzazioni sistema**
```bash
# Disabilitare autosuspend USB per il dispositivo
echo '23d8:0285' | sudo tee /sys/bus/usb/drivers/usb/new_id

# Aumentare priorità processo
nice -n -10 ./crt_288_test

# Configurazione udev per prestazioni
echo 'SUBSYSTEM=="usb", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", ATTR{power/autosuspend}="-1"' | \
sudo tee -a /etc/udev/rules.d/99-crt288x.rules
```

---

## 12. APPENDICI

### Appendice A: Codici Errore

| Codice | Descrizione | Soluzione |
|--------|-------------|-----------|
| -201 | Command error | Verificare formato comando |
| -202 | Command parameter error | Controllare parametri |
| -203 | Command cannot be executed | Verificare stato dispositivo |
| -204 | Hardware not supported | Controllare compatibilità |
| -280 | Communication timeout | Verificare connessione |

### Appendice B: Mapping GPIO (Se Applicabile)

| Pin | Funzione | Direzione |
|-----|----------|-----------|
| 1 | +5V | Alimentazione |
| 2 | GND | Massa |
| 3 | Data+ | I/O |
| 4 | Data- | I/O |

### Appendice C: Protocolli Supportati

**Carte Magnetiche:**
- ISO 7811-1/2/3
- Track 1: 76 caratteri max
- Track 2: 37 caratteri max  
- Track 3: 104 caratteri max

**Carte IC:**
- ISO 7816-1/2/3/4
- T=0, T=1 protocols
- Voltage: 1.8V, 3V, 5V
- Clock: 1-5 MHz

**RFID/NFC:**
- ISO 14443 Type A/B
- ISO 15693
- Frequency: 13.56 MHz

### Appendice D: Comandi APDU Comuni

```c
// Select Application
BYTE select_cmd[] = {0x00, 0xA4, 0x04, 0x00, 0x07, 0xA0, 0x00, 0x00, 0x00, 0x03, 0x10, 0x10};

// Get Response
BYTE get_response[] = {0x00, 0xC0, 0x00, 0x00, 0x00};

// Read Binary
BYTE read_binary[] = {0x00, 0xB0, 0x00, 0x00, 0x00};
```

### Appendice E: Risorse e Supporto

**Documentazione Ufficiale:**
- CRT288K001 V1.0 Specification.pdf
- CRT288K001 Communication Protocol.pdf

**Siti Web:**
- [CREATOR Tech Official](http://www.creator-china.com)
- [Ubuntu Documentation](https://help.ubuntu.com/)
- [libusb Documentation](https://libusb.sourceforge.io/)

**Community e Forum:**
- Stack Overflow: tag `smart-card`, `libusb`
- Ubuntu Forums: Hardware sezione
- GitHub: progetti open source correlati

---

**© 2025 - Manuale Tecnico CRT288x**  
**Versione 1.0 - Tutti i diritti riservati**

---

*Questo documento è stato creato per fornire una guida completa e professionale per l'installazione e configurazione del lettore smart card CRT288x su sistemi Ubuntu 22.04 LTS. Per aggiornamenti e supporto, consultare la documentazione ufficiale del produttore.*

```

---

## File: uso.md

**Percorso:** `drivers/288K/install/uso.md`
**Directory:** `drivers/288K/install`
**Dimensione:** 372 bytes
**Ultima modifica:** 2025-07-24 08:42:10
**Permessi:** 664

### Contenuto:

```text
📋 Opzioni Disponibili

./verifica_288x.sh --check      # Solo verifica
./verifica_288x.sh --install    # Solo installazione
./verifica_288x.sh --test       # Solo test
./verifica_288x.sh --compile    # Solo compilazione
./verifica_288x.sh --report     # Solo report
./verifica_288x.sh --auto       # Tutto automatico
./verifica_288x.sh              # Menù interattivo

```

---

## File: verifica_288x.sh

**Percorso:** `drivers/288K/install/verifica_288x.sh`
**Directory:** `drivers/288K/install`
**Dimensione:** 16452 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 775

### Contenuto:

```bash
#!/bin/bash

# verifica_288x.sh - Script di verifica e installazione CRT288x
# Versione: 2.0
# Compatibile con qualsiasi posizione della cartella 288K/

set -e  # Exit on error

# Colori per output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funzioni di utilità
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[✓]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[⚠]${NC} $1"
}

log_error() {
    echo -e "${RED}[✗]${NC} $1"
}

# Determina la directory dello script e trova la cartella 288K/
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_288K_DIR=""

# Funzione per trovare la cartella 288K
find_288k_directory() {
    log_info "Ricerca cartella 288K/ ..."
    
    # Lista delle possibili posizioni relative allo script
    local search_paths=(
        "$SCRIPT_DIR"                           # Stesso directory dello script
        "$SCRIPT_DIR/.."                        # Directory padre
        "$SCRIPT_DIR/../.."                     # Due livelli sopra
        "$SCRIPT_DIR/288K"                      # Sottodirectory
        "$(pwd)"                                # Directory corrente
        "$(pwd)/288K"                           # 288K nella directory corrente
        "/opt/access_control/src/drivers/288K"  # Posizione di destinazione
    )
    
    for path in "${search_paths[@]}"; do
        if [[ -d "$path/linux_crt_288x/drivers/x64" ]]; then
            BASE_288K_DIR="$(realpath "$path")"
            log_success "Cartella 288K trovata in: $BASE_288K_DIR"
            return 0
        elif [[ -d "$path/288K/linux_crt_288x/drivers/x64" ]]; then
            BASE_288K_DIR="$(realpath "$path/288K")"
            log_success "Cartella 288K trovata in: $BASE_288K_DIR"
            return 0
        fi
    done
    
    # Ricerca ricorsiva nell'albero delle directory
    log_info "Ricerca ricorsiva in corso..."
    local found_path
    found_path=$(find "$SCRIPT_DIR" -maxdepth 3 -type d -name "288K" 2>/dev/null | head -1)
    
    if [[ -n "$found_path" && -d "$found_path/linux_crt_288x/drivers/x64" ]]; then
        BASE_288K_DIR="$(realpath "$found_path")"
        log_success "Cartella 288K trovata ricorsivamente in: $BASE_288K_DIR"
        return 0
    fi
    
    log_error "Cartella 288K/ non trovata!"
    log_error "Assicurati che lo script sia posizionato correttamente rispetto alla struttura 288K/"
    return 1
}

# Verifica prerequisiti sistema
check_system_requirements() {
    log_info "Verifica prerequisiti sistema..."
    
    # Verifica architettura
    if [[ "$(uname -m)" != "x86_64" ]]; then
        log_error "Sistema non 64-bit ($(uname -m)). Richiesto x86_64."
        return 1
    fi
    log_success "Architettura x86_64 confermata"
    
    # Verifica Ubuntu/Debian
    if ! command -v lsb_release &> /dev/null; then
        log_warning "lsb_release non trovato, installo..."
        sudo apt update && sudo apt install -y lsb-release
    fi
    
    local os_info
    os_info=$(lsb_release -d 2>/dev/null || echo "Unknown")
    log_info "Sistema operativo: $os_info"
    
    # Verifica strumenti essenziali
    local required_tools=("gcc" "make" "lsusb" "ldconfig")
    for tool in "${required_tools[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            log_error "Strumento richiesto non trovato: $tool"
            log_info "Installa con: sudo apt install build-essential usbutils"
            return 1
        fi
    done
    log_success "Strumenti essenziali presenti"
    
    return 0
}

# Verifica dispositivo CRT288x
check_device_connection() {
    log_info "Verifica connessione dispositivo CRT288x..."
    
    if lsusb | grep -q "23d8:0285"; then
        local device_info
        device_info=$(lsusb | grep "23d8:0285")
        log_success "Dispositivo CRT288x rilevato:"
        echo "    $device_info"
        return 0
    else
        log_warning "Dispositivo CRT288x non rilevato"
        log_info "Verifica che il dispositivo sia:"
        log_info "  - Collegato via USB (senza alimentazione esterna)"
        log_info "  - Porta USB funzionante" 
        log_info "  - LED rosso/blu accesi"
        return 1
    fi
}

# Verifica struttura file 288K
verify_288k_structure() {
    log_info "Verifica struttura cartella 288K..."
    
    local required_files=(
        "linux_crt_288x/drivers/x64/crt_288x_ur.so"
        "linux_crt_288x/drivers/x64/crt_288x_ur.h"
        "288K-linux-sample/288K/crt_288_test.c"
        "288K-linux-sample/288K/Makefile"
    )
    
    for file in "${required_files[@]}"; do
        if [[ ! -f "$BASE_288K_DIR/$file" ]]; then
            log_error "File mancante: $file"
            return 1
        fi
    done
    
    log_success "Struttura 288K verificata"
    
    # Mostra informazioni sui file principali
    log_info "File driver x64:"
    ls -la "$BASE_288K_DIR/linux_crt_288x/drivers/x64/"
    
    return 0
}

# Installa libreria nel sistema
install_system_library() {
    log_info "Installazione libreria sistema..."
    
    local x64_dir="$BASE_288K_DIR/linux_crt_288x/drivers/x64"
    
    # Backup file esistenti
    if [[ -f "/usr/local/lib/crt_288x_ur.so" ]]; then
        log_warning "Backup libreria esistente..."
        sudo cp "/usr/local/lib/crt_288x_ur.so" "/usr/local/lib/crt_288x_ur.so.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # Installa file
    sudo cp "$x64_dir/crt_288x_ur.so" /usr/local/lib/
    sudo cp "$x64_dir/crt_288x_ur.h" /usr/local/include/
    
    # Imposta permessi
    sudo chmod 644 /usr/local/lib/crt_288x_ur.so
    sudo chmod 644 /usr/local/include/crt_288x_ur.h
    
    # Aggiorna cache librerie
    sudo ldconfig
    
    log_success "Libreria installata nel sistema"
    
    # Verifica installazione
    if [[ -f "/usr/local/lib/crt_288x_ur.so" ]] && [[ -f "/usr/local/include/crt_288x_ur.h" ]]; then
        log_success "Installazione verificata:"
        ls -la /usr/local/lib/crt_288x_ur.so
        ls -la /usr/local/include/crt_288x_ur.h
    else
        log_error "Installazione fallita"
        return 1
    fi
    
    return 0
}

# Configura permessi utente
configure_user_permissions() {
    log_info "Configurazione permessi utente..."
    
    # Verifica gruppi attuali
    local current_groups
    current_groups=$(groups "$USER")
    log_info "Gruppi attuali: $current_groups"
    
    # Aggiunge ai gruppi necessari se mancanti
    local groups_added=false
    
    if ! echo "$current_groups" | grep -q "plugdev"; then
        sudo usermod -a -G plugdev "$USER"
        groups_added=true
        log_success "Aggiunto al gruppo plugdev"
    fi
    
    if ! echo "$current_groups" | grep -q "dialout"; then
        sudo usermod -a -G dialout "$USER"
        groups_added=true
        log_success "Aggiunto al gruppo dialout"
    fi
    
    if $groups_added; then
        log_warning "IMPORTANTE: Eseguire logout/login per applicare i nuovi gruppi"
        log_info "Oppure eseguire: newgrp plugdev"
    else
        log_success "Permessi utente già configurati"
    fi
    
    return 0
}

# Configura regole udev
configure_udev_rules() {
    log_info "Configurazione regole udev..."
    
    local udev_file="/etc/udev/rules.d/99-crt288x.rules"
    
    if [[ -f "$udev_file" ]]; then
        log_info "Regole udev esistenti trovate, creo backup..."
        sudo cp "$udev_file" "${udev_file}.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # Crea regole udev
    sudo tee "$udev_file" > /dev/null << 'EOF'
# CRT288x Smart Card Reader - Auto-generated by verifica_288x.sh
# Vendor ID: 23d8, Product ID: 0285

# USB device rules
SUBSYSTEM=="usb", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"
SUBSYSTEM=="usb_device", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", MODE="0666", GROUP="plugdev"

# TTY device rules (for serial communication)
KERNEL=="ttyUSB*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"
KERNEL=="ttyACM*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"

# HID device rules (if applicable)  
KERNEL=="hidraw*", ATTRS{idVendor}=="23d8", ATTRS{idProduct}=="0285", MODE="0666", GROUP="plugdev", TAG+="uaccess"

# Power management - disable autosuspend
SUBSYSTEM=="usb", ATTR{idVendor}=="23d8", ATTR{idProduct}=="0285", ATTR{power/autosuspend}="-1"
EOF
    
    # Ricarica regole udev
    sudo udevadm control --reload-rules
    sudo udevadm trigger
    
    log_success "Regole udev configurate e ricaricate"
    
    return 0
}

# Installa dipendenze
install_dependencies() {
    log_info "Installazione dipendenze..."
    
    # Aggiorna repository
    sudo apt update
    
    # Lista dipendenze
    local dependencies=(
        "build-essential"
        "libusb-1.0-0-dev"
        "libudev-dev"
        "pkg-config"
        "python3"
        "python3-pip"
    )
    
    # Installa dipendenze mancanti
    local to_install=()
    for dep in "${dependencies[@]}"; do
        if ! dpkg -l | grep -q "^ii  $dep "; then
            to_install+=("$dep")
        fi
    done
    
    if [[ ${#to_install[@]} -gt 0 ]]; then
        log_info "Installazione dipendenze mancanti: ${to_install[*]}"
        sudo apt install -y "${to_install[@]}"
        log_success "Dipendenze installate"
    else
        log_success "Tutte le dipendenze già presenti"
    fi
    
    return 0
}

# Compila programma di test
compile_test_program() {
    log_info "Compilazione programma di test..."
    
    local sample_dir="$BASE_288K_DIR/288K-linux-sample/288K"
    
    if [[ ! -d "$sample_dir" ]]; then
        log_error "Directory sample non trovata: $sample_dir"
        return 1
    fi
    
    cd "$sample_dir"
    
    # Pulisci compilazioni precedenti
    make clean 2>/dev/null || rm -f *.o crt_288_test 2>/dev/null || true
    
    # Compila
    if make; then
        log_success "Programma test compilato con successo"
        
        # Verifica eseguibile
        if [[ -x "./crt_288_test" ]]; then
            log_success "Eseguibile crt_288_test pronto"
            ls -la ./crt_288_test
        else
            log_error "Eseguibile non trovato dopo compilazione"
            return 1
        fi
    else
        log_error "Compilazione fallita"
        log_info "Provo compilazione manuale..."
        
        # Compilazione manuale fallback
        if gcc -o crt_288_test crt_288_test.c LoadCrt288lib.c -ldl -I/usr/local/include -L/usr/local/lib; then
            log_success "Compilazione manuale riuscita"
        else
            log_error "Anche la compilazione manuale è fallita"
            return 1
        fi
    fi
    
    return 0
}

# Test funzionalità base
test_basic_functionality() {
    log_info "Test funzionalità base..."
    
    # Test caricamento libreria Python
    if python3 -c "
import ctypes
import sys
try:
    lib = ctypes.CDLL('/usr/local/lib/crt_288x_ur.so')
    print('✓ Libreria caricabile da Python')
    sys.exit(0)
except Exception as e:
    print(f'✗ Errore caricamento libreria: {e}')
    sys.exit(1)
" 2>/dev/null; then
        log_success "Libreria compatibile con Python"
    else
        log_warning "Problema caricamento libreria da Python"
    fi
    
    # Test simboli libreria
    if command -v nm &> /dev/null; then
        local symbol_count
        symbol_count=$(nm -D /usr/local/lib/crt_288x_ur.so 2>/dev/null | grep -c "CRT288x_" || echo "0")
        if [[ $symbol_count -gt 0 ]]; then
            log_success "Simboli CRT288x trovati nella libreria: $symbol_count"
        else
            log_warning "Nessun simbolo CRT288x trovato"
        fi
    fi
    
    return 0
}

# Genera report finale
generate_final_report() {
    log_info "Generazione report finale..."
    
    local report_file="/tmp/crt288x_verification_report_$(date +%Y%m%d_%H%M%S).txt"
    
    cat > "$report_file" << EOF
=================================================================
REPORT VERIFICA CRT288x
=================================================================
Data: $(date)
Script: $0
Directory 288K: $BASE_288K_DIR
Sistema: $(uname -a)
OS: $(lsb_release -d 2>/dev/null || echo "Sconosciuto")

DISPOSITIVO:
$(lsusb | grep "23d8:0285" || echo "Dispositivo non rilevato")

FILE INSTALLATI:
$(ls -la /usr/local/lib/crt_288x_ur.so 2>/dev/null || echo "Libreria non installata")
$(ls -la /usr/local/include/crt_288x_ur.h 2>/dev/null || echo "Header non installato")

REGOLE UDEV:
$(ls -la /etc/udev/rules.d/99-crt288x.rules 2>/dev/null || echo "Regole non configurate")

GRUPPI UTENTE:
$(groups "$USER")

LIBRERIE SISTEMA:
$(ldconfig -p | grep crt || echo "Nessuna libreria CRT nel cache")

DIPENDENZE:
$(pkg-config --modversion libusb-1.0 2>/dev/null || echo "libusb non configurata")

TEST COMPILAZIONE:
$(ls -la "$BASE_288K_DIR/288K-linux-sample/288K/crt_288_test" 2>/dev/null || echo "Test non compilato")

=================================================================
EOF
    
    log_success "Report salvato in: $report_file"
    log_info "Mostra contenuto con: cat $report_file"
    
    return 0
}

# Funzione principale
main() {
    echo -e "${BLUE}"
    echo "================================================================="
    echo "    SCRIPT VERIFICA E INSTALLAZIONE CRT288x v2.0"
    echo "    Compatible con qualsiasi posizione cartella 288K/"
    echo "================================================================="
    echo -e "${NC}"
    
    # Trova cartella 288K
    if ! find_288k_directory; then
        log_error "Impossibile continuare senza cartella 288K"
        exit 1
    fi
    
    # Menu opzioni
    if [[ $# -eq 0 ]]; then
        echo ""
        echo "Opzioni disponibili:"
        echo "  --check       : Solo verifica sistema e dispositivo"
        echo "  --install     : Installazione completa"
        echo "  --test        : Solo test funzionalità"
        echo "  --compile     : Solo compilazione programma test"
        echo "  --report      : Genera report dettagliato"
        echo "  --auto        : Installazione automatica completa"
        echo ""
        read -p "Seleziona opzione (o Enter per --auto): " option
        [[ -z "$option" ]] && option="--auto"
    else
        option="$1"
    fi
    
    case "$option" in
        --check)
            check_system_requirements
            verify_288k_structure
            check_device_connection
            ;;
        --install)
            check_system_requirements || exit 1
            verify_288k_structure || exit 1
            install_dependencies || exit 1
            install_system_library || exit 1
            configure_user_permissions
            configure_udev_rules || exit 1
            log_success "Installazione completata"
            ;;
        --test)
            test_basic_functionality
            check_device_connection
            ;;
        --compile)
            compile_test_program || exit 1
            ;;
        --report)
            generate_final_report
            ;;
        --auto)
            log_info "Installazione automatica completa..."
            check_system_requirements || exit 1
            verify_288k_structure || exit 1
            install_dependencies || exit 1
            install_system_library || exit 1
            configure_user_permissions
            configure_udev_rules || exit 1
            compile_test_program || exit 1
            test_basic_functionality
            check_device_connection
            generate_final_report
            
            echo ""
            log_success "=== INSTALLAZIONE COMPLETATA ==="
            echo ""
            log_info "PROSSIMI PASSI:"
            log_info "1. Logout/login se sono stati aggiunti gruppi utente"
            log_info "2. Collegare dispositivo CRT288x via USB (senza alimentazione esterna)"
            log_info "3. Testare con: cd $BASE_288K_DIR/288K-linux-sample/288K && ./crt_288_test"
            echo ""
            log_info "Per sviluppo:"
            log_info "- Header: /usr/local/include/crt_288x_ur.h"  
            log_info "- Libreria: /usr/local/lib/crt_288x_ur.so"
            log_info "- Link con: -lcrt_288x_ur -L/usr/local/lib -I/usr/local/include"
            ;;
        *)
            log_error "Opzione non riconosciuta: $option"
            exit 1
            ;;
    esac
    
    echo ""
    log_success "Script completato!"
}

# Esegui funzione principale
main "$@"

```

---

## File: crt_288x_ur.h

**Percorso:** `drivers/288K/linux_crt_288x/drivers/x64/crt_288x_ur.h`
**Directory:** `drivers/288K/linux_crt_288x/drivers/x64`
**Dimensione:** 17331 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```c
#ifndef __CRT_288K_UR__
#define __CRT_288K_UR__
#include <stdbool.h>

#define BYTE unsigned char
#define WORD unsigned short 
#define DWORD unsigned int

//Í¨Ñ¶Ð­Òé
#define ENQ  0x05
#define ACK  0x06
#define NAK  0x15
#define EOT  0x04
#define CAN  0x18
#define STX  0xF2
#define ETX  0x03
#define US   0x1F

//´íÎóÂë
#define CRT_ERRCOUNT                 -200
#define CRT_ERR_CMD                  (CRT_ERRCOUNT-1) //ÃüÁî×Ö´íÎó
#define CRT_ERR_CMDPARAM             (CRT_ERRCOUNT-2) //ÃüÁî²ÎÊý´íÎó
#define CRT_ERR_CMDDENIAL            (CRT_ERRCOUNT-3) //ÃüÁî²»ÄÜ±»Ö´ÐÐ
#define CRT_ERR_DEVNOTSUP            (CRT_ERRCOUNT-4) //Ó²¼þ²»Ö§³Ö
#define CRT_ERR_CMDDATA              (CRT_ERRCOUNT-5) //ÃüÁîÊý¾Ý´íÎó
#define CRT_ERR_LOCKCARD             (CRT_ERRCOUNT-11) //Ëø¿¨¹³²Ù×÷Ê§°Ü
#define CRT_ERR_EEPROM               (CRT_ERRCOUNT-15) //EEPROM error
#define CRT_ERR_TRACKCHECK           (CRT_ERRCOUNT-20) //¶Á´Å¿¨´í£¨Ð£Ñé´í£©
#define CRT_ERR_READTRACK            (CRT_ERRCOUNT-21) //¶Á´Å¿¨´í
#define CRT_ERR_POWERDOWN            (CRT_ERRCOUNT-30) //¿¨»úµôµç£¨Power down£©
#define CRT_ERR_ICPROCESS            (CRT_ERRCOUNT-41) //IC¿¨Ä£¿é²Ù×÷Ê§°Ü
#define CRT_ERR_ICPOWERSHORT         (CRT_ERRCOUNT-60) //IC¿¨µçÔ´¶ÌÂ·
#define CRT_ERR_ICACTIVATIONFAIL     (CRT_ERRCOUNT-61) //IC¿¨¼¤»îÊ§°Ü
#define CRT_ERR_ICDENIAL             (CRT_ERRCOUNT-62) //IC¿¨²»Ö§³Öµ±Ç°ÃüÁî
#define CRT_ERR_ICNOTRESPOND         (CRT_ERRCOUNT-63) //IC¿¨Í¨Ñ¶³ö´í
#define CRT_ERR_ICNOTRESPOND_OTHER   (CRT_ERRCOUNT-64) //IC¿¨Í¨Ñ¶³ö´í(ÆäËû)
#define CRT_ERR_ICNOTACTIVATION      (CRT_ERRCOUNT-65) //IC¿¨Î´¼¤»î
#define CRT_ERR_ICNOTSUP             (CRT_ERRCOUNT-66) //¿¨»ú²»Ö§³ÖÕâÖÖIC¿¨
#define CRT_ERR_ICEMV                (CRT_ERRCOUNT-66) //²»Ö§³ÖEMVÄ£Ê½
#define CRT_ERR_COMMTIMEOUT	         (CRT_ERRCOUNT-80) //Í¨Ñ¶Ê§°Ü³¬Ê±
#define CRT_ERR_CANCEL	             (CRT_ERRCOUNT-84) //ÃüÁîÈ¡Ïû
#define CRT_ERR_PWDPROCESS	         (CRT_ERRCOUNT-90) //Ð£ÑéÃÜÂë²Ù×÷Ê§°Ü
#define CRT_ERR_PWDCHECK	         (CRT_ERRCOUNT-91) //ÃÜÂëÐ£ÑéÊ§°Ü
#define CRT_ERR_PWDSCRAP	         (CRT_ERRCOUNT-92) //ÃÜÂëÐ£ÑéÊ§°Ü£¬¿¨ËøËÀ
#define CRT_ERR_PWDADDROVERFLOW	     (CRT_ERRCOUNT-93) //²Ù×÷µØÖ·Òç³ö
#define CRT_ERR_PWDLENOVERFLOW	     (CRT_ERRCOUNT-94) //²Ù×÷³¤¶ÈÒç³ö
#define CRT_ERR_PWDPMERR	         (CRT_ERRCOUNT-95) //PM ´íÎó
#define CRT_ERR_PWDCMERR	         (CRT_ERRCOUNT-96) //CM ´íÎó
#define CRT_ERR_UNKNOWN              (CRT_ERRCOUNT-99) //Î´Öª´íÎó

//´ò¿ªÉè±¸
#define CRT_OPEN_TYPEUSB             0 //USB¿Ú·½Ê½´ò¿ªÉè±¸
#define CRT_OPEN_TYPERS232           1 //RS232¿Ú·½Ê½´ò¿ªÉè±¸

//³õÊ¼»¯
#define CRT_INIT_NOTUNLOCK          0 //³õÊ¼»¯ÎÞ¶¯×÷
#define CRT_INIT_UNLOCK             1 //³õÊ¼»¯½âËø


//¿¨×´Ì¬
#define CRT_CARDST_NOCARD             1 //ÎÞ¿¨
#define CRT_CARDST_INDOOR             2 //¿¨¿Ú
#define CRT_CARDST_INSIDE             3 //¿¨ÄÚ
#define CRT_CARDST_UNKNOW             9 //Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª

//Ëø¿¨×´Ì¬
#define CRT_LOCKCARD_NOTLOCK            1 //Î´Ëø¿¨
#define CRT_LOCKCARD_LOCKED             2 //ÒÑËø¿¨
#define CRT_LOCKCARD_UNKNOW             9 //Éè±¸²»ÔÚÏß,Ëø¿¨×´Ì¬Î´Öª

//¶Á¿¨Æ÷¶¯×÷
#define CRT_RDACTION_NOACTION           0 //ÎÞ¶¯×÷
#define CRT_RDACTION_UNLOCK             1 //½âËø
#define CRT_RDACTION_LOCKED             2 //Ëø¿¨
#define CRT_RDACTION_AUTOLOCKED         3 //ÓÐ¿¨×Ô¶¯Ëø¿¨
#define CRT_RDACTION_NOTAUTOLOCK        4 //ÓÐ¿¨²»×Ô¶¯Ëø¿¨

//²Ù×÷Ö¸Ê¾µÆ
#define  CRT_LED_RED                    0 //²Ù×÷ºìÉ«Ö¸Ê¾µÆ
#define  CRT_LED_BLUE                   1 //²Ù×÷À¶É«Ö¸Ê¾µÆ
#define  CRT_LED_ALL                    2 //²Ù×÷ËùÓÐÖ¸Ê¾µÆ

//µÆ¿ØÖÆ
#define  CRT_LED_OFF                    0 //Ö¸Ê¾µÆ¹Ø±Õ
#define  CRT_LED_ON                     1 //Ö¸Ê¾µÆ´ò¿ª
#define  CRT_LED_FLASHING               2 //Ö¸Ê¾µÆÉÁË¸

//´ÅÌõ¿¨¶ÁÈ¡ÉèÖÃ
#define CRT_SETMAGTYPE_READASCII        0x00000000 //ÒÔASCIIÂë¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_READHEX          0x00000001 //ÒÔ¶þ½øÖÆ·½Ê½¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_AUTOUPLOAD       0x00000000 //Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_NOTUPLOAD        0x00000010 //½ûÖ¹Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_EFFINSERT        0x00000000 //²åÈë¶Á´ÅµÀÊý¾ÝÓÐÐ§
#define CRT_SETMAGTYPE_EFFUPPLUG        0x00000100 //°Î³ö¶Á´ÅµÀÊý¾ÝÓÐÐ§

//¶Á´ÅµÀÊý
#define CRT_ReadTracks_Track1           1 //´ÅµÀ1Êý¾Ý
#define CRT_ReadTracks_Track2           2 //´ÅµÀ2Êý¾Ý
#define CRT_ReadTracks_Track3           3 //´ÅµÀ3Êý¾Ý

/** 
 * @fn		CRT288x_OpenConnection() 
 * @detail	´ò¿ªÉè±¸
 * @see		...
 * @param	[in]iOpenMode--´ò¿ªÄ£Ê½:0 USBÁ¬½ÓÄ£Ê½£¬ 1 RS232Á¬½ÓÄ£Ê½
 * @param	[in]iComPort--ÉèÖÃCOM¿Ú(USBÄ£Ê½ÏÂ£¬ÎÞÐè´¦Àí)
 * @param	[in]lBaudRate--ÉèÖÃ²¨ÌØÂÊ(Ä¬ÈÏ 9600)
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó.
 * @exception ...
 * @example USBÁ¬½Ó£ºint iRet = CRT288x_OpenConnection(0); 
            COM3,²¨ÌØÂÊ9600 Á¬½Ó£ºint iRet = CRT288x_OpenConnection(1, 3, 9600);
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_OpenConnection(int iOpenMode, int iComPort, long lBaudRate);



/** 
 * @fn		CRT288x_CloseConnection() 
 * @detail	¹Ø±ÕÉè±¸
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 * @example int iRet = CRT288x_CloseConnection(); 
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_CloseConnection();



/** 
 * @fn		CRT288x_ExeCommand() 
 * @detail	·¢ËÍÖ´ÐÐÃüÁî
 * @see		...
 * @param	[in]iSendDataLen:·¢ËÍµÄÃüÁî³¤¶È
 * @param	[in]bySendData:·¢ËÍµÄÃüÁî
 * @param	[out]iRecvDataLen:·µ»ØµÄÃüÁî³¤¶È
 * @param	[out]byRecvData:·µ»ØµÄÃüÁî
 * @param	[out]byStCode:·µ»ØµÄÖ´ÐÐ×´Ì¬Âë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ExeCommand(int iSendDataLen, BYTE bySendData[] , int* iRecvDataLen, BYTE byRecvData[],BYTE byStCode[]);



/** 
 * @fn		CRT288x_InitDev() 
 * @detail	³õÊ¼»¯Éè±¸
 * @see		...
 * @param	[in]InitMode--³õÊ¼»¯Ä£Ê½:0 ÎÞ¶¯×÷£¬ 1 ½âËø
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_InitDev(int InitMode );


/** 
 * @fn		CRT288x_GetCardStatus() 
 * @detail	»ñÈ¡¿¨Æ¬×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 ÎÞ¿¨£¬2 ¿¨ÔÚ¿¨¿Ú£¬ 3 ¿¨ÔÚ¶Á¿¨Æ÷ÄÚ£¬ 9 Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardStatus();



/** 
 * @fn		CRT288x_GetLockStatus() 
 * @detail	»ñÈ¡Ëø¿¨×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 Î´Ëø¿¨£¬2 ÒÑËø¿¨£¬ 9 Éè±¸²»ÔÚÏß£¬Ëø¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetLockStatus();



/** 
 * @fn		CRT288x_LockedProcess() 
 * @detail	Ëø¿¨²Ù×÷
 * @see		...
 * @param	[in]iLockType--¿¨»úËø¿¨²Ù×÷:0 ÎÞ¶¯×÷£¬ 1 ½âËø£¬ 2 Ëø¿¨£¬ 3 ÓÐ¿¨×Ô¶¯Ëø¿¨£¬ 4 ÓÐ¿¨²»×Ô¶¯Ëø¿¨
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LockedProcess(int iLockType);



/** 
 * @fn		CRT288x_LEDProcess() 
 * @detail	Ö¸Ê¾µÆ²Ù×÷
 * @see		...
 * @param	[in]iLightType--²Ù×÷Ö¸Ê¾µÆ:0 ºìÉ«Ö¸Ê¾µÆ£¬1 À¶É«Ö¸Ê¾µÆ£¬ 2 ËùÓÐÖ¸Ê¾µÆ
 * @param	[in]iFlag--Ö¸Ê¾µÆ×´Ì¬:0 Ãð£¬1 ÁÁ£¬ 2 ÉÁË¸
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LEDProcess(int iLightType, int iFlag);



/** 
 * @fn		CRT288x_SetLEDFlashTime() 
 * @detail	ÉèÖÃÖ¸Ê¾µÆÉÁË¸Ê±¼ä
 * @see		...
 * @param	[in]iOnTime--Ö¸Ê¾µÆÉÁË¸ ÁÁÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @param	[in]iOffTime--Ö¸Ê¾µÆÉÁË¸ ÃðÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetLEDFlashTime(int iOnTime, int iOffTime);



/** 
 * @fn		CRT288x_SetReaderMagType() 
 * @detail	ÉèÖÃ¶Á¿¨Æ÷¶Á´Å¿¨·½Ê½
 * @see		...
 * @param	[in]iReadMode--¶Á¿¨·½Ê½: 0 ASCIIÂë¶Á¿¨Êý¾Ý£¬ 1 ¶þ½øÖÆÂë¶Á¿¨Êý¾Ý
 * @param	[in]iDataMode--Êý¾ÝÓÐÐ§·½Ê½: 0 ²å¿¨Êý¾ÝÓÐÐ§£¬ 1 °Î¿¨Êý¾ÝÓÐÐ§ 
  * @param	[in]bAutoUpload--ÊÇ·ñÖ÷¶¯ÉÏ´«: TRUE ÔÊÐíÖ÷¶¯ÉÏ´«£¬ FALSE ½ûÖ¹Ö÷¶¯ÉÏ´« 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetReaderMagType(int iReadMode, int iDataMode, bool bAutoUpload);



/** 
 * @fn		CRT288x_ReadTrack() 
 * @detail	¶Áµ¥´ÅµÀÊý¾Ý
 * @see		...
 * @param	[in]iTrackNum--´ÅµÀºÅ: 1 Ò»´ÅµÀ£¬ 2 ¶þ´ÅµÀ£¬ 3 Èý´ÅµÀ
 * @param	[out]szTrackData--·µ»Ø´ÅµÀÊý¾Ý 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadTrack(int iTrackNum, char szTrackData[]);




/** 
 * @fn		CRT288x_ReadAllTracks() 
 * @detail	¶ÁËùÓÐ´ÅµÀÊý¾Ý
 * @see		...
 * @param	[out]szTrack1Data--·µ»ØÒ»´ÅµÀÊý¾Ý
 * @param	[out]szTrack2Data--·µ»Ø¶þ´ÅµÀÊý¾Ý
 * @param	[out]szTrack3Data--·µ»ØÈý´ÅµÀÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadAllTracks(char szTrack1Data[], char szTrack2Data[], char szTrack3Data[]);



/** 
 * @fn		CRT288x_ClearTrackData() 
 * @detail	Çå³ý»º´æÇø´ÅµÀÊý¾Ý
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ClearTrackData();



/** 
 * @fn		CRT288x_GetICType() 
 * @detail	»ñÈ¡(½Ó´¥Ê½)IC¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªIC¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
                 33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨¡£ 
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetICType();



/** 
 * @fn		CRT288x_GetRFType() 
 * @detail	»ñÈ¡(·Ç½Ó´¥Ê½)RF¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªRF¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetRFType();



/** 
 * @fn		CRT288x_ChipPower() 
 * @detail	IC¿¨ÉÏµç²Ù×÷
 * @see		...
 * @param	[in]iICType--IC¿¨ÀàÐÍ:10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
							  33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨
							  110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨£¬ 210 SAM ¿¨¡£
 * @param	[in]wChipPower--ÉÏµç²Ù×÷: 0x02 Àä¸´Î»ÉÏµç£¬ 0x04 ÈÈ¸´Î»ÉÏµç£¬ 0x08 ÏÂµç¡£
 * @param	[out]byOutChipData--Àä¸´Î»·µ»ØATRÊý¾Ý
 * @param	[out]iOutChipDatalen--Àä¸´Î»·µ»ØATRÊý¾Ý³¤¶È
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipPower(int iICType, WORD wChipPower, BYTE byOutChipData[], int* iOutChipDatalen);




/** 
 * @fn		CRT288x_ChipIO() 
 * @detail	ÓëIC¿¨Ð¾Æ¬Í¨Ñ¶
 * @see		...
 * @param	[in]wChipProtocol--IC¿¨Í¨Ñ¶Ð­Òé: 0 ¶Á¿¨Æ÷×Ô¶¯Ñ¡ÔñÐ­Òé£¬1 T0Ð­Òé£¬ 2 T1Ð­Òé¡£
 * @param	[in]ulInChipDataLength--·¢ËÍAPDUÊý¾Ý³¤¶È¡£
 * @param	[in]lpInbChipData--·¢ËÍAPDUÊý¾Ý
 * @param	[out]ulOutChipDataLength--·µ»ØµÄAPDUÊý¾Ý³¤¶È
 * @param	[out]lpOutbChipData--·µ»ØµÄAPDUÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipIO(WORD wChipProtocol, int ulInChipDataLength , BYTE lpInbChipData[], int* ulOutChipDataLength , BYTE lpOutbChipData[]);




/** 
 * @fn		CRT288x_GetCardActiveStatus() 
 * @detail	²éÑ¯µ±Ç°ICÐ¾Æ¬µÄ¼¤»î×´Ì¬
 * @see		...
 * @return	½á¹û,1 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª3.57 MHZ£¬ 2 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª7.16 MHZ£¬ 3 Î´¼¤»î£¬ 9¼¤»î×´Ì¬Î´Öª£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardActiveStatus();




/** 
 * @fn		CRT288x_SAMSlotChange() 
 * @detail	SAM¿¨ÇÐ»»¿¨×ù
 * @see		...
 * @param	[in]iSamNum--ÐèÇÐ»»µÄ¿¨×ù(1-10) 1 SAM1¿¨×ù£¬ 2 SAM2¿¨×ù£¬ 3 SAM3¿¨×ù£¬ 4 SAM4¿¨×ù
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SAMSlotChange(int iSamNum);




/** 
 * @fn		CRT288x_SetVcc() 
 * @detail	ÉèÖÃÉÏµçVccÊôÐÔ
 * @see		...
 * @param	[in]iVcc--VccÊôÐÔ 1 5VµçÔ´£¬EMV·½Ê½¼¤»î£¬ 2 5VµçÔ´£¬ISO7816·½Ê½¼¤»î£¬ 3 3VµçÔ´£¬ISO7816·½Ê½¼¤»î
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetVcc(int iVcc);




/** 
 * @fn		CRT288x_SL4442CheckPasswd() 
 * @detail	SL4442¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4442¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó2 »òÐ¡ÓÚ2 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4442Process() 
 * @detail	SL4442¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø£¬ 3 °²È«Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0xFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-128£¬ ±£»¤Î»Çø£º0-4£¬ °²È«Çø£º0-4)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4428CheckPasswd() 
 * @detail	SL4428¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4428¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó7 »òÐ¡ÓÚ7 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_SL4428Process() 
 * @detail	SL4428¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0x01FF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-256£¬ ±£»¤Î»Çø£º0-128)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_24CxProcess() 
 * @detail	24Cx¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(24C01: 0x00-0x07F, 24C02: 0x00-0xFF, 24C04: 0x00-0x01FF, 24C08: 0x00-0x03FF, 24C16: 0x00-0x07FF,
                                 24C32: 0x00-0x0FFF, 24C64: 0x00-0x1FFF, 24C128: 0x00-0x3FFF, 24C256: 0x00-0x7FFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_24CxProcess(int iMode ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareKeyProcess() 
 * @detail	Mifare¿¨µÄÃÜÂë²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 Ð£ÑéÃÜÂë£¬ 2 ÏÂÔØÃÜÂëµ½EERPROM£¬ 3 ÐÞ¸ÄÃÜÂë
 * @param	[in]iKs--ÃÜÔ¿ÀàÐÍ    0 KeyA£¬ 1 KeyB
 * @param	[in]iSn--ÉÈÇøºÅ  (S50 card sn=00H-0FH, S70 card sn=00H-27H)
 * @param	[in][uDataLength--²Ù×÷µÄÃÜÂë³¤¶È
 * @param	[in]lpData--²Ù×÷µÄÃÜÂëÊý¾Ý(Ä¬ÈÏÃÜÂë£ºFFFFFFFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareKeyProcess(int iMode, int iKs, int iSn, int uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareCardProcess() 
 * @detail	Mifare¿¨²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶ÁÉÈÇø¿éÊý¾Ý£¬ 2 Ð´ÉÈÇø¿éÊý¾Ý£¬ 3 S50 S70 ³õÊ¼»¯£¬4 S50 S70 ¶ÁÓà¶î£¬ 5 S50 S70 ÔöÖµ£¬ 6 S50 S70 ¼õÖµ
 * @param	[in]iSn--ÉÈÇøºÅ  (Ultralight Card: iSn=00H-0FH, S50 card: iSn=00H-0FH, S70 card: iSn=00H-20H (iSn=21H-27H  S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iBn--²Ù×÷ÆðÊ¼¿éºÅ (Ultralight Card: iBn=00H, S50 card: iBn=00H-03H, S70 card: iBn=00H-03H  (iBn=00H-0FH   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iLc--²Ù×÷¿éÊýÄ¿ (Ultralight Card: iLc=01H-10H, S50 card: iLc=01H-04H, S70 card: iLc=01H-04H  (iLc=01H-10H   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(S50 S70 ³õÊ¼»¯£¬ÔöÖµ£¬¼õÖµÊ± Îª²Ù×÷µÄ½ð¶îÊý)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(ËùÓÐÐ´²Ù×÷ ÎªÊäÈë£¬ËùÓÐ¶Á²Ù×÷ ÎªÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareCardProcess(int iMode, int iSn, int iBn, int iLc, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288C_GetHidCardNums() 
 * @detail	»ñÈ¡Hid¿¨ºÅ
 * @see		...
 * @param	[out]szHidCardNums--»ñÈ¡µ½µÄHid¿¨ºÅ
 * @return ½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288C_GetHidCardNums(char szHidCardNums[]);



#endif 

```

---

## File: crt_288x_ur.h(EN).txt

**Percorso:** `drivers/288K/linux_crt_288x/drivers/x64/crt_288x_ur.h(EN).txt`
**Directory:** `drivers/288K/linux_crt_288x/drivers/x64`
**Dimensione:** 20101 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```text
#ifndef __CRT_288K_UR__
#define __CRT_288K_UR__
#include <stdbool.h>

#define BYTE unsigned char
#define WORD unsigned short 
#define DWORD unsigned int

//communication protocol
#define ENQ  0x05
#define ACK  0x06
#define NAK  0x15
#define EOT  0x04
#define CAN  0x18
#define STX  0xF2
#define ETX  0x03
#define US   0x1F

//error code
#define CRT_ERRCOUNT                 -200
#define CRT_ERR_CMD                  (CRT_ERRCOUNT-1) //command  charactor error
#define CRT_ERR_CMDPARAM             (CRT_ERRCOUNT-2) //command parameter error
#define CRT_ERR_CMDDENIAL            (CRT_ERRCOUNT-3) //command can't be executed
#define CRT_ERR_DEVNOTSUP            (CRT_ERRCOUNT-4) //hardware doesn't support
#define CRT_ERR_CMDDATA              (CRT_ERRCOUNT-5) //command data error
#define CRT_ERR_LOCKCARD             (CRT_ERRCOUNT-11) //fail to operate latch hook
#define CRT_ERR_EEPROM               (CRT_ERRCOUNT-15) //EEPROM error
#define CRT_ERR_TRACKCHECK           (CRT_ERRCOUNT-20) //read Mag-card error£¨parity error£©
#define CRT_ERR_READTRACK            (CRT_ERRCOUNT-21) //read Mag-card error
#define CRT_ERR_POWERDOWN            (CRT_ERRCOUNT-30) //ICRW power dump£¨Power down£©
#define CRT_ERR_ICPROCESS            (CRT_ERRCOUNT-41) //fail to operate IC card module
#define CRT_ERR_ICPOWERSHORT         (CRT_ERRCOUNT-60) //IC card power short cut
#define CRT_ERR_ICACTIVATIONFAIL     (CRT_ERRCOUNT-61) //IC card fail to activate 
#define CRT_ERR_ICDENIAL             (CRT_ERRCOUNT-62) //IC card doesn't support current command
#define CRT_ERR_ICNOTRESPOND         (CRT_ERRCOUNT-63) //IC card communication error
#define CRT_ERR_ICNOTRESPOND_OTHER   (CRT_ERRCOUNT-64) //IC card communicate error (other)
#define CRT_ERR_ICNOTACTIVATION      (CRT_ERRCOUNT-65) //IC card isn't activated
#define CRT_ERR_ICNOTSUP             (CRT_ERRCOUNT-66) //ICRW doesn't support this kind IC card
#define CRT_ERR_ICEMV                (CRT_ERRCOUNT-66) //no support EMV mode
#define CRT_ERR_COMMTIMEOUT	         (CRT_ERRCOUNT-80) //communication time out, failure
#define CRT_ERR_CANCEL	             (CRT_ERRCOUNT-84) //command cancel
#define CRT_ERR_PWDPROCESS	         (CRT_ERRCOUNT-90) //fail to operate parity password
#define CRT_ERR_PWDCHECK	         (CRT_ERRCOUNT-91) //faiure of parity password
#define CRT_ERR_PWDSCRAP	         (CRT_ERRCOUNT-92) //faiure of parity password£¬the card is locked
#define CRT_ERR_PWDADDROVERFLOW	     (CRT_ERRCOUNT-93) //operation address overflow
#define CRT_ERR_PWDLENOVERFLOW	     (CRT_ERRCOUNT-94) //operation Len overflow
#define CRT_ERR_PWDPMERR	         (CRT_ERRCOUNT-95) //PM error
#define CRT_ERR_PWDCMERR	         (CRT_ERRCOUNT-96) //CM error
#define CRT_ERR_UNKNOWN              (CRT_ERRCOUNT-99) //unknown error

//open device
#define CRT_OPEN_TYPEUSB             0 //USB to open
#define CRT_OPEN_TYPERS232           1 //RS232 to open

//initialization
#define CRT_INIT_NOTUNLOCK          0 //initialization no action
#define CRT_INIT_UNLOCK             1 //initialization unlock


//card status
#define CRT_CARDST_NOCARD             1 //no card
#define CRT_CARDST_INDOOR             2 //card insertion
#define CRT_CARDST_INSIDE             3 //card inside
#define CRT_CARDST_UNKNOW             9 //device is offline, the card status unknown

//card latch status
#define CRT_LOCKCARD_NOTLOCK            1 //no latch
#define CRT_LOCKCARD_LOCKED             2 //locked
#define CRT_LOCKCARD_UNKNOW             9 //device is offline, the card latch status unknown

//reader action
#define CRT_RDACTION_NOACTION           0 //no action
#define CRT_RDACTION_UNLOCK             1 //unlock
#define CRT_RDACTION_LOCKED             2 //card latch
#define CRT_RDACTION_AUTOLOCKED         3 //auto-latch with card
#define CRT_RDACTION_NOTAUTOLOCK        4 //no auto-latch with card

//operation LED 
#define  CRT_LED_RED                    0 //operation red indicator
#define  CRT_LED_BLUE                   1 //operation blue indicator
#define  CRT_LED_ALL                    2 //operation all indicators

//LED control
#define  CRT_LED_OFF                    0 //close
#define  CRT_LED_ON                     1 //open
#define  CRT_LED_FLASHING               2 //flash

//Mag-card reading position
#define CRT_SETMAGTYPE_READASCII        0x00000000 //reading with ASCII
#define CRT_SETMAGTYPE_READHEX          0x00000001 //read with binary
#define CRT_SETMAGTYPE_AUTOUPLOAD       0x00000000 //active to upload track data
#define CRT_SETMAGTYPE_NOTUPLOAD        0x00000010 //prohibit to active to upload track data
#define CRT_SETMAGTYPE_EFFINSERT        0x00000000 //data is valid when insert the card
#define CRT_SETMAGTYPE_EFFUPPLUG        0x00000100 //data is valid when pull the card

//read Mag-track
#define CRT_ReadTracks_Track1           1 //track 1 data
#define CRT_ReadTracks_Track2           2 //track 2 data
#define CRT_ReadTracks_Track3           3 //track 3 data

/** 
 * @fn		CRT288x_OpenConnection() 
 * @detail	open equipment
 * @see		...
 * @param	[in]iOpenMode--open mode:0 USB connection mode£¬ 1 RS232 mode
 * @param	[in]iComPort--set COM port (USB£¬no need set)
 * @param	[in]lBaudRate--set baudrate (default 9600)
 * @return	result,0: success£¬others: error.
 * @exception ...
 * @example USB connection£ºint iRet = CRT288x_OpenConnection(0); 
            COM3, baudrate:9600 connection£ºint iRet = CRT288x_OpenConnection(1, 3, 9600);
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_OpenConnection(int iOpenMode, int iComPort, long lBaudRate);



/** 
 * @fn		CRT288x_CloseConnection() 
 * @detail	close equipment
 * @see		...
 * @return	result,0: success£¬others: error.
 * @exception ...
 * @example int iRet = CRT288x_CloseConnection(); 
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_CloseConnection();



/** 
 * @fn		CRT288x_ExeCommand() 
 * @detail	send execution command
 * @see		...
 * @param	[in]iSendDataLen:sent command length
 * @param	[in]bySendData:sent command
 * @param	[out]iRecvDataLen:returned command length
 * @param	[out]byRecvData:returned command
 * @param	[out]byStCode:returned execution status code
 * @return	result,0: success£¬others: error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ExeCommand(int iSendDataLen, BYTE bySendData[] , int* iRecvDataLen, BYTE byRecvData[],BYTE byStCode[]);



/** 
 * @fn		CRT288x_InitDev() 
 * @detail	initialization of equipment
 * @see		...
 * @param	[in]InitMode--initialize mode:0 no action£¬ 1 unlock
 * @return	result,0: success£¬others: error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_InitDev(int InitMode );


/** 
 * @fn		CRT288x_GetCardStatus() 
  * @detail	get the card status
 * @see		...
 * @return	the card status: 1 no card£¬ 3 the card inside the reader£¬ 9 the machine offline£¬the card status unknown
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardStatus();



/** 
 * @fn		CRT288x_GetLockStatus() 
 * @detail	get card lock status
 * @see		...
 * @return	card status: 1 card unlock£¬2 card lock£¬ 9 decice not on-line£¬ card lock status unknown
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetLockStatus();



/** 
 * @fn		CRT288x_LockedProcess() 
 * @detail	lock operation
 * @see		...
 * @param	[in]iLockType--reader locks card operation:0 no action£¬ 1 unlock£¬ 2 card lock£¬ 3 auto-lock with card£¬ 4 don't auto-lock with card
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LockedProcess(int iLockType);



/** 
 * @fn		CRT288x_LEDProcess() 
 * @detail	indicator operation
 * @see		...
 * @param	[in]iLightType--operation indicator:0 red indicator£¬1 blue indicator£¬ 2 all indicator
 * @param	[in]iFlag--indicator status:0 dark£¬1 light£¬ 2 flash
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LEDProcess(int iLightType, int iFlag);



/** 
 * @fn		CRT288x_SetLEDFlashTime() 
  * @detail	set indicator flash time
 * @see		...
 * @param	[in]iOnTime--indicator flash, light time: £¨0x00-0xFF£©*0.25 sec
 * @param	[in]iOffTime--indicator flash, dark time: £¨0x00-0xFF£©*0.25 sec
 * @return	result,0 success£¬ others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetLEDFlashTime(int iOnTime, int iOffTime);



/** 
 * @fn		CRT288x_SetReaderMagType() 
 * @detail	set reader mag-stripe card reading method
 * @see		...
 * @param	[in]iReadMode--card read method: 0 ASCII data of card reading£¬ 1 bin data of card reading
 * @param	[in]iDataMode--data valid mode: 0 data valid when inserting the card£¬ 1 data valid when pulling the card 
  * @param	[in]bAutoUpload--data active uploading: TRUE allow to active uploading£¬ FALSE ban to active uploading 
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetReaderMagType(int iReadMode, int iDataMode, bool bAutoUpload);



/** 
 * @fn		CRT288x_ReadTrack() 
  * @detail	read single track data
 * @see		...
 * @param	[in]iTrackNum--track number: 1 track1£¬ 2 track2£¬ 3 track3
 * @param	[out]szTrackData--return tracks data 
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadTrack(int iTrackNum, char szTrackData[]);




/** 
 * @fn		CRT288x_ReadAllTracks() 
 * @detail	read all tracks data
 * @see		...
 * @param	[out]szTrack1Data--return track1 data
 * @param	[out]szTrack2Data--return track2 data
 * @param	[out]szTrack3Data--return track3 data
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadAllTracks(char szTrack1Data[], char szTrack2Data[], char szTrack3Data[]);



/** 
 * @fn		CRT288x_ClearTrackData() 
* @detail	clear tracks data in buffer 
 * @see		...
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ClearTrackData();



/** 
 * @fn		CRT288x_GetICType() 
 * @detail	get IC card type
 * @see		...
 * @return	result,0 S50, 1 S70, 2 UL card, 4 TYPEA CPU card£¬ 5 TYPEB CPU card£¬ 9 unknown RF type£¬ 10 T=0 contact CPU card£¬ 11 T=1 contact CPU card£¬ 20 24C01£¬ 21 24C02£¬22 24C04£¬ 23 24C08£¬ 24 24C16£¬ 25 24C32£¬ 26 24C64£¬ 30 SL4442£¬ SL4428, 98 no card£¬ 99 unknown card type£¬ other failure
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetICType();



/** 
 * @fn		CRT288x_GetRFType() 
 * @detail	get (contactless) RF card type
 * @see		...
 * @return	result,0: unknown RF card type£¬others: error£¬ 110 S50£¬ 111 S70£¬ 112 UL£¬ 120 TypeA CPU£¬ 130 TypeB CPU.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetRFType();



/** 
 * @fn		CRT288x_ChipPower() 
 * @detail	power on IC card to operate
 * @see		...
 * @param	[in]iICType--IC card type: 10 T=0 CPU£¬ 11 T=1 CPU£¬ 20 SL4442£¬ 21 SL4428£¬ 30 AT24C01£¬ 31 AT24C02£¬ 32 AT24C04£¬
							  33 AT24C08£¬ 34 AT24C16£¬ 35 AT24C32£¬ 36 AT24C64£¬ 37 AT24C128£¬ 38 AT24C256
							  110 S50£¬ 111 S70£¬ 112 UL£¬ 120 TypeA CPU£¬ 130 TypeB CPU£¬ 210 SAM .
 * @param	[in]wChipPower--power on to operate: 0x02 cold reset activate£¬ 0x04 warm reset activate£¬ 0x08 deactive
 * @param	[out]byOutChipData--cold reset to return ATR data
 * @param	[out]iOutChipDatalen--cold reset returning ATR data length
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipPower(int iICType, WORD wChipPower, BYTE byOutChipData[], int* iOutChipDatalen);




/** 
 * @fn		CRT288x_ChipIO() 
* @detail	communicate with IC card
 * @see		...
 * @param	[in]wChipProtocol--IC card communication protocol: 0 reader select protocol automatically£¬1 T0 protocol£¬ 2 T1 protocol.
 * @param	[in]ulInChipDataLength--send APDU data length.
 * @param	[in]lpInbChipData--send APDU data
 * @param	[out]ulOutChipDataLength--return APDU data length
 * @param	[out]lpOutbChipData--return APDU data
 * @return	result,0 success£¬ others error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipIO(WORD wChipProtocol, int ulInChipDataLength , BYTE lpInbChipData[], int* ulOutChipDataLength , BYTE lpOutbChipData[]);




/** 
 * @fn		CRT288x_GetCardActiveStatus() 
 * @detail	check current IC card activate status
 * @see		...
 * @return	result, 1 the card has been activated£¬current CPU card working clock frequence is 3.57 MHZ£¬ 2 the card has been activated£¬current CPU card working clock frequence is 7.16 MHZ£¬ 3 not activated£¬ 9 unknown activated status, others except 0 is error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardActiveStatus();




/** 
 * @fn		CRT288x_SAMSlotChange() 
* @detail	SAM card slot switching
 * @see		...
 * @param	[in]iSamNum--switched SAM slots (1-10) 1 SAM1£¬ 2 SAM2£¬ 3 SAM3£¬ 4 SAM4
 * @return	result, 0 success£¬others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SAMSlotChange(int iSamNum);




/** 
 * @fn		CRT288x_SetVcc() 
 * @detail	set Vcc attribute
 * @see		...
 * @param	[in]iVcc--Vcc attribute: 1 5V£¬EMV activate£¬ 2 5V£¬ISO7816 activate£¬ 3 3V£¬ISO7816 activate
 * @return	result, 0 success£¬ others except 0 is error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetVcc(int iVcc);




/** 
 * @fn		CRT288x_SL4442CheckPasswd() 
 * @detail	SL4442 card checking password
 * @see		...
 * @param	[in]iMode--operation mode: 1 checking password£¬ 2 modifying password
 * @param	[in]uDataLength--password length
 * @param	[in]lpData--checking password (default is£ºFFFFFF)
 * @return	result, 0 success£¬others except 0 is error.
 * @exception  note£ºuser must know the password previously modify the data of SLE4442 card£¬ password error counter value will be changed from 2 or less than 2 to 0,    when the counter value is 0, the card will collapse.
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4442Process() 
 * @detail	SL4442 read/write operation
 * @see		...
 * @param	[in]iMode--operation mode   1 read£¬ 2 write
 * @param	[in]iRegion--operation field   1 main memory, 2 protect bit area£¬ 3 security area
 * @param	[in]wStartAddr--start position (0x00-0xFF)
 * @param	[in][out]uDataLength--operation data length (main memory£º0-128£¬ protect bit area£º0-4£¬ security area£º0-4)
 * @param	[in][out]lpData--operation data (if the mode is writing, that means inputting. if the mode is reading, that means outputting.)
 * @return	result, 0 success, others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4428CheckPasswd() 
 * @detail	SL4442 card checking password
 * @see		...
 * @param	[in]iMode--operation mode: 1 checking password£¬ 2 modifying password
 * @param	[in]uDataLength--password length
 * @param	[in]lpData--checking password (default is£ºFFFFFF)
 * @return	result, 0 success£¬others except 0 is error.
 * @exception  note£ºuser must know the password previously modify the data of SLE4442 card£¬ password error counter value will be changed from 7 or less than 7 to 0,    when the counter value is 0, the card will collapse.
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_SL4428Process() 
 * @detail	SL4428 read/write operation
 * @see		...
 * @param	[in]iMode--operation mode   1 read£¬ 2 write
 * @param	[in]iRegion--operation field   1 main memory, 2 protect bit area£¬
 * @param	[in]wStartAddr--start position (0x00-0xFF)
 * @param	[in][out]uDataLength--operation data length (main memory£º0-256£¬ protect bit area£º0-128)
 * @param	[in][out]lpData--operation data (if the mode is writing, that means inputting. if the mode is reading, that means outputting.)
 * @return	result, 0 success, others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_24CxProcess() 
 * @detail	24Cxx card read/write 
 * @see		...
 * @param	[in]iMode--operation mode   1 read£¬ 2 write without parity, 3 write with parity
 * @param	[in]i24CxxType--24Cxx card type. 20 24C01card£¬ 21 24C02card£¬22 24C04card£¬ 23 24C08card£¬ 24 24C16card£¬ 25 24C32card£¬ 26 24C64card
 * @param	[in]wStartAddr--beginning position (24C01: 0x00-0x07F, 24C02: 0x00-0xFF, 24C04: 0x00-0x01FF, 24C08: 0x00-0x03FF, 24C16: 0x00-0x07FF,
                                 24C32: 0x00-0x0FFF, 24C64: 0x00-0x1FFF)
 * @param	[in][out]uDataLength--operational data length
 * @param	[in][out]lpData--operational data (the mode is 'writing', here inputting. the mode is 'reading', here outputting)
 * @return	result,0: success£¬others: error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_24CxProcess(int iMode ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareKeyProcess() 
 * @detail	Mifare card password operation
 * @see		...
 * @param	[in]iMode--operation mode   1 check password£¬ 2 download password to EERPROM£¬ 3 modify password
 * @param	[in]iKs--password type    0 KeyA£¬ 1 KeyB
 * @param	[in]iSn--sector number  (S50 card sn=00H-0FH, S70 card sn=00H-27H)
 * @param	[in][uDataLength--operation password length
 * @param	[in]lpData--operation password data (default£ºFFFFFFFFFFFF)
 * @return	result, 0 success£¬ others except 0 is error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareKeyProcess(int iMode, int iKs, int iSn, int uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareCardProcess() 
  * @detail	Mifare card operation
 * @see		...
 * @param	[in]iMode--operation mode   1 read sector block data£¬ 2 write sector block data£¬ 3 S50 S70 initialization£¬4 S50 S70 read balance£¬ 5 S50 S70 increment£¬ 6 S50 S70 decrement
 * @param	[in]iSn--sector number (Ultralight Card: iSn=00H-0FH, S50 card: iSn=00H-0FH, S70 card: iSn=00H-20H (iSn=21H-27H  S70 card has 16 blocks in every sector among final 8 sectors))
 * @param	[in]iBn--operate start block (Ultralight Card: iBn=00H, S50 card: iBn=00H-03H, S70 card: iBn=00H-03H  (iBn=00H-0FH   S70 card has 16 blocks in every sector among final 8 sectors))
 * @param	[in]iLc--operation block number (Ultralight Card: iLc=01H-10H, S50 card: iLc=01H-04H, S70 card: iLc=01H-04H  (iLc=01H-10H   S70 card has 16 blocks in every sector among final 8 sectors))
 * @param	[in][out]uDataLength--operation data length (S50 S70 initialization£¬when they do increment£¬decrement, those are amount)
 * @param	[in][out]lpData--operation data (all writing operation means input£¬all reading operation means output)
 * @return	result, 0 success£¬others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareCardProcess(int iMode, int iSn, int iBn, int iLc, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288C_GetHidCardNums() 
 * @detail	get Hid card number
 * @see		...
 * @param	[out]szHidCardNums--got Hid card number
 * @return      result, 0 success£¬others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288C_GetHidCardNums(char szHidCardNums[]);



#endif 

```

---

## File: crt_288x_ur.h

**Percorso:** `drivers/288K/linux_crt_288x/drivers/x86/crt_288x_ur.h`
**Directory:** `drivers/288K/linux_crt_288x/drivers/x86`
**Dimensione:** 17331 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```c
#ifndef __CRT_288K_UR__
#define __CRT_288K_UR__
#include <stdbool.h>

#define BYTE unsigned char
#define WORD unsigned short 
#define DWORD unsigned int

//Í¨Ñ¶Ð­Òé
#define ENQ  0x05
#define ACK  0x06
#define NAK  0x15
#define EOT  0x04
#define CAN  0x18
#define STX  0xF2
#define ETX  0x03
#define US   0x1F

//´íÎóÂë
#define CRT_ERRCOUNT                 -200
#define CRT_ERR_CMD                  (CRT_ERRCOUNT-1) //ÃüÁî×Ö´íÎó
#define CRT_ERR_CMDPARAM             (CRT_ERRCOUNT-2) //ÃüÁî²ÎÊý´íÎó
#define CRT_ERR_CMDDENIAL            (CRT_ERRCOUNT-3) //ÃüÁî²»ÄÜ±»Ö´ÐÐ
#define CRT_ERR_DEVNOTSUP            (CRT_ERRCOUNT-4) //Ó²¼þ²»Ö§³Ö
#define CRT_ERR_CMDDATA              (CRT_ERRCOUNT-5) //ÃüÁîÊý¾Ý´íÎó
#define CRT_ERR_LOCKCARD             (CRT_ERRCOUNT-11) //Ëø¿¨¹³²Ù×÷Ê§°Ü
#define CRT_ERR_EEPROM               (CRT_ERRCOUNT-15) //EEPROM error
#define CRT_ERR_TRACKCHECK           (CRT_ERRCOUNT-20) //¶Á´Å¿¨´í£¨Ð£Ñé´í£©
#define CRT_ERR_READTRACK            (CRT_ERRCOUNT-21) //¶Á´Å¿¨´í
#define CRT_ERR_POWERDOWN            (CRT_ERRCOUNT-30) //¿¨»úµôµç£¨Power down£©
#define CRT_ERR_ICPROCESS            (CRT_ERRCOUNT-41) //IC¿¨Ä£¿é²Ù×÷Ê§°Ü
#define CRT_ERR_ICPOWERSHORT         (CRT_ERRCOUNT-60) //IC¿¨µçÔ´¶ÌÂ·
#define CRT_ERR_ICACTIVATIONFAIL     (CRT_ERRCOUNT-61) //IC¿¨¼¤»îÊ§°Ü
#define CRT_ERR_ICDENIAL             (CRT_ERRCOUNT-62) //IC¿¨²»Ö§³Öµ±Ç°ÃüÁî
#define CRT_ERR_ICNOTRESPOND         (CRT_ERRCOUNT-63) //IC¿¨Í¨Ñ¶³ö´í
#define CRT_ERR_ICNOTRESPOND_OTHER   (CRT_ERRCOUNT-64) //IC¿¨Í¨Ñ¶³ö´í(ÆäËû)
#define CRT_ERR_ICNOTACTIVATION      (CRT_ERRCOUNT-65) //IC¿¨Î´¼¤»î
#define CRT_ERR_ICNOTSUP             (CRT_ERRCOUNT-66) //¿¨»ú²»Ö§³ÖÕâÖÖIC¿¨
#define CRT_ERR_ICEMV                (CRT_ERRCOUNT-66) //²»Ö§³ÖEMVÄ£Ê½
#define CRT_ERR_COMMTIMEOUT	         (CRT_ERRCOUNT-80) //Í¨Ñ¶Ê§°Ü³¬Ê±
#define CRT_ERR_CANCEL	             (CRT_ERRCOUNT-84) //ÃüÁîÈ¡Ïû
#define CRT_ERR_PWDPROCESS	         (CRT_ERRCOUNT-90) //Ð£ÑéÃÜÂë²Ù×÷Ê§°Ü
#define CRT_ERR_PWDCHECK	         (CRT_ERRCOUNT-91) //ÃÜÂëÐ£ÑéÊ§°Ü
#define CRT_ERR_PWDSCRAP	         (CRT_ERRCOUNT-92) //ÃÜÂëÐ£ÑéÊ§°Ü£¬¿¨ËøËÀ
#define CRT_ERR_PWDADDROVERFLOW	     (CRT_ERRCOUNT-93) //²Ù×÷µØÖ·Òç³ö
#define CRT_ERR_PWDLENOVERFLOW	     (CRT_ERRCOUNT-94) //²Ù×÷³¤¶ÈÒç³ö
#define CRT_ERR_PWDPMERR	         (CRT_ERRCOUNT-95) //PM ´íÎó
#define CRT_ERR_PWDCMERR	         (CRT_ERRCOUNT-96) //CM ´íÎó
#define CRT_ERR_UNKNOWN              (CRT_ERRCOUNT-99) //Î´Öª´íÎó

//´ò¿ªÉè±¸
#define CRT_OPEN_TYPEUSB             0 //USB¿Ú·½Ê½´ò¿ªÉè±¸
#define CRT_OPEN_TYPERS232           1 //RS232¿Ú·½Ê½´ò¿ªÉè±¸

//³õÊ¼»¯
#define CRT_INIT_NOTUNLOCK          0 //³õÊ¼»¯ÎÞ¶¯×÷
#define CRT_INIT_UNLOCK             1 //³õÊ¼»¯½âËø


//¿¨×´Ì¬
#define CRT_CARDST_NOCARD             1 //ÎÞ¿¨
#define CRT_CARDST_INDOOR             2 //¿¨¿Ú
#define CRT_CARDST_INSIDE             3 //¿¨ÄÚ
#define CRT_CARDST_UNKNOW             9 //Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª

//Ëø¿¨×´Ì¬
#define CRT_LOCKCARD_NOTLOCK            1 //Î´Ëø¿¨
#define CRT_LOCKCARD_LOCKED             2 //ÒÑËø¿¨
#define CRT_LOCKCARD_UNKNOW             9 //Éè±¸²»ÔÚÏß,Ëø¿¨×´Ì¬Î´Öª

//¶Á¿¨Æ÷¶¯×÷
#define CRT_RDACTION_NOACTION           0 //ÎÞ¶¯×÷
#define CRT_RDACTION_UNLOCK             1 //½âËø
#define CRT_RDACTION_LOCKED             2 //Ëø¿¨
#define CRT_RDACTION_AUTOLOCKED         3 //ÓÐ¿¨×Ô¶¯Ëø¿¨
#define CRT_RDACTION_NOTAUTOLOCK        4 //ÓÐ¿¨²»×Ô¶¯Ëø¿¨

//²Ù×÷Ö¸Ê¾µÆ
#define  CRT_LED_RED                    0 //²Ù×÷ºìÉ«Ö¸Ê¾µÆ
#define  CRT_LED_BLUE                   1 //²Ù×÷À¶É«Ö¸Ê¾µÆ
#define  CRT_LED_ALL                    2 //²Ù×÷ËùÓÐÖ¸Ê¾µÆ

//µÆ¿ØÖÆ
#define  CRT_LED_OFF                    0 //Ö¸Ê¾µÆ¹Ø±Õ
#define  CRT_LED_ON                     1 //Ö¸Ê¾µÆ´ò¿ª
#define  CRT_LED_FLASHING               2 //Ö¸Ê¾µÆÉÁË¸

//´ÅÌõ¿¨¶ÁÈ¡ÉèÖÃ
#define CRT_SETMAGTYPE_READASCII        0x00000000 //ÒÔASCIIÂë¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_READHEX          0x00000001 //ÒÔ¶þ½øÖÆ·½Ê½¶Á´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_AUTOUPLOAD       0x00000000 //Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_NOTUPLOAD        0x00000010 //½ûÖ¹Ö÷¶¯ÉÏ´«´ÅµÀÊý¾Ý
#define CRT_SETMAGTYPE_EFFINSERT        0x00000000 //²åÈë¶Á´ÅµÀÊý¾ÝÓÐÐ§
#define CRT_SETMAGTYPE_EFFUPPLUG        0x00000100 //°Î³ö¶Á´ÅµÀÊý¾ÝÓÐÐ§

//¶Á´ÅµÀÊý
#define CRT_ReadTracks_Track1           1 //´ÅµÀ1Êý¾Ý
#define CRT_ReadTracks_Track2           2 //´ÅµÀ2Êý¾Ý
#define CRT_ReadTracks_Track3           3 //´ÅµÀ3Êý¾Ý

/** 
 * @fn		CRT288x_OpenConnection() 
 * @detail	´ò¿ªÉè±¸
 * @see		...
 * @param	[in]iOpenMode--´ò¿ªÄ£Ê½:0 USBÁ¬½ÓÄ£Ê½£¬ 1 RS232Á¬½ÓÄ£Ê½
 * @param	[in]iComPort--ÉèÖÃCOM¿Ú(USBÄ£Ê½ÏÂ£¬ÎÞÐè´¦Àí)
 * @param	[in]lBaudRate--ÉèÖÃ²¨ÌØÂÊ(Ä¬ÈÏ 9600)
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó.
 * @exception ...
 * @example USBÁ¬½Ó£ºint iRet = CRT288x_OpenConnection(0); 
            COM3,²¨ÌØÂÊ9600 Á¬½Ó£ºint iRet = CRT288x_OpenConnection(1, 3, 9600);
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_OpenConnection(int iOpenMode, int iComPort, long lBaudRate);



/** 
 * @fn		CRT288x_CloseConnection() 
 * @detail	¹Ø±ÕÉè±¸
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 * @example int iRet = CRT288x_CloseConnection(); 
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_CloseConnection();



/** 
 * @fn		CRT288x_ExeCommand() 
 * @detail	·¢ËÍÖ´ÐÐÃüÁî
 * @see		...
 * @param	[in]iSendDataLen:·¢ËÍµÄÃüÁî³¤¶È
 * @param	[in]bySendData:·¢ËÍµÄÃüÁî
 * @param	[out]iRecvDataLen:·µ»ØµÄÃüÁî³¤¶È
 * @param	[out]byRecvData:·µ»ØµÄÃüÁî
 * @param	[out]byStCode:·µ»ØµÄÖ´ÐÐ×´Ì¬Âë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ExeCommand(int iSendDataLen, BYTE bySendData[] , int* iRecvDataLen, BYTE byRecvData[],BYTE byStCode[]);



/** 
 * @fn		CRT288x_InitDev() 
 * @detail	³õÊ¼»¯Éè±¸
 * @see		...
 * @param	[in]InitMode--³õÊ¼»¯Ä£Ê½:0 ÎÞ¶¯×÷£¬ 1 ½âËø
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_InitDev(int InitMode );


/** 
 * @fn		CRT288x_GetCardStatus() 
 * @detail	»ñÈ¡¿¨Æ¬×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 ÎÞ¿¨£¬2 ¿¨ÔÚ¿¨¿Ú£¬ 3 ¿¨ÔÚ¶Á¿¨Æ÷ÄÚ£¬ 9 Éè±¸²»ÔÚÏß£¬¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardStatus();



/** 
 * @fn		CRT288x_GetLockStatus() 
 * @detail	»ñÈ¡Ëø¿¨×´Ì¬
 * @see		...
 * @return	¿¨Æ¬×´Ì¬: 1 Î´Ëø¿¨£¬2 ÒÑËø¿¨£¬ 9 Éè±¸²»ÔÚÏß£¬Ëø¿¨×´Ì¬Î´Öª¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetLockStatus();



/** 
 * @fn		CRT288x_LockedProcess() 
 * @detail	Ëø¿¨²Ù×÷
 * @see		...
 * @param	[in]iLockType--¿¨»úËø¿¨²Ù×÷:0 ÎÞ¶¯×÷£¬ 1 ½âËø£¬ 2 Ëø¿¨£¬ 3 ÓÐ¿¨×Ô¶¯Ëø¿¨£¬ 4 ÓÐ¿¨²»×Ô¶¯Ëø¿¨
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LockedProcess(int iLockType);



/** 
 * @fn		CRT288x_LEDProcess() 
 * @detail	Ö¸Ê¾µÆ²Ù×÷
 * @see		...
 * @param	[in]iLightType--²Ù×÷Ö¸Ê¾µÆ:0 ºìÉ«Ö¸Ê¾µÆ£¬1 À¶É«Ö¸Ê¾µÆ£¬ 2 ËùÓÐÖ¸Ê¾µÆ
 * @param	[in]iFlag--Ö¸Ê¾µÆ×´Ì¬:0 Ãð£¬1 ÁÁ£¬ 2 ÉÁË¸
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LEDProcess(int iLightType, int iFlag);



/** 
 * @fn		CRT288x_SetLEDFlashTime() 
 * @detail	ÉèÖÃÖ¸Ê¾µÆÉÁË¸Ê±¼ä
 * @see		...
 * @param	[in]iOnTime--Ö¸Ê¾µÆÉÁË¸ ÁÁÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @param	[in]iOffTime--Ö¸Ê¾µÆÉÁË¸ ÃðÊ±¼ä: £¨0x00-0xFF£©*0.25Ãë
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetLEDFlashTime(int iOnTime, int iOffTime);



/** 
 * @fn		CRT288x_SetReaderMagType() 
 * @detail	ÉèÖÃ¶Á¿¨Æ÷¶Á´Å¿¨·½Ê½
 * @see		...
 * @param	[in]iReadMode--¶Á¿¨·½Ê½: 0 ASCIIÂë¶Á¿¨Êý¾Ý£¬ 1 ¶þ½øÖÆÂë¶Á¿¨Êý¾Ý
 * @param	[in]iDataMode--Êý¾ÝÓÐÐ§·½Ê½: 0 ²å¿¨Êý¾ÝÓÐÐ§£¬ 1 °Î¿¨Êý¾ÝÓÐÐ§ 
  * @param	[in]bAutoUpload--ÊÇ·ñÖ÷¶¯ÉÏ´«: TRUE ÔÊÐíÖ÷¶¯ÉÏ´«£¬ FALSE ½ûÖ¹Ö÷¶¯ÉÏ´« 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetReaderMagType(int iReadMode, int iDataMode, bool bAutoUpload);



/** 
 * @fn		CRT288x_ReadTrack() 
 * @detail	¶Áµ¥´ÅµÀÊý¾Ý
 * @see		...
 * @param	[in]iTrackNum--´ÅµÀºÅ: 1 Ò»´ÅµÀ£¬ 2 ¶þ´ÅµÀ£¬ 3 Èý´ÅµÀ
 * @param	[out]szTrackData--·µ»Ø´ÅµÀÊý¾Ý 
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadTrack(int iTrackNum, char szTrackData[]);




/** 
 * @fn		CRT288x_ReadAllTracks() 
 * @detail	¶ÁËùÓÐ´ÅµÀÊý¾Ý
 * @see		...
 * @param	[out]szTrack1Data--·µ»ØÒ»´ÅµÀÊý¾Ý
 * @param	[out]szTrack2Data--·µ»Ø¶þ´ÅµÀÊý¾Ý
 * @param	[out]szTrack3Data--·µ»ØÈý´ÅµÀÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadAllTracks(char szTrack1Data[], char szTrack2Data[], char szTrack3Data[]);



/** 
 * @fn		CRT288x_ClearTrackData() 
 * @detail	Çå³ý»º´æÇø´ÅµÀÊý¾Ý
 * @see		...
 * @return	½á¹û,0³É¹¦£¬·Ç0´íÎó
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ClearTrackData();



/** 
 * @fn		CRT288x_GetICType() 
 * @detail	»ñÈ¡(½Ó´¥Ê½)IC¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªIC¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
                 33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨¡£ 
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetICType();



/** 
 * @fn		CRT288x_GetRFType() 
 * @detail	»ñÈ¡(·Ç½Ó´¥Ê½)RF¿¨ÀàÐÍ
 * @see		...
 * @return	½á¹û,0 Î´ÖªRF¿¨ÀàÐÍ£¬·Ç0Ê§°Ü£¬ 110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetRFType();



/** 
 * @fn		CRT288x_ChipPower() 
 * @detail	IC¿¨ÉÏµç²Ù×÷
 * @see		...
 * @param	[in]iICType--IC¿¨ÀàÐÍ:10 T=0 CPU¿¨£¬ 11 T=1 CPU¿¨£¬ 20 SL4442¿¨£¬ 21 SL4428¿¨£¬ 30 AT24C01¿¨£¬ 31 AT24C02¿¨£¬ 32 AT24C04¿¨£¬
							  33 AT24C08¿¨£¬ 34 AT24C16¿¨£¬ 35 AT24C32¿¨£¬ 36 AT24C64¿¨£¬ 37 AT24C128¿¨£¬ 38 AT24C256¿¨
							  110 S50¿¨£¬ 111 S70¿¨£¬ 112 UL¿¨£¬ 120 TypeA CPU¿¨£¬ 130 TypeB CPU¿¨£¬ 210 SAM ¿¨¡£
 * @param	[in]wChipPower--ÉÏµç²Ù×÷: 0x02 Àä¸´Î»ÉÏµç£¬ 0x04 ÈÈ¸´Î»ÉÏµç£¬ 0x08 ÏÂµç¡£
 * @param	[out]byOutChipData--Àä¸´Î»·µ»ØATRÊý¾Ý
 * @param	[out]iOutChipDatalen--Àä¸´Î»·µ»ØATRÊý¾Ý³¤¶È
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipPower(int iICType, WORD wChipPower, BYTE byOutChipData[], int* iOutChipDatalen);




/** 
 * @fn		CRT288x_ChipIO() 
 * @detail	ÓëIC¿¨Ð¾Æ¬Í¨Ñ¶
 * @see		...
 * @param	[in]wChipProtocol--IC¿¨Í¨Ñ¶Ð­Òé: 0 ¶Á¿¨Æ÷×Ô¶¯Ñ¡ÔñÐ­Òé£¬1 T0Ð­Òé£¬ 2 T1Ð­Òé¡£
 * @param	[in]ulInChipDataLength--·¢ËÍAPDUÊý¾Ý³¤¶È¡£
 * @param	[in]lpInbChipData--·¢ËÍAPDUÊý¾Ý
 * @param	[out]ulOutChipDataLength--·µ»ØµÄAPDUÊý¾Ý³¤¶È
 * @param	[out]lpOutbChipData--·µ»ØµÄAPDUÊý¾Ý
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipIO(WORD wChipProtocol, int ulInChipDataLength , BYTE lpInbChipData[], int* ulOutChipDataLength , BYTE lpOutbChipData[]);




/** 
 * @fn		CRT288x_GetCardActiveStatus() 
 * @detail	²éÑ¯µ±Ç°ICÐ¾Æ¬µÄ¼¤»î×´Ì¬
 * @see		...
 * @return	½á¹û,1 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª3.57 MHZ£¬ 2 ¿¨Æ¬ÒÑ¼¤»î£¬µ±Ç°CPU ¿¨¹¤×÷Ê±ÖÓÆµÂÊÎª7.16 MHZ£¬ 3 Î´¼¤»î£¬ 9¼¤»î×´Ì¬Î´Öª£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardActiveStatus();




/** 
 * @fn		CRT288x_SAMSlotChange() 
 * @detail	SAM¿¨ÇÐ»»¿¨×ù
 * @see		...
 * @param	[in]iSamNum--ÐèÇÐ»»µÄ¿¨×ù(1-10) 1 SAM1¿¨×ù£¬ 2 SAM2¿¨×ù£¬ 3 SAM3¿¨×ù£¬ 4 SAM4¿¨×ù
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SAMSlotChange(int iSamNum);




/** 
 * @fn		CRT288x_SetVcc() 
 * @detail	ÉèÖÃÉÏµçVccÊôÐÔ
 * @see		...
 * @param	[in]iVcc--VccÊôÐÔ 1 5VµçÔ´£¬EMV·½Ê½¼¤»î£¬ 2 5VµçÔ´£¬ISO7816·½Ê½¼¤»î£¬ 3 3VµçÔ´£¬ISO7816·½Ê½¼¤»î
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetVcc(int iVcc);




/** 
 * @fn		CRT288x_SL4442CheckPasswd() 
 * @detail	SL4442¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4442¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó2 »òÐ¡ÓÚ2 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4442Process() 
 * @detail	SL4442¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø£¬ 3 °²È«Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0xFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-128£¬ ±£»¤Î»Çø£º0-4£¬ °²È«Çø£º0-4)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4428CheckPasswd() 
 * @detail	SL4428¿¨µÄÐ£ÑéÃÜÂë
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½ 1 Ð£ÑéÃÜÂë£¬ 2 ÐÞ¸ÄÃÜÂë
 * @param	[in]uDataLength--ÃÜÂëµÄ³¤¶È
 * @param	[in]lpData--Ð£ÑéµÄÃÜÂë(Ä¬ÈÏÃÜÂë£ºFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ×¢Òâ£ºÓÃ»§Òª¸ÄÐ´SLE4428¿¨Êý¾Ý±ØÐëÖªµÀ¿¨µÄÃÜÂë£¬ÃÜÂë´íÎó¼ÆÊýÆ÷Öµ»á´Ó7 »òÐ¡ÓÚ7 µÄÖµÖ±ÖÁ¸´Î»³ÉÁã£¬µ±´íÎó¼ÆÊýÖµÎª
 * ÁãÊ±£¬¿¨Æ¬ËøËÀ±¨·Ï¡£
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_SL4428Process() 
 * @detail	SL4428¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]iRegion--²Ù×÷ÇøÓò   1 Ö÷´æ´¢Çø£¬ 2 ±£»¤Î»Çø
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(0x00-0x01FF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(Ö÷´æ´¢Çø£º0-256£¬ ±£»¤Î»Çø£º0-128)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_24CxProcess() 
 * @detail	24Cx¿¨µÄ¶ÁÐ´²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶Á£¬ 2 Ð´
 * @param	[in]wStartAddr--ÆðÊ¼Î»ÖÃ(24C01: 0x00-0x07F, 24C02: 0x00-0xFF, 24C04: 0x00-0x01FF, 24C08: 0x00-0x03FF, 24C16: 0x00-0x07FF,
                                 24C32: 0x00-0x0FFF, 24C64: 0x00-0x1FFF, 24C128: 0x00-0x3FFF, 24C256: 0x00-0x7FFF)
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(Ä£Ê½ÎªÐ´£¬´ËÊäÈë¡£ Ä£Ê½Îª¶Á£¬ ´ËÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_24CxProcess(int iMode ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareKeyProcess() 
 * @detail	Mifare¿¨µÄÃÜÂë²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 Ð£ÑéÃÜÂë£¬ 2 ÏÂÔØÃÜÂëµ½EERPROM£¬ 3 ÐÞ¸ÄÃÜÂë
 * @param	[in]iKs--ÃÜÔ¿ÀàÐÍ    0 KeyA£¬ 1 KeyB
 * @param	[in]iSn--ÉÈÇøºÅ  (S50 card sn=00H-0FH, S70 card sn=00H-27H)
 * @param	[in][uDataLength--²Ù×÷µÄÃÜÂë³¤¶È
 * @param	[in]lpData--²Ù×÷µÄÃÜÂëÊý¾Ý(Ä¬ÈÏÃÜÂë£ºFFFFFFFFFFFF)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareKeyProcess(int iMode, int iKs, int iSn, int uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareCardProcess() 
 * @detail	Mifare¿¨²Ù×÷
 * @see		...
 * @param	[in]iMode--²Ù×÷Ä£Ê½   1 ¶ÁÉÈÇø¿éÊý¾Ý£¬ 2 Ð´ÉÈÇø¿éÊý¾Ý£¬ 3 S50 S70 ³õÊ¼»¯£¬4 S50 S70 ¶ÁÓà¶î£¬ 5 S50 S70 ÔöÖµ£¬ 6 S50 S70 ¼õÖµ
 * @param	[in]iSn--ÉÈÇøºÅ  (Ultralight Card: iSn=00H-0FH, S50 card: iSn=00H-0FH, S70 card: iSn=00H-20H (iSn=21H-27H  S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iBn--²Ù×÷ÆðÊ¼¿éºÅ (Ultralight Card: iBn=00H, S50 card: iBn=00H-03H, S70 card: iBn=00H-03H  (iBn=00H-0FH   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in]iLc--²Ù×÷¿éÊýÄ¿ (Ultralight Card: iLc=01H-10H, S50 card: iLc=01H-04H, S70 card: iLc=01H-04H  (iLc=01H-10H   S70 card ÔÚ×îºó8 ¸öÉÈÇøÖÐÊÇÃ¿Ò»¸öÉÈÇøÊÇ16 ¿é))
 * @param	[in][out]uDataLength--²Ù×÷µÄÊý¾Ý³¤¶È(S50 S70 ³õÊ¼»¯£¬ÔöÖµ£¬¼õÖµÊ± Îª²Ù×÷µÄ½ð¶îÊý)
 * @param	[in][out]lpData--²Ù×÷µÄÊý¾Ý(ËùÓÐÐ´²Ù×÷ ÎªÊäÈë£¬ËùÓÐ¶Á²Ù×÷ ÎªÊä³ö)
 * @return	½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareCardProcess(int iMode, int iSn, int iBn, int iLc, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288C_GetHidCardNums() 
 * @detail	»ñÈ¡Hid¿¨ºÅ
 * @see		...
 * @param	[out]szHidCardNums--»ñÈ¡µ½µÄHid¿¨ºÅ
 * @return ½á¹û,0³É¹¦£¬·Ç0Ê§°Ü¡£
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288C_GetHidCardNums(char szHidCardNums[]);



#endif 

```

---

## File: crt_288x_ur.h(EN).txt

**Percorso:** `drivers/288K/linux_crt_288x/drivers/x86/crt_288x_ur.h(EN).txt`
**Directory:** `drivers/288K/linux_crt_288x/drivers/x86`
**Dimensione:** 20101 bytes
**Ultima modifica:** 2025-07-24 08:24:38
**Permessi:** 644

### Contenuto:

```text
#ifndef __CRT_288K_UR__
#define __CRT_288K_UR__
#include <stdbool.h>

#define BYTE unsigned char
#define WORD unsigned short 
#define DWORD unsigned int

//communication protocol
#define ENQ  0x05
#define ACK  0x06
#define NAK  0x15
#define EOT  0x04
#define CAN  0x18
#define STX  0xF2
#define ETX  0x03
#define US   0x1F

//error code
#define CRT_ERRCOUNT                 -200
#define CRT_ERR_CMD                  (CRT_ERRCOUNT-1) //command  charactor error
#define CRT_ERR_CMDPARAM             (CRT_ERRCOUNT-2) //command parameter error
#define CRT_ERR_CMDDENIAL            (CRT_ERRCOUNT-3) //command can't be executed
#define CRT_ERR_DEVNOTSUP            (CRT_ERRCOUNT-4) //hardware doesn't support
#define CRT_ERR_CMDDATA              (CRT_ERRCOUNT-5) //command data error
#define CRT_ERR_LOCKCARD             (CRT_ERRCOUNT-11) //fail to operate latch hook
#define CRT_ERR_EEPROM               (CRT_ERRCOUNT-15) //EEPROM error
#define CRT_ERR_TRACKCHECK           (CRT_ERRCOUNT-20) //read Mag-card error£¨parity error£©
#define CRT_ERR_READTRACK            (CRT_ERRCOUNT-21) //read Mag-card error
#define CRT_ERR_POWERDOWN            (CRT_ERRCOUNT-30) //ICRW power dump£¨Power down£©
#define CRT_ERR_ICPROCESS            (CRT_ERRCOUNT-41) //fail to operate IC card module
#define CRT_ERR_ICPOWERSHORT         (CRT_ERRCOUNT-60) //IC card power short cut
#define CRT_ERR_ICACTIVATIONFAIL     (CRT_ERRCOUNT-61) //IC card fail to activate 
#define CRT_ERR_ICDENIAL             (CRT_ERRCOUNT-62) //IC card doesn't support current command
#define CRT_ERR_ICNOTRESPOND         (CRT_ERRCOUNT-63) //IC card communication error
#define CRT_ERR_ICNOTRESPOND_OTHER   (CRT_ERRCOUNT-64) //IC card communicate error (other)
#define CRT_ERR_ICNOTACTIVATION      (CRT_ERRCOUNT-65) //IC card isn't activated
#define CRT_ERR_ICNOTSUP             (CRT_ERRCOUNT-66) //ICRW doesn't support this kind IC card
#define CRT_ERR_ICEMV                (CRT_ERRCOUNT-66) //no support EMV mode
#define CRT_ERR_COMMTIMEOUT	         (CRT_ERRCOUNT-80) //communication time out, failure
#define CRT_ERR_CANCEL	             (CRT_ERRCOUNT-84) //command cancel
#define CRT_ERR_PWDPROCESS	         (CRT_ERRCOUNT-90) //fail to operate parity password
#define CRT_ERR_PWDCHECK	         (CRT_ERRCOUNT-91) //faiure of parity password
#define CRT_ERR_PWDSCRAP	         (CRT_ERRCOUNT-92) //faiure of parity password£¬the card is locked
#define CRT_ERR_PWDADDROVERFLOW	     (CRT_ERRCOUNT-93) //operation address overflow
#define CRT_ERR_PWDLENOVERFLOW	     (CRT_ERRCOUNT-94) //operation Len overflow
#define CRT_ERR_PWDPMERR	         (CRT_ERRCOUNT-95) //PM error
#define CRT_ERR_PWDCMERR	         (CRT_ERRCOUNT-96) //CM error
#define CRT_ERR_UNKNOWN              (CRT_ERRCOUNT-99) //unknown error

//open device
#define CRT_OPEN_TYPEUSB             0 //USB to open
#define CRT_OPEN_TYPERS232           1 //RS232 to open

//initialization
#define CRT_INIT_NOTUNLOCK          0 //initialization no action
#define CRT_INIT_UNLOCK             1 //initialization unlock


//card status
#define CRT_CARDST_NOCARD             1 //no card
#define CRT_CARDST_INDOOR             2 //card insertion
#define CRT_CARDST_INSIDE             3 //card inside
#define CRT_CARDST_UNKNOW             9 //device is offline, the card status unknown

//card latch status
#define CRT_LOCKCARD_NOTLOCK            1 //no latch
#define CRT_LOCKCARD_LOCKED             2 //locked
#define CRT_LOCKCARD_UNKNOW             9 //device is offline, the card latch status unknown

//reader action
#define CRT_RDACTION_NOACTION           0 //no action
#define CRT_RDACTION_UNLOCK             1 //unlock
#define CRT_RDACTION_LOCKED             2 //card latch
#define CRT_RDACTION_AUTOLOCKED         3 //auto-latch with card
#define CRT_RDACTION_NOTAUTOLOCK        4 //no auto-latch with card

//operation LED 
#define  CRT_LED_RED                    0 //operation red indicator
#define  CRT_LED_BLUE                   1 //operation blue indicator
#define  CRT_LED_ALL                    2 //operation all indicators

//LED control
#define  CRT_LED_OFF                    0 //close
#define  CRT_LED_ON                     1 //open
#define  CRT_LED_FLASHING               2 //flash

//Mag-card reading position
#define CRT_SETMAGTYPE_READASCII        0x00000000 //reading with ASCII
#define CRT_SETMAGTYPE_READHEX          0x00000001 //read with binary
#define CRT_SETMAGTYPE_AUTOUPLOAD       0x00000000 //active to upload track data
#define CRT_SETMAGTYPE_NOTUPLOAD        0x00000010 //prohibit to active to upload track data
#define CRT_SETMAGTYPE_EFFINSERT        0x00000000 //data is valid when insert the card
#define CRT_SETMAGTYPE_EFFUPPLUG        0x00000100 //data is valid when pull the card

//read Mag-track
#define CRT_ReadTracks_Track1           1 //track 1 data
#define CRT_ReadTracks_Track2           2 //track 2 data
#define CRT_ReadTracks_Track3           3 //track 3 data

/** 
 * @fn		CRT288x_OpenConnection() 
 * @detail	open equipment
 * @see		...
 * @param	[in]iOpenMode--open mode:0 USB connection mode£¬ 1 RS232 mode
 * @param	[in]iComPort--set COM port (USB£¬no need set)
 * @param	[in]lBaudRate--set baudrate (default 9600)
 * @return	result,0: success£¬others: error.
 * @exception ...
 * @example USB connection£ºint iRet = CRT288x_OpenConnection(0); 
            COM3, baudrate:9600 connection£ºint iRet = CRT288x_OpenConnection(1, 3, 9600);
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_OpenConnection(int iOpenMode, int iComPort, long lBaudRate);



/** 
 * @fn		CRT288x_CloseConnection() 
 * @detail	close equipment
 * @see		...
 * @return	result,0: success£¬others: error.
 * @exception ...
 * @example int iRet = CRT288x_CloseConnection(); 
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_CloseConnection();



/** 
 * @fn		CRT288x_ExeCommand() 
 * @detail	send execution command
 * @see		...
 * @param	[in]iSendDataLen:sent command length
 * @param	[in]bySendData:sent command
 * @param	[out]iRecvDataLen:returned command length
 * @param	[out]byRecvData:returned command
 * @param	[out]byStCode:returned execution status code
 * @return	result,0: success£¬others: error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ExeCommand(int iSendDataLen, BYTE bySendData[] , int* iRecvDataLen, BYTE byRecvData[],BYTE byStCode[]);



/** 
 * @fn		CRT288x_InitDev() 
 * @detail	initialization of equipment
 * @see		...
 * @param	[in]InitMode--initialize mode:0 no action£¬ 1 unlock
 * @return	result,0: success£¬others: error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288x_InitDev(int InitMode );


/** 
 * @fn		CRT288x_GetCardStatus() 
  * @detail	get the card status
 * @see		...
 * @return	the card status: 1 no card£¬ 3 the card inside the reader£¬ 9 the machine offline£¬the card status unknown
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardStatus();



/** 
 * @fn		CRT288x_GetLockStatus() 
 * @detail	get card lock status
 * @see		...
 * @return	card status: 1 card unlock£¬2 card lock£¬ 9 decice not on-line£¬ card lock status unknown
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetLockStatus();



/** 
 * @fn		CRT288x_LockedProcess() 
 * @detail	lock operation
 * @see		...
 * @param	[in]iLockType--reader locks card operation:0 no action£¬ 1 unlock£¬ 2 card lock£¬ 3 auto-lock with card£¬ 4 don't auto-lock with card
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LockedProcess(int iLockType);



/** 
 * @fn		CRT288x_LEDProcess() 
 * @detail	indicator operation
 * @see		...
 * @param	[in]iLightType--operation indicator:0 red indicator£¬1 blue indicator£¬ 2 all indicator
 * @param	[in]iFlag--indicator status:0 dark£¬1 light£¬ 2 flash
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_LEDProcess(int iLightType, int iFlag);



/** 
 * @fn		CRT288x_SetLEDFlashTime() 
  * @detail	set indicator flash time
 * @see		...
 * @param	[in]iOnTime--indicator flash, light time: £¨0x00-0xFF£©*0.25 sec
 * @param	[in]iOffTime--indicator flash, dark time: £¨0x00-0xFF£©*0.25 sec
 * @return	result,0 success£¬ others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetLEDFlashTime(int iOnTime, int iOffTime);



/** 
 * @fn		CRT288x_SetReaderMagType() 
 * @detail	set reader mag-stripe card reading method
 * @see		...
 * @param	[in]iReadMode--card read method: 0 ASCII data of card reading£¬ 1 bin data of card reading
 * @param	[in]iDataMode--data valid mode: 0 data valid when inserting the card£¬ 1 data valid when pulling the card 
  * @param	[in]bAutoUpload--data active uploading: TRUE allow to active uploading£¬ FALSE ban to active uploading 
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetReaderMagType(int iReadMode, int iDataMode, bool bAutoUpload);



/** 
 * @fn		CRT288x_ReadTrack() 
  * @detail	read single track data
 * @see		...
 * @param	[in]iTrackNum--track number: 1 track1£¬ 2 track2£¬ 3 track3
 * @param	[out]szTrackData--return tracks data 
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadTrack(int iTrackNum, char szTrackData[]);




/** 
 * @fn		CRT288x_ReadAllTracks() 
 * @detail	read all tracks data
 * @see		...
 * @param	[out]szTrack1Data--return track1 data
 * @param	[out]szTrack2Data--return track2 data
 * @param	[out]szTrack3Data--return track3 data
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ReadAllTracks(char szTrack1Data[], char szTrack2Data[], char szTrack3Data[]);



/** 
 * @fn		CRT288x_ClearTrackData() 
* @detail	clear tracks data in buffer 
 * @see		...
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ClearTrackData();



/** 
 * @fn		CRT288x_GetICType() 
 * @detail	get IC card type
 * @see		...
 * @return	result,0 S50, 1 S70, 2 UL card, 4 TYPEA CPU card£¬ 5 TYPEB CPU card£¬ 9 unknown RF type£¬ 10 T=0 contact CPU card£¬ 11 T=1 contact CPU card£¬ 20 24C01£¬ 21 24C02£¬22 24C04£¬ 23 24C08£¬ 24 24C16£¬ 25 24C32£¬ 26 24C64£¬ 30 SL4442£¬ SL4428, 98 no card£¬ 99 unknown card type£¬ other failure
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetICType();



/** 
 * @fn		CRT288x_GetRFType() 
 * @detail	get (contactless) RF card type
 * @see		...
 * @return	result,0: unknown RF card type£¬others: error£¬ 110 S50£¬ 111 S70£¬ 112 UL£¬ 120 TypeA CPU£¬ 130 TypeB CPU.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetRFType();



/** 
 * @fn		CRT288x_ChipPower() 
 * @detail	power on IC card to operate
 * @see		...
 * @param	[in]iICType--IC card type: 10 T=0 CPU£¬ 11 T=1 CPU£¬ 20 SL4442£¬ 21 SL4428£¬ 30 AT24C01£¬ 31 AT24C02£¬ 32 AT24C04£¬
							  33 AT24C08£¬ 34 AT24C16£¬ 35 AT24C32£¬ 36 AT24C64£¬ 37 AT24C128£¬ 38 AT24C256
							  110 S50£¬ 111 S70£¬ 112 UL£¬ 120 TypeA CPU£¬ 130 TypeB CPU£¬ 210 SAM .
 * @param	[in]wChipPower--power on to operate: 0x02 cold reset activate£¬ 0x04 warm reset activate£¬ 0x08 deactive
 * @param	[out]byOutChipData--cold reset to return ATR data
 * @param	[out]iOutChipDatalen--cold reset returning ATR data length
 * @return	result,0 success£¬others error
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipPower(int iICType, WORD wChipPower, BYTE byOutChipData[], int* iOutChipDatalen);




/** 
 * @fn		CRT288x_ChipIO() 
* @detail	communicate with IC card
 * @see		...
 * @param	[in]wChipProtocol--IC card communication protocol: 0 reader select protocol automatically£¬1 T0 protocol£¬ 2 T1 protocol.
 * @param	[in]ulInChipDataLength--send APDU data length.
 * @param	[in]lpInbChipData--send APDU data
 * @param	[out]ulOutChipDataLength--return APDU data length
 * @param	[out]lpOutbChipData--return APDU data
 * @return	result,0 success£¬ others error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_ChipIO(WORD wChipProtocol, int ulInChipDataLength , BYTE lpInbChipData[], int* ulOutChipDataLength , BYTE lpOutbChipData[]);




/** 
 * @fn		CRT288x_GetCardActiveStatus() 
 * @detail	check current IC card activate status
 * @see		...
 * @return	result, 1 the card has been activated£¬current CPU card working clock frequence is 3.57 MHZ£¬ 2 the card has been activated£¬current CPU card working clock frequence is 7.16 MHZ£¬ 3 not activated£¬ 9 unknown activated status, others except 0 is error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_GetCardActiveStatus();




/** 
 * @fn		CRT288x_SAMSlotChange() 
* @detail	SAM card slot switching
 * @see		...
 * @param	[in]iSamNum--switched SAM slots (1-10) 1 SAM1£¬ 2 SAM2£¬ 3 SAM3£¬ 4 SAM4
 * @return	result, 0 success£¬others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SAMSlotChange(int iSamNum);




/** 
 * @fn		CRT288x_SetVcc() 
 * @detail	set Vcc attribute
 * @see		...
 * @param	[in]iVcc--Vcc attribute: 1 5V£¬EMV activate£¬ 2 5V£¬ISO7816 activate£¬ 3 3V£¬ISO7816 activate
 * @return	result, 0 success£¬ others except 0 is error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SetVcc(int iVcc);




/** 
 * @fn		CRT288x_SL4442CheckPasswd() 
 * @detail	SL4442 card checking password
 * @see		...
 * @param	[in]iMode--operation mode: 1 checking password£¬ 2 modifying password
 * @param	[in]uDataLength--password length
 * @param	[in]lpData--checking password (default is£ºFFFFFF)
 * @return	result, 0 success£¬others except 0 is error.
 * @exception  note£ºuser must know the password previously modify the data of SLE4442 card£¬ password error counter value will be changed from 2 or less than 2 to 0,    when the counter value is 0, the card will collapse.
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4442Process() 
 * @detail	SL4442 read/write operation
 * @see		...
 * @param	[in]iMode--operation mode   1 read£¬ 2 write
 * @param	[in]iRegion--operation field   1 main memory, 2 protect bit area£¬ 3 security area
 * @param	[in]wStartAddr--start position (0x00-0xFF)
 * @param	[in][out]uDataLength--operation data length (main memory£º0-128£¬ protect bit area£º0-4£¬ security area£º0-4)
 * @param	[in][out]lpData--operation data (if the mode is writing, that means inputting. if the mode is reading, that means outputting.)
 * @return	result, 0 success, others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4442Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);






/** 
 * @fn		CRT288x_SL4428CheckPasswd() 
 * @detail	SL4442 card checking password
 * @see		...
 * @param	[in]iMode--operation mode: 1 checking password£¬ 2 modifying password
 * @param	[in]uDataLength--password length
 * @param	[in]lpData--checking password (default is£ºFFFFFF)
 * @return	result, 0 success£¬others except 0 is error.
 * @exception  note£ºuser must know the password previously modify the data of SLE4442 card£¬ password error counter value will be changed from 7 or less than 7 to 0,    when the counter value is 0, the card will collapse.
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428CheckPasswd(int iMode, int uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_SL4428Process() 
 * @detail	SL4428 read/write operation
 * @see		...
 * @param	[in]iMode--operation mode   1 read£¬ 2 write
 * @param	[in]iRegion--operation field   1 main memory, 2 protect bit area£¬
 * @param	[in]wStartAddr--start position (0x00-0xFF)
 * @param	[in][out]uDataLength--operation data length (main memory£º0-256£¬ protect bit area£º0-128)
 * @param	[in][out]lpData--operation data (if the mode is writing, that means inputting. if the mode is reading, that means outputting.)
 * @return	result, 0 success, others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_SL4428Process(int iMode, int iRegion ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288x_24CxProcess() 
 * @detail	24Cxx card read/write 
 * @see		...
 * @param	[in]iMode--operation mode   1 read£¬ 2 write without parity, 3 write with parity
 * @param	[in]i24CxxType--24Cxx card type. 20 24C01card£¬ 21 24C02card£¬22 24C04card£¬ 23 24C08card£¬ 24 24C16card£¬ 25 24C32card£¬ 26 24C64card
 * @param	[in]wStartAddr--beginning position (24C01: 0x00-0x07F, 24C02: 0x00-0xFF, 24C04: 0x00-0x01FF, 24C08: 0x00-0x03FF, 24C16: 0x00-0x07FF,
                                 24C32: 0x00-0x0FFF, 24C64: 0x00-0x1FFF)
 * @param	[in][out]uDataLength--operational data length
 * @param	[in][out]lpData--operational data (the mode is 'writing', here inputting. the mode is 'reading', here outputting)
 * @return	result,0: success£¬others: error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_24CxProcess(int iMode ,WORD wStartAddr, int* uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareKeyProcess() 
 * @detail	Mifare card password operation
 * @see		...
 * @param	[in]iMode--operation mode   1 check password£¬ 2 download password to EERPROM£¬ 3 modify password
 * @param	[in]iKs--password type    0 KeyA£¬ 1 KeyB
 * @param	[in]iSn--sector number  (S50 card sn=00H-0FH, S70 card sn=00H-27H)
 * @param	[in][uDataLength--operation password length
 * @param	[in]lpData--operation password data (default£ºFFFFFFFFFFFF)
 * @return	result, 0 success£¬ others except 0 is error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareKeyProcess(int iMode, int iKs, int iSn, int uDataLength, BYTE lpData[]);




/** 
 * @fn		CRT288x_MifareCardProcess() 
  * @detail	Mifare card operation
 * @see		...
 * @param	[in]iMode--operation mode   1 read sector block data£¬ 2 write sector block data£¬ 3 S50 S70 initialization£¬4 S50 S70 read balance£¬ 5 S50 S70 increment£¬ 6 S50 S70 decrement
 * @param	[in]iSn--sector number (Ultralight Card: iSn=00H-0FH, S50 card: iSn=00H-0FH, S70 card: iSn=00H-20H (iSn=21H-27H  S70 card has 16 blocks in every sector among final 8 sectors))
 * @param	[in]iBn--operate start block (Ultralight Card: iBn=00H, S50 card: iBn=00H-03H, S70 card: iBn=00H-03H  (iBn=00H-0FH   S70 card has 16 blocks in every sector among final 8 sectors))
 * @param	[in]iLc--operation block number (Ultralight Card: iLc=01H-10H, S50 card: iLc=01H-04H, S70 card: iLc=01H-04H  (iLc=01H-10H   S70 card has 16 blocks in every sector among final 8 sectors))
 * @param	[in][out]uDataLength--operation data length (S50 S70 initialization£¬when they do increment£¬decrement, those are amount)
 * @param	[in][out]lpData--operation data (all writing operation means input£¬all reading operation means output)
 * @return	result, 0 success£¬others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int  CRT288x_MifareCardProcess(int iMode, int iSn, int iBn, int iLc, int* uDataLength, BYTE lpData[]);





/** 
 * @fn		CRT288C_GetHidCardNums() 
 * @detail	get Hid card number
 * @see		...
 * @param	[out]szHidCardNums--got Hid card number
 * @return      result, 0 success£¬others except 0 error.
 * @exception ...
 *
 * @author	luowei
 * @date	2016/01/06
 */
int CRT288C_GetHidCardNums(char szHidCardNums[]);



#endif 

```

---

## File: odoo_partner_connector.py

**Percorso:** `external/odoo_partner_connector.py`
**Directory:** `external`
**Dimensione:** 15386 bytes
**Ultima modifica:** 2025-07-20 18:43:27
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/external/odoo_partner_connector.py
# Connettore Odoo per controllo accessi
# Solo 4 campi essenziali: CF, name, city, active

import xmlrpc.client
import logging
import time
import json
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple
import threading
import re
from pathlib import Path

logger = logging.getLogger(__name__)

class OdooPartnerConnector:
    """Connettore Odoo ROBUSTO per cittadini - Solo campi essenziali"""
    
    def __init__(self, config_manager):
        self.config = config_manager.get_config()
        
        # Connessioni XML-RPC
        self.common_proxy = None
        self.object_proxy = None
        self.uid = None
        
        # Stato connessione
        self.is_connected = False
        self.last_sync = None
        self.sync_errors = 0
        self.max_sync_errors = 3
        
        # Thread sincronizzazione
        self.sync_thread = None
        self.running = False
        
        # Cache file
        self.cache_file = Path("/opt/access_control/data/partner_cache.json")
        self.cache_file.parent.mkdir(parents=True, exist_ok=True)
        
        logger.info("🔗 OdooPartnerConnector ROBUSTO inizializzato")
    
    def configure_connection(self, url: str, database: str, username: str, password: str,
                           comune: str = "Rende", sync_interval: int = 43200):
        """Configura connessione Odoo ROBUSTA"""
        
        # Assicura protocollo HTTPS
        if not url.startswith(('http://', 'https://')):
            url = f"https://{url}"
        
        self.odoo_url = url.rstrip('/')
        self.odoo_database = database
        self.odoo_username = username
        self.odoo_password = password
        self.comune_filter = comune
        self.sync_interval = sync_interval
        
        # URLs XML-RPC
        self.common_url = f"{self.odoo_url}/xmlrpc/2/common"
        self.object_url = f"{self.odoo_url}/xmlrpc/2/object"
        
        logger.info(f"📝 Odoo configurato per {comune}: {url}/{database}")
    
    def test_connection(self) -> Tuple[bool, str]:
        """Test connessione ROBUSTO con timeout"""
        try:
            logger.info(f"🔍 Test connessione {self.odoo_url}...")
            
            # Test endpoint common con timeout
            common = xmlrpc.client.ServerProxy(self.common_url)
            version_info = common.version()
            
            server_version = version_info.get('server_version', 'Unknown')
            logger.info(f"✅ Server Odoo: {server_version}")
            
            # Test autenticazione
            uid = common.authenticate(self.odoo_database, self.odoo_username, self.odoo_password, {})
            
            if not uid:
                return False, "❌ Autenticazione fallita - controllare credenziali"
            
            logger.info(f"✅ Autenticazione OK - UID: {uid}")
            
            # Test accesso res.partner con SOLO campi necessari
            models = xmlrpc.client.ServerProxy(self.object_url)
            
            # Test count con filtri ESATTI
            domain_test = [
                ('city', '=', self.comune_filter),
                ('is_person', '=', True),
                ('is_company', '=', False),
                ('is_ente', '=', False),
                ('l10n_it_codice_fiscale', '!=', False),
                ('l10n_it_codice_fiscale', '!=', '')
            ]
            
            test_count = models.execute_kw(
                self.odoo_database, uid, self.odoo_password,
                'res.partner', 'search_count', [domain_test]
            )
            
            if test_count == 0:
                return False, f"⚠️ Nessun cittadino per {self.comune_filter} - verificare dati"
            
            logger.info(f"✅ Test OK: {test_count} cittadini {self.comune_filter}")
            return True, f"✅ Connessione OK - {test_count} cittadini disponibili"
                
        except Exception as e:
            return False, f"❌ Errore connessione: {e}"
    
    def connect(self) -> bool:
        """Stabilisce connessione Odoo ROBUSTA"""
        try:
            if not all([self.odoo_url, self.odoo_database, self.odoo_username, self.odoo_password]):
                logger.error("❌ Configurazione Odoo incompleta")
                return False
            
            # Connessioni XML-RPC
            self.common_proxy = xmlrpc.client.ServerProxy(self.common_url)
            self.object_proxy = xmlrpc.client.ServerProxy(self.object_url)
            
            # Autenticazione
            self.uid = self.common_proxy.authenticate(
                self.odoo_database, self.odoo_username, self.odoo_password, {}
            )
            
            if self.uid:
                self.is_connected = True
                self.sync_errors = 0
                logger.info(f"✅ Connesso a Odoo - UID: {self.uid}")
                return True
            else:
                logger.error("❌ Autenticazione Odoo fallita")
                return False
                
        except Exception as e:
            logger.error(f"❌ Errore connessione: {e}")
            return False
    
    def fetch_cittadini_autorizzati(self) -> List[Dict]:
        """Recupera cittadini SOLO con campi essenziali
        
        Returns:
            Lista dizionari con dati cittadini essenziali
        """
        try:
            if not self.is_connected and not self.connect():
                logger.warning("⚠️ Connessione Odoo non disponibile - uso cache")
                return self._load_from_cache()
            
            # Domain ROBUSTO per filtri
            domain = [
                ('city', '=', self.comune_filter),
                ('is_person', '=', True),
                ('is_company', '=', False),
                ('is_ente', '=', False),
                ('l10n_it_codice_fiscale', '!=', False),
                ('l10n_it_codice_fiscale', '!=', ''),
                ('active', '=', True)  # Solo attivi
            ]
            
            # SOLO 4 campi essenziali - PERFORMANCE OTTIMIZZATA
            fields = [
                'l10n_it_codice_fiscale',  # CF per identificazione
                'name',                    # Nome completo per log
                'city',                    # Città per verifica
                'active'                   # Stato attivo
            ]
            
            logger.info(f"📥 Recupero cittadini {self.comune_filter} - SOLO campi essenziali...")
            
            # Ricerca IDs con LIMIT per sicurezza
            partner_ids = self.object_proxy.execute_kw(
                self.odoo_database, self.uid, self.odoo_password,
                'res.partner', 'search', [domain], {'limit': 30000}
            )
            
            if not partner_ids:
                logger.warning(f"⚠️ Nessun cittadino per {self.comune_filter}")
                return []
            
            logger.info(f"📋 Trovati {len(partner_ids)} cittadini, recupero dati essenziali...")
            
            # Lettura dati in batch per performance
            batch_size = 1000
            all_partners = []
            
            for i in range(0, len(partner_ids), batch_size):
                batch_ids = partner_ids[i:i + batch_size]
                
                batch_partners = self.object_proxy.execute_kw(
                    self.odoo_database, self.uid, self.odoo_password,
                    'res.partner', 'read', [batch_ids], {'fields': fields}
                )
                
                all_partners.extend(batch_partners)
                logger.info(f"📦 Batch {i//batch_size + 1}: {len(batch_partners)} record")
            
            # Processamento SEMPLIFICATO e ROBUSTO
            cittadini_validi = []
            errori_cf = 0
            
            for partner in all_partners:
                try:
                    # CF validation ROBUSTA
                    cf = partner.get('l10n_it_codice_fiscale', '').strip().upper()
                    
                    if not self._validate_codice_fiscale(cf):
                        errori_cf += 1
                        continue
                    
                    # Nome completo da Odoo
                    nome = partner.get('name', '').strip()
                    if not nome:
                        nome = 'Cittadino Sconosciuto'
                    
                    # Dati cittadino ESSENZIALI
                    cittadino = {
                        'codice_fiscale': cf,
                        'nome': nome,
                        'note': f"Sync Odoo {datetime.now().strftime('%Y-%m-%d')}",
                        'attivo': partner.get('active', True),
                        'odoo_id': partner.get('id'),
                        'sync_timestamp': datetime.now().isoformat(),
                        'creato_da': 'ODOO_SYNC',
                        'modificato_da': 'ODOO_SYNC'
                    }
                    
                    cittadini_validi.append(cittadino)
                    
                except Exception as e:
                    errori_cf += 1
                    logger.debug(f"⚠️ Errore partner {partner.get('id')}: {e}")
            
            # Statistiche finali
            logger.info(f"✅ Processati {len(cittadini_validi)} cittadini validi")
            if errori_cf > 0:
                logger.warning(f"⚠️ {errori_cf} record con CF invalido/mancante")
            
            # Salva in cache
            self._save_to_cache(cittadini_validi)
            
            return cittadini_validi
            
        except Exception as e:
            logger.error(f"❌ Errore recupero cittadini: {e}")
            self.sync_errors += 1
            
            # Fallback cache
            logger.info("🔄 Fallback su cache locale")
            return self._load_from_cache()
    
    def _validate_codice_fiscale(self, cf: str) -> bool:
        """Validazione CF ROBUSTA"""
        if not cf or len(cf) != 16:
            return False
        
        # Pattern CF italiano
        pattern = r'^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$'
        if not re.match(pattern, cf):
            return False
        
        # Evita pattern troppo uniformi (test data)
        if len(set(cf)) < 6:
            return False
        
        return True
    
    def _save_to_cache(self, cittadini: List[Dict]):
        """Salva cittadini in cache locale ROBUSTA"""
        try:
            cache_data = {
                'timestamp': datetime.now().isoformat(),
                'comune': self.comune_filter,
                'count': len(cittadini),
                'cittadini': cittadini
            }
            
            with open(self.cache_file, 'w', encoding='utf-8') as f:
                json.dump(cache_data, f, indent=2, ensure_ascii=False, default=str)
            
            logger.info(f"💾 Cache salvata: {len(cittadini)} cittadini")
            
        except Exception as e:
            logger.error(f"❌ Errore salvataggio cache: {e}")
    
    def _load_from_cache(self) -> List[Dict]:
        """Carica cittadini da cache locale"""
        try:
            if not self.cache_file.exists():
                logger.warning("⚠️ Cache locale non esistente")
                return []
            
            with open(self.cache_file, 'r', encoding='utf-8') as f:
                cache_data = json.load(f)
            
            cittadini = cache_data.get('cittadini', [])
            timestamp = cache_data.get('timestamp', 'Unknown')
            
            logger.info(f"📂 Cache: {len(cittadini)} cittadini ({timestamp})")
            return cittadini
            
        except Exception as e:
            logger.error(f"❌ Errore caricamento cache: {e}")
            return []
    
    def sync_to_database(self, database_manager) -> Tuple[bool, Dict]:
        """Sincronizza cittadini con database locale ROBUSTO"""
        start_time = time.time()
        stats = {'fetched': 0, 'updated': 0, 'added': 0, 'errors': 0, 'skipped': 0}
        
        try:
            logger.info(f"🔄 Sync ROBUSTA cittadini {self.comune_filter}")
            
            # Recupera cittadini
            cittadini = self.fetch_cittadini_autorizzati()
            stats['fetched'] = len(cittadini)
            
            if not cittadini:
                logger.warning("⚠️ Nessun cittadino da sincronizzare")
                return False, stats
            
            # Sincronizzazione ROBUSTA
            for cittadino in cittadini:
                try:
                    cf = cittadino['codice_fiscale']
                    
                    # Verifica esistenza
                    exists, existing_user = database_manager.verify_access(cf)
                    
                    if exists:
                        # Già presente - skip
                        stats['skipped'] += 1
                    else:
                        # Aggiungi nuovo cittadino
                        success = database_manager.add_user(
                            codice_fiscale=cf,
                            nome=cittadino['nome'],
                            note=cittadino['note'],
                            creato_da=cittadino['creato_da'],
                            modificato_da=cittadino['modificato_da']
                        )
                        
                        if success:
                            stats['added'] += 1
                            if stats['added'] % 1000 == 0:
                                logger.info(f"📈 Aggiunti {stats['added']} cittadini...")
                        else:
                            stats['errors'] += 1
                
                except Exception as e:
                    stats['errors'] += 1
                    logger.debug(f"⚠️ Errore sync cittadino: {e}")
            
            # Risultati
            self.last_sync = datetime.now()
            duration = time.time() - start_time
            
            logger.info(f"✅ Sync completata in {duration:.2f}s")
            logger.info(f"📊 {stats['added']} aggiunti, {stats['skipped']} esistenti, {stats['errors']} errori")
            
            return True, stats
            
        except Exception as e:
            logger.error(f"❌ Errore sincronizzazione: {e}")
            return False, stats
    
    def get_sync_status(self) -> Dict:
        """Status connessione e sincronizzazione"""
        return {
            'connected': self.is_connected,
            'comune': self.comune_filter,
            'last_sync': self.last_sync.isoformat() if self.last_sync else None,
            'sync_errors': self.sync_errors,
            'cache_exists': self.cache_file.exists(),
            'cache_size': self.cache_file.stat().st_size if self.cache_file.exists() else 0
        }
    
    def disconnect(self):
        """Disconnetti da Odoo"""
        self.common_proxy = None
        self.object_proxy = None
        self.uid = None
        self.is_connected = False
        logger.info("🔌 Disconnesso da Odoo")

# Factory function
def create_partner_connector(config_manager) -> OdooPartnerConnector:
    """Crea istanza OdooPartnerConnector ROBUSTO"""
    return OdooPartnerConnector(config_manager)

```

---

## File: test_connessione_utente_api.py

**Percorso:** `external/test_connessione_utente_api.py`
**Directory:** `external`
**Dimensione:** 909 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# Test rapido connessione
import xmlrpc.client

url = "https://app.calabramaceri.it"
db = "cmapp"
username = "controllo-accessi@calabramaceri.it"  # CORRETTO
password = "AcC3ss0C0ntr0l!2025#Rnd"

common = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/common')
uid = common.authenticate(db, username, password, {})

if uid:
    print(f"✅ Connessione OK - UID: {uid}")
    
    # Test filtri corretti
    models = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/object')
    count = models.execute_kw(
        db, uid, password,
        'res.partner', 'search_count',
        [[
            ('city', '=', 'Rende'),
            ('is_person', '=', True),
            ('is_company', '=', False),
            ('is_ente', '=', False),  # AGGIUNTO
            ('l10n_it_codice_fiscale', '!=', False)
        ]]
    )
    print(f"✅ Cittadini Rende (filtri corretti): {count}")
else:
    print("❌ Autenticazione fallita")
```

---

## File: genera_documentazione.py

**Percorso:** `genera_documentazione.py`
**Directory:** `.`
**Dimensione:** 9544 bytes
**Ultima modifica:** 2025-07-24 10:16:17
**Permessi:** 664

### Contenuto:

```python
#!/usr/bin/env python3
"""
Script per generare documentazione completa del progetto Access Control
Genera un documento con nome file, percorso e contenuto di tutti i file rilevanti
"""

import os
import datetime
from pathlib import Path
import mimetypes

class ProjectDocumenter:
    def __init__(self, project_root="/opt/access_control/src"):
        self.project_root = Path(project_root)
        self.output_file = f"documentazione_access_control_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        
        # Cartelle e file da escludere
        self.excluded_dirs = {
            '__pycache__',
            '.git',
            '.vscode',
            'node_modules',
            'backup',
            'download',
            'venv',
            '.pytest_cache'
        }
        
        # Estensioni di file da escludere
        self.excluded_extensions = {
            '.pyc',
            '.pyo',
            '.pyd',
            '__pycache__',
            '.git',
            '.gitignore',
            '.DS_Store',
            '.tar.gz',
            '.zip',
            '.rar',
            '.7z',
            '.bz2',
            '.o',  # object files
            '.so'  # shared objects (ma potremmo volerli documentare)
        }
        
        # Estensioni di file di codice/configurazione da includere
        self.code_extensions = {
            '.py', '.js', '.html', '.css', '.sql', '.md', '.txt', '.json', 
            '.xml', '.yml', '.yaml', '.ini', '.cfg', '.conf', '.sh', 
            '.c', '.h', '.cpp', '.hpp', '.java', '.php', '.rb', '.go'
        }

    def should_exclude_dir(self, dir_name):
        """Verifica se una directory deve essere esclusa"""
        return dir_name in self.excluded_dirs

    def should_exclude_file(self, file_path):
        """Verifica se un file deve essere escluso"""
        file_path = Path(file_path)
        
        # Esclude per estensione
        if file_path.suffix.lower() in self.excluded_extensions:
            return True
            
        # Esclude file di backup specifici
        if 'backup_completo_' in file_path.name:
            return True
            
        # Esclude file temporanei
        if file_path.name.startswith('.') and file_path.suffix == '':
            return True
            
        return False

    def is_text_file(self, file_path):
        """Verifica se un file è testuale e può essere letto"""
        try:
            # Controlla per estensione
            if file_path.suffix.lower() in self.code_extensions:
                return True
                
            # Usa mimetypes per altri file
            mime_type, _ = mimetypes.guess_type(str(file_path))
            if mime_type and mime_type.startswith('text/'):
                return True
                
            # Prova a leggere i primi bytes per verificare se è testo
            with open(file_path, 'rb') as f:
                sample = f.read(1024)
                try:
                    sample.decode('utf-8')
                    return True
                except UnicodeDecodeError:
                    return False
                    
        except Exception:
            return False

    def read_file_content(self, file_path):
        """Legge il contenuto di un file"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                return f.read()
        except UnicodeDecodeError:
            try:
                with open(file_path, 'r', encoding='latin-1') as f:
                    return f.read()
            except Exception as e:
                return f"[ERRORE LETTURA FILE: {e}]"
        except Exception as e:
            return f"[ERRORE LETTURA FILE: {e}]"

    def get_file_info(self, file_path):
        """Ottiene informazioni su un file"""
        try:
            stat = file_path.stat()
            return {
                'size': stat.st_size,
                'modified': datetime.datetime.fromtimestamp(stat.st_mtime).strftime('%Y-%m-%d %H:%M:%S'),
                'permissions': oct(stat.st_mode)[-3:]
            }
        except Exception:
            return {'size': 0, 'modified': 'N/A', 'permissions': 'N/A'}

    def scan_directory(self, directory):
        """Scansiona ricorsivamente una directory"""
        files_info = []
        
        try:
            for root, dirs, files in os.walk(directory):
                # Rimuove le directory da escludere dalla lista
                dirs[:] = [d for d in dirs if not self.should_exclude_dir(d)]
                
                for file in files:
                    file_path = Path(root) / file
                    
                    if self.should_exclude_file(file_path):
                        continue
                        
                    relative_path = file_path.relative_to(self.project_root)
                    file_info = self.get_file_info(file_path)
                    
                    files_info.append({
                        'name': file,
                        'path': str(relative_path),
                        'full_path': str(file_path),
                        'directory': str(relative_path.parent),
                        'is_text': self.is_text_file(file_path),
                        'info': file_info
                    })
                    
        except Exception as e:
            print(f"Errore durante la scansione di {directory}: {e}")
            
        return files_info

    def generate_documentation(self):
        """Genera la documentazione completa"""
        print(f"Generazione documentazione per: {self.project_root}")
        print(f"File output: {self.output_file}")
        
        # Scansiona tutti i file
        all_files = self.scan_directory(self.project_root)
        
        # Ordina per percorso
        all_files.sort(key=lambda x: x['path'])
        
        # Genera il documento
        with open(self.output_file, 'w', encoding='utf-8') as doc:
            # Header del documento
            doc.write(f"# Documentazione Progetto Access Control\n\n")
            doc.write(f"**Data generazione:** {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            doc.write(f"**Directory progetto:** {self.project_root}\n")
            doc.write(f"**Totale file documentati:** {len(all_files)}\n\n")
            
            # Indice
            doc.write("## Indice File\n\n")
            for file_info in all_files:
                doc.write(f"- [{file_info['path']}](#{file_info['path'].replace('/', '').replace('.', '').replace('_', '').replace('-', '')})\n")
            doc.write("\n---\n\n")
            
            # Contenuto di ogni file
            for i, file_info in enumerate(all_files, 1):
                print(f"Processando file {i}/{len(all_files)}: {file_info['path']}")
                
                doc.write(f"## File: {file_info['name']}\n\n")
                doc.write(f"**Percorso:** `{file_info['path']}`\n")
                doc.write(f"**Directory:** `{file_info['directory']}`\n")
                doc.write(f"**Dimensione:** {file_info['info']['size']} bytes\n")
                doc.write(f"**Ultima modifica:** {file_info['info']['modified']}\n")
                doc.write(f"**Permessi:** {file_info['info']['permissions']}\n\n")
                
                if file_info['is_text']:
                    content = self.read_file_content(file_info['full_path'])
                    
                    # Determina il linguaggio per syntax highlighting
                    extension = Path(file_info['name']).suffix.lower()
                    language_map = {
                        '.py': 'python',
                        '.js': 'javascript', 
                        '.html': 'html',
                        '.css': 'css',
                        '.sql': 'sql',
                        '.sh': 'bash',
                        '.c': 'c',
                        '.h': 'c',
                        '.cpp': 'cpp',
                        '.json': 'json',
                        '.xml': 'xml',
                        '.yml': 'yaml',
                        '.yaml': 'yaml'
                    }
                    
                    lang = language_map.get(extension, 'text')
                    
                    doc.write(f"### Contenuto:\n\n")
                    doc.write(f"```{lang}\n")
                    doc.write(content)
                    doc.write(f"\n```\n\n")
                else:
                    doc.write("### Contenuto:\n\n")
                    doc.write("*[File binario - contenuto non visualizzabile]*\n\n")
                
                doc.write("---\n\n")
        
        print(f"\nDocumentazione generata con successo: {self.output_file}")
        print(f"Totale file documentati: {len(all_files)}")

def main():
    # Configura il percorso del progetto
    project_path = "/opt/access_control/src"
    
    # Se lo script viene eseguito dalla directory del progetto
    if os.path.exists("./src"):
        project_path = "./src"
    elif os.path.exists("../src"):
        project_path = "../src"
    
    print("=== GENERATORE DOCUMENTAZIONE ACCESS CONTROL ===")
    print(f"Percorso progetto: {project_path}")
    
    if not os.path.exists(project_path):
        print(f"ERRORE: Directory {project_path} non trovata!")
        print("Modifica il percorso nella variabile 'project_path' nello script.")
        return
    
    documenter = ProjectDocumenter(project_path)
    documenter.generate_documentation()

if __name__ == "__main__":
    main()

```

---

## File: __init__.py

**Percorso:** `hardware/__init__.py`
**Directory:** `hardware`
**Dimensione:** 0 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python

```

---

## File: after.txt

**Percorso:** `hardware/after.txt`
**Directory:** `hardware`
**Dimensione:** 278 bytes
**Ultima modifica:** 2025-07-23 11:47:58
**Permessi:** 664

### Contenuto:

```text
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 003: ID 8087:0a2a Intel Corp. Bluetooth wireless interface
Bus 001 Device 002: ID 04d8:ffee Microchip Technology, Inc. Devantech USB-ISS
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub

```

---

## File: before.txt

**Percorso:** `hardware/before.txt`
**Directory:** `hardware`
**Dimensione:** 278 bytes
**Ultima modifica:** 2025-07-23 11:47:58
**Permessi:** 664

### Contenuto:

```text
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 003: ID 8087:0a2a Intel Corp. Bluetooth wireless interface
Bus 001 Device 002: ID 04d8:ffee Microchip Technology, Inc. Devantech USB-ISS
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub

```

---

## File: card_reader.py

**Percorso:** `hardware/card_reader.py`
**Directory:** `hardware`
**Dimensione:** 15168 bytes
**Ultima modifica:** 2025-07-23 11:08:30
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/hardware/card_reader.py
# LETTORE TESSERA SANITARIA * OMNIKEY 5427 G2
import time
import logging
import re
from typing import Optional
from smartcard.System import readers
from smartcard.util import toHexString
from smartcard.CardRequest import CardRequest
from smartcard.CardType import AnyCardType
from smartcard.Exceptions import CardRequestTimeoutException, NoCardException

logger = logging.getLogger(__name__)

class CardReader:
    """LETTORE TESSERA SANITARIA ROBUSTO - Retry automatici e gestione errori"""
    
    def __init__(self, device_path=None, reader_type=None):
        self.readers = []
        self.running = False
        self.last_cf = None
        self.debug = False  # Ridotto logging per prestazioni
        self.device_path = device_path  # Supporto per device_path specifico
        self.reader_type = reader_type  # Supporto per tipo lettore specifico
        
        # Configurazione retry
        self.max_retries = 3
        self.retry_delay = 0.5
        self.read_timeout = 3
        
        # Cache per evitare letture duplicate
        self.last_read_time = 0
        self.duplicate_threshold = 1.0  # Secondi
        
        self.init_readers()
        logger.info("💳 CardReader ROBUSTO inizializzato")
    
    def init_readers(self):
        """Inizializza lettori smart card"""
        try:
            self.readers = readers()
            if not self.readers:
                raise Exception("Nessun lettore smart card trovato")
            
            logger.info(f"📱 Lettori trovati: {len(self.readers)}")
            for i, reader in enumerate(self.readers):
                logger.info(f"  {i}: {reader}")
                
        except Exception as e:
            logger.error(f"❌ Errore inizializzazione lettori: {e}")
            raise
    
    def start_continuous_reading(self, callback=None):
        """Avvia lettura continua ROBUSTA con retry automatici"""
        self.running = True
        logger.info("🚀 AVVIO LETTURA CONTINUA ROBUSTA")
        logger.info("💳 Inserire tessere sanitarie...")
        
        consecutive_errors = 0
        max_consecutive_errors = 5
        
        while self.running:
            try:
                # Attendi tessera con timeout breve
                cf = self._read_card_robust(timeout=2)
                
                if cf:
                    # CF letto con successo
                    current_time = time.time()
                    
                    # Evita duplicati ravvicinati
                    if (current_time - self.last_read_time) < self.duplicate_threshold and cf == self.last_cf:
                        if self.debug:
                            logger.debug(f"🔄 CF duplicato ignorato: {cf}")
                        continue
                    
                    # Nuovo CF valido
                    logger.info(f"🎯 CODICE FISCALE: {cf}")
                    self.last_cf = cf
                    self.last_read_time = current_time
                    consecutive_errors = 0  # Reset errori
                    
                    # Chiama callback
                    if callback:
                        try:
                            callback(cf)
                        except Exception as e:
                            logger.error(f"❌ Errore callback: {e}")
                    
                    # Attendi rimozione tessera ROBUSTA
                    self._wait_card_removal_robust()
                
                else:
                    # Nessun CF letto - normale se nessuna tessera
                    consecutive_errors = 0
                
                # Breve pausa per CPU
                time.sleep(0.2)
                
            except KeyboardInterrupt:
                logger.info("⏹️ Interruzione richiesta")
                break
            except Exception as e:
                consecutive_errors += 1
                
                if consecutive_errors <= max_consecutive_errors:
                    if self.debug:
                        logger.debug(f"⚠️ Errore {consecutive_errors}/{max_consecutive_errors}: {e}")
                else:
                    logger.error(f"❌ Troppi errori consecutivi: {e}")
                
                # Pausa più lunga dopo errori
                time.sleep(1)
        
        self.running = False
        logger.info("🛑 Lettura continua FERMATA")
    
    def _read_card_robust(self, timeout=3) -> Optional[str]:
        """Lettura tessera ROBUSTA con retry automatici"""
        
        for attempt in range(self.max_retries):
            try:
                # Attendi tessera
                cardrequest = CardRequest(timeout=timeout, cardType=AnyCardType())
                cardservice = cardrequest.waitforcard()
                
                if not cardservice:
                    return None
                
                # Connetti con retry
                connection_success = False
                for conn_attempt in range(2):
                    try:
                        cardservice.connection.connect()
                        connection_success = True
                        break
                    except Exception as e:
                        if conn_attempt == 0:
                            time.sleep(0.2)
                            continue
                        else:
                            raise e
                
                if not connection_success:
                    continue
                
                # Leggi ATR
                atr = cardservice.connection.getATR()
                atr_hex = toHexString(atr).replace(" ", "")
                
                if self.debug:
                    logger.debug(f"ATR: {atr_hex}")
                
                # SEQUENZA APDU ROBUSTA con retry
                cf = self._read_apdu_robust(cardservice.connection)
                
                # Disconnetti sempre
                try:
                    cardservice.connection.disconnect()
                except:
                    pass
                
                if cf:
                    return cf
                
                # Se non ha letto CF, retry
                if attempt < self.max_retries - 1:
                    time.sleep(self.retry_delay)
                    continue
                
            except CardRequestTimeoutException:
                # Normale - nessuna tessera
                return None
            except Exception as e:
                if self.debug:
                    logger.debug(f"⚠️ Errore tentativo {attempt + 1}: {e}")
                
                # Retry con pausa crescente
                if attempt < self.max_retries - 1:
                    time.sleep(self.retry_delay * (attempt + 1))
                    continue
        
        # Tutti i tentativi falliti
        return None
    
    def _read_apdu_robust(self, connection) -> Optional[str]:
        """Sequenza APDU ROBUSTA con error handling"""
        
        try:
            # STEP 1: SELECT MF con retry
            for retry in range(2):
                try:
                    response, sw1, sw2 = connection.transmit([0x00, 0xA4, 0x00, 0x00, 0x02, 0x3F, 0x00])
                    if sw1 == 0x90 and sw2 == 0x00:
                        break
                    elif retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise Exception(f"SELECT MF failed: {sw1:02X}{sw2:02X}")
                except Exception as e:
                    if retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise e
            
            # STEP 2: SELECT DF1 con retry
            for retry in range(2):
                try:
                    response, sw1, sw2 = connection.transmit([0x00, 0xA4, 0x00, 0x00, 0x02, 0x11, 0x00])
                    if sw1 == 0x90 and sw2 == 0x00:
                        break
                    elif retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise Exception(f"SELECT DF1 failed: {sw1:02X}{sw2:02X}")
                except Exception as e:
                    if retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise e
            
            # STEP 3: SELECT EF con retry
            for retry in range(2):
                try:
                    response, sw1, sw2 = connection.transmit([0x00, 0xA4, 0x00, 0x00, 0x02, 0x11, 0x02])
                    if sw1 == 0x90 and sw2 == 0x00:
                        break
                    elif retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise Exception(f"SELECT EF failed: {sw1:02X}{sw2:02X}")
                except Exception as e:
                    if retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise e
            
            # STEP 4: READ BINARY con retry
            for retry in range(2):
                try:
                    response, sw1, sw2 = connection.transmit([0x00, 0xB0, 0x00, 0x00, 0x9F])
                    if sw1 == 0x90 and sw2 == 0x00 and response:
                        break
                    elif retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise Exception(f"READ BINARY failed: {sw1:02X}{sw2:02X}")
                except Exception as e:
                    if retry == 0:
                        time.sleep(0.1)
                        continue
                    else:
                        raise e
            
            if self.debug:
                logger.debug(f"Data: {toHexString(response)}")
            
            # Estrai CF
            return self._extract_cf_optimized(response)
            
        except Exception as e:
            if self.debug:
                logger.debug(f"❌ Errore APDU: {e}")
            return None
    
    def _extract_cf_optimized(self, data: list) -> Optional[str]:
        """Estrazione CF ottimizzata per performance"""
        try:
            # Pattern CF
            cf_pattern = r'[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]'
            
            # METODO 1: Scansione diretta (più veloce)
            for i in range(len(data) - 15):
                candidate = ""
                valid_chars = True
                
                for j in range(16):
                    byte = data[i + j]
                    if (65 <= byte <= 90) or (48 <= byte <= 57):  # A-Z o 0-9
                        candidate += chr(byte)
                    else:
                        valid_chars = False
                        break
                
                if valid_chars and len(candidate) == 16:
                    if re.match(cf_pattern, candidate) and self._validate_cf_fast(candidate):
                        return candidate
            
            # METODO 2: ASCII fallback
            ascii_data = ''.join([chr(b) if 32 <= b <= 126 else '.' for b in data])
            matches = re.findall(cf_pattern, ascii_data.upper())
            
            for match in matches:
                if self._validate_cf_fast(match):
                    return match
            
            return None
            
        except Exception as e:
            if self.debug:
                logger.debug(f"❌ Errore estrazione CF: {e}")
            return None
    
    def _validate_cf_fast(self, cf: str) -> bool:
        """Validazione CF veloce"""
        if not cf or len(cf) != 16:
            return False
        
        # Verifica pattern base
        pattern = r'^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$'
        if not re.match(pattern, cf):
            return False
        
        # Evita pattern troppo uniformi
        if len(set(cf)) < 4:
            return False
        
        return True
    
    def _wait_card_removal_robust(self):
        """Attesa rimozione tessera ROBUSTA"""
        removal_timeout = 30  # Max 30 secondi di attesa
        start_time = time.time()
        
        while (time.time() - start_time) < removal_timeout:
            try:
                # Test presenza tessera con timeout molto breve
                cardrequest = CardRequest(timeout=0.2, cardType=AnyCardType())
                cardservice = cardrequest.waitforcard()
                
                if cardservice:
                    # Tessera ancora presente
                    time.sleep(0.3)
                    continue
                else:
                    # Tessera rimossa
                    break
                    
            except CardRequestTimeoutException:
                # Tessera rimossa - normale
                break
            except Exception:
                # Errore generico = probabilmente tessera rimossa
                break
        
        # Pausa breve dopo rimozione per stabilizzare
        time.sleep(0.2)
    
    def stop(self):
        """Ferma lettura continua"""
        self.running = False
    
    def get_last_cf(self) -> Optional[str]:
        """Ultimo CF letto"""
        return self.last_cf
    
    def test_connection(self) -> bool:
        """Test connessione"""
        return len(self.readers) > 0
    
    def set_debug(self, debug: bool):
        """Abilita/disabilita debug logging"""
        self.debug = debug
        if debug:
            logger.setLevel(logging.DEBUG)
        else:
            logger.setLevel(logging.INFO)

# Test e utilizzo
if __name__ == "__main__":
    import signal
    import sys
    
    def handle_cf(cf: str):
        """Callback per CF letti"""
        print(f"\n🎯 ACCESSO RILEVATO!")
        print(f"📋 Codice Fiscale: {cf}")
        print(f"⏰ {time.strftime('%H:%M:%S')}")
        print("💳 Pronto per prossima tessera...\n")
    
    def signal_handler(signum, frame):
        print(f"\n🛑 Arresto...")
        if 'reader' in globals():
            reader.stop()
        sys.exit(0)
    
    signal.signal(signal.SIGINT, signal_handler)
    
    print("🏥 SISTEMA CONTROLLO ACCESSI ROBUSTO")
    print("=" * 50)
    
    # Setup logging
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s'
    )
    
    try:
        reader = CardReader()
        
        # Abilita debug se necessario
        # reader.set_debug(True)
        
        print("✅ Sistema ROBUSTO inizializzato")
        print("💳 Inserire tessere sanitarie...")
        print("🔄 Retry automatici attivi")
        print("⚠️ Gestione errori robusta")
        print("⏹️ Ctrl+C per fermare")
        
        # Avvia lettura continua
        reader.start_continuous_reading(callback=handle_cf)
        
    except Exception as e:
        print(f"❌ Errore: {e}")
    finally:
        print("✅ Sistema fermato")

```

---

## File: find_crt288x

**Percorso:** `hardware/find_crt288x`
**Directory:** `hardware`
**Dimensione:** 16592 bytes
**Ultima modifica:** 2025-07-23 11:46:59
**Permessi:** 775

### Contenuto:

*[File binario - contenuto non visualizzabile]*

---

## File: find_crt288x.c

**Percorso:** `hardware/find_crt288x.c`
**Directory:** `hardware`
**Dimensione:** 4656 bytes
**Ultima modifica:** 2025-07-23 11:39:14
**Permessi:** 664

### Contenuto:

```c
#include "crt_288x_ur.h"
#include <stdio.h>
#include <unistd.h>
#include <sys/stat.h>

void check_usb_devices() {
    printf("=== Controllo dispositivi USB ===\n");
    printf("Esegui 'lsusb' per vedere tutti i dispositivi collegati.\n");
    printf("Cerca un dispositivo che NON sia:\n");
    printf("- Linux Foundation (hub)\n");
    printf("- Intel Bluetooth\n");
    printf("- Devantech USB-RLY08\n");
    printf("\nSe vedi un nuovo dispositivo, quello potrebbe essere il CRT288x.\n\n");
}

void check_serial_devices() {
    printf("=== Controllo dispositivi seriali ===\n");
    
    const char* devices[] = {
        "/dev/ttyUSB0", "/dev/ttyUSB1", "/dev/ttyUSB2", "/dev/ttyUSB3",
        "/dev/ttyACM1", "/dev/ttyACM2", "/dev/ttyACM3", // ACM0 è già il Devantech
        "/dev/ttyS0", "/dev/ttyS1"
    };
    
    int found_new = 0;
    
    for (int i = 0; i < sizeof(devices)/sizeof(devices[0]); i++) {
        struct stat st;
        if (stat(devices[i], &st) == 0) {
            printf("✓ Trovato: %s\n", devices[i]);
            found_new++;
        }
    }
    
    if (found_new == 0) {
        printf("- Nessun nuovo dispositivo seriale trovato\n");
        printf("- /dev/ttyACM0 è il Devantech (già identificato)\n");
    }
    
    printf("\n");
}

int test_crt288x_connection() {
    printf("=== Test connessione CRT288x ===\n");
    
    // Test connessione USB
    printf("1. Test modalità USB...\n");
    int result = CRT288x_OpenConnection(CRT_OPEN_TYPEUSB, 0, 0);
    if (result == 0) {
        printf("✓ SUCCESSO! CRT288x trovato in modalità USB!\n");
        
        // Test funzionalità base
        int card_status = CRT288x_GetCardStatus();
        printf("Status carta: %d\n", card_status);
        
        int lock_status = CRT288x_GetLockStatus();
        printf("Status lock: %d\n", lock_status);
        
        // Test LED per confermare che funziona
        printf("Test LED (rosso per 2 secondi)...\n");
        CRT288x_LEDProcess(CRT_LED_RED, CRT_LED_ON);
        sleep(2);
        CRT288x_LEDProcess(CRT_LED_RED, CRT_LED_OFF);
        
        CRT288x_CloseConnection();
        return 0;
    } else {
        printf("✗ Connessione USB fallita: errore %d\n", result);
    }
    
    // Test connessioni seriali
    printf("\n2. Test modalità seriale (RS232)...\n");
    for (int com = 0; com <= 10; com++) {
        printf("   Provo COM%d...\n", com);
        result = CRT288x_OpenConnection(CRT_OPEN_TYPERS232, com, 9600);
        if (result == 0) {
            printf("✓ SUCCESSO! CRT288x trovato su COM%d!\n", com);
            
            int card_status = CRT288x_GetCardStatus();
            printf("Status carta: %d\n", card_status);
            
            CRT288x_CloseConnection();
            return 0;
        }
    }
    
    printf("✗ Nessuna connessione riuscita\n");
    return -1;
}

void show_error_codes() {
    printf("=== Codici errore comuni CRT288x ===\n");
    printf("-201: Errore carattere comando\n");
    printf("-202: Errore parametri comando\n");
    printf("-203: Comando non può essere eseguito\n");
    printf("-204: Hardware non supporta\n");
    printf("-205: Errore dati comando\n");
    printf("-280: Timeout comunicazione\n");
    printf("-284: Comando cancellato\n");
    printf("-299: Errore sconosciuto\n");
    printf("\n");
}

int main() {
    printf("=== Ricerca lettore CRT288x ===\n\n");
    
    check_usb_devices();
    check_serial_devices();
    
    // Verifica se la libreria è installata
    printf("=== Verifica libreria CRT288x ===\n");
    struct stat st;
    if (stat("/usr/local/lib/crt_288x_ur.so", &st) == 0) {
        printf("✓ Libreria trovata in /usr/local/lib/\n");
    } else {
        printf("✗ Libreria non trovata!\n");
        printf("Esegui: sudo cp crt_288x_ur.so /usr/local/lib/\n");
        printf("        sudo ldconfig\n");
        return -1;
    }
    
    if (stat("/usr/local/include/crt_288x_ur.h", &st) == 0) {
        printf("✓ Header trovato in /usr/local/include/\n");
    } else {
        printf("- Header non trovato (opzionale)\n");
    }
    
    printf("\n");
    
    int success = test_crt288x_connection();
    
    if (success != 0) {
        show_error_codes();
        printf("=== Cosa fare ===\n");
        printf("1. Assicurati che il lettore CRT288x sia collegato via USB\n");
        printf("2. Controlla che appaia in 'lsusb' come nuovo dispositivo\n");
        printf("3. Verifica che il dispositivo sia alimentato (LED acceso?)\n");
        printf("4. Prova un cavo USB diverso\n");
        printf("5. Controlla i permessi: groups | grep dialout\n");
    }
    
    return success;
}


```

---

## File: serial_test

**Percorso:** `hardware/serial_test`
**Directory:** `hardware`
**Dimensione:** 16784 bytes
**Ultima modifica:** 2025-07-23 11:35:50
**Permessi:** 775

### Contenuto:

*[File binario - contenuto non visualizzabile]*

---

## File: usb_rly08_controller.py

**Percorso:** `hardware/usb_rly08_controller.py`
**Directory:** `hardware`
**Dimensione:** 15983 bytes
**Ultima modifica:** 2025-07-23 11:09:20
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/hardware/usb_rly08_controller.py
# Controller USB-RLY08 per sistema controllo accessi

import serial
import time
import logging
import threading
from typing import Optional, Dict, Any
from enum import Enum

logger = logging.getLogger(__name__)

class RelayChannel(Enum):
    """Mapping canali relè per funzionalità specifiche"""
    LED_GREEN = 1      # LED Verde - Accesso autorizzato
    LED_RED = 2        # LED Rosso - Accesso negato
    BUZZER = 3         # Buzzer - Segnalazioni acustiche
    GATE_MOTOR = 4     # Motore cancello - Apertura/Chiusura
    MAGNETIC_LOCK = 5  # Blocco elettromagnetico
    AREA_LIGHT = 6     # Illuminazione area RAEE
    SPARE_1 = 7        # Relè di riserva 1
    SPARE_2 = 8        # Relè di riserva 2

class USBRLY08Controller:
    """Controller USB-RLY08 per sistema controllo accessi RAEE"""
    
    def __init__(self, port: str = "/dev/ttyACM0", baudrate: int = 19200, device_path: Optional[str] = None, baud_rate: Optional[int] = None):
        # Supporto per parametri alternativi (device_path/baud_rate)
        self.port = device_path if device_path is not None else port
        self.baudrate = baud_rate if baud_rate is not None else baudrate
        self.serial_connection = None
        self.is_connected = False
        self.last_state = 0
        
        # Lock per thread safety
        self._lock = threading.Lock()
        
        # Configurazione relè
        self.relay_config = {
            RelayChannel.LED_GREEN: {"name": "LED Verde", "auto_off_delay": 3.0},
            RelayChannel.LED_RED: {"name": "LED Rosso", "auto_off_delay": 3.0},
            RelayChannel.BUZZER: {"name": "Buzzer", "auto_off_delay": 0.5},
            RelayChannel.GATE_MOTOR: {"name": "Motore Cancello", "auto_off_delay": 5.0},
            RelayChannel.MAGNETIC_LOCK: {"name": "Blocco Magnetico", "auto_off_delay": None},
            RelayChannel.AREA_LIGHT: {"name": "Illuminazione", "auto_off_delay": None}
        }
        
        # Timer per auto-spegnimento
        self.auto_off_timers = {}
        
        logger.info("🔧 USBRelay08Controller inizializzato")
    
    def connect(self) -> bool:
        """Stabilisce connessione con USB-RLY08"""
        try:
            with self._lock:
                if self.is_connected:
                    return True
                
                logger.info(f"🔌 Connessione a USB-RLY08 su {self.port}...")
                
                self.serial_connection = serial.Serial(
                    port=self.port,
                    baudrate=self.baudrate,
                    bytesize=serial.EIGHTBITS,
                    parity=serial.PARITY_NONE,
                    stopbits=serial.STOPBITS_TWO,
                    timeout=2
                )
                
                time.sleep(0.5)  # Stabilizzazione
                
                # Test connessione - Get software version
                self.serial_connection.write(bytes([90]))  # 0x5A
                time.sleep(0.1)
                response = self.serial_connection.read(2)
                
                if len(response) == 2 and response[0] == 8:
                    module_id = response[0]
                    sw_version = response[1]
                    logger.info(f"✅ USB-RLY08 connesso - ID: {module_id}, SW: {sw_version}")
                    
                    # Spegni tutti i relè all'avvio
                    self._all_relays_off()
                    
                    self.is_connected = True
                    return True
                else:
                    logger.error(f"❌ Risposta modulo inaspettata: {response}")
                    return False
                    
        except Exception as e:
            logger.error(f"❌ Errore connessione USB-RLY08: {e}")
            self.is_connected = False
            return False
    
    def disconnect(self):
        """Disconnessione sicura"""
        try:
            with self._lock:
                if self.is_connected and self.serial_connection:
                    # Spegni tutti i relè prima di disconnettere
                    self._all_relays_off()
                    self.serial_connection.close()
                    
                self.is_connected = False
                self.serial_connection = None
                
                # Cancella timer attivi
                for timer in self.auto_off_timers.values():
                    timer.cancel()
                self.auto_off_timers.clear()
                
                logger.info("🔌 USB-RLY08 disconnesso")
        except Exception as e:
            logger.error(f"❌ Errore disconnessione: {e}")
    
    def _send_command(self, command: int) -> bool:
        """Invia comando al modulo"""
        try:
            if not self.is_connected or not self.serial_connection:
                logger.warning("⚠️ USB-RLY08 non connesso")
                return False
            
            self.serial_connection.write(bytes([command]))
            return True
            
        except Exception as e:
            logger.error(f"❌ Errore invio comando {command}: {e}")
            return False
    
    def _all_relays_off(self):
        """Spegne tutti i relè"""
        self._send_command(110)  # 0x6E - All relays OFF
        self.last_state = 0
        logger.debug("💡 Tutti i relè spenti")
    
    def _set_relay_state(self, channel: RelayChannel, state: bool) -> bool:
        """Imposta stato singolo relè"""
        try:
            with self._lock:
                if not self.is_connected:
                    logger.warning(f"⚠️ Cannot control {channel.name} - USB-RLY08 not connected")
                    return False
                
                relay_num = channel.value
                config = self.relay_config.get(channel, {})
                relay_name = config.get("name", f"Relè {relay_num}")
                
                if state:
                    # Accendi relè (comandi 101-108)
                    command = 100 + relay_num
                    self._send_command(command)
                    
                    # Aggiorna stato locale
                    self.last_state |= (1 << (relay_num - 1))
                    
                    logger.info(f"🔆 {relay_name} ACCESO")
                    
                    # Auto-spegnimento se configurato
                    auto_off_delay = config.get("auto_off_delay")
                    if auto_off_delay is not None:
                        self._schedule_auto_off(channel, auto_off_delay)
                        
                else:
                    # Spegni relè (comandi 111-118)
                    command = 110 + relay_num
                    self._send_command(command)
                    
                    # Aggiorna stato locale
                    self.last_state &= ~(1 << (relay_num - 1))
                    
                    logger.info(f"💡 {relay_name} SPENTO")
                    
                    # Cancella timer auto-off se presente
                    if channel in self.auto_off_timers:
                        self.auto_off_timers[channel].cancel()
                        del self.auto_off_timers[channel]
                
                return True
                
        except Exception as e:
            logger.error(f"❌ Errore controllo {channel.name}: {e}")
            return False
    
    def _schedule_auto_off(self, channel: RelayChannel, delay: float):
        """Programma spegnimento automatico"""
        # Cancella timer precedente se esiste
        if channel in self.auto_off_timers:
            self.auto_off_timers[channel].cancel()
        
        # Programma nuovo timer
        timer = threading.Timer(delay, lambda: self._set_relay_state(channel, False))
        timer.start()
        self.auto_off_timers[channel] = timer
        
        logger.debug(f"⏰ Auto-off programmato per {channel.name} in {delay}s")
    
    # ===== INTERFACCIA PUBBLICA CONTROLLO ACCESSI =====
    
    def access_granted(self):
        """Segnala accesso autorizzato"""
        logger.info("✅ ACCESSO AUTORIZZATO")
        
        # LED Verde ON (auto-off 3s)
        self._set_relay_state(RelayChannel.LED_GREEN, True)
        
        # Buzzer breve (auto-off 500ms)
        self._set_relay_state(RelayChannel.BUZZER, True)
    
    def access_denied(self):
        """Segnala accesso negato"""
        logger.info("❌ ACCESSO NEGATO")
        
        # LED Rosso ON (auto-off 3s)
        self._set_relay_state(RelayChannel.LED_RED, True)
        
        # Pattern buzzer: 3 beep
        self._buzzer_pattern_denied()
    
    def _buzzer_pattern_denied(self):
        """Pattern buzzer per accesso negato (3 beep)"""
        def beep_sequence():
            for i in range(3):
                self._set_relay_state(RelayChannel.BUZZER, True)
                time.sleep(0.2)
                self._set_relay_state(RelayChannel.BUZZER, False)
                time.sleep(0.3)
        
        # Esegui in thread separato per non bloccare
        threading.Thread(target=beep_sequence, daemon=True).start()
    
    def open_gate(self, duration: float = 5.0):
        """Apre cancello per durata specificata"""
        logger.info(f"🚪 APERTURA CANCELLO per {duration}s")
        
        # Disattiva blocco magnetico
        self._set_relay_state(RelayChannel.MAGNETIC_LOCK, False)
        
        # Attiva motore cancello (auto-off dopo duration)
        config = self.relay_config[RelayChannel.GATE_MOTOR]
        config["auto_off_delay"] = duration
        self._set_relay_state(RelayChannel.GATE_MOTOR, True)
        
        # Riattiva blocco dopo apertura + 1s di sicurezza
        def relock():
            time.sleep(duration + 1.0)
            self._set_relay_state(RelayChannel.MAGNETIC_LOCK, True)
            logger.info("🔒 Blocco magnetico riattivato")
        
        threading.Thread(target=relock, daemon=True).start()
    
    def processing(self, active: bool):
        """Segnala elaborazione in corso"""
        if active:
            logger.info("🟡 ELABORAZIONE IN CORSO...")
            # Illuminazione area durante elaborazione
            self._set_relay_state(RelayChannel.AREA_LIGHT, True)
        else:
            logger.info("💡 Elaborazione completata")
            # Spegni illuminazione area
            self._set_relay_state(RelayChannel.AREA_LIGHT, False)
    
    def emergency_stop(self):
        """Stop di emergenza - spegne tutto"""
        logger.critical("🚨 EMERGENCY STOP - Spegnimento tutti i relè")
        
        with self._lock:
            # Cancella tutti i timer
            for timer in self.auto_off_timers.values():
                timer.cancel()
            self.auto_off_timers.clear()
            
            # Spegni tutti i relè
            self._all_relays_off()
    
    def set_area_lighting(self, state: bool):
        """Controllo illuminazione area RAEE"""
        action = "ACCESA" if state else "SPENTA"
        logger.info(f"💡 Illuminazione area RAEE {action}")
        self._set_relay_state(RelayChannel.AREA_LIGHT, state)
    
    def get_relay_states(self) -> Dict[str, bool]:
        """Ottieni stato attuale di tutti i relè"""
        try:
            with self._lock:
                if not self.is_connected:
                    return {}
                
                # Richiedi stato dal modulo
                self._send_command(91)  # 0x5B - Get relay states
                time.sleep(0.1)
                response = self.serial_connection.read(1)
                
                if len(response) == 1:
                    current_state = response[0]
                    self.last_state = current_state
                    
                    # Decodifica stato per ogni canale
                    states = {}
                    for channel in RelayChannel:
                        bit_position = channel.value - 1
                        is_on = bool(current_state & (1 << bit_position))
                        config = self.relay_config.get(channel, {})
                        name = config.get("name", f"Relè {channel.value}")
                        states[name] = is_on
                    
                    return states
                
                return {}
                
        except Exception as e:
            logger.error(f"❌ Errore lettura stati relè: {e}")
            return {}
    
    def health_check(self) -> bool:
        """Verifica salute del modulo"""
        try:
            if not self.is_connected:
                return self.connect()
            
            # Test comunicazione
            self._send_command(90)  # Get version
            time.sleep(0.1)
            response = self.serial_connection.read(2)
            
            return len(response) == 2 and response[0] == 8
            
        except Exception as e:
            logger.error(f"❌ Health check failed: {e}")
            return False
    
    def __enter__(self):
        """Context manager entry"""
        self.connect()
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        """Context manager exit"""
        self.disconnect()

# Alias per compatibilità
USBRelay08Controller = USBRLY08Controller

# Compatibilità con MockRelay esistente
class RelayController:
    """Alias per compatibilità con il sistema esistente"""
    
    def __init__(self, port: str = "/dev/ttyACM0", baudrate: int = 19200):
        self.usb_relay = USBRLY08Controller(port, baudrate)
        self.usb_relay.connect()
    
    def open_gate(self, duration: float = 5.0):
        """Compatibilità con interfaccia MockRelay"""
        self.usb_relay.open_gate(duration)
    
    def disconnect(self):
        """Disconnessione"""
        self.usb_relay.disconnect()

# Test del controller
if __name__ == "__main__":
    import signal
    import sys
    
    def signal_handler(signum, frame):
        print(f"\n🛑 Arresto test...")
        if 'controller' in globals():
            controller.emergency_stop()
            controller.disconnect()
        sys.exit(0)
    
    signal.signal(signal.SIGINT, signal_handler)
    
    print("🔧 TEST CONTROLLER USB-RLY08")
    print("=" * 50)
    
    # Setup logging per test
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s'
    )
    
    try:
        controller = USBRLY08Controller()
        
        if controller.connect():
            print("✅ Controller connesso")
            
            # Test sequenza controllo accessi
            print("\n🧪 Test sequenza controllo accessi...")
            
            print("1. Elaborazione...")
            controller.processing(True)
            time.sleep(2)
            
            print("2. Accesso autorizzato...")
            controller.processing(False)
            controller.access_granted()
            time.sleep(1)
            
            print("3. Apertura cancello...")
            controller.open_gate(3)
            time.sleep(4)
            
            print("4. Test accesso negato...")
            controller.access_denied()
            time.sleep(3)
            
            print("5. Illuminazione area...")
            controller.set_area_lighting(True)
            time.sleep(2)
            controller.set_area_lighting(False)
            
            # Mostra stati finali
            print("\n📊 Stati finali relè:")
            states = controller.get_relay_states()
            for name, state in states.items():
                print(f"   {name}: {'ON' if state else 'OFF'}")
            
            print("\n✅ Test completato")
            
        else:
            print("❌ Impossibile connettersi al controller")
    
    except Exception as e:
        print(f"❌ Errore: {e}")
    
    finally:
        if 'controller' in locals():
            controller.disconnect()

```

---

## File: main.py

**Percorso:** `main.py`
**Directory:** `.`
**Dimensione:** 25416 bytes
**Ultima modifica:** 2025-07-19 13:05:35
**Permessi:** 775

### Contenuto:

```python
# File: /opt/access_control/src/main.py
# APPLICAZIONE PRINCIPALE CON INTEGRAZIONE ODOO + USB-RLY08 REALE
# Versione con gestione robusta logging

import sys
import os
import time
import signal
import logging
import threading
from datetime import datetime, timedelta
from pathlib import Path

# Aggiungi moduli al path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'hardware'))
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'database'))
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'external'))

# Import moduli
try:
    from card_reader import CardReader
    from database_manager import DatabaseManager
    from odoo_partner_connector import OdooPartnerConnector
    from usb_rly08_controller import USBRLY08Controller  # NUOVO CONTROLLER REALE
    print("✅ Moduli importati correttamente (incluso USB-RLY08)")
except ImportError as e:
    print(f"⚠️ Import warning: {e}")

# Setup logging ROBUSTO con fallback
project_root = Path(__file__).parent.parent
log_dir = project_root / "logs"

# Crea directory log se non esiste (con gestione errori)
try:
    log_dir.mkdir(exist_ok=True)
    log_access_ok = True
    # Test scrittura
    test_file = log_dir / "test_write.tmp"
    test_file.write_text("test")
    test_file.unlink()
except (PermissionError, OSError) as e:
    print(f"⚠️ Impossibile accedere a {log_dir}: {e}")
    print("📝 Log verranno scritti solo su console")
    log_access_ok = False

# Configurazione logging con fallback
log_handlers = [logging.StreamHandler(sys.stdout)]

if log_access_ok:
    try:
        log_handlers.append(logging.FileHandler(log_dir / 'access_control.log'))
        print(f"📝 Log file: {log_dir / 'access_control.log'}")
    except Exception as e:
        print(f"⚠️ Impossibile creare log file: {e}")

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=log_handlers
)
logger = logging.getLogger(__name__)

# Setup logger specifici con gestione errori
def setup_secure_logger(name: str, filename: str):
    """Setup logger sicuro con fallback"""
    logger_instance = logging.getLogger(name)
    
    if log_access_ok:
        try:
            handler = logging.FileHandler(log_dir / filename)
            handler.setFormatter(logging.Formatter(
                f'%(asctime)s - {name.upper()} - %(levelname)s - %(message)s'
            ))
            logger_instance.addHandler(handler)
            logger_instance.setLevel(logging.INFO)
        except Exception as e:
            print(f"⚠️ Impossibile creare logger {name}: {e}")
            # Fallback a console
            logger_instance.addHandler(logging.StreamHandler(sys.stdout))
    else:
        # Solo console
        logger_instance.addHandler(logging.StreamHandler(sys.stdout))
    
    return logger_instance

# Logger specializzati
security_logger = setup_secure_logger('security_audit', 'security_audit.log')
raee_logger = setup_secure_logger('raee_audit', 'raee_access.log')

# Mock components solo per Arduino (USB-RLY08 sostituisce tutto il resto)
class MockArduino:
    """Mock Arduino - ora solo per compatibilità, USB-RLY08 gestisce tutto"""
    def access_granted(self):
        print("🟢 [Compatibilità] Arduino: LED VERDE")
        logger.info("Hardware: Segnale accesso autorizzato (compatibilità)")
    
    def access_denied(self):
        print("🔴 [Compatibilità] Arduino: LED ROSSO") 
        logger.warning("Hardware: Segnale accesso negato (compatibilità)")
    
    def processing(self, active):
        status = "ON" if active else "OFF"
        print(f"🟡 [Compatibilità] Arduino: Processing {status}")

class MockConfigManager:
    """Config Manager mock per OdooPartnerConnector"""
    
    def __init__(self):
        self.config = MockConfig()
    
    def get_config(self):
        return self.config

class MockConfig:
    """Config mock che simula la struttura richiesta"""
    
    def __init__(self):
        self.odoo = None

class AccessControlSystem:
    """Sistema controllo accessi ISOLA RAEE con integrazione Odoo + USB-RLY08"""
    
    def __init__(self):
        self.running = False
        self.last_sync_time = None
        self.sync_in_progress = False
        
        # Statistiche con sicurezza ISOLA RAEE
        self.stats = {
            'total': 0, 'authorized': 0, 'denied': 0,
            'sync_operations': 0, 'failed_connections': 0,
            'last_security_check': None,
            'raee_sessions': 0, 'avg_session_duration': 0
        }
        
        # Rate limiting sicurezza
        self.rate_limiter = {
            'max_attempts_per_minute': 60,
            'attempts_log': [],
            'blocked_until': None
        }
        
        # Componenti
        self.card_reader = None
        self.arduino = MockArduino()  # Solo compatibilità
        self.usb_relay_controller = None  # CONTROLLER REALE USB-RLY08
        self.database = None
        self.odoo_connector = None
        
        # Configurazione Odoo CORRETTA
        self.odoo_config = {
            'url': 'https://app.calabramaceri.it',
            'database': 'cmapp',
            'username': 'controllo-accessi@calabramaceri.it',
            'password': 'AcC3ss0C0ntr0l!2025#Rnd',
            'comune': 'Rende',
            'sync_interval_hours': 12
        }
        
        # Configurazione ISOLA RAEE
        self.raee_config = {
            'location': 'Isola Ecologica RAEE - Rende',
            'gate_open_duration': 8.0,  # 8 secondi per isola RAEE
            'auto_lighting': True,
            'security_lock': True
        }
        
        print("🏗️ Sistema ISOLA RAEE con USB-RLY08 inizializzato")
        security_logger.info("SYSTEM_INIT - RAEE access control system started")
        raee_logger.info("RAEE_SYSTEM_INIT - Isola Ecologica control system started")
    
    def security_check(self) -> bool:
        """Controlli sicurezza avanzati ISOLA RAEE"""
        try:
            current_time = datetime.now()
            
            # Rate limiting check
            if self.rate_limiter['blocked_until']:
                if current_time < self.rate_limiter['blocked_until']:
                    return False
                else:
                    self.rate_limiter['blocked_until'] = None
            
            # Pulizia rate limiter
            one_minute_ago = current_time - timedelta(minutes=1)
            self.rate_limiter['attempts_log'] = [
                t for t in self.rate_limiter['attempts_log'] if t > one_minute_ago
            ]
            
            # Rate limit check
            if len(self.rate_limiter['attempts_log']) >= self.rate_limiter['max_attempts_per_minute']:
                self.rate_limiter['blocked_until'] = current_time + timedelta(minutes=5)
                security_logger.critical("RATE_LIMIT_EXCEEDED - Sistema bloccato")
                return False
            
            self.stats['last_security_check'] = current_time
            return True
            
        except Exception as e:
            security_logger.error(f"SECURITY_CHECK_FAILED - {e}")
            return False
    
    def log_raee_access(self, cf: str, authorized: bool, user_data: dict = None):
        """Log specifico per accessi ISOLA RAEE"""
        timestamp = datetime.now()
        self.rate_limiter['attempts_log'].append(timestamp)
        
        # CF mascherato per log sicurezza
        masked_cf = f"{cf[:4]}***{cf[-4:]}"
        
        # Log RAEE specifico
        user_name = "Cittadino Sconosciuto"
        if user_data:
            user_name = f"{user_data.get('nome', '')} {user_data.get('cognome', '')}".strip()
        
        raee_logger.info(
            f"RAEE_ACCESS - CF: {masked_cf} - "
            f"User: {user_name} - "
            f"Authorized: {authorized} - "
            f"Location: {self.raee_config['location']} - "
            f"Timestamp: {timestamp.isoformat()}"
        )
        
        # Log sicurezza generale
        security_logger.info(
            f"ACCESS_ATTEMPT - CF: {masked_cf} - "
            f"Authorized: {authorized} - Timestamp: {timestamp.isoformat()}"
        )
    
    def initialize(self):
        """Inizializza componenti con Odoo + USB-RLY08"""
        print("🔧 Inizializzazione ISOLA RAEE con USB-RLY08...")
        
        try:
            # Security check
            if not self.security_check():
                logger.error("❌ Security check fallito")
                return False
            
            # USB-RLY08 Controller (REALE)
            print("🔌 Inizializzazione USB-RLY08...")
            self.usb_relay_controller = USBRLY08Controller()
            
            if not self.usb_relay_controller.connect():
                logger.error("❌ USB-RLY08 non connesso")
                print("⚠️ Impossibile connettersi a USB-RLY08")
                print("💡 Verifica:")
                print("   1. Dispositivo collegato USB")
                print("   2. Permessi gruppo dialout (newgrp dialout)")
                print("   3. Porta /dev/ttyACM0 disponibile")
                
                # Chiedi se continuare senza hardware
                response = input("\n🔧 Continuare senza USB-RLY08? (y/n): ").lower().strip()
                if response not in ['y', 'yes', 's', 'si']:
                    return False
                
                print("⚠️ Modalità DEMO attivata - solo mock hardware")
                self.usb_relay_controller = None
            else:
                logger.info("✅ USB-RLY08 Controller inizializzato")
                print("✅ USB-RLY08 Controller operativo")
                
                # Test iniziale relè
                print("🧪 Test iniziale sistema...")
                self.usb_relay_controller.set_area_lighting(True)
                time.sleep(1)
                self.usb_relay_controller.set_area_lighting(False)
            
            # CardReader
            self.card_reader = CardReader()
            logger.info("✅ CardReader inizializzato")
            
            # Database
            db_path = project_root / "src" / "access.db"
            self.database = DatabaseManager(str(db_path))
            
            if not self.database.health_check():
                logger.error("❌ Database non funzionante")
                return False
            
            logger.info("✅ Database inizializzato")
            
            # Odoo Connector con configurazione CORRETTA
            mock_config_manager = MockConfigManager()
            self.odoo_connector = OdooPartnerConnector(mock_config_manager)
            self.odoo_connector.configure_connection(
                url=self.odoo_config['url'],
                database=self.odoo_config['database'],
                username=self.odoo_config['username'],
                password=self.odoo_config['password'],
                comune=self.odoo_config['comune'],
                sync_interval=self.odoo_config['sync_interval_hours'] * 3600
            )
            
            # Test connessione
            success, message = self.odoo_connector.test_connection()
            if success:
                logger.info("✅ Connessione Odoo sicura stabilita")
                security_logger.info(f"ODOO_CONNECTION_SUCCESS - {message}")
                
                # SYNC COMPLETA PRIMA DELL'AVVIO
                print("🔄 Sincronizzazione database ISOLA RAEE...")
                print("⏳ Attendere completamento sync cittadini Rende...")
                logger.info("🔄 Esecuzione sync completa OBBLIGATORIA...")
                
                sync_success, sync_stats = self.odoo_connector.sync_to_database(self.database)
                
                if sync_success:
                    citizens_added = sync_stats.get('added', 0)
                    citizens_fetched = sync_stats.get('fetched', 0)
                    print(f"✅ Sincronizzazione ISOLA RAEE completata!")
                    print(f"📊 {citizens_fetched} cittadini Rende, {citizens_added} aggiunti")
                    logger.info(f"✅ Sync iniziale completata: {citizens_added} cittadini")
                    self.stats['sync_operations'] += 1
                    self.last_sync_time = datetime.now()
                else:
                    print("❌ ERRORE: Sincronizzazione fallita!")
                    logger.error("❌ Sync iniziale fallita - sistema continuerà con database locale")
                    print("⚠️ Sistema continuerà con database locale")
                
                # Avvia sync automatica periodica
                self.start_auto_sync()
                
            else:
                logger.warning(f"⚠️ Test Odoo fallito: {message}")
                security_logger.warning(f"ODOO_CONNECTION_FAILED - {message}")
                logger.info("🔄 Sistema continuerà con database locale")
            
            return True
            
        except Exception as e:
            logger.error(f"❌ Errore inizializzazione: {e}")
            security_logger.error(f"INIT_FAILED - {e}")
            return False
    
    def start_auto_sync(self):
        """Avvia sincronizzazione automatica"""
        def sync_worker():
            while self.running:
                try:
                    sleep_hours = self.odoo_config['sync_interval_hours']
                    logger.info(f"⏰ Prossima sync automatica in {sleep_hours} ore")
                    time.sleep(sleep_hours * 3600)
                    
                    if self.running:
                        self.perform_sync()
                    
                except Exception as e:
                    logger.error(f"❌ Errore sync worker: {e}")
                    time.sleep(3600)
        
        sync_thread = threading.Thread(target=sync_worker, daemon=True)
        sync_thread.start()
        logger.info("🔄 Auto-sync Odoo avviata")
    
    def perform_sync(self):
        """Esegue sincronizzazione sicura"""
        if self.sync_in_progress:
            return
        
        self.sync_in_progress = True
        sync_start = datetime.now()
        
        try:
            logger.info("🔄 Inizio sincronizzazione Odoo ISOLA RAEE")
            security_logger.info("SYNC_START - Odoo synchronization initiated")
            
            success, stats = self.odoo_connector.sync_to_database(self.database)
            
            if success:
                self.last_sync_time = datetime.now()
                self.stats['sync_operations'] += 1
                
                duration = (datetime.now() - sync_start).total_seconds()
                logger.info(f"✅ Sync completata in {duration:.2f}s - Stats: {stats}")
                
                security_logger.info(
                    f"SYNC_SUCCESS - Duration: {duration:.2f}s - "
                    f"Citizens: {stats['fetched']} - Added: {stats['added']}"
                )
            else:
                self.stats['failed_connections'] += 1
                logger.warning("⚠️ Sincronizzazione fallita")
                
        except Exception as e:
            logger.error(f"❌ Errore sync: {e}")
            security_logger.error(f"SYNC_ERROR - {e}")
        finally:
            self.sync_in_progress = False
    
    def handle_cf(self, codice_fiscale):
        """Gestisce CF ISOLA RAEE con hardware USB-RLY08"""
        if not self.security_check():
            logger.warning("⚠️ Security check fallito - accesso bloccato")
            if self.usb_relay_controller:
                self.usb_relay_controller.access_denied()
            else:
                print("❌ [MOCK] Accesso bloccato per sicurezza")
            return
        
        start_time = time.time()
        masked_cf = f"{codice_fiscale[:4]}***{codice_fiscale[-4:]}"
        
        logger.info(f"🎯 CF ricevuto ISOLA RAEE: {masked_cf}")
        
        # Processing con illuminazione area
        if self.usb_relay_controller:
            self.usb_relay_controller.processing(True)
        else:
            print("🟡 [MOCK] Elaborazione in corso...")
        
        print(f"\n🟡 ELABORAZIONE ACCESSO ISOLA RAEE...")
        print(f"🆔 CF: {masked_cf}")
        
        try:
            # Verifica accesso
            authorized, user_data = self.database.verify_access(codice_fiscale)
            
            # Log accesso RAEE
            self.log_raee_access(codice_fiscale, authorized, user_data)
            
            # Statistiche
            self.stats['total'] += 1
            if authorized:
                self.stats['authorized'] += 1
                self.stats['raee_sessions'] += 1
            else:
                self.stats['denied'] += 1
            
            # Log database
            processing_time = time.time() - start_time
            self.database.log_access(
                codice_fiscale=codice_fiscale,
                authorized=authorized,
                processing_time=processing_time,
                user_data=user_data,
                terminal_id="RAEE_ISOLA_RENDE_001"
            )
            
            # Fine processing
            if self.usb_relay_controller:
                self.usb_relay_controller.processing(False)
            
            if authorized:
                # ACCESSO AUTORIZZATO ISOLA RAEE
                user_name = f"{user_data.get('nome', '')} {user_data.get('cognome', '')}" if user_data else 'Cittadino'
                
                print(f"\n✅ ACCESSO AUTORIZZATO - ISOLA ECOLOGICA RAEE")
                print(f"🏘️ Comune: {self.odoo_config['comune']}")
                print(f"👤 Cittadino: {user_name}")
                print(f"🆔 CF: {masked_cf}")
                print(f"📍 Ubicazione: {self.raee_config['location']}")
                print(f"⏱️ Tempo elaborazione: {processing_time:.2f}s")
                
                # Segnalazioni hardware USB-RLY08
                if self.usb_relay_controller:
                    self.usb_relay_controller.access_granted()  # LED Verde + Buzzer
                    gate_duration = self.raee_config['gate_open_duration']
                    self.usb_relay_controller.open_gate(gate_duration)
                    print(f"🚪 Cancello aperto per {gate_duration} secondi")
                else:
                    print("🟢 [MOCK] LED Verde + Buzzer OK")
                    print("🚪 [MOCK] Cancello aperto per 8 secondi")
                
                print("♻️ Accesso consentito per conferimento RAEE")
                
                # Log RAEE specifico
                raee_logger.info(f"RAEE_ACCESS_GRANTED - User: {user_name} - Gate: {self.raee_config['gate_open_duration']}s")
                
            else:
                # ACCESSO NEGATO
                print(f"\n❌ ACCESSO NEGATO - ISOLA RAEE")
                print(f"⚠️ CF non autorizzato: {masked_cf}")
                print(f"🏘️ Solo cittadini {self.odoo_config['comune']} autorizzati")
                print("📞 Per informazioni contattare ufficio ambiente")
                
                # Segnalazioni hardware USB-RLY08
                if self.usb_relay_controller:
                    self.usb_relay_controller.access_denied()  # LED Rosso + Buzzer x3
                else:
                    print("🔴 [MOCK] LED Rosso + 3 Buzzer")
                
                # Log RAEE negato
                raee_logger.warning(f"RAEE_ACCESS_DENIED - CF: {masked_cf}")
            
            # Statistiche
            self.print_raee_stats()
            print("-" * 60)
            
        except Exception as e:
            logger.error(f"❌ Errore gestione CF: {e}")
            security_logger.error(f"CF_HANDLING_ERROR - {e}")
            if self.usb_relay_controller:
                self.usb_relay_controller.access_denied()
        finally:
            if self.usb_relay_controller:
                self.usb_relay_controller.processing(False)
    
    def print_raee_stats(self):
        """Stampa statistiche ISOLA RAEE"""
        total = self.stats['total']
        success_rate = (self.stats['authorized'] / total * 100) if total > 0 else 0
        
        print(f"📊 Stats RAEE: {self.stats['authorized']}/{total} autorizzati ({success_rate:.1f}%)")
        print(f"♻️ Sessioni RAEE: {self.stats['raee_sessions']}")
        print(f"🔄 Sync Odoo: {self.stats['sync_operations']} completate")
        
        if self.last_sync_time:
            hours_ago = (datetime.now() - self.last_sync_time).total_seconds() / 3600
            print(f"⏰ Ultima sync: {hours_ago:.1f}h fa")
    
    def run(self):
        """Avvia sistema ISOLA RAEE"""
        print("🚀 AVVIO SISTEMA CONTROLLO ACCESSI ISOLA RAEE")
        print("=" * 60)
        print(f"📅 {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"♻️ Ubicazione: {self.raee_config['location']}")
        print(f"🏘️ Comune: {self.odoo_config['comune']}")
        print(f"🔗 Server: {self.odoo_config['url']}")
        print(f"👤 Utente: {self.odoo_config['username']}")
        hardware_status = "USB-RLY08 Controller" if self.usb_relay_controller else "MOCK Mode"
        print(f"🔌 Hardware: {hardware_status}")
        print()
        print("🔧 Inizializzazione sistema...")
        
        if not self.initialize():
            print("❌ Inizializzazione fallita")
            return False
        
        print(f"\n♻️ SISTEMA ISOLA RAEE ATTIVO")
        print("=" * 60)
        print("💳 Inserire tessere sanitarie cittadini Rende")
        print("♻️ Per conferimento RAEE, oli esausti, vestiti")
        print("🔐 Controlli sicurezza attivi")
        print("🔄 Sincronizzazione automatica ogni 12h")
        print("📝 Audit log completo")
        print(f"🔌 Hardware: {hardware_status}")
        print("⏹️ Ctrl+C per fermare")
        print("=" * 60)
        
        try:
            self.running = True
            
            # Illuminazione area all'avvio
            if self.usb_relay_controller:
                self.usb_relay_controller.set_area_lighting(True)
                print("💡 Illuminazione area RAEE attivata")
            
            # Avvia CardReader
            self.card_reader.start_continuous_reading(self.handle_cf)
            
        except KeyboardInterrupt:
            print("\n⏹️ Arresto richiesto")
        except Exception as e:
            logger.error(f"\n❌ Errore: {e}")
            security_logger.critical(f"SYSTEM_ERROR - {e}")
        finally:
            self.shutdown()
        
        return True
    
    def shutdown(self):
        """Arresto sicuro sistema ISOLA RAEE"""
        print("\n🛑 Arresto sicuro ISOLA RAEE...")
        security_logger.info("SYSTEM_SHUTDOWN - Secure RAEE shutdown initiated")
        raee_logger.info("RAEE_SYSTEM_SHUTDOWN - Sistema spento")
        
        self.running = False
        
        if self.card_reader:
            self.card_reader.stop()
        
        if self.usb_relay_controller:
            print("🔌 Spegnimento USB-RLY08...")
            self.usb_relay_controller.emergency_stop()
            self.usb_relay_controller.disconnect()
        
        if self.odoo_connector:
            self.odoo_connector.disconnect()
        
        # Statistiche finali
        print(f"\n📊 STATISTICHE FINALI ISOLA RAEE:")
        print(f"   Accessi totali: {self.stats['total']}")
        print(f"   Autorizzati: {self.stats['authorized']}")
        print(f"   Negati: {self.stats['denied']}")
        print(f"   Sessioni RAEE: {self.stats['raee_sessions']}")
        print(f"   Sync completate: {self.stats['sync_operations']}")
        
        if self.last_sync_time:
            print(f"   Ultima sync: {self.last_sync_time.strftime('%H:%M:%S')}")
        
        security_logger.info(
            f"SYSTEM_SHUTDOWN_COMPLETE - Total: {self.stats['total']} - "
            f"Authorized: {self.stats['authorized']} - Denied: {self.stats['denied']} - "
            f"RAEE_Sessions: {self.stats['raee_sessions']}"
        )
        
        print("✅ Sistema ISOLA RAEE arrestato in sicurezza")

# Gestione segnali
system = None

def signal_handler(signum, frame):
    print(f"\n🛑 Segnale {signum}...")
    global system
    if system:
        system.running = False
    sys.exit(0)

def main():
    """Main applicazione ISOLA RAEE"""
    print("♻️ SISTEMA CONTROLLO ACCESSI ISOLA ECOLOGICA RAEE")
    print("=" * 60)
    print(f"⏰ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("💳 CardReader OMNIKEY 5427 CK ✅")
    print("🔗 Integrazione Odoo SICURA ✅")
    print("🏘️ Configurato per Comune di RENDE ✅")
    print("🔌 Hardware USB-RLY08 Controller ✅")
    print("♻️ ISOLA ECOLOGICA per RAEE, oli, vestiti ✅")
    print()
    
    # Signal handlers
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        global system
        system = AccessControlSystem()
        
        if system.run():
            print("✅ Sistema ISOLA RAEE terminato OK")
            sys.exit(0)
        else:
            print("❌ Sistema terminato con errori")
            sys.exit(1)
    
    except Exception as e:
        logger.error(f"❌ Errore critico: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

---

